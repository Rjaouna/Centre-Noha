{% extends 'base.html.twig' %}

{% block title %}Recherche des Médicaments
{% endblock %}

{% block body %}

	<div
		class="mt-4">
{# ================= HEADER : RECHERCHE MÉDICAMENTS ================= #}

{% embed '_partials/_page_header.html.twig' with {
    icon: 'bi bi-capsule-pill',
    title: 'Recherche des médicaments',
    subtitle: null
} %}

	{# Sous-texte / description #}
	{% block header_subtitle %}
		<small class="text-muted">
			Tapez pour rechercher un médicament
		</small>
	{% endblock %}

	{# Actions métier (mobile à gauche) #}
	{% block header_actions_left %}
		<a href="{{ path('medicine_new') }}" class="action-icon bg-danger text-white" data-bs-toggle="tooltip" title="Ajouter un médicament">
			<i class="bi bi-plus-circle"></i>
		</a>
	{% endblock %}

	{# Navigation (mobile à droite) #}
	{% block header_actions_right %}
		<a href="{{ path('app_home') }}" class="action-icon bg-light text-dark" data-bs-toggle="tooltip" title="Accueil">
			<i class="bi bi-house"></i>
		</a>

		<a href="javascript:void(0);" onclick="history.back()" class="action-icon bg-light" data-bs-toggle="tooltip" title="Retour">
			<i class="bi bi-arrow-left"></i>
		</a>
	{% endblock %}

{% endembed %}



	</div>

	<!-- ⭐⭐ CHAMP DE RECHERCHE ⭐⭐ -->
	<div class="position-relative my-4">
		<i class="bi bi-search text-secondary position-absolute top-50 start-3 translate-middle-y"></i>

		<input type="text" id="medicineSearch" class="form-control-lg shadow-sm form-control rounded-pill ps-5" placeholder="Rechercher un médicament...">
	</div>

	<style>
		.start-3 {
			left: 16px;
		}
	</style>

	<!-- ⭐⭐ CONTENU STATIQUE D’INTRO ⭐⭐ -->
	<div id="staticIntro" class="mb-4">

		

		<div class="row g-4">

			<div class="col-md-4">
				<div class="card med-info shadow-sm border-0 rounded-4 p-4 h-100">
					<i class="bi bi-capsule text-danger fs-2 mb-3"></i>
					<h5 class="fw-bold">Vue d’ensemble rapide</h5>
					<p class="text-secondary small">
						Accédez en un coup d’œil aux médicaments les plus courants de votre pratique
						                    et aux informations essentielles qui les concernent.
					</p>
				</div>
			</div>

			<div class="col-md-4">
				<div class="card med-info shadow-sm border-0 rounded-4 p-4 h-100">
<i class="bi bi-search text-danger fs-2 mb-3"></i>

					<h5 class="fw-bold">Recherche intelligente</h5>
					<p class="text-secondary small">
						Tapez quelques lettres du nom, de la DCI ou du code pour filtrer instantanément
						                    les médicaments de votre base.
					</p>
				</div>
			</div>

			<div class="col-md-4">
				<div class="card med-info shadow-sm border-0 rounded-4 p-4 h-100">
<i class="bi bi-shield-check text-danger fs-2 mb-3"></i>

					<h5 class="fw-bold">Suivi sécurisé</h5>
					<p class="text-secondary small">
						Chaque fiche médicament est liée à votre système de suivi, pour une prise de décision plus simple
						                    et plus sécurisée.
					</p>
				</div>
			</div>

		</div>

	</div>

	<!-- ⭐⭐ ZONE DES RÉSULTATS API ⭐⭐ -->
	<div id="results"></div>

	<style>
		.med-card {
			background: white;
			border-radius: 20px;
			padding: 22px;
			margin-bottom: 18px;
			border: 1px solid rgba(0, 0, 0, 0.08);
			transition: 0.3s ease;
			cursor: pointer;
		}
		.med-card:hover {
			transform: translateY(-6px);
			box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
		}

		.med-info {
			transition: 0.3s ease;
		}
		.med-info:hover {
			transform: translateY(-5px);
			box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
		}
	</style>

	 <script>
	document.addEventListener("DOMContentLoaded", () => {
	
	    const input       = document.getElementById("medicineSearch");
	    const results     = document.getElementById("results");
	    const staticIntro = document.getElementById("staticIntro");
	    let timer         = null;
	
	    function renderResults(data) {
	        results.innerHTML = "";
	
	        data.forEach(m => {
	            const card = `
	                <div class="med-card shadow-sm" onclick="window.location='/medicine/${m.id}'">
	                    <div class="d-flex justify-content-between">
	
	                        <div>
<p class="fw-bold text-secondary mb-1">${m.name} - ${m.dosage} ${m.uniteDosage} ${
		                                m.isGeneric
		                                    ? `<span class="fw-light badge bg-success py-1 mx-1">Générique</span>`
		                                    : `<span class="fw-light badge bg-warning py-1 mx-1">Princeps</span>`
		                            }


</p>



	                            <p class="text-secondary small mb-1">
${m.forme} - ${m.presentation}


<span class="text-${m.tauxRembourssement != 0 ? 'success' : 'danger'}">
	${m.tauxRembourssement != 0 ? '(Taux de rembourssement : 70%)' : '(Non Rembourssable)'}</span>


	                            </p>
	                        </div>
	
	                        <div class="text-end">
	                            <span class="badge bg-info text-dark px-3 py-2">${m.ppv} DH</span><br>
	                            
	                        </div>
	
	                    </div>
	                </div>
	            `;
	            results.insertAdjacentHTML("beforeend", card);
	        });
	    }
	
	    input.addEventListener("keyup", () => {
	
	        clearTimeout(timer);
	
	        timer = setTimeout(() => {
	
	            const q = input.value.trim();
	
	            // Si moins de 2 caractères → on remet l'intro et on vide les résultats
	            if (q.length < 2) {
	                staticIntro.style.display = "block";
	                results.innerHTML = "";
	                return;
	            }
	
	            // Dès qu'on commence une vraie recherche → cacher l'intro
	            staticIntro.style.display = "none";
	
	            fetch(`/medicine/search/api?search=${encodeURIComponent(q)}`)
	                .then(res => res.json())
	                .then(data => {
	
	                    if (data.length === 0) {
	                        results.innerHTML = `
	                            <div class="alert alert-warning text-center rounded-4 py-3">
	                                Aucun médicament trouvé.
	                            </div>`;
	                        return;
	                    }
	
	                    renderResults(data);
	                });
	
	        }, 250);
	    });
	
	});
	</script>

{% endblock %}

