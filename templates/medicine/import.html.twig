{% extends 'base.html.twig' %}

{% block title %}Import Excel
{% endblock %}

{% block body %}
	<div class="container mt-5">
		<h2 class="mb-4 fw-bold">Importer les Médicaments (Excel)</h2>

		<div class="mb-3">
			<input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls">
		</div>

		<button id="importBtn" class="btn btn-primary px-4">Importer</button>

		<div id="message" class="mt-4"></div>
	</div>

	 <script>
	document.getElementById('importBtn').addEventListener('click', async () => {
	
	    const fileInput = document.getElementById('excelFile');
	    const messageBox = document.getElementById('message');
	
	    if (!fileInput.files.length) {
	        messageBox.innerHTML = "<div class='alert alert-danger'>Veuillez sélectionner un fichier</div>";
	        return;
	    }
	
	    let formData = new FormData();
	    formData.append('file', fileInput.files[0]);
	
	    messageBox.innerHTML = "<div class='alert alert-info'>Importation en cours...</div>";
	
	    try {
const response = await fetch('{{ path("medicine_import_process") }}', {
	    method: 'POST',
	    body: formData
	});
	
	// Vérification si JSON ou HTML
	const contentType = response.headers.get("content-type");
	
	if (!contentType || !contentType.includes("application/json")) {
	    const text = await response.text();
	    console.error("Réponse HTML détectée :", text);
	    messageBox.innerHTML = "<div class='alert alert-danger'>Le serveur renvoie du HTML au lieu du JSON.<br>Voir console.</div>";
	    return;
	}
	
	const data = await response.json();


	
	        if (data.success) {
	            messageBox.innerHTML = "<div class='alert alert-success'>Importation terminée avec succès ✔</div>";
	        } else {
	            messageBox.innerHTML = `<div class='alert alert-danger'>${data.error}</div>`;
	        }
	
	    } catch (error) {
	        messageBox.innerHTML = `<div class='alert alert-danger'>Erreur : ${error}</div>`;
	    }
	
	});
	</script>
{% endblock %}

