{% extends 'base.html.twig' %}

{% block title %}Gestion des maladies chroniques
{% endblock %}

{% block body %}
	<div
		class="container-fluid mt-4">

		<!-- ================= ENTÊTE ================= -->
		<div class="card shadow-sm border-0 rounded-4 mb-4">
			<div class="card-body d-flex justify-content-between align-items-center">
				<div>
					<h3 class="fw-bold mb-0">
						<i class="bi bi-heart-pulse text-danger me-2"></i>
						Gestion des maladies chroniques
					</h3>
					<small class="text-muted">
						Référentiel des maladies chroniques utilisées comme contre-indications
					</small>
				</div>

				<button class="btn btn-danger rounded-pill px-4" id="btnAdd">
					<i class="bi bi-plus-circle me-1"></i>
					Nouvelle maladie
				</button>
			</div>
		</div>

		<!-- ================= TABLE ================= -->
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-body">
				<table id="tableMaladies" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>Nom</th>
							<th>Description</th>
							<th class="text-end">Actions</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>

	</div>

	<!-- ================= MODAL ================= -->
	<div class="modal fade" id="modalMaladie" tabindex="-1">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<form id="formMaladie">

					<div class="modal-header bg-danger text-white">
						<h5 class="modal-title fw-bold">
							<i class="bi bi-heart-pulse me-2"></i>
							Maladie chronique
						</h5>
						<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>

					<div class="modal-body">

						<div class="mb-3">
							<label class="form-label fw-semibold">Nom</label>
							<input name="nom" class="form-control" required>
						</div>

						<div class="mb-3">
							<label class="form-label fw-semibold">Description</label>
							<textarea name="description" class="form-control" rows="3" placeholder="Informations complémentaires (optionnel)"></textarea>
						</div>

					</div>

					<div class="modal-footer">
						<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
							Annuler
						</button>
						<button class="btn btn-danger rounded-pill">
							Enregistrer
						</button>
					</div>

				</form>

			</div>
		</div>
	</div>
{% endblock %}



{% block javascripts %}
	{{ parent() }}
 <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

	 <script>
	let editId = null;
	const modal = new bootstrap.Modal(document.getElementById('modalMaladie'));
	const form = document.getElementById('formMaladie');
	
	const table = $('#tableMaladies').DataTable({
	    ajax: {
	        url: '/api/referentiel/maladies-chroniques',
	        dataSrc: ''
	    },
	    columns: [
	        { data: 'nom', className: 'fw-semibold' },
	        { data: 'description', render: d => d ?? '<span class="text-muted">—</span>' },
	        {
	            data: 'id',
	            orderable: false,
	            className: 'text-center',
	            render: id => `
	                <button class="btn btn-sm btn-outline-primary me-1" onclick="editMaladie(${id})">
	                    <i class="bi bi-pencil"></i>
	                </button>
	                <button class="btn btn-sm btn-outline-danger" onclick="deleteMaladie(${id})">
	                    <i class="bi bi-trash"></i>
	                </button>
	            `
	        }
	    ],
	    language: { url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json' }
	});
	
	document.getElementById('btnAdd').onclick = () => {
	    editId = null;
	    form.reset();
	    modal.show();
	};
	
	window.editMaladie = async (id) => {
	    const res = await fetch(`/api/referentiel/maladies-chroniques/${id}`);
	    const m = await res.json();
	
	    editId = id;
	    form.nom.value = m.nom;
	    form.description.value = m.description ?? '';
	    modal.show();
	};
	
	window.deleteMaladie = async (id) => {
	    if (!confirm('Supprimer ?')) return;
	    await fetch(`/api/referentiel/maladies-chroniques/${id}`, { method: 'DELETE' });
	    table.ajax.reload(null, false);
	};
	
	form.addEventListener('submit', async e => {
	    e.preventDefault();
	
	    const payload = {
	        nom: form.nom.value,
	        description: form.description.value
	    };
	
	    const url = editId
	        ? `/api/referentiel/maladies-chroniques/${editId}`
	        : `/api/referentiel/maladies-chroniques`;
	
	    await fetch(url, {
	        method: editId ? 'PUT' : 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify(payload)
	    });
	
	    modal.hide();
	    form.reset();
	    editId = null;
	    table.ajax.reload(null, false);
	});
	</script>
{% endblock %}

