{% extends 'base.html.twig' %}

{% block title %}Recherche par nom de dispositif
{% endblock %}

{% block body %}
<div class="mt-4">


	{% embed '_partials/_page_header.html.twig' with {
		icon: 'bi bi-card-text',
		title: 'Recherche par nom de dispositif',
		subtitle: 'Recherchez un dispositif ou un acte par son libell√©'
	} %}

		{# Pas d‚Äôactions m√©tier √† gauche pour l‚Äôinstant #}
		{% block header_actions_left %}{% endblock %}

		{# On garde le bloc right par d√©faut : Home + Retour #}
	{% endembed %}

</div>



	<!-- üîç CHAMP DE RECHERCHE -->
	<div class="position-relative my-4">
		<i class="bi bi-search text-secondary position-absolute top-50 start-3 translate-middle-y"></i>
		<input type="text" id="libelleSearch" class="form-control-lg shadow-sm form-control rounded-pill ps-5" placeholder="Rechercher par libell√©...">
	</div>

	<style>
		.start-3 {
			left: 16px;
		}

		.libelle-card {
			background: white;
			border-radius: 20px;
			padding: 22px;
			margin-bottom: 18px;
			border: 1px solid rgba(0, 0, 0, .08);
			transition: 0.3s ease;
			cursor: pointer;
		}
		.libelle-card:hover {
			transform: translateY(-6px);
			box-shadow: 0 18px 40px rgba(0, 0, 0, .12);
		}
	</style>

	<!-- ‚≠ê‚≠ê INTRO STATIQUE -->
	<div id="staticIntro" class="mb-4">
		<div class="row g-4">

			<div class="col-md-4">
				<div class="card shadow-sm border-0 rounded-4 p-4 h-100">
					<i class="bi bi-info-circle text-primary fs-2 mb-3"></i>
					<h5 class="fw-bold">Recherche rapide</h5>
					<p class="text-secondary small">
						Acc√©dez rapidement aux libell√©s officiels enregistr√©s dans votre base.
					</p>
				</div>
			</div>

			<div class="col-md-4">
				<div class="card shadow-sm border-0 rounded-4 p-4 h-100">
					<i class="bi bi-funnel text-primary fs-2 mb-3"></i>
					<h5 class="fw-bold">Filtrage intelligent</h5>
					<p class="text-secondary small">
						Tapez quelques mots pour filtrer instantan√©ment les r√©sultats.
					</p>
				</div>
			</div>

			<div class="col-md-4">
				<div class="card shadow-sm border-0 rounded-4 p-4 h-100">
					<i class="bi bi-shield-check text-primary fs-2 mb-3"></i>
					<h5 class="fw-bold">Donn√©es fiables</h5>
					<p class="text-secondary small">
						Les donn√©es sont issues de votre r√©f√©rentiel officiel.
					</p>
				</div>
			</div>

		</div>
	</div>

	<!-- üì¶ R√âSULTATS -->
	<div id="results"></div>

	 <script>
	document.addEventListener("DOMContentLoaded", () => {
	
	    const input       = document.getElementById("libelleSearch");
	    const results     = document.getElementById("results");
	    const staticIntro = document.getElementById("staticIntro");
	    let timer         = null;
	
	    function renderResults(data) {
	        results.innerHTML = "";
	
	        data.forEach(item => {
	            const card = `
<div class="libelle-card shadow-sm">
	<div class="d-flex justify-content-between align-items-center">

		<div>
			<p class="fw-bold mb-1 text-primary">
				${item.libelle}
			</p>

			<p class="text-secondary small mb-1">
				Code CNOPS :
				<strong>${item.codeCnops}</strong>
				&nbsp;|&nbsp;
				                Code ANAM :
				<strong>${item.codeAnam}</strong>
			</p>
		</div>

		<div class="text-end">
			<span class="badge bg-info px-3 py-2 mb-1 d-inline-block">
				üí∞ ${item.tarif} DH
			</span>
			  

			${
			                item.ap === 'AP'
			                ? `<span class="badge bg-warning text-dark px-3 py-2">
				‚ö†Ô∏è Accord pr√©alable requis
			</span>`
			                : `<span class="badge bg-success px-3 py-2">
				‚úÖ Pas d‚Äôaccord pr√©alable
			</span>`
			            }
		</div>

	</div>
</div>


	            `;
	            results.insertAdjacentHTML("beforeend", card);
	        });
	    }
	
	    input.addEventListener("keyup", () => {
	
	        clearTimeout(timer);
	
	        timer = setTimeout(() => {
	
	            const q = input.value.trim();
	
	            if (q.length < 2) {
	                staticIntro.style.display = "block";
	                results.innerHTML = "";
	                return;
	            }
	
	            staticIntro.style.display = "none";
	
fetch(`/dispositif/search/api?search=${encodeURIComponent(q)}`)

	                .then(res => res.json())
	                .then(data => {
	
	                    if (data.length === 0) {
	                        results.innerHTML = `
	                            <div class="alert alert-warning text-center rounded-4 py-3">
	                                Aucun r√©sultat trouv√©.
	                            </div>`;
	                        return;
	                    }
	
	                    renderResults(data);
	                });
	
	        }, 250);
	    });
	
	});
	</script>

{% endblock %}

