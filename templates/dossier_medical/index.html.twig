{% extends 'base.html.twig' %}

{% block title %}Liste des Dossiers MÃ©dicaux
{% endblock %}

{% block body %}

<div
	class="container-fluid mt-4">

	<!-- ===== HEADER ===== -->
	<div class="card shadow-lg border-0 rounded-4 mb-4">
		<div class="card-body py-4 px-4">

			<div
				class="row align-items-center">

				<!-- TITRE -->
				<div class="col-12 col-md-7 d-flex align-items-center mb-3 mb-md-0">
					<i class="bi bi-folder2-open text-primary fs-1 me-3"></i>
					<div>
						<h2 class="fw-bold text-primary mb-1">Gestion des Dossiers MÃ©dicaux</h2>
						<p class="text-muted mb-0">
							Regroupe les suivis, diagnostics et historique mÃ©dical
						</p>
					</div>
				</div>

				<!-- BOUTONS -->
				<div
					class="col-12 col-md-5 d-flex justify-content-md-end justify-content-center gap-2 flex-wrap">

					<!-- ðŸŸ¦ Bouton Nouveau dossier -->
<button id="addDossierBtn" class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#modalAddDossier">
	<i class="bi bi-folder-plus fs-4"></i>
	Nouveau dossier
</button>



					<!-- Bouton Retour -->
					<a href="{{ path('app_home') }}" class="btn btn-outline-secondary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
						<i class="bi bi-arrow-left"></i>
						Retour
					</a>

				</div>

			</div>
		</div>
	</div>

</div>



{{ include('dossier_medical/_composants/_modal_ajouter_dossier.html.twig') }}



	<!-- ===== TABLEAU ===== -->
	<table id="dossiersTable" class="table table-striped table-hover align-middle rounded-4" style="width:100%">
		<thead class="table-primary text-dark">
			<tr>
				<th>#</th>
				<th>
					<i class="bi bi-bookmark-check"></i>
					Titre</th>
				<th>
					<i class="bi bi-text-paragraph"></i>
					Description</th>
				<th>
					<i class="bi bi-clock"></i>
					CrÃ©Ã©</th>
			
				<th class="text-center">
					<i class="bi bi-gear"></i>
					Actions</th>
			</tr>
		</thead>
		<tbody id="dossiersBody">
			<tr>
				<td colspan="6" class="text-center py-4">
					<div class="spinner-border text-primary" role="status"></div>
					<p class="text-muted mt-2">Chargement des dossiersâ€¦</p>
				</td>
			</tr>
		</tbody>
	</table>


{% endblock %}


{% block javascripts %}
	{{ parent() }}

 <script>
async function getDossier() {

    const tableBody = document.getElementById("dossiersBody");

    try {
const url = "{{ path('api_dossier_medical_by_patient', { id: patient.id }) }}";








        const response = await fetch(url, {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("jwt_token")
            }
        });

        if (!response.ok) {
            tableBody.innerHTML =
                `<tr><td colspan="6" class="text-danger text-center py-3">
                    Erreur API : ${response.status}
                </td></tr>`;
            return;
        }

        const dossiers = await response.json();
        tableBody.innerHTML = "";

        if (dossiers.length === 0) {
            tableBody.innerHTML =
                `<tr><td colspan="6" class="text-muted text-center py-3">
                    Aucun dossier trouvÃ©
                </td></tr>`;
            return;
        }

        dossiers.forEach(d => {
const urlSuivi = "{{ path('app_suivi_par_dossier', { patientId: patient.id, dossierId: '__ID__' }) }}"
	                    .replace('__ID__', d.id);

            const row = `
                <tr>
                    <td class="fw-bold">${d.id}</td>
                    <td class="fw-semibold">${d.titre}</td>
                    <td>${d.description ?? ""}</td>
                    <td class="text-muted">${d.createdAt ?? ""}</td>
                    <td class="text-center">
<a href="${urlSuivi}" class="btn btn-outline-success btn-sm rounded-pill me-2">

	<i class="bi bi-clipboard2-pulse"></i>
</a>

                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML("beforeend", row);
        });

    } catch (error) {
        console.error(error);
        tableBody.innerHTML =
            `<tr><td colspan="6" class="text-danger text-center py-3">
                Erreur lors du chargement.
            </td></tr>`;
    }
}

// ðŸš€ On charge juste une fois au chargement
document.addEventListener("DOMContentLoaded", () => {
    getDossier();
});

// ðŸ”„ Mise Ã  jour toutes les 10 secondes (Ã©vite un spam serveur)
setInterval(getDossier, 10000);
</script>



{% endblock %}

