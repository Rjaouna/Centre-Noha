{% extends 'base.html.twig' %}

{% block title %}Liste des Dossiers M√©dicaux
{% endblock %}

{% block body %}

<div
	class="container-fluid mt-4">

	<!-- ===== HEADER ===== -->
	<div class="card shadow-lg border-0 rounded-4 mb-4">
		<div class="card-body py-4 px-4">

			<div
				class="row align-items-center">

				<!-- TITRE -->
				<div class="col-12 col-md-7 d-flex align-items-center mb-3 mb-md-0">
					<i class="bi bi-folder2-open text-primary fs-1 me-3"></i>
					<div>
						<h2 class="fw-bold text-primary mb-1">Gestion des Dossiers M√©dicaux</h2>
						<p class="text-muted mb-0">
							Regroupe les suivis, diagnostics et historique m√©dical
						</p>
					</div>
				</div>

				<!-- BOUTONS -->
				<div
					class="col-12 col-md-5 d-flex justify-content-md-end justify-content-center gap-2 flex-wrap">

					<!-- üü¶ Bouton Nouveau dossier -->
<button id="addDossierBtn" class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#modalAddDossier">
	<i class="bi bi-folder-plus fs-4"></i>
	Nouveau dossier
</button>



					<!-- Bouton Retour -->
					<a href="{{ path('app_home') }}" class="btn btn-outline-secondary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
						<i class="bi bi-arrow-left"></i>
						Retour
					</a>

				</div>

			</div>
		</div>
	</div>

</div>



{{ include('dossier_medical/_composants/_modal_ajouter_dossier.html.twig') }}


<div
	id="dossiersContainer" class="row g-4"><!-- Le JS va injecter ici les cards -->
</div>




{% endblock %}


{% block javascripts %}
	{{ parent() }}

 <script>
async function getDossier() {

	const container = document.getElementById("dossiersContainer");

	try {
		const url = "{{ path('api_dossier_medical_by_patient', { id: patient.id }) }}";

		const response = await fetch(url, {
			headers: {
				"Authorization": "Bearer " + localStorage.getItem("jwt_token")
			}
		});

		if (!response.ok) {
			container.innerHTML = `
				<div class="col-12 text-center py-4">
					<div class="text-danger fs-4">‚ùå Erreur API : ${response.status}</div>
				</div>
			`;
			return;
		}

		const dossiers = await response.json();
		container.innerHTML = "";

		if (dossiers.length === 0) {
			container.innerHTML = `
				<div class="col-12 text-center py-4">
					<div class="text-muted fs-5">Aucun dossier trouv√©</div>
				</div>
			`;
			return;
		}

		dossiers.forEach(d => {
			
			const urlSuivi = "{{ path('app_suivi_par_dossier', { patientId: patient.id, dossierId: '__ID__' }) }}"
				.replace("__ID__", d.id);

			const card = `
				<div class="col-12 col-md-6 col-lg-4">
					<div class="card shadow-sm border-0 h-100 rounded-4 dossier-card">
						
						<div class="card-body p-4">

							<!-- HEADER -->
							<div class="d-flex align-items-center mb-3">
								<div class="icon-circle bg-primary bg-opacity-10 text-primary me-3">
									<i class="bi bi-clipboard2-pulse fs-3"></i>
								</div>

								<div>
									<h5 class="fw-bold mb-0 text-primary">${d.titre}</h5>
									<p class="text-muted small mb-0">Dossier #${d.id}</p>
								</div>
							</div>

							<!-- DESCRIPTION -->
							<p class="text-muted small mb-3">
								${d.description ?? "Aucune description"}
							</p>

							<!-- DATE -->
							<div class="d-flex align-items-center mb-3">
								<i class="bi bi-clock-history text-secondary me-2"></i>
								<span class="text-secondary small">${d.createdAt}</span>
							</div>

							<!-- ACTION -->
							<div class="text-end">
								<a href="${urlSuivi}" 
								   class="btn btn-outline-success rounded-pill px-4">
									<i class="bi bi-search-heart me-1"></i> Voir le dossier
								</a>
							</div>
						</div>

					</div>
				</div>
			`;

			container.insertAdjacentHTML("beforeend", card);
		});

	} catch (error) {
		console.error(error);
		container.innerHTML = `
			<div class="col-12 text-center py-4 text-danger">
				Erreur lors du chargement
			</div>
		`;
	}
}

document.addEventListener("DOMContentLoaded", getDossier);

// Refresh toutes les 10s
setInterval(getDossier, 10000);
</script>





{% endblock %}

