{% extends 'base.html.twig' %}

{% block title %}Types de radiologie
{% endblock %}

{% block body %}
	<div
		class="container-fluid mt-4">

		{# ================= HEADER ================= #}
		{% embed '_partials/_page_header.html.twig' with {
        icon: 'bi bi-clipboard-data',
        title: 'Types de radiologie',
        subtitle: 'Référentiel des examens radiologiques prescrivables'
    } %}
			{% block header_actions_left %}
				<span class="action-icon bg-primary text-white" role="button" onclick="openModal()" title="Ajouter un type de radio">
					<i class="bi bi-plus-circle"></i>
				</span>
			{% endblock %}
		{% endembed %}

		{# ================= LISTE ================= #}
		<div class="row g-4" id="radioTypeList"></div>

	</div>

	{# ================= MODAL ================= #}
	<div class="modal fade" id="radioTypeModal" tabindex="-1">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<div class="modal-header bg-primary text-white rounded-top-4">
					<h5 class="modal-title fw-bold d-flex align-items-center gap-2">
						<i class="bi bi-clipboard-data"></i>
						Type de radiologie
					</h5>
					<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body p-4">
					<div id="formAlert"></div>

					<input type="hidden" id="radioTypeId">

					<div class="mb-3">
						<label class="form-label fw-bold">Nom *</label>
						<input type="text" id="nom" class="form-control rounded-3">
					</div>

					<div class="mb-3">
						<label class="form-label fw-bold">Zone du corps *</label>
						<input type="text" id="zone_corps" class="form-control rounded-3">
					</div>

					<div class="mb-3">
						<label class="form-label fw-bold">Description *</label>
						<textarea id="description" class="form-control rounded-3" rows="3"></textarea>
					</div>
				</div>

				<div class="modal-footer border-0 px-4 pb-4">
					<button class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">
						Annuler
					</button>
					<button class="btn btn-primary rounded-pill px-4" onclick="saveRadioType()">
						<i class="bi bi-check2-circle me-1"></i>
						Enregistrer
					</button>
				</div>

			</div>
		</div>
	</div>

	{# ================= STYLES ================= #}
	<style>
		.radio-card {
			background: #fff;
			border-radius: 18px;
			padding: 18px;
			border: 1px solid rgba(0, 0, 0, .08);
			box-shadow: 0 10px 26px rgba(0, 0, 0, .06);
			transition: 0.18s ease;
		}
		.radio-card:hover {
			transform: translateY(-3px);
			box-shadow: 0 16px 36px rgba(0, 0, 0, .10);
		}
		.table-actions {
			display: inline-flex;
			gap: 0.4rem;
		}
		.btn-action {
			width: 36px;
			height: 36px;
			border-radius: 12px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			background: #fff;
		}
		.btn-action-primary {
			border: 1px solid rgba(13, 110, 253, .25);
			color: #0d6efd;
		}
		.btn-action-danger {
			border: 1px solid rgba(220, 53, 69, .25);
			color: #dc3545;
		}
	</style>

{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	let modal;
	let currentId = null;
	
	document.addEventListener('DOMContentLoaded', () => {
	    modal = new bootstrap.Modal(document.getElementById('radioTypeModal'));
	    loadRadioTypes();
	});
	
	/* ================= LOAD ================= */
	function loadRadioTypes() {
	    fetch('/api/radio-types')
	        .then(r => r.json())
	        .then(data => {
	            const box = document.getElementById('radioTypeList');
	            box.innerHTML = '';
	
	            if (!data.length) {
	                box.innerHTML = `
	                    <div class="col-12">
	                        <div class="alert alert-info rounded-4 text-center">
	                            Aucun type de radiologie enregistré
	                        </div>
	                    </div>`;
	                return;
	            }
	
	            data.forEach(r => {
	                box.insertAdjacentHTML('beforeend', `
	                    <div class="col-md-6 col-lg-4">
	                        <div class="radio-card h-100">
	                            <div class="d-flex justify-content-between">
	                                <div>
	                                    <h5 class="fw-bold text-primary mb-1">${r.nom}</h5>
	                                    <div class="text-muted small mb-1">
	                                        Zone : <strong>${r.zone_corps}</strong>
	                                    </div>
	                                    <p class="text-muted small mb-0">
	                                        ${r.description}
	                                    </p>
	                                </div>
	                                <div class="table-actions">
	                                    <button class="btn btn-action btn-action-primary"
	                                            onclick="editRadioType(${r.id})">
	                                        <i class="bi bi-pencil"></i>
	                                    </button>
	                                    <button class="btn btn-action btn-action-danger"
	                                            onclick="deleteRadioType(${r.id})">
	                                        <i class="bi bi-trash"></i>
	                                    </button>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                `);
	            });
	        });
	}
	
	/* ================= MODAL ================= */
	function openModal() {
	    currentId = null;
	    document.getElementById('radioTypeId').value = '';
	    document.getElementById('nom').value = '';
	    document.getElementById('zone_corps').value = '';
	    document.getElementById('description').value = '';
	    document.getElementById('formAlert').innerHTML = '';
	    modal.show();
	}
	
	function editRadioType(id) {
	    fetch(`/api/radio-types/${id}`)
	        .then(r => r.json())
	        .then(d => {
	            currentId = id;
	            document.getElementById('nom').value = d.nom;
	            document.getElementById('zone_corps').value = d.zone_corps;
	            document.getElementById('description').value = d.description;
	            modal.show();
	        });
	}
	
	/* ================= SAVE ================= */
	function saveRadioType() {
	    const payload = {
	        nom: nom.value.trim(),
	        zone_corps: zone_corps.value.trim(),
	        description: description.value.trim()
	    };
	
	    if (!payload.nom || !payload.zone_corps || !payload.description) {
	        showError('Tous les champs sont obligatoires.');
	        return;
	    }
	
	    fetch(`/api/radio-types${currentId ? '/' + currentId : ''}`, {
	        method: currentId ? 'PUT' : 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify(payload)
	    })
	    .then(async r => {
	        if (!r.ok) {
	            const err = await r.json();
	            throw err.message;
	        }
	        modal.hide();
	        loadRadioTypes();
	    })
	    .catch(msg => showError(msg));
	}
	
	/* ================= DELETE ================= */
	function deleteRadioType(id) {
	    if (!confirm('Supprimer ce type de radiologie ?')) return;
	
	    fetch(`/api/radio-types/${id}`, { method: 'DELETE' })
	        .then(() => loadRadioTypes());
	}
	
	/* ================= ALERT ================= */
	function showError(msg) {
	    document.getElementById('formAlert').innerHTML = `
	        <div class="alert alert-danger rounded-4">
	            <i class="bi bi-exclamation-triangle-fill me-1"></i>
	            ${msg}
	        </div>`;
	}
	</script>
{% endblock %}

