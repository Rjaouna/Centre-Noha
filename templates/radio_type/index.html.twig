{% extends 'base.html.twig' %}

{% block title %}Types de radiologie
{% endblock %}

{% block body %}
	<div
class="mt-4">


		{# ================= HEADER ================= #}
		{% embed '_partials/_page_header.html.twig' with {
        icon: 'bi bi-clipboard-data',
        title: 'Types de radiologie',
        subtitle: 'Référentiel des examens radiologiques prescrivables'
    } %}
			{% block header_actions_left %}
				<span class="action-icon bg-primary text-white" role="button" onclick="openModal()" title="Ajouter un type de radio">
					<i class="bi bi-plus-circle"></i>
				</span>
			{% endblock %}
		{% endembed %}

		{# ================= LISTE ================= #}
		<div class="row g-4" id="radioTypeList"></div>

	</div>

{# ================= MODAL ================= #}
<div class="modal fade" id="radioTypeModal" tabindex="-1" aria-labelledby="radioTypeModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div
			class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

			{# Header #}
			<div class="modal-header bg-light border-0 px-4 py-3">
				<div class="d-flex align-items-center gap-3">
					<div class="rounded-3 d-inline-flex align-items-center justify-content-center bg-primary text-white" style="width:42px;height:42px;">
						<i class="bi bi-clipboard-data fs-5"></i>
					</div>

					<div class="lh-sm">
						<h5 class="modal-title mb-0 fw-semibold" id="radioTypeModalLabel">Type de radiologie</h5>
						<small class="text-muted">Ajout / modification d’un type</small>
					</div>
				</div>

				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
			</div>

			{# Body #}
			<div class="modal-body px-4 py-4">
				<div id="formAlert" class="mb-3"></div>

				<input type="hidden" id="radioTypeId">

				<div class="row g-3">
					<div class="col-md-6">
						<label class="form-label fw-medium" for="nom">Nom
							<span class="text-danger">*</span>
						</label>
						<div class="input-group">
							<span class="input-group-text bg-white">
								<i class="bi bi-type"></i>
							</span>
							<input type="text" id="nom" class="form-control" placeholder="Ex: Radiographie">
						</div>
					</div>

					<div class="col-md-6">
						<label class="form-label fw-medium" for="zone_corps">Zone du corps
							<span class="text-danger">*</span>
						</label>
						<div class="input-group">
							<span class="input-group-text bg-white">
								<i class="bi bi-bounding-box"></i>
							</span>
							<input type="text" id="zone_corps" class="form-control" placeholder="Ex: Thorax">
						</div>
					</div>

					<div class="col-12">
						<label class="form-label fw-medium" for="description">Description
							<span class="text-danger">*</span>
						</label>
						<div class="input-group">
							<span class="input-group-text bg-white align-items-start pt-2">
								<i class="bi bi-card-text"></i>
							</span>
							<textarea id="description" class="form-control" rows="4" style="resize:none;" placeholder="Détails, indications, remarques..."></textarea>
						</div>
						<div class="form-text">Tu peux mettre une description courte et claire.</div>
					</div>
				</div>
			</div>

			{# Footer #}
			<div class="modal-footer border-0 px-4 pb-4 pt-0 d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
					Annuler
				</button>

				<button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveRadioType()">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


	{# ================= STYLES ================= #}
	<style>
		.radio-card {
			background: #fff;
			border-radius: 18px;
			padding: 18px;
			border: 1px solid rgba(0, 0, 0, .08);
			box-shadow: 0 10px 26px rgba(0, 0, 0, .06);
			transition: 0.18s ease;
		}
		.radio-card:hover {
			transform: translateY(-3px);
			box-shadow: 0 16px 36px rgba(0, 0, 0, .10);
		}
		.table-actions {
			display: inline-flex;
			gap: 0.4rem;
		}
		.btn-action {
			width: 36px;
			height: 36px;
			border-radius: 12px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			background: #fff;
		}
		.btn-action-primary {
			border: 1px solid rgba(13, 110, 253, .25);
			color: #0d6efd;
		}
		.btn-action-danger {
			border: 1px solid rgba(220, 53, 69, .25);
			color: #dc3545;
		}
	</style>

{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	let modal;
	let currentId = null;
	
	document.addEventListener('DOMContentLoaded', () => {
	    modal = new bootstrap.Modal(document.getElementById('radioTypeModal'));
	    loadRadioTypes();
	});
	
	/* ================= LOAD ================= */
	function loadRadioTypes() {
	    fetch('/api/radio-types')
	        .then(r => r.json())
	        .then(data => {
	            const box = document.getElementById('radioTypeList');
	            box.innerHTML = '';
	
	            if (!data.length) {
	                box.innerHTML = `
	                    <div class="col-12">
	                        <div class="alert alert-info rounded-4 text-center">
	                            Aucun type de radiologie enregistré
	                        </div>
	                    </div>`;
	                return;
	            }
	
	            data.forEach(r => {
	                box.insertAdjacentHTML('beforeend', `
	                    <div class="col-md-6 col-lg-4">
	                        <div class="radio-card h-100">
	                            <div class="d-flex justify-content-between">
	                                <div>
	                                    <h5 class="fw-bold text-primary mb-1">${r.nom}</h5>
	                                    <div class="text-muted small mb-1">
	                                        Zone : <strong>${r.zone_corps}</strong>
	                                    </div>
	                                    <p class="text-muted small mb-0">
	                                        ${r.description}
	                                    </p>
	                                </div>
	                                <div class="table-actions">
	                                    <button class="btn btn-action btn-action-primary"
	                                            onclick="editRadioType(${r.id})">
	                                        <i class="bi bi-pencil"></i>
	                                    </button>
	                                    <button class="btn btn-action btn-action-danger"
	                                            onclick="deleteRadioType(${r.id})">
	                                        <i class="bi bi-trash"></i>
	                                    </button>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                `);
	            });
	        });
	}
	
	/* ================= MODAL ================= */
	function openModal() {
	    currentId = null;
	    document.getElementById('radioTypeId').value = '';
	    document.getElementById('nom').value = '';
	    document.getElementById('zone_corps').value = '';
	    document.getElementById('description').value = '';
	    document.getElementById('formAlert').innerHTML = '';
	    modal.show();
	}
	
	function editRadioType(id) {
	    fetch(`/api/radio-types/${id}`)
	        .then(r => r.json())
	        .then(d => {
	            currentId = id;
	            document.getElementById('nom').value = d.nom;
	            document.getElementById('zone_corps').value = d.zone_corps;
	            document.getElementById('description').value = d.description;
	            modal.show();
	        });
	}
	
	/* ================= SAVE ================= */
	function saveRadioType() {
	    const payload = {
	        nom: nom.value.trim(),
	        zone_corps: zone_corps.value.trim(),
	        description: description.value.trim()
	    };
	
	    if (!payload.nom || !payload.zone_corps || !payload.description) {
	        showError('Tous les champs sont obligatoires.');
	        return;
	    }
	
	    fetch(`/api/radio-types${currentId ? '/' + currentId : ''}`, {
	        method: currentId ? 'PUT' : 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify(payload)
	    })
	    .then(async r => {
	        if (!r.ok) {
	            const err = await r.json();
	            throw err.message;
	        }
	        modal.hide();
	        loadRadioTypes();
	    })
	    .catch(msg => showError(msg));
	}
	
	/* ================= DELETE ================= */
	function deleteRadioType(id) {
	    if (!confirm('Supprimer ce type de radiologie ?')) return;
	
	    fetch(`/api/radio-types/${id}`, { method: 'DELETE' })
	        .then(() => loadRadioTypes());
	}
	
	/* ================= ALERT ================= */
	function showError(msg) {
	    document.getElementById('formAlert').innerHTML = `
	        <div class="alert alert-danger rounded-4">
	            <i class="bi bi-exclamation-triangle-fill me-1"></i>
	            ${msg}
	        </div>`;
	}
	</script>
{% endblock %}

