{% extends 'base.html.twig' %}

{% block title %}Paiements du patient
{% endblock %}

{% block body %}

	<div
		class="container-fluid mt-4">

		<!-- HEADER -->
		<div class="card shadow-lg border-0 rounded-4 mb-4">
			<div
				class="card-body d-flex justify-content-between align-items-center py-4 px-4">

				<!-- GAUCHE -->
				<div class="d-flex align-items-center">
					<i class="bi bi-credit-card-2-front-fill text-success fs-1 me-3"></i>
					<div>
						<h2 class="fw-bold text-success mb-1">Paiements du patient</h2>
						<p class="text-muted mb-0">Historique complet des paiements enregistrés</p>
					</div>
				</div>

				<!-- DROITE -->
				<div
					class="d-flex gap-3">

					<!-- Nouveau paiement -->
					<a href="{{ path('app_paiement_new', {'id': patient.id}) }}" class="btn btn-success btn-lg px-4 rounded-pill shadow-sm d-flex align-items-center">
						<i class="bi bi-plus-circle me-2 fs-5"></i>
						Nouveau paiement
					</a>

					<!-- Retour fiche patient -->
					<a href="{{ path('app_fiche_client_show', {'id': patient.id}) }}" class="btn btn-secondary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
						<i class="bi bi-arrow-left"></i>
						Retour fiche patient
					</a>

				</div>

			</div>
		</div>

		<!-- TABLEAU DES PAIEMENTS -->
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-body p-4">

				<table id="paiementTable" class="table table-striped table-hover align-middle rounded-4 overflow-hidden" style="width:100%;">
					<thead class="table-success text-dark">
						<tr>
							<th class="d-none">ID</th>
							<th>
								<i class="bi bi-cash-stack me-1"></i>Prix total</th>
							<th>
								<i class="bi bi-cash me-1"></i>Montant payé</th>
							<th>
								<i class="bi bi-wallet2 me-1"></i>Reste</th>
							<th>
								<i class="bi bi-credit-card me-1"></i>Type</th>
							<th>
								<i class="bi bi-calendar-check me-1"></i>Date</th>
							<th>
								<i class="bi bi-calendar-week me-1"></i>MàJ</th>
							<th class="text-center">
								<i class="bi bi-gear"></i>
								Actions</th>
						</tr>
					</thead>

					<tbody>
						{% for paiement in paiements %}
							<tr id="paiement-row-{{ paiement.id }}">

								<td class="d-none">{{ paiement.id }}</td>

								<td>{{ paiement.prixTotal }}
									DH</td>

								<td class="text-success fw-semibold">{{ paiement.montantPaye }}
									DH</td>

								<td class="text-danger fw-semibold reste-{{ paiement.id }}">
									{{ paiement.reste }}
									DH
								</td>

								<td>
									<span class="badge bg-primary px-3 py-2 rounded-pill">
										{{ paiement.typePaiement }}
									</span>
								</td>

								<td>{{ paiement.createdAt ? paiement.createdAt|date('d/m/Y H:i') }}</td>

								<td>{{ paiement.updatedAt ? paiement.updatedAt|date('d/m/Y H:i') }}</td>

								<td class="text-center">

									<a href="{{ path('app_paiement_show', {'id': paiement.id}) }}" class="btn btn-outline-primary btn-sm rounded-pill px-3 me-2">
										<i class="bi bi-eye"></i>
									</a>

<a href="{{ path('app_paiement_edit', {'id': paiement.id}) }}" class="btn btn-outline-warning btn-sm rounded-pill px-3 me-2">

										<i class="bi bi-pencil-square"></i>
									</a>

									<button class="btn btn-success btn-sm rounded-pill px-3 validatePaiementBtn" data-id="{{ paiement.id }}" data-bs-toggle="modal" data-bs-target="#modalConfirmValidation">
										<i class="bi bi-check2-circle"></i>
									</button>

								</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="8" class="text-center text-muted py-4">
									<i class="bi bi-exclamation-circle me-2"></i>
									Aucun paiement trouvé
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>

			</div>
		</div>

	</div>


	<!-- MODAL CONFIRMATION VALIDATION -->
	<div class="modal fade" id="modalConfirmValidation" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0 shadow-lg rounded-4">

				<div class="modal-header py-4 bg-light">
					<h5 class="modal-title fw-bold text-success">
						<i class="bi bi-shield-check me-2"></i>
						Confirmer la validation
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" tabindex="-1"></button>

				</div>

				<div class="modal-body">
					<p class="fs-5">Voulez-vous valider définitivement ce paiement ?</p>
					<input type="hidden" id="paiementToValidate">
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">
						Annuler
					</button>

					<button class="btn btn-success px-4" id="modalValidateBtn">
						<i class="bi bi-check2-circle me-2"></i>
						Valider
					</button>
				</div>

			</div>
		</div>
	</div>


	<!-- JAVASCRIPT -->
	 <script>
		document.addEventListener("DOMContentLoaded", () => {
		
		
		
			/* CLICK SUR BOUTON VALIDER DANS TABLEAU */
			document.querySelectorAll(".validatePaiementBtn").forEach(btn => {
				btn.addEventListener("click", () => {
					let id = btn.getAttribute("data-id");
					document.getElementById("paiementToValidate").value = id;
				});
			});
		
			/* CONFIRMATION VALIDATION */
			document.getElementById("modalValidateBtn").addEventListener("click", function () {
		
				let id = document.getElementById("paiementToValidate").value;
	
				fetch("/paiement/" + id + "/valider", {
					method: "POST"
				})
				.then(r => r.json())
				.then(data => {
		
					if (data.success) {
		
						// Reste = 0
						document.querySelector(".reste-" + id).innerHTML = "0 DH";
		
						// Ligne verte
						document.getElementById("paiement-row-" + id)
							.classList.add("table-success");
		
						// Désactiver bouton
						document.querySelector('.validatePaiementBtn[data-id="' + id + '"]')
							.disabled = true;
		// Enlève le focus de la croix ou du bouton
	document.activeElement.blur();
	
						// Fermer modal
						let modal = bootstrap.Modal.getInstance(
							document.getElementById('modalConfirmValidation')
						);
						modal.hide();
					}
		
				});
			});
		
		});
		</script>

{% endblock %}

