<div class="modal fade" id="modalEditFiche" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div
			class="modal-content rounded-4 shadow">

			<!-- HEADER -->
			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-pencil-square me-2"></i>
					Modifier la fiche patient
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<!-- BODY -->
			<div class="modal-body">
				<form id="formEditFiche">
					<div
						class="row g-3">

						<!-- NOM -->
						<div class="col-md-6 form-floating">
							<input type="text" class="form-control" name="nom" value="{{ fiche_client.nom }}">
							<label>Nom</label>
						</div>

						<!-- VILLE -->
						<div class="col-md-6 form-floating">
							<input type="text" class="form-control" name="ville" value="{{ fiche_client.ville }}">
							<label>Ville</label>
						</div>

						<!-- TELEPHONE -->
						<div class="col-md-6 form-floating">
							<input type="text" class="form-control" name="telephone" value="{{ fiche_client.telephone }}">
							<label>Téléphone</label>
						</div>

						<!-- POIDS -->
						<div class="col-md-6 form-floating">
							{% set poidsOptions = {
                                '6 - 9 kg': '6-9',
                                '10 - 19 kg': '10-19',
                                '20 - 29 kg': '20-29',
                                '30 - 39 kg': '30-39',
                                '40 - 49 kg': '40-49',
                                '50 - 59 kg': '50-59',
                                '60 - 69 kg': '60-69',
                                '70 - 79 kg': '70-79',
                                '80 - 89 kg': '80-89',
                                '90 - 99 kg': '90-99',
                                '100 - 109 kg': '100-109',
                                '110 - 119 kg': '110-119',
                                '120 - 129 kg': '120-129',
                                '130 - 139 kg': '130-139',
                                '140 - 149 kg': '140-149',
                                '150 kg et +': '150+'
                            } %}

							<select class="form-select" name="poids">
								<option value="">—</option>
								{% for label, value in poidsOptions %}
									<option value="{{ value }}" {% if fiche_client.poids == value %} selected {% endif %}>
										{{ label }}
									</option>
								{% endfor %}
							</select>
							<label>Poids</label>
						</div>

						<!-- DATE NAISSANCE -->
						<div class="col-md-6 form-floating">
							<input type="date" class="form-control" name="dateNaissance" value="{{ fiche_client.dateNaissance ? fiche_client.dateNaissance|date('Y-m-d') : '' }}">
							<label>Date de naissance</label>
						</div>

						<!-- TYPE MALADIE -->
						<div class="col-12 form-floating">
							<input type="text" class="form-control" name="typeMaladie" value="{{ fiche_client.typeMaladie }}">
							<label>Type de maladie</label>
						</div>

						<!-- TRAITEMENT -->
						<div class="col-12 form-floating">
							<textarea class="form-control" name="traitement" style="height:90px">{{ fiche_client.traitement }}</textarea>
							<label>Traitement</label>
						</div>

						<!-- OBSERVATIONS -->
						<div class="col-12 form-floating">
							<textarea class="form-control" name="observation" style="height:90px">{{ fiche_client.observation }}</textarea>
							<label>Observations</label>
						</div>

					</div>
				</form>
			</div>

			<!-- FOOTER -->
			<div class="modal-footer">
				<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
					Annuler
				</button>
				<button class="btn btn-primary rounded-pill" id="btnSaveFiche">
					<i class="bi bi-check-lg"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>

 <script>
document.addEventListener("DOMContentLoaded", () => {

    const btnSave = document.getElementById("btnSaveFiche");
    const form = document.getElementById("formEditFiche");

    btnSave.addEventListener("click", async () => {

        btnSave.disabled = true;
        btnSave.innerHTML = "Enregistrement...";

        const data = Object.fromEntries(new FormData(form));

        try {
            const response = await fetch(
                "{{ path('api_fiche_edit', { id: fiche_client.id }) }}",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                }
            );

            const result = await response.json();

            if (!result.success) {
                alert(result.message || "Erreur lors de la mise à jour");
                btnSave.disabled = false;
                btnSave.innerHTML = "Enregistrer";
                return;
            }

            // ✅ Reload complet (logique simple et fiable)
            window.location.reload();

        } catch (e) {
            alert("Erreur réseau");
            btnSave.disabled = false;
            btnSave.innerHTML = "Enregistrer";
        }
    });

});
</script>

