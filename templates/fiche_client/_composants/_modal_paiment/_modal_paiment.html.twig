<div class="modal fade" id="paiementModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">

			<div class="modal-header bg-success text-white">
				<h5 class="modal-title">
					<i class="bi bi-credit-card-2-front me-2"></i>
					Ajouter un paiement
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>
<div id="paiementError" class="text-danger fw-bold mt-2 d-none"></div>


			<div class="modal-body">

				{{ form_start(formPaiement, { attr: { id: 'formPaiement' } }) }}

				<!-- PRIX TOTAL -->
				<div class="form-floating mb-3">
					{{ form_widget(formPaiement.prixTotal, {
						'attr': { 'class': 'form-control', 'placeholder': 'Prix total' }
					}) }}
					<label for="{{ formPaiement.prixTotal.vars.id }}">Prix total (DH)</label>
				</div>

				<!-- MONTANT PAY√â -->
				<div class="form-floating mb-3">
					{{ form_widget(formPaiement.montantPaye, {
						'attr': { 'class': 'form-control', 'placeholder': 'Montant pay√©' }
					}) }}
					<label for="{{ formPaiement.montantPaye.vars.id }}">Montant pay√© (DH)</label>
				</div>

				<!-- RESTE -->
				<div class="form-floating mb-3">
					{{ form_widget(formPaiement.reste, {
						'attr': { 'class': 'form-control', 'placeholder': 'Reste' }
					}) }}
					<label for="{{ formPaiement.reste.vars.id }}">Reste √† payer (DH)</label>
				</div>

				<!-- TYPE PAIEMENT -->
				<div class="form-floating mb-3">
					{{ form_widget(formPaiement.typePaiement, {
						'attr': { 'class': 'form-select', 'placeholder': 'S√©lectionner le type' }
					}) }}
					<label for="{{ formPaiement.typePaiement.vars.id }}">Type de paiement</label>
				</div>

				{{ form_end(formPaiement) }}

				<div id="paiementErrors" class="alert alert-danger d-none mt-3"></div>

			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					<i class="bi bi-x-lg me-1"></i>
					Fermer
				</button>

				<button type="button" id="submitPaiement" class="btn btn-success">
					<i class="bi bi-check-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>



 <script>
document.addEventListener("DOMContentLoaded", () => {

    const btn    = document.getElementById("submitPaiement");
    const form   = document.getElementById("formPaiement");
    const modal  = new bootstrap.Modal(document.getElementById("paiementModal"));
    const pop    = document.getElementById("popupSuccess");
    const errors = document.getElementById("paiementErrors");

    btn.addEventListener("click", async () => {

        // üîä Son de clic
        buttonSoundClick("submitPaiement");

        // R√©cup√©ration des donn√©es (multipart)
        const formData = new FormData(form);

        const url = "{{ path('ajouter_paiement_ajax', {id: fiche_client.id}) }}";

        // üîÑ Envoi AJAX
        const response = await fetch(url, {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        // ‚ùå ERREURS
        if (!data.success) {
            buttonSoundError("submitPaiement");
            errors.classList.remove("d-none");
            errors.innerHTML = data.errors;
            return;
        }

        // üëç Succ√®s
        buttonSoundSuccess("submitPaiement");
        errors.classList.add("d-none");

        // Fermer modal
        modal.hide();

        // Animation carte paiement
        moveElement("blocListPaiement");

        // Ajouter le paiement dans la table
        ajouterPaiementDansTableau(data.paiement);

        // Afficher popup succ√®s
        pop.style.display = "block";
        pop.innerHTML = `
<div class="d-flex align-items-start">
	<i class="bi bi-check-circle-fill fs-1 text-white bg-success p-2 rounded-circle me-3"></i>

	<div>
		<h5 class="fw-bold mb-1 text-light">
			üéâ Paiement enregistr√© avec succ√®s !
		</h5>

		<p class="text-light mb-1">
			Le paiement a bien √©t√© ajout√© au dossier du patient.
		</p>

		<p class="text-light small opacity-75 mb-0">
			Montant pay√© : <strong>${data.paiement.montant} DH</strong><br>
			Reste : <strong>${data.paiement.reste} DH</strong>
		</p>
	</div>

	<button type="button" class="btn-close" onclick="document.getElementById('popupSuccess').style.display='none';"></button>
</div>
        `;
    });

});


// üìå Insert nouveau paiement dans le tableau
function ajouterPaiementDansTableau(p) {

    const table = document.querySelector('#paiementsTable tbody');

    const newRow = `
        <tr>
            <td>${p.date}</td>
            <td class="text-success fw-semibold">${p.montant} DH</td>
            <td class="text-danger fw-semibold">${p.reste} DH</td>
            <td>
                <span class="badge bg-primary px-3 py-2 rounded-pill">
                    ${p.type}
                </span>
            </td>
        </tr>
    `;

    table.insertAdjacentHTML("afterbegin", newRow);
}

function calculePaiment(){
const prixTotalInput = document.getElementById('paiement_prixTotal');
const montantPayeInput = document.getElementById('paiement_montantPaye');
const resteInput = document.getElementById('paiement_reste');
const errorDiv = document.getElementById('paiementError');





// üü¢ Fonction de calcul automatique
function updateReste() {
    const total = parseFloat(prixTotalInput.value) || 0;
    const paye = parseFloat(montantPayeInput.value) || 0;

    // Remet l'erreur √† z√©ro
    errorDiv.classList.add("d-none");
    errorDiv.innerHTML = "";
    montantPayeInput.classList.remove("is-invalid");

    // Si total vide ‚Üí bloque Montant pay√©
    if (total <= 0) {
        montantPayeInput.value = "";
        montantPayeInput.disabled = true;
        resteInput.value = "";
        return;
    } else {
        montantPayeInput.disabled = false;
    }

    // Erreur si montant pay√© > total
    if (paye > total) {
        errorDiv.innerHTML = "‚ö† Le montant pay√© ne peut pas d√©passer le prix total.";
        errorDiv.classList.remove("d-none");
        montantPayeInput.classList.add("is-invalid");
        resteInput.value = "";
        return;
    }

    // Calcul du reste
    const reste = total - paye;
    resteInput.value = reste.toFixed(2);
}

// üéØ √âv√©nements
prixTotalInput.addEventListener("input", updateReste);
montantPayeInput.addEventListener("input", updateReste);



}
calculePaiment()

</script>



