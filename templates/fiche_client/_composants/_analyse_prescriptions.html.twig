<div class="row g-3">
	{% for p in prescriptions %}
		<div class="col-12 col-sm-6 col-lg-3" id="prescription-{{ p.id }}">
			<div
				class="card shadow-sm border-0 rounded-4 h-100 position-relative">

				<!-- ðŸ—‘ï¸ DELETE ICON -->
				<button class="btn btn-sm btn-outline-danger rounded-circle position-absolute top-0 end-0 m-2 btn-delete-prescription" data-id="{{ p.id }}" title="Supprimer la prescription">
					<i class="bi bi-trash"></i>
				</button>

				<div
					class="card-body p-3 d-flex flex-column justify-content-between">

					<!-- DATE + STATUT -->
					<div class="mb-2">
						<div class="fw-bold text-primary small">
							{{ p.prescribedAt|date('d/m/Y') }}
						</div>

						{% set statusMap = {
                        'prescrite': 'warning',
                        'en_cours': 'info',
                        'recue': 'success'
                    } %}

						<span class="badge bg-{{ statusMap[p.status]|default('secondary') }} mt-1">
							{{ p.status|capitalize }}
						</span>
					</div>

					<!-- ANALYSES -->
					<div class="mb-2">
						{% for a in p.analyses %}
							<span class="badge bg-info text-dark me-1 mb-1">
								{{ a.name }}
							</span>
						{% endfor %}
					</div>

					<!-- COMMENTAIRE -->
					{% if p.comment %}
						<div class="text-muted small mb-2">
							{{ p.comment }}
						</div>
					{% endif %}
<!-- COMPTE RENDU -->
<!-- COMPTE RENDU -->
	{% if p.compteRendu %}
		<div class="text-muted small mb-2 d-flex align-items-start gap-2"> <div>
			{{ p.compteRendu }}
		</div>

		<button class="btn btn-sm btn-link p-0 btnEditCompteRendu" data-id="{{ p.id }}" data-text="{{ p.compteRendu|e('html_attr') }}" title="Modifier le compte rendu">
			<i class="bi bi-pencil-square text-primary"></i>
		</button>
	</div>
{% else %}
	<div class="text-muted small mb-2">
		<em>En attente de compte rendu disponible.</em>
<button class="btn btn-sm btn-link btnAddCompteRendu" data-id="{{ p.id }}">


			Ajouter un compte rendu
		</button>
	</div>
{% endif %}



					<!-- ACTION -->
					<div class="text-end mt-auto">
						<a href="{{ path('analyse_prescription_pdf', {id: p.id}) }}" class="btn btn-sm btn-link  rounded-pill d-inline-flex align-items-center gap-1">
<i class="bi bi-file-earmark-pdf link-danger fs-4"></i>

						</a>
					</div>

				</div>
			</div>
		</div>
	{% else %}
		<div class="col-12 text-muted small">
			Aucune analyse prescrite.
		</div>
	{% endfor %}
</div>
<div class="modal fade" id="modalCompteRendu" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content rounded-4">

			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-file-earmark-medical"></i>
					Compte rendu dâ€™analyse
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<input type="hidden" id="compteRenduPrescriptionId">

				<label class="fw-bold mb-2">
					Compte rendu du laboratoire
				</label>

				<textarea id="compteRenduText" class="form-control" rows="6" placeholder="Saisir le compte renduâ€¦"></textarea>

				<div id="compteRenduError" class="alert alert-danger mt-3 d-none"></div>

			</div>

			<div class="modal-footer">
				<button id="saveCompteRendu" class="btn btn-success rounded-pill px-4">
					<i class="bi bi-check-lg"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>
 <script>
document.addEventListener('DOMContentLoaded', () => {

    const modalEl = document.getElementById('modalCompteRendu');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

    const inputId   = document.getElementById('compteRenduPrescriptionId');
    const textarea  = document.getElementById('compteRenduText');
    const errorBox  = document.getElementById('compteRenduError');

    function resetModal() {
        textarea.value = '';
        errorBox.classList.add('d-none');
        errorBox.textContent = '';
    }

    async function reloadAnalysePrescriptions() {
        const container = document.getElementById('analysePrescriptionsContainer');
        const patientId = container.dataset.patientId;

        const res = await fetch(`/api/patient/${patientId}/analyse-prescriptions`);
        container.innerHTML = await res.text();
    }

    // AJOUT
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.btnAddCompteRendu');
        if (!btn) return;

        resetModal();
        inputId.value = btn.dataset.id;
        modal.show();
    });

    // MODIFICATION
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.btnEditCompteRendu');
        if (!btn) return;

        resetModal();
        inputId.value = btn.dataset.id;
        textarea.value = btn.dataset.text;
        modal.show();
    });

    // SAVE
    document.getElementById('saveCompteRendu').addEventListener('click', async () => {

        const id = inputId.value;
        const text = textarea.value.trim();

        if (!text) {
            errorBox.textContent = 'Le compte rendu ne peut pas Ãªtre vide.';
            errorBox.classList.remove('d-none');
            return;
        }

        const res = await fetch(`/api/analyse-prescription/${id}/compte-rendu`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compteRendu: text })
        });

        const data = await res.json();

        if (!data.success) {
            errorBox.textContent = data.message || 'Erreur serveur';
            errorBox.classList.remove('d-none');
            return;
        }

        modal.hide();

        modalEl.addEventListener('hidden.bs.modal', async () => {
            await reloadAnalysePrescriptions();
        }, { once: true });
    });

    // BACKDROP CLEAN (sÃ©curitÃ© ultime)
    modalEl.addEventListener('hidden.bs.modal', () => {
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    });

    // DELETE
    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.btn-delete-prescription');
        if (!btn) return;

        if (!confirm("Supprimer cette prescription dâ€™analyses ?")) return;

        await fetch(`/api/analyse-prescription/${btn.dataset.id}`, {
            method: 'DELETE',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        await reloadAnalysePrescriptions();
    });

});
</script>

