{% if prescriptions is empty %}
	<div class="alert alert-light rounded-4 text-center py-4">
		<div class="fw-bold mb-1">Aucune analyse prescrite</div>
		<div class="text-muted">Prescris une analyse pour l’ajouter à l’historique du patient.</div>
	</div>
{% else %}
	<div class="vstack gap-3">
		{% for p in prescriptions %}
			<div class="rad-card">

				<div class="d-flex justify-content-between align-items-start gap-2">
					<div class="flex-grow-1">

						<div class="d-flex align-items-center gap-2 mb-1">
							<div class="fw-bold">
								<i class="bi bi-flask text-success me-1"></i>
								Analyse biologique
							</div>

							{% set statusMap = {
								'prescrite': 'warning',
								'en_cours': 'info',
								'recue': 'success'
							} %}

							<span class="rad-badge bg-{{ statusMap[p.status]|default('secondary') }}">
								{{ p.status|capitalize }}
							</span>

							<span class="text-muted small ms-auto">
								{{ p.prescribedAt|date('d/m/Y') }}
							</span>
						</div>

						<div class="mb-2">
							{% for a in p.analyses %}
								<span class="badge bg-success-subtle text-success me-1 mb-1">
									{{ a.name }}
								</span>
							{% endfor %}
						</div>

						{% if p.comment %}
							<div class="text-muted small mb-2">
								<strong>Commentaire :</strong>
								{{ p.comment }}
							</div>
						{% endif %}

						{% if p.compteRendu %}
							<div class="text-muted small">
								<i class="bi bi-clipboard-check me-1"></i>
								{{ p.compteRendu }}
							</div>
						{% else %}
							<div class="text-muted small fst-italic">
								En attente de compte rendu.
							</div>
						{% endif %}
					</div>

					<!-- ✅ ACTIONS COMME RADIOLOGIE -->
					<div class="table-actions">

						<button class="btn btn-action btn-action-primary" title="Voir la prescription" onclick="window.open('{{ path('analyse_prescription_pdf', {id: p.id}) }}','_blank')">
							<i class="bi bi-file-earmark-text"></i>
						</button>

						<button class="btn btn-action btn-action-success {{ p.compteRendu ? 'btnEditCompteRendu' : 'btnAddCompteRendu' }}" title="{{ p.compteRendu ? 'Modifier le résultat' : 'Ajouter un résultat' }}" data-id="{{ p.id }}" {% if p.compteRendu %} data-text="{{ p.compteRendu|e('html_attr') }}" {% endif %}>
							<i class="bi {{ p.compteRendu ? 'bi-pencil-square' : 'bi-clipboard-plus' }}"></i>
						</button>

						<button class="btn btn-action btn-action-danger btn-delete-prescription" title="Supprimer" data-id="{{ p.id }}">
							<i class="bi bi-trash"></i>
						</button>

					</div>
				</div>
			</div>
		{% endfor %}
	</div>
{% endif %}



<div class="modal fade" id="modalCompteRendu" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content rounded-4">

			<div class="modal-header bg-success text-white">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-file-earmark-medical me-2"></i>
					Compte rendu d’analyse
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">
				<input type="hidden" id="compteRenduPrescriptionId">

				<label class="fw-bold mb-2">Compte rendu</label>
				<textarea id="compteRenduText" class="form-control" rows="6"></textarea>

				<div id="compteRenduError" class="alert alert-danger mt-3 d-none"></div>
			</div>

			<div class="modal-footer">
				<button id="saveCompteRendu" class="btn btn-success rounded-pill px-4">
					<i class="bi bi-check-lg"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>

 <script>
document.addEventListener('DOMContentLoaded', () => {

	const modalEl = document.getElementById('modalCompteRendu');
	const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

	const inputId  = document.getElementById('compteRenduPrescriptionId');
	const textarea = document.getElementById('compteRenduText');
	const errorBox = document.getElementById('compteRenduError');

	async function reloadAnalysePrescriptions() {
		const container = document.getElementById('analysePrescriptionsContainer');
		const patientId = container.dataset.patientId;
		const res = await fetch(`/api/patient/${patientId}/analyse-prescriptions`);
		container.innerHTML = await res.text();
	}

	document.addEventListener('click', e => {
		const addBtn = e.target.closest('.btnAddCompteRendu');
		const editBtn = e.target.closest('.btnEditCompteRendu');

		if (addBtn || editBtn) {
			inputId.value = (addBtn || editBtn).dataset.id;
			textarea.value = editBtn ? editBtn.dataset.text : '';
			errorBox.classList.add('d-none');
			modal.show();
		}
	});

	document.getElementById('saveCompteRendu').addEventListener('click', async () => {
		if (!textarea.value.trim()) {
			errorBox.textContent = 'Le compte rendu est obligatoire.';
			errorBox.classList.remove('d-none');
			return;
		}

		await fetch(`/api/analyse-prescription/${inputId.value}/compte-rendu`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ compteRendu: textarea.value })
		});

		modal.hide();
		await reloadAnalysePrescriptions();
	});

	document.addEventListener('click', async e => {
		const btn = e.target.closest('.btn-delete-prescription');
		if (!btn || !confirm('Supprimer cette prescription ?')) return;

		await fetch(`/api/analyse-prescription/${btn.dataset.id}`, { method: 'DELETE' });
		await reloadAnalysePrescriptions();
	});

});
</script>

