{# ===================== MODAL : CHOISIR CERTIFICAT ===================== #}
<div class="modal fade" id="certificatPrintModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div
			class="modal-content rounded-4 shadow-lg border-0">

			{# HEADER #}
			<div class="modal-header bg-primary text-white rounded-top-4 border-0">
				<div class="d-flex align-items-center gap-2">
					<div class="doc-head-icon">
						<i class="bi bi-file-medical"></i>
					</div>
					<div>
						<h5 class="modal-title fw-bold mb-0">Certificat médical</h5>
						<small class="text-white-50">Choisissez un modèle à imprimer</small>
					</div>
				</div>

				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
			</div>

			{# BODY #}
			<div
				class="modal-body p-4">

				{# Zone dynamique (loading -> list -> empty/error) #}
				<div
					id="certificat-modal-body">

					{# Loading par défaut (même vibe) #}
					<div class="text-center py-4">
						<div class="spinner-border text-primary"></div>
						<p class="mt-2 text-secondary mb-0">Chargement des certificats…</p>
					</div>

				</div>

				<hr class="my-4">

				<div class="d-flex justify-content-end">
					<button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">
						Fermer
					</button>
				</div>

			</div>

		</div>
	</div>
</div>

<style>
	/* ===== Header icon (même que Documents médicaux) ===== */
	.doc-head-icon {
		width: 42px;
		height: 42px;
		border-radius: 14px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		background: rgba(255, 255, 255, .16);
		box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .18);
		font-size: 1.25rem;
	}

	/* ===== Actions layout ===== */
	.doc-grid {
		display: grid;
		gap: 12px;
	}

	/* ===== Action card button ===== */
	.doc-action {
		width: 100%;
		border: 0;
		border-radius: 18px;
		padding: 14px;
		display: flex;
		align-items: center;
		gap: 12px;
		text-align: left;
		background: #fff;
		box-shadow: 0 10px 26px rgba(0, 0, 0, .06);
		transition: 0.18s ease;
	}
	.doc-action:hover {
		transform: translateY(-2px);
		box-shadow: 0 18px 40px rgba(0, 0, 0, .10);
	}
	.doc-action:active {
		transform: translateY(0);
		box-shadow: 0 10px 26px rgba(0, 0, 0, .06);
	}

	/* ===== Icon block ===== */
	.doc-action-icon {
		width: 48px;
		height: 48px;
		border-radius: 16px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-size: 1.35rem;
		flex: 0 0 auto;
	}

	/* ===== Text ===== */
	.doc-action-text {
		flex: 1;
		min-width: 0;
	}
	.doc-action-title {
		font-weight: 800;
		font-size: 1rem;
		line-height: 1.1;
		color: #111827;
	}
	.doc-action-subtitle {
		font-size: 0.85rem;
		color: #6b7280;
		margin-top: 2px;
	}

	/* ===== Arrow / right icon ===== */
	.doc-action-arrow {
		width: 34px;
		height: 34px;
		border-radius: 12px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		background: rgba(0, 0, 0, .04);
		color: #6b7280;
		flex: 0 0 auto;
	}

	/* ===== Variants ===== */
	.doc-action-primary {
		border: 1px solid rgba(13, 110, 253, .16);
	}
	.doc-action-primary .doc-action-icon {
		background: rgba(13, 110, 253, .10);
		color: #0d6efd;
	}
	.doc-action-primary:hover {
		border-color: rgba(13, 110, 253, .26);
	}

	/* Empty / error */
	.doc-action-muted {
		border: 1px solid rgba(0, 0, 0, .08);
	}
	.doc-action-muted .doc-action-icon {
		background: rgba(13, 110, 253, .08);
		color: #0d6efd;
	}

	@media(max-width:576px) {
		.doc-action {
			padding: 14px 12px;
		}
		.doc-action-title {
			font-size: 0.98rem;
		}
	}
</style>

 <script>
let certificatModal;

document.addEventListener('DOMContentLoaded', () => {
	const el = document.getElementById('certificatPrintModal');
	certificatModal = new bootstrap.Modal(el);
});

function openCertificatModal(patientId) {
	certificatModal.show();

	// loading (design propre)
	document.getElementById('certificat-modal-body').innerHTML = `
		<div class="text-center py-4">
			<div class="spinner-border text-primary"></div>
			<p class="mt-2 text-secondary mb-0">Chargement des certificats…</p>
		</div>
	`;

	fetch('/certificats/certificats/ajax/list')
		.then(res => res.json())
		.then(data => renderCertificatList(data, patientId))
		.catch(() => {
			document.getElementById('certificat-modal-body').innerHTML = `
				<div class="doc-grid">
					<div class="doc-action doc-action-muted">
						<div class="doc-action-icon">
							<i class="bi bi-exclamation-triangle"></i>
						</div>
						<div class="doc-action-text">
							<div class="doc-action-title">Erreur de chargement</div>
							<div class="doc-action-subtitle">Impossible de récupérer les certificats</div>
						</div>
						<div class="doc-action-arrow">
							<i class="bi bi-x"></i>
						</div>
					</div>
				</div>
			`;
		});
}

function renderCertificatList(certificats, patientId) {
	if (!certificats || certificats.length === 0) {
		document.getElementById('certificat-modal-body').innerHTML = `
			<div class="doc-grid">
				<div class="doc-action doc-action-muted">
					<div class="doc-action-icon">
						<i class="bi bi-folder-x"></i>
					</div>
					<div class="doc-action-text">
						<div class="doc-action-title">Aucun certificat disponible</div>
						<div class="doc-action-subtitle">Créez d’abord un modèle de certificat</div>
					</div>
					<div class="doc-action-arrow">
						<i class="bi bi-dash"></i>
					</div>
				</div>
			</div>
		`;
		return;
	}

	let html = `<div class="doc-grid">`;

	certificats.forEach(cert => {
		html += `
			<button type="button"
				class="doc-action doc-action-primary"
				onclick="printCertificat(${patientId}, ${cert.id})">

				<div class="doc-action-icon">
					<i class="bi bi-file-medical"></i>
				</div>

				<div class="doc-action-text">
					<div class="doc-action-title">${escapeHtml(cert.titre)}</div>
					<div class="doc-action-subtitle">Imprimer ce certificat pour le patient</div>
				</div>

				<div class="doc-action-arrow" title="Imprimer">
					<i class="bi bi-printer"></i>
				</div>
			</button>
		`;
	});

	html += `</div>`;
	document.getElementById('certificat-modal-body').innerHTML = html;
}

function printCertificat(patientId, certificatId) {
	const url = `/certificats/print/patient/${patientId}/${certificatId}`;
	window.open(url, '_blank');
}

/* Sécurise l’affichage (évite injection si titre contient des caractères spéciaux) */
function escapeHtml(str) {
	if (str === null || str === undefined) return '';
	return String(str)
		.replaceAll('&', '&amp;')
		.replaceAll('<', '&lt;')
		.replaceAll('>', '&gt;')
		.replaceAll('"', '&quot;')
		.replaceAll("'", '&#039;');
}
</script>

