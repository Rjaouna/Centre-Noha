<div class="container-fluid card shadow-lg border-0 rounded-4 mb-4 py-3">

	<div class="d-flex justify-content-between align-items-center">
		<h3 class="text-dark fw-bold mb-3 d-flex align-items-center">
			<i class="bi bi-credit-card-2-back me-2"></i>
			Historique des paiements
		</h3>

		<span class="badge bg-light text-primary fs-6">
			{{ fiche_client.paiements|length }}
			paiement(s)
		</span>
	</div>

	<div class="card-body p-0">
		<div class="table-responsive">
			<table class="table table-hover mb-0" id="paiementsTable">
				<thead class="table-light">
					<tr>
						<th class="text-center">Date création</th>
						<th class="text-center">Dernière MAJ</th>
						<th class="text-center">Montant payé</th>
						<th class="text-center">Reste</th>
						<th class="text-center">Type</th>
						<th class="text-center">Créé par</th>
						<th class="text-center">Modifié par</th>
						<th class="text-center">Actions</th>
					</tr>
				</thead>

				<tbody>
					{% for p in fiche_client.paiements %}
<tr id="paiement-row-{{ p.id }}" {% if p.reste == 0 %} class="table-validated" {% endif %}></tr>


							<td class="text-center fw-semibold">{{ p.createdAt|date('d/m/Y H:i') }}</td>

							<td class="text-center text-secondary">
								{% if p.updatedAt %}
									{{ p.updatedAt|date('d/m/Y H:i') }}
								{% else %}
									—
								{% endif %}
							</td>

							<td class="text-center text-success fw-bold">
								{{ p.montantPaye }}
								DH
							</td>

							<td class="text-center text-danger fw-semibold reste-{{ p.id }}">
								{{ p.reste }}
								DH
							</td>

							<td class="text-center">
								<span class="badge bg-info text-dark px-3 py-2">
									{{ p.typePaiement|capitalize }}
								</span>
							</td>

							<td class="text-center">
								{{ p.createdBy ? p.createdBy.email : '—' }}
							</td>

							<td class="text-center">
								{{ p.updatedBy ? p.updatedBy.email : '—' }}
							</td>

							<td class="text-center">

								<button class="btn btn-sm btn-success validatePaiementBtn" data-id="{{ p.id }}" {% if p.reste == 0 %} disabled {% endif %}>
									<i class="bi bi-check2-circle"></i>
								</button>

							</td>
						</tr>
					{% endfor %}
				</tbody>

			</table>
		</div>
	</div>
</div>


<!-- ===========================
      MODAL CONFIRM VALIDATION
=========================== -->
<div class="modal fade" id="modalConfirmValidation" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg rounded-4">

			<div class="modal-header py-4" style="background: #f5faf7;">
				<h5 class="modal-title fw-bold text-success">
					<i class="bi bi-shield-check me-2"></i>
					Confirmation de paiement
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body px-4 pb-4 pt-3">

				<div class="alert alert-light border-start border-4 shadow-sm" style="border-color:#4caf50 !important;">

					<p class="mb-2 fs-5">
						Vous êtes sur le point de
						<strong>valider définitivement</strong>
						ce paiement.
					</p>

					<ul class="mb-1 text-muted">
						<li>Le
							<strong>reste dû</strong>
							sera automatiquement réglé</li>
						<li>Le paiement deviendra
							<strong>soldé</strong>
						</li>
						<li>Aucune modification ne sera possible</li>
					</ul>
				</div>

				<p class="mt-3 text-danger fw-semibold">
					Confirmez-vous cette action ?
				</p>

				<input type="hidden" id="paiementToValidate">
			</div>

			<div class="modal-footer p-3">
				<button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
					<i class="bi bi-x-circle me-1"></i>
					Annuler
				</button>

				<button class="btn btn-success px-4" id="confirmValidateBtn" style="background:#4caf50; border-color:#4caf50;">
					<i class="bi bi-check2-circle me-2"></i>Valider
				</button>
			</div>

		</div>
	</div>
</div>



<!-- ===========================
      JAVASCRIPT VALIDATION
=========================== -->
 <script>

/* OUVRIR LE MODAL DE CONFIRMATION */
document.querySelectorAll('.validatePaiementBtn').forEach(btn => {
	btn.addEventListener('click', function () {

		let id = this.dataset.id;

		document.getElementById('paiementToValidate').value = id;

		let modal = new bootstrap.Modal(document.getElementById('modalConfirmValidation'));
		modal.show();
	});
});


/* CONFIRMER LA VALIDATION */
document.getElementById('confirmValidateBtn').addEventListener('click', function () {

	let id = document.getElementById('paiementToValidate').value;

	fetch("/paiement/" + id + "/valider", {
		method: "POST"
	})
	.then(r => r.json())
	.then(data => {

		if (data.success) {

			// mettre reste à 0
			document.querySelector('.reste-' + id).innerHTML = "0 DH";

			// ligne colorée
document.getElementById('paiement-row-' + id).classList.add("table-validated");


			// désactiver bouton
			document.querySelector('.validatePaiementBtn[data-id="' + id + '"]').disabled = true;

			// fermer le modal
			let modal = bootstrap.Modal.getInstance(
				document.getElementById('modalConfirmValidation')
			);
			modal.hide();
		}
	});
});

</script>

<style>
.table-validated {
    background-color: #dff5e1 !important; /* vert clair apaisant */
}
</style>