<style>
	.pill {
		display: inline-flex;
		align-items: center;
		gap: 10px;
		padding: 8px 12px;
		border-radius: 999px;
		background: rgba(25, 135, 84, 0.08);
		border: 1px solid rgba(25, 135, 84, 0.25);
		font-weight: 800;
	}

	.pill .x {
		width: 26px;
		height: 26px;
		border-radius: 10px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		background: #fff;
		border: 1px solid rgba(0, 0, 0, 0.08);
		cursor: pointer;
	}
</style>

{# =================== MODAL ANALYSE: PRESCRIPTION =================== #}
<div class="modal fade" id="modalAnalysePrescription" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
		<div class="modal-content rounded-4 shadow">

			<div class="modal-header bg-success text-white rounded-top-4">
				<h5 class="modal-title fw-bold d-flex align-items-center gap-2">
					<i class="bi bi-clipboard-pulse"></i>
					Prescrire des analyses
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div
				class="modal-body p-3 p-md-4">

				{# Recherche #}
				<div class="card border-0 shadow-sm rounded-4 mb-3">
					<div class="card-header bg-light fw-bold rounded-top-4 d-flex align-items-center gap-2">
						<i class="bi bi-search text-success"></i>
						Recherche d’analyses
					</div>
					<div class="card-body">
						<input id="analyseSearch" class="form-control rounded-3 mb-2" placeholder="Tapez au moins 2 caractères (NFS, CRP, glycémie…)">

						<div id="analyseResults" class="list-group rounded-4"></div>
					</div>
				</div>

				{# Sélection #}
				<div class="card border-0 shadow-sm rounded-4 mb-3">
					<div class="card-header bg-light fw-bold rounded-top-4">
						Analyses sélectionnées
					</div>
					<div class="card-body">
						<div id="selectedAnalyses" class="d-flex flex-wrap gap-2"></div>
						<small class="text-muted d-block mt-2">
							Astuce : clique sur la ✕ pour retirer une analyse.
						</small>
					</div>
				</div>

				{# Commentaire #}
				<div class="card border-0 shadow-sm rounded-4">
					<div class="card-header bg-light fw-bold rounded-top-4 d-flex align-items-center gap-2">
						<i class="bi bi-chat-left-text text-success"></i>
						Commentaire
					</div>
					<div class="card-body">
						<textarea id="analyseComment" class="form-control rounded-3" rows="3" placeholder="Commentaire ou précision clinique (optionnel)…"></textarea>
					</div>
				</div>

				<div id="analyseError" class="mt-3"></div>
			</div>

			<div class="modal-footer border-0 px-4 pb-4 pt-0">
				<button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">
					Annuler
				</button>
				<button class="btn btn-success rounded-pill px-4" id="saveAnalysePrescription">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>



 <script>
document.addEventListener('DOMContentLoaded', () => {

    let selectedAnalyses = [];
    const input = document.getElementById('analyseSearch');
    const results = document.getElementById('analyseResults');
    const selectedUl = document.getElementById('selectedAnalyses');
    const errorBox = document.getElementById('analyseError');

    function showError(msg) {
        errorBox.textContent = msg;
        errorBox.classList.remove('d-none');
    }
    function hideError() {
        errorBox.classList.add('d-none');
        errorBox.textContent = '';
    }

    input.addEventListener('keyup', async (e) => {
        hideError();
        const q = e.target.value.trim();

        if (q.length < 2) {
            results.innerHTML = '';
            return;
        }

        try {
            const res = await fetch(`/api/analyse/search?q=${encodeURIComponent(q)}`);
            if (!res.ok) throw new Error('HTTP ' + res.status);

            const data = await res.json();
            results.innerHTML = '';

            data.forEach(a => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = a.name;

                item.onclick = () => addAnalyse(a);
                results.appendChild(item);
            });
        } catch (err) {
            showError("Erreur recherche analyses : " + err.message);
        }
    });

    function addAnalyse(analyse) {
        if (selectedAnalyses.find(x => x.id === analyse.id)) return;

        selectedAnalyses.push({ id: analyse.id, name: analyse.name });
        renderSelectedAnalyses();
        results.innerHTML = '';
        input.value = '';
        input.focus();
    }

    function renderSelectedAnalyses() {
        selectedUl.innerHTML = '';

        selectedAnalyses.forEach(a => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';

            li.innerHTML = `
                <span class="fw-semibold text-primary">${a.name}</span>
                <button type="button" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;

            li.querySelector('button').onclick = () => {
                selectedAnalyses = selectedAnalyses.filter(x => x.id !== a.id);
                renderSelectedAnalyses();
            };

            selectedUl.appendChild(li);
        });
    }

    document.getElementById('saveAnalysePrescription').addEventListener('click', async () => {
        hideError();

        if (selectedAnalyses.length === 0) {
            showError("Veuillez sélectionner au moins une analyse.");
            return;
        }

        const payload = {
            patient: {{ fiche_client.id }},
            analyses: selectedAnalyses,
            comment: document.getElementById('analyseComment').value
        };

        try {
            const res = await fetch('/api/analyse/prescription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('HTTP ' + res.status);

            const data = await res.json();
            if (data.success) {
               if (data.success) {

    // Fermer le modal
    bootstrap.Modal
        .getInstance(document.getElementById('modalAnalysePrescription'))
        .hide();

    // Recharger le bloc analyses prescrites
    const container = document.getElementById('analysePrescriptionsContainer');

    const res2 = await fetch(
        `/api/patient/{{ fiche_client.id }}/analyse-prescriptions`
    );
    container.innerHTML = await res2.text();

    // Reset formulaire
    selectedAnalyses = [];
    renderSelectedAnalyses();
    document.getElementById('analyseComment').value = '';
}

            } else {
                showError(data.message || "Erreur lors de l'enregistrement.");
            }
        } catch (err) {
            showError("Erreur sauvegarde : " + err.message);
        }
    });

});
</script>

