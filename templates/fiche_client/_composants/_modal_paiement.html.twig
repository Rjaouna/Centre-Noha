<div class="modal fade" id="paiementModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
		<div
			class="modal-content rounded-4 shadow">

			{# HEADER #}
			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold d-flex align-items-center gap-2">
					<i class="bi bi-cash-coin"></i>
					<span id="paiementModalTitle">Ajouter un paiement</span>
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			{# BODY #}
			<div class="modal-body p-3 p-md-4">

				<input type="hidden" id="paiementId">

				<div class="card border-0 shadow-sm rounded-4">
					<div class="card-header bg-light fw-bold rounded-top-4 d-flex align-items-center gap-2">
						<i class="bi bi-receipt text-primary"></i>
						Détails du paiement
					</div>

					<div class="card-body">

						<div class="row g-3">
							<div class="col-md-4">
								<label class="fw-bold mb-1">Montant total *</label>
								<input type="number" step="0.01" min="0" class="form-control rounded-3" id="prixTotal">
							</div>

							<div class="col-md-4">
								<label class="fw-bold mb-1">Montant payé *</label>
								<input type="number" step="0.01" min="0" class="form-control rounded-3" id="montantPaye">
							</div>

							<div class="col-md-4">
								<label class="fw-bold mb-1">Reste</label>
								<input type="text" class="form-control rounded-3 bg-light" id="resteCalc" disabled>
							</div>

							<div class="col-md-6">
								<label class="fw-bold mb-1">Type de paiement *</label>
								<select class="form-select rounded-3" id="typePaiement">
									<option value="">— Choisir —</option>
									<option value="espece">Espèces</option>
									<option value="carte">Carte</option>
									<option value="virement">Virement</option>
									<option value="cheque">Chèque</option>
								</select>
							</div>
						</div>

					</div>
				</div>

				<div id="paiementError" class="alert alert-danger rounded-4 mt-3 d-none"></div>

			</div>

			{# FOOTER #}
			<div class="modal-footer border-0 px-4 pb-4 pt-0">
				<button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">
					Annuler
				</button>

				<button class="btn btn-primary rounded-pill px-4" id="btnSavePaiement">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>



 <script>
document.addEventListener('DOMContentLoaded', () => {

    const clientId = {{ fiche_client.id }};
    const modalEl = document.getElementById('paiementModal');
    const modal = new bootstrap.Modal(modalEl);

    const listEl = document.getElementById('paiementsList');
    const emptyEl = document.getElementById('paiementsEmpty');

    const paiementIdEl = document.getElementById('paiementId');
    const titleEl = document.getElementById('paiementModalTitle');

    const prixTotalEl = document.getElementById('prixTotal');
    const montantPayeEl = document.getElementById('montantPaye');
    const resteCalcEl = document.getElementById('resteCalc');
    const typeEl = document.getElementById('typePaiement');
    const errEl = document.getElementById('paiementError');

    function statutBadge(statut) {
        if (statut === 'solde') return `<span class="badge bg-success rounded-pill">Soldé</span>`;
        if (statut === 'partiel') return `<span class="badge bg-warning text-dark rounded-pill">Partiel</span>`;
        return `<span class="badge bg-danger rounded-pill">Impayé</span>`;
    }

    function calcReste() {
        const total = parseFloat(prixTotalEl.value || '0');
        const paye = parseFloat(montantPayeEl.value || '0');
        const reste = Math.max(0, total - paye);
        resteCalcEl.value = reste.toFixed(2) + " DH";
    }

    prixTotalEl.addEventListener('input', calcReste);
    montantPayeEl.addEventListener('input', calcReste);

    function resetModal() {
        paiementIdEl.value = '';
        titleEl.textContent = 'Ajouter un paiement';
        prixTotalEl.value = '';
        montantPayeEl.value = '';
        resteCalcEl.value = '';
        typeEl.value = '';
        errEl.classList.add('d-none');
        errEl.textContent = '';
    }

    async function loadPaiements() {
        const res = await fetch(`/api/paiements/client/${clientId}`);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            emptyEl.classList.remove('d-none');
            listEl.classList.add('d-none');
            listEl.innerHTML = '';
            return;
        }

        emptyEl.classList.add('d-none');
        listEl.classList.remove('d-none');

        listEl.innerHTML = data.map(p => `
            <div class="border shadow-sm rounded-4 p-3 mb-2 d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">
                        ${statutBadge(p.statut)}
                        <span class="ms-2">${p.date}</span>
                    </div>
                    <div class="text-muted small">
                        Total: <b>${p.prixTotal.toFixed(2)}</b> | Payé: <b>${p.montantPaye.toFixed(2)}</b> | Reste: <b>${p.reste.toFixed(2)}</b>
                        <span class="ms-2">• ${p.typePaiement}</span>
                    </div>
                </div>

<div class="table-actions">
	<button class="btn btn-action btn-action-primary btn-edit" title="Modifier le paiement" data-id="${p.id}" data-total="${p.prixTotal}" data-paye="${p.montantPaye}" data-type="${p.typePaiement}">
		<i class="bi bi-pencil-square"></i>
	</button>

	<button class="btn btn-action btn-action-success btn-regulariser" title="Régulariser" data-id="${p.id}">
		<i class="bi bi-check2-circle"></i>
	</button>

	<button class="btn btn-action btn-action-danger btn-delete" title="Supprimer" data-id="${p.id}">
		<i class="bi bi-trash"></i>
	</button>
</div>


            </div>
        `).join('');

        // Bind events
        listEl.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => {
                resetModal();
                paiementIdEl.value = btn.dataset.id;
                titleEl.textContent = 'Modifier le paiement';
                prixTotalEl.value = btn.dataset.total;
                montantPayeEl.value = btn.dataset.paye;
                typeEl.value = btn.dataset.type;
                calcReste();
                modal.show();
            });
        });

        listEl.querySelectorAll('.btn-regulariser').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('Régulariser ce paiement (mettre reste à 0) ?')) return;
                await fetch(`/api/paiements/${btn.dataset.id}/regulariser`, { method: 'POST' });
                loadPaiements();
            });
        });

        listEl.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('Supprimer ce paiement définitivement ?')) return;
                await fetch(`/api/paiements/${btn.dataset.id}`, { method: 'DELETE' });
                loadPaiements();
            });
        });
    }

    document.getElementById('btnSavePaiement').addEventListener('click', async () => {
        errEl.classList.add('d-none');

        const total = parseFloat(prixTotalEl.value || '0');
        const paye = parseFloat(montantPayeEl.value || '0');
        const type = typeEl.value;

        if (!type || total <= 0 || paye < 0 || paye > total) {
            errEl.textContent = "Vérifie les montants et le type de paiement.";
            errEl.classList.remove('d-none');
            return;
        }

        const payload = {
            prixTotal: total,
            montantPaye: paye,
            typePaiement: type
        };

        const id = paiementIdEl.value;

        if (!id) {
            await fetch(`/api/paiements/add/${clientId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            await fetch(`/api/paiements/${id}/edit`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        modal.hide();
        resetModal();
        loadPaiements();
    });

    modalEl.addEventListener('hidden.bs.modal', resetModal);

    // First load
    loadPaiements();
});
</script>

