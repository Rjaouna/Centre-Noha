<div class="modal fade" id="paiementModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content rounded-4 shadow">

			<div class="modal-header border-0">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-cash-coin text-primary me-2"></i>
					<span id="paiementModalTitle">Ajouter un paiement</span>
				</h5>
				<button class="btn-close" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<input type="hidden" id="paiementId">

				<div class="row g-3">
					<div class="col-md-4">
						<label class="form-label">Montant total</label>
						<input type="number" step="0.01" min="0" class="form-control" id="prixTotal">
					</div>

					<div class="col-md-4">
						<label class="form-label">Montant payé</label>
						<input type="number" step="0.01" min="0" class="form-control" id="montantPaye">
					</div>

					<div class="col-md-4">
						<label class="form-label">Reste</label>
						<input type="text" class="form-control" id="resteCalc" disabled>
					</div>

					<div class="col-md-6">
						<label class="form-label">Type</label>
						<select class="form-select" id="typePaiement">
							<option value="">-- Choisir --</option>
							<option value="espece">Espèces</option>
							<option value="carte">Carte</option>
							<option value="virement">Virement</option>
							<option value="cheque">Chèque</option>
						</select>
					</div>
				</div>

				<div class="alert alert-danger mt-3 d-none" id="paiementError"></div>

			</div>

			<div class="modal-footer border-0">
				<button class="btn btn-light rounded-pill" data-bs-dismiss="modal">Fermer</button>
				<button class="btn btn-primary rounded-pill" id="btnSavePaiement">
					<i class="bi bi-check-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>

 <script>
document.addEventListener('DOMContentLoaded', () => {

    const clientId = {{ fiche_client.id }};
    const modalEl = document.getElementById('paiementModal');
    const modal = new bootstrap.Modal(modalEl);

    const listEl = document.getElementById('paiementsList');
    const emptyEl = document.getElementById('paiementsEmpty');

    const paiementIdEl = document.getElementById('paiementId');
    const titleEl = document.getElementById('paiementModalTitle');

    const prixTotalEl = document.getElementById('prixTotal');
    const montantPayeEl = document.getElementById('montantPaye');
    const resteCalcEl = document.getElementById('resteCalc');
    const typeEl = document.getElementById('typePaiement');
    const errEl = document.getElementById('paiementError');

    function statutBadge(statut) {
        if (statut === 'solde') return `<span class="badge bg-success rounded-pill">Soldé</span>`;
        if (statut === 'partiel') return `<span class="badge bg-warning text-dark rounded-pill">Partiel</span>`;
        return `<span class="badge bg-danger rounded-pill">Impayé</span>`;
    }

    function calcReste() {
        const total = parseFloat(prixTotalEl.value || '0');
        const paye = parseFloat(montantPayeEl.value || '0');
        const reste = Math.max(0, total - paye);
        resteCalcEl.value = reste.toFixed(2) + " DH";
    }

    prixTotalEl.addEventListener('input', calcReste);
    montantPayeEl.addEventListener('input', calcReste);

    function resetModal() {
        paiementIdEl.value = '';
        titleEl.textContent = 'Ajouter un paiement';
        prixTotalEl.value = '';
        montantPayeEl.value = '';
        resteCalcEl.value = '';
        typeEl.value = '';
        errEl.classList.add('d-none');
        errEl.textContent = '';
    }

    async function loadPaiements() {
        const res = await fetch(`/api/paiements/client/${clientId}`);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            emptyEl.classList.remove('d-none');
            listEl.classList.add('d-none');
            listEl.innerHTML = '';
            return;
        }

        emptyEl.classList.add('d-none');
        listEl.classList.remove('d-none');

        listEl.innerHTML = data.map(p => `
            <div class="border shadow-sm rounded-4 p-3 mb-2 d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">
                        ${statutBadge(p.statut)}
                        <span class="ms-2">${p.date}</span>
                    </div>
                    <div class="text-muted small">
                        Total: <b>${p.prixTotal.toFixed(2)}</b> | Payé: <b>${p.montantPaye.toFixed(2)}</b> | Reste: <b>${p.reste.toFixed(2)}</b>
                        <span class="ms-2">• ${p.typePaiement}</span>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary rounded-pill btn-edit" data-id="${p.id}"
                        data-total="${p.prixTotal}" data-paye="${p.montantPaye}" data-type="${p.typePaiement}">
                        <i class="bi bi-pencil"></i>
                    </button>

                    <button class="btn btn-sm btn-outline-success rounded-pill btn-regulariser" data-id="${p.id}">
                        <i class="bi bi-check2-circle"></i>
                    </button>

                    <button class="btn btn-sm btn-outline-danger rounded-pill btn-delete" data-id="${p.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        // Bind events
        listEl.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => {
                resetModal();
                paiementIdEl.value = btn.dataset.id;
                titleEl.textContent = 'Modifier le paiement';
                prixTotalEl.value = btn.dataset.total;
                montantPayeEl.value = btn.dataset.paye;
                typeEl.value = btn.dataset.type;
                calcReste();
                modal.show();
            });
        });

        listEl.querySelectorAll('.btn-regulariser').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('Régulariser ce paiement (mettre reste à 0) ?')) return;
                await fetch(`/api/paiements/${btn.dataset.id}/regulariser`, { method: 'POST' });
                loadPaiements();
            });
        });

        listEl.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('Supprimer ce paiement définitivement ?')) return;
                await fetch(`/api/paiements/${btn.dataset.id}`, { method: 'DELETE' });
                loadPaiements();
            });
        });
    }

    document.getElementById('btnSavePaiement').addEventListener('click', async () => {
        errEl.classList.add('d-none');

        const total = parseFloat(prixTotalEl.value || '0');
        const paye = parseFloat(montantPayeEl.value || '0');
        const type = typeEl.value;

        if (!type || total <= 0 || paye < 0 || paye > total) {
            errEl.textContent = "Vérifie les montants et le type de paiement.";
            errEl.classList.remove('d-none');
            return;
        }

        const payload = {
            prixTotal: total,
            montantPaye: paye,
            typePaiement: type
        };

        const id = paiementIdEl.value;

        if (!id) {
            await fetch(`/api/paiements/add/${clientId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            await fetch(`/api/paiements/${id}/edit`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        modal.hide();
        resetModal();
        loadPaiements();
    });

    modalEl.addEventListener('hidden.bs.modal', resetModal);

    // First load
    loadPaiements();
});
</script>

