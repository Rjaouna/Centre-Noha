{# --------------------------------------------- #}
{#  Sympt√¥mes g√©n√©raux - fiche patient (Lux)     #}
{# --------------------------------------------- #}

{# üü£ MODAL ‚Äî AJOUT / √âDITION #}
	<div class="modal fade" id="modalAddSymptomesGeneraux" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-lg">
		<div class="modal-content">

			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title">
					<i class="bi bi-plus-circle"></i>
					Ajouter / modifier les sympt√¥mes g√©n√©raux
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<form
					id="symptomesForm" class="mt-2">

					{# üî∂ TEMPLATE BLOC RADIO #}
					{% macro bloc(icon, title, name, options) %}
						<div class="p-3 mb-4 bg-light border rounded-3 shadow-sm">
							<h5 class="fw-bold text-primary mb-2">
								<i class="bi {{ icon }}"></i>
								{{ title }}
							</h5>

							<div class="d-flex flex-wrap gap-3">
								{% for opt in options %}
									<div class="form-check form-check-inline">
										<input class="form-check-input" type="radio" name="{{ name }}" value="{{ opt }}" id="{{ name }}_{{ loop.index }}">
										<label class="form-check-label" for="{{ name }}_{{ loop.index }}">
											{{ opt }}
										</label>
									</div>
								{% endfor %}
							</div>
						</div>
					{% endmacro %}

					{# OPTIONS CHOISIES (Option B) #}
					{{ _self.bloc("bi-emoji-dizzy", "Maux de t√™te", "mauxTete", ["Jamais","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-person-arms-up", "Maux de nuque", "mauxNuque", ["Jamais","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-moon-stars", "Insomnie", "insomnie", ["Jamais","Difficult√©s d‚Äôendormissement","R√©veils nocturnes","Insomnie s√©v√®re"]) }}
					{{ _self.bloc("bi-emoji-frown", "H√©morro√Ødes", "hemorroides", ["Jamais","Occasionnelles","Fr√©quentes"]) }}
					{{ _self.bloc("bi-droplet-half", "√ânur√©sie", "enuresie", ["Jamais","Rare","Parfois","Souvent"]) }}

				</form>

			</div>

			<div class="modal-footer">
				<button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>

				<button class="btn btn-primary" id="btnSaveSymptomes">
					<i class="bi bi-check-circle"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


{# üîµ MODAL ‚Äî VISUALISATION #}
<div class="modal fade" id="modalSymptomesGeneraux" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h3 class="modal-title d-flex align-items-center fw-bold">
					<i class="bi bi-heart-pulse-fill me-2 fs-3"></i>
					Sympt√¥mes g√©n√©raux
				</h3>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body py-4 px-4">

				{% set s = fiche_client.symptomesGeneraux %}

				{% if s %}
					<div class="row g-4">

						{% macro view(icon, label, value, color) %}
							<div class="col-md-4">
								<div class="p-3 rounded-4 border-start border-4 bg-light shadow-sm h-100 border-{{ color }}">
									<p class="text-secondary fw-semibold mb-1">
										<i class="bi {{ icon }} me-1 text-{{ color }}"></i>
										{{ label }}
									</p>
									<p class="fs-5 fw-bold">{{ value ?? "-" }}</p>
								</div>
							</div>
						{% endmacro %}

						{{ _self.view("bi-emoji-dizzy", "Maux de t√™te", s.mauxTete, "primary") }}
						{{ _self.view("bi-person-arms-up", "Maux de nuque", s.mauxNuque, "success") }}
						{{ _self.view("bi-moon-stars", "Insomnie", s.insomnie, "warning") }}
						{{ _self.view("bi-emoji-frown", "H√©morro√Ødes", s.hemorroides, "danger") }}
						{{ _self.view("bi-droplet-half", "√ânur√©sie", s.enuresie, "info") }}

					</div>

					<div class="text-end mt-4">
						<button class="btn btn-primary btn-lg px-4 shadow-sm fw-bold" id="btnEditSymptomes" data-bs-target="#modalAddSymptomesGeneraux" data-bs-toggle="modal" data-bs-dismiss="modal">
							<i class="bi bi-pencil-square me-1"></i>
							Modifier
						</button>
					</div>
				{% else %}
					<div class="text-center py-3">
						<p class="text-muted mb-3">
							Aucun sympt√¥me g√©n√©ral renseign√© pour ce patient pour le moment.
						</p>
						<button class="btn btn-primary btn-lg px-4" data-bs-target="#modalAddSymptomesGeneraux" data-bs-toggle="modal" data-bs-dismiss="modal">
							<i class="bi bi-plus-circle me-1"></i>
							Ajouter des sympt√¥mes
						</button>
					</div>
				{% endif %}

			</div>

		</div>
	</div>
</div>


{# ‚úèÔ∏è JS PR√â-REMPLISSAGE SUR MODIFICATION #}
 <script>
document.getElementById("btnEditSymptomes")?.addEventListener("click", async () => {
	const response = await fetch("{{ path('api_symptomes_show', {idClient: fiche_client.id}) }}");
	const data = await response.json();

	if (!data.exists || !data.data) return;

	const values = data.data;

	for (const key in values) {
		const value = values[key];
		if (value) {
			const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
			if (radio) radio.checked = true;
		}
	}
});
</script>


{# üíæ JS ENREGISTREMENT (ADD / EDIT) #}
 <script>
document.getElementById("btnSaveSymptomes").addEventListener("click", async () => {
	const form = document.getElementById("symptomesForm");
	const data = Object.fromEntries(new FormData(form));

	const url = "{{ fiche_client.symptomesGeneraux
		? path('api_symptomes_edit', {id: fiche_client.id})
		: path('api_symptomes_add', {id: fiche_client.id})
	}}";

	const response = await fetch(url, {
		method: "POST",
		headers: {"Content-Type": "application/json"},
		body: JSON.stringify(data)
	});

	const result = await response.json();

	if (result.success) {
		// Tu as d√©j√† une fonction showFlashMessage apparement
		showFlashMessage('Sympt√¥mes g√©n√©raux enregistr√©s !', 'success');
		location.reload();
	} else {
		alert('Erreur : ' + (result.message ?? 'Erreur serveur'));
	}
});
</script>

