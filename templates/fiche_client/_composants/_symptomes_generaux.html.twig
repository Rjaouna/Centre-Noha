{# --------------------------------------------- #}
{#  Sympt√¥mes g√©n√©raux - fiche patient (Lux)     #}
{# --------------------------------------------- #}

{# üü£ MODAL ‚Äî AJOUT / √âDITION #}
	<div class="modal fade" id="modalAddSymptomesGeneraux" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-lg">
		<div class="modal-content">

			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title">
					<i class="bi bi-plus-circle"></i>
					Ajouter / modifier les sympt√¥mes g√©n√©raux
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<form
					id="symptomesForm" class="mt-2">

					{# üî∂ TEMPLATE BLOC RADIO #}
					{% macro bloc(icon, title, name, options) %}
						<div class="p-3 mb-4 bg-light border rounded-3 shadow-sm">
							<h5 class="fw-bold text-primary mb-2">
								<i class="bi {{ icon }}"></i>
								{{ title }}
							</h5>

							<div class="d-flex flex-wrap gap-3">
								{% for opt in options %}
									<div class="form-check form-check-inline">
										<input class="form-check-input" type="radio" name="{{ name }}" value="{{ opt }}" id="{{ name }}_{{ loop.index }}">
										<label class="form-check-label" for="{{ name }}_{{ loop.index }}">
											{{ opt }}
										</label>
									</div>
								{% endfor %}
							</div>
						</div>
					{% endmacro %}

					{# OPTIONS CHOISIES (Option B) #}
					{{ _self.bloc("bi-emoji-dizzy", "Maux de t√™te", "mauxTete", ["Jamais","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-person-arms-up", "Maux de nuque", "mauxNuque", ["Jamais","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-moon-stars", "Insomnie", "insomnie", ["Jamais","Difficult√©s d‚Äôendormissement","R√©veils nocturnes","Insomnie s√©v√®re"]) }}
					{{ _self.bloc("bi-emoji-frown", "H√©morro√Ødes", "hemorroides", ["Jamais","Occasionnelles","Fr√©quentes"]) }}
					{{ _self.bloc("bi-droplet-half", "√ânur√©sie", "enuresie", ["Jamais","Rare","Parfois","Souvent"]) }}

				</form>

			</div>

			<div class="modal-footer">
				<button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>

				<button class="btn btn-primary" id="btnSaveSymptomes">
					<i class="bi bi-check-circle"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


<!-- üîµ MODAL ‚Äî VISUALISATION (DYNAMIQUE) -->

<div class="modal fade" id="modalSymptomesGeneraux" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
<div class="modal-content rounded-4 shadow-lg">


<!-- HEADER -->

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h3 class="modal-title d-flex align-items-center fw-bold">
					<i class="bi bi-heart-pulse-fill me-2 fs-3"></i>
					Sympt√¥mes g√©n√©raux
				</h3>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

<!-- BODY -->
<div class="modal-body py-4 px-4">


<!-- CONTENU DYNAMIQUE -->
<div id="symptomesContent">


<div class="row g-4">


<!-- Maux de t√™te -->
<div class="col-md-4">

<div class="p-3 rounded-4 border-start border-4 border-primary bg-light shadow-sm h-100">
	<p class="text-secondary fw-semibold mb-1"></p>

<i class="bi bi-emoji-dizzy me-1 text-primary"></i>
Maux de t√™te</p>

<p class="fs-5 fw-bold" id="view-mauxTete">-</p></div></div>


<!-- Maux de nuque -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-success bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">
			<i class="bi bi-person-arms-up me-1 text-success"></i>
			Maux de nuque
		</p>
		<p class="fs-5 fw-bold" id="view-mauxNuque">-</p>
	</div>
</div>

<!-- Insomnie -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-warning bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">
			<i class="bi bi-moon-stars me-1 text-warning"></i>
			Insomnie
		</p>
		<p class="fs-5 fw-bold" id="view-insomnie">-</p>
	</div>
</div>

<!-- H√©morro√Ødes -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-danger bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">
			<i class="bi bi-emoji-frown me-1 text-danger"></i>
			H√©morro√Ødes
		</p>
		<p class="fs-5 fw-bold" id="view-hemorroides">-</p>
	</div>
</div>

<!-- √ânur√©sie -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-info bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">
			<i class="bi bi-droplet-half me-1 text-info"></i>
			√ânur√©sie
		</p>
		<p class="fs-5 fw-bold" id="view-enuresie">-</p>
	</div>
</div>


					</div>

<!-- BOUTON MODIFIER -->

					<div class="text-end mt-4">
						<button class="btn btn-primary btn-lg px-4 shadow-sm fw-bold" id="btnEditSymptomes" data-bs-target="#modalAddSymptomesGeneraux" data-bs-toggle="modal" data-bs-dismiss="modal">
							<i class="bi bi-pencil-square me-1"></i>
							Modifier
						</button>
					</div>
</div>

<!-- FALLBACK SI AUCUNE DONN√âE -->
<div id="symptomesEmpty" class="text-center py-3 d-none">
	<p class="text-muted mb-3"></p>

Aucun sympt√¥me g√©n√©ral renseign√© pour ce patient.</p><button class="btn btn-primary btn-lg px-4" data-bs-target="#modalAddSymptomesGeneraux" data-bs-toggle="modal" data-bs-dismiss="modal">
<i class="bi bi-plus-circle me-1"></i>
Ajouter des sympt√¥mes</button></div>


			</div>

		</div>
	</div>
</div>

<!-- üöÄ JS ‚Äî FETCH √Ä L‚ÄôOUVERTURE -->
 <script>
document.getElementById('modalSymptomesGeneraux')
    .addEventListener('show.bs.modal', async () => {

    const content = document.getElementById('symptomesContent');
    const empty   = document.getElementById('symptomesEmpty');

    try {
        const response = await fetch("{{ path('api_symptomes_show', {idClient: fiche_client.id}) }}");
        const result   = await response.json();

        if (!result.exists || !result.data) {
            content.classList.add('d-none');
            empty.classList.remove('d-none');
            return;
        }

        content.classList.remove('d-none');
        empty.classList.add('d-none');

        const s = result.data;

        const fields = [
            'mauxTete',
            'mauxNuque',
            'insomnie',
            'hemorroides',
            'enuresie'
        ];

        fields.forEach(field => {
            const el = document.getElementById(`view-${field}`);
            if (el) {
                el.textContent = s[field] ?? '-';
            }
        });

    } catch (e) {
        console.error('Erreur chargement sympt√¥mes g√©n√©raux', e);
    }
});
</script>



{# ‚úèÔ∏è JS PR√â-REMPLISSAGE SUR MODIFICATION #}
 <script>
document.getElementById("btnEditSymptomes")?.addEventListener("click", async () => {
	const response = await fetch("{{ path('api_symptomes_show', {idClient: fiche_client.id}) }}");
	const data = await response.json();

	if (!data.exists || !data.data) return;

	const values = data.data;

	for (const key in values) {
		const value = values[key];
		if (value) {
			const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
			if (radio) radio.checked = true;
		}
	}
});
</script>


{# üíæ JS ENREGISTREMENT (ADD / EDIT) #}
 <script>
document.getElementById("btnSaveSymptomes").addEventListener("click", async () => {

	const form = document.getElementById("symptomesForm");
	const data = Object.fromEntries(new FormData(form));
	const pop  = document.getElementById("popupSuccess");

	const url = "{{ fiche_client.symptomesGeneraux
		? path('api_symptomes_edit', {id: fiche_client.id})
		: path('api_symptomes_add', {id: fiche_client.id})
	}}";

	const response = await fetch(url, {
		method: "POST",
		headers: {"Content-Type": "application/json"},
		body: JSON.stringify(data)
	});

	const result = await response.json();

	if (result.success) {

		// üîä Son succ√®s
		buttonSoundSuccess('btnSaveSymptomes');

		// üîí FERMETURE AUTOMATIQUE DE LA MODAL
		const modal = bootstrap.Modal.getInstance(document.getElementById("modalAddSymptomesGeneraux"));
		if (modal) modal.hide();

		// ‚ú® POPUP SUCC√àS
		pop.style.display = "block";
		pop.innerHTML = `
<div class="d-flex align-items-start">
	<i class="bi bi-check-circle-fill fs-1 text-white bg-success p-2 rounded-circle me-3"></i>

	<div>
		<h5 class="fw-bold mb-1 text-light">Sympt√¥mes enregistr√©s ! üéâ</h5>
		<p class="mb-1 text-light">Les informations ont √©t√© mises √† jour avec succ√®s.</p>
		<small class="text-light opacity-75 d-block mt-2">Merci ‚úîÔ∏è</small>
	</div>

	<button type="button" class="btn-close" onclick="document.getElementById('popupSuccess').style.display='none';"></button>
</div>`;
	} 
	else {
		alert('Erreur : ' + (result.message ?? 'Erreur serveur'));
	}
});
</script>



