{# --------------------------------------------- #}
{#  Troubles digestifs - fiche patient (Lux)     #}
{# --------------------------------------------- #}

{# ====== BLOC 3 CARTES (regroupement) ====== #}
	<div class="card shadow-sm border-0 rounded-4 mb-4"> <div class="card-body p-3 p-md-4">
		<div
			class="row g-3">

			{# Digestif #}
			<div class="col-md-4">
				<div class="p-4 rounded-4 border shadow-sm h-100 clickable-alert" id="card-digestif" style="cursor:pointer;" data-bs-toggle="modal">
					<div class="d-flex justify-content-between gap-3">
						<div>
							<h5 class="fw-bold mb-1 d-flex align-items-center gap-2" id="digestifTitle">
								<i class="bi bi-bandaid"></i>
								Troubles digestifs
							</h5>
							<p class="mb-0 small opacity-75" id="digestifText">
								Charger...
							</p>
						</div>
						<i class="bi bi-chevron-right fs-4 opacity-50"></i>
					</div>
				</div>
			</div>

			{# Symptomes #}
			<div class="col-md-4">
				<div class="p-4 rounded-4 border shadow-sm h-100 clickable-alert" id="card-symptomes" style="cursor:pointer;" data-bs-toggle="modal">
					<div class="d-flex justify-content-between gap-3">
						<div>
							<h5 class="fw-bold mb-1 d-flex align-items-center gap-2" id="symptomesTitle">
								<i class="bi bi-heart-pulse"></i>
								Symptômes & douleurs
							</h5>
							<p class="mb-0 small opacity-75" id="symptomesText">
								Charger...
							</p>
						</div>
						<i class="bi bi-chevron-right fs-4 opacity-50"></i>
					</div>
				</div>
			</div>

			{# Maladies #}
			<div class="col-md-4">
				<div class="p-4 rounded-4 border shadow-sm h-100 clickable-alert" id="card-maladies" style="cursor:pointer;" data-bs-toggle="modal">
					<div class="d-flex justify-content-between gap-3">
						<div>
							<h5 class="fw-bold mb-1 d-flex align-items-center gap-2" id="maladiesTitle">
								<i class="bi bi-activity"></i>
								Maladies chroniques
							</h5>
							<p class="mb-0 small opacity-75" id="maladiesText">
								Charger...
							</p>
						</div>
						<i class="bi bi-chevron-right fs-4 opacity-50"></i>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>

{# ===== MODAL ADD / EDIT DIGESTIF ===== #}
<div class="modal fade" id="modalAddDigestif" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

			<div class="modal-header bg-success text-white border-0 px-4 py-3">
				<div class="d-flex align-items-center gap-3">
					<div class="rounded-3 d-inline-flex align-items-center justify-content-center bg-white text-success" style="width:42px;height:42px;">
						<i class="bi bi-bandaid fs-5"></i>
					</div>
					<div class="lh-sm">
						<h5 class="modal-title mb-0 fw-semibold">Troubles digestifs</h5>
						<small class="opacity-75">Ajouter / modifier</small>
					</div>
				</div>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body px-4 py-4">
				<form id="digestifForm">
					{% macro pills(theme, name, options) %}
						<div class="d-flex flex-wrap gap-2">
							{% for opt in options %}
								{% set id = name ~ '_' ~ loop.index %}
								<input class="btn-check" type="radio" name="{{ name }}" id="{{ id }}" value="{{ opt }}" autocomplete="off">
								<label class="btn btn-outline-{{ theme }} rounded-pill px-3 py-2" for="{{ id }}">{{ opt }}</label>
							{% endfor %}
						</div>
					{% endmacro %}

					{% macro bloc(theme, icon, title, name, options) %}
						<div class="p-3 p-md-4 rounded-4 border bg-light shadow-sm mb-3">
							<div class="d-flex align-items-center gap-2 mb-2">
								<i class="bi {{ icon }} text-{{ theme }} fs-5"></i>
								<h6 class="fw-bold mb-0">{{ title }}</h6>
							</div>
							{{ _self.pills(theme, name, options) }}
						</div>
					{% endmacro %}

					{{ _self.bloc('success','bi-fire','Acidité gastrique','aciditeGastrique',['Jamais','Parfois','Souvent']) }}
					{{ _self.bloc('success','bi-exclamation-octagon','Constipation','constipation',['Jamais','Parfois','Souvent']) }}
					{{ _self.bloc('success','bi-droplet-half','Diarrhée','diarrhee',['Jamais','Occasionnelle','Souvent']) }}
					{{ _self.bloc('success','bi-wind','Gaz','gaz',['Rarement','Parfois','Fréquents']) }}
					{{ _self.bloc('success','bi-cloud','Éructation','eructation',['Rarement','Parfois','Souvent']) }}
					{{ _self.bloc('success','bi-droplet','Aspect des selles','aspectSelles',['Minces','Épaisses','Discontinues']) }}

				</form>
			</div>

			<div class="modal-footer border-0 px-4 pb-4 pt-0 d-flex gap-2 justify-content-end">
				<button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Annuler</button>
				<button class="btn btn-success rounded-pill px-4" id="btnSaveDigestif">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>

{# ===== MODAL VIEW DIGESTIF ===== #}
<div class="modal fade" id="modalDigestif" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

			<div class="modal-header bg-warning text-white border-0 px-4 py-3">
				<h5 class="modal-title fw-semibold d-flex align-items-center gap-2 mb-0">
					<i class="bi bi-bandaid-fill fs-5"></i>
					Troubles digestifs
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body px-4 py-4">
				<div class="row g-3">
					{% set boxes = [
            ['Acidité gastrique','aciditeGastrique','danger','bi-fire'],
            ['Constipation','constipation','warning','bi-dash-circle'],
            ['Diarrhée','diarrhee','primary','bi-droplet-half'],
            ['Gaz','gaz','success','bi-wind'],
            ['Éructation','eructation','info','bi-chat-dots'],
            ['Aspect des selles','aspectSelles','secondary','bi-droplet']
          ] %}

					{% for b in boxes %}
						<div class="col-md-4">
							<div class="p-3 rounded-4 bg-light border-start border-4 border-{{ b[2] }} shadow-sm h-100">
								<div class="text-muted small fw-semibold">
									<i class="bi {{ b[3] }} me-1 text-{{ b[2] }}"></i>
									{{ b[0] }}
								</div>
								<div class="fs-5 fw-bold" id="view-{{ b[1] }}">-</div>
							</div>
						</div>
					{% endfor %}
				</div>

				<div class="text-end mt-4">
					<button class="btn btn-warning rounded-pill px-4 fw-semibold" id="btnEditDigestif" data-bs-target="#modalAddDigestif" data-bs-toggle="modal" data-bs-dismiss="modal">
						<i class="bi bi-pencil-square me-1"></i>
						Modifier
					</button>
				</div>
			</div>

		</div>
	</div>
</div>

 <script>
(function () {
  const clientId = {{ fiche_client.id }};

  // URLs
  const DIG_SHOW = "{{ path('api_troubles_digestifs_show', {idClient: fiche_client.id}) }}";
  const DIG_ADD  = "{{ path('api_digestifs_add',  {id: fiche_client.id}) }}";
  const DIG_EDIT = "{{ path('api_digestifs_edit', {id: fiche_client.id}) }}";

  const SYM_SHOW = "{{ path('api_symptomes_show', {idClient: fiche_client.id}) }}";
  const MAL_SHOW = "{{ path('api_maladies_show', {idClient: fiche_client.id}) }}";

  let digExists = false;

  // Cards elements
  const cardDigestif  = document.getElementById('card-digestif');
  const cardSymptomes = document.getElementById('card-symptomes');
  const cardMaladies  = document.getElementById('card-maladies');

  // Titles/texts
  const digestifTitle = document.getElementById('digestifTitle');
  const digestifText  = document.getElementById('digestifText');
  const symptomesText = document.getElementById('symptomesText');
  const maladiesText  = document.getElementById('maladiesText');

  // Modals
  const modalDigestifView = document.getElementById('modalDigestif');
  const modalDigestifAdd  = document.getElementById('modalAddDigestif');

  const btnEditDigestif = document.getElementById('btnEditDigestif');
  const btnSaveDigestif = document.getElementById('btnSaveDigestif');
  const formDigestif    = document.getElementById('digestifForm');

  if (!cardDigestif || !btnSaveDigestif || !formDigestif) return;

  async function fetchJSON(url) {
    const r = await fetch(url);
    return await r.json();
  }

  function setCardStyle(el, theme) {
    // reset
    el.classList.remove('border-success','border-warning','border-danger','bg-success-subtle','bg-warning-subtle','bg-danger-subtle');
    el.classList.add('border');

    if (theme === 'success') {
      el.classList.add('border-success','bg-success-subtle');
    } else if (theme === 'warning') {
      el.classList.add('border-warning','bg-warning-subtle');
    } else {
      el.classList.add('border-danger','bg-danger-subtle');
    }
  }

  function setDigestifTargets() {
    cardDigestif.setAttribute('data-bs-target', digExists ? '#modalDigestif' : '#modalAddDigestif');
  }

  async function refreshCards() {
    // Digestif
    try {
      const dig = await fetchJSON(DIG_SHOW);
      digExists = !!(dig.exists && dig.data);

      setCardStyle(cardDigestif, digExists ? 'warning' : 'success');
      digestifTitle.innerHTML = digExists
        ? `<i class="bi bi-pencil-square"></i> Troubles digestifs`
        : `<i class="bi bi-plus-circle"></i> Troubles digestifs`;
      digestifText.textContent = digExists
        ? 'Modifier les troubles digestifs du patient.'
        : 'Ajouter les troubles digestifs du patient.';
      setDigestifTargets();

      // expose
      window.medicalBlocks = window.medicalBlocks || {};
      window.medicalBlocks.digestif = { exists: digExists };

      // si la modal view est ouverte, on remplit
      if (digExists && modalDigestifView?.classList.contains('show')) {
        setDigestifView(dig.data);
      }

    } catch (e) {
      console.error('Digestif: refreshCards error', e);
    }

    // Symptomes (carte seulement)
    try {
      const s = await fetchJSON(SYM_SHOW);
      const symExists = !!(s.exists && s.data);
      setCardStyle(cardSymptomes, symExists ? 'warning' : 'primary');
      symptomesText.textContent = symExists
        ? 'Modifier les symptômes du patient.'
        : 'Ajouter les symptômes du patient.';
      cardSymptomes.setAttribute('data-bs-target', symExists ? '#modalSymptomesGeneraux' : '#modalAddSymptomesGeneraux');
    } catch (e) {}

    // Maladies (carte seulement)
    try {
      const m = await fetchJSON(MAL_SHOW);
      const malExists = !!(m.exists && m.data);
      setCardStyle(cardMaladies, malExists ? 'warning' : 'danger');
      maladiesText.textContent = malExists
        ? 'Modifier les maladies chroniques.'
        : 'Ajouter les maladies chroniques.';
      cardMaladies.setAttribute('data-bs-target', malExists ? '#modalMaladiesChroniques' : '#modalAddMaladiesChroniques');
    } catch (e) {}
  }

  function setDigestifView(d) {
    const fields = ['aciditeGastrique','constipation','diarrhee','gaz','eructation','aspectSelles'];
    fields.forEach(f => {
      const el = document.getElementById('view-' + f);
      if (el) el.textContent = d && d[f] ? d[f] : '-';
    });
  }

  function fillDigestifForm(d) {
    formDigestif.reset();
    if (!d) return;
    Object.keys(d).forEach((key) => {
      const value = d[key];
      if (!value) return;
      const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
      if (radio) radio.checked = true;
    });
  }

  // Open view -> fetch
  modalDigestifView?.addEventListener('show.bs.modal', async () => {
    const dig = await fetchJSON(DIG_SHOW);
    digExists = !!(dig.exists && dig.data);
    if (digExists) setDigestifView(dig.data);
  });

  // Edit -> prefill
  btnEditDigestif?.addEventListener('click', async () => {
    const dig = await fetchJSON(DIG_SHOW);
    digExists = !!(dig.exists && dig.data);
    fillDigestifForm(dig.data);
  });

  // Save
  btnSaveDigestif.addEventListener('click', async () => {
    const payload = Object.fromEntries(new FormData(formDigestif));
    const url = digExists ? DIG_EDIT : DIG_ADD;

    const response = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (!result.success) {
      buttonSoundError?.('btnSaveDigestif');
      alert('Erreur : ' + (result.message ?? 'Erreur serveur'));
      return;
    }

    buttonSoundSuccess?.('btnSaveDigestif');
    digExists = true;

    const inst = bootstrap.Modal.getInstance(modalDigestifAdd);
    inst?.hide();

    // refresh cards + view values
    await refreshCards();

    document.dispatchEvent(new CustomEvent('medical:updated', {
      detail: { section: 'digestif' }
    }));
  });

  // Quand un autre module sauvegarde, on refresh les cartes (pas besoin reload)
  document.addEventListener('medical:updated', () => refreshCards());

  // init
  refreshCards();
})();
</script>

