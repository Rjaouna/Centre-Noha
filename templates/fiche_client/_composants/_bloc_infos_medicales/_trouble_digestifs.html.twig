{# ===========================
   INFOS MÉDICALES — 3 BLOCS (UX LUX)
   - clic sur un bloc => ouvre modal d’édition
   - save => refresh badge sans reload
   - modals: 2 questions par ligne (desktop), 1 par ligne (mobile)
   =========================== #}

<style>
	/* ---------- TILES (3 BLOCS) ---------- */
	.med-tile {
		cursor: pointer;
		border: 1px solid rgba(2, 6, 23, .08);
		border-radius: 22px;
		overflow: hidden;
		background: #fff;
		box-shadow: 0 16px 46px rgba(2, 6, 23, .08);
		transition: 0.18s ease;
		height: 100%;
		position: relative;
	}
	.med-tile:hover {
		transform: translateY(-2px);
		box-shadow: 0 24px 70px rgba(2, 6, 23, .12);
	}
	.med-tile .med-top {
		padding: 16px 18px;
		display: flex;
		gap: 12px;
		align-items: flex-start;
	}
	.med-tile .med-ico {
		width: 46px;
		height: 46px;
		border-radius: 16px;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #fff;
		box-shadow: 0 14px 34px rgba(2, 6, 23, .16);
		flex: 0 0 auto;
	}
	.med-tile h5 {
		margin: 0;
		font-weight: 900;
		letter-spacing: 0.2px;
		line-height: 1.15;
	}
	.med-tile p {
		margin: 4px 0 0;
		opacity: .85;
	}
	.med-tile .med-bottom {
		padding: 0 18px 16px;
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 10px;
	}
	.med-pill {
		border-radius: 999px;
		padding: 8px 12px;
		font-weight: 900;
		letter-spacing: 0.2px;
		display: inline-flex;
		align-items: center;
		gap: 8px;
		border: 1px solid rgba(2, 6, 23, .10);
		background: rgba(2, 6, 23, .03);
	}
	.med-pill.ok {
		background: rgba(25, 135, 84, .10);
		border-color: rgba(25, 135, 84, .20);
		color: #198754;
	}
	.med-pill.todo {
		background: rgba(13, 110, 253, .10);
		border-color: rgba(13, 110, 253, .20);
		color: #0d6efd;
	}
	.med-chevron {
		width: 36px;
		height: 36px;
		border-radius: 14px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(2, 6, 23, .04);
		border: 1px solid rgba(2, 6, 23, .08);
	}

	/* ---------- MODALS (LUX) ---------- */
	.lux-modal .modal-content {
		border: 0;
		border-radius: 22px;
		overflow: hidden;
		box-shadow: 0 26px 80px rgba(2, 6, 23, 0.22);
		background: #fff;
	}
	.lux-modal .modal-header {
		border: 0;
		padding: 18px 22px;
	}
	.lux-head {
		display: flex;
		align-items: center;
		gap: 14px;
	}
	.lux-icon {
		width: 48px;
		height: 48px;
		border-radius: 16px;
		display: flex;
		align-items: center;
		justify-content: center;
		box-shadow: 0 14px 34px rgba(2, 6, 23, .18);
		flex: 0 0 auto;
	}
	.lux-title {
		margin: 0;
		font-weight: 900;
		letter-spacing: 0.2px;
		line-height: 1.1;
		color: #fff;
	}
	.lux-subtitle {
		margin: 4px 0 0;
		opacity: .9;
		font-size: 0.92rem;
		color: #fff;
	}
	.lux-modal .modal-body {
		padding: 18px 22px 10px;
		background: linear-gradient(180deg, rgba(2,6,23,.03), rgba(2,6,23,0));
	}

	/* ✅ 2 QUESTIONS PAR LIGNE */
	.lux-form-grid {
		display: grid;
		grid-template-columns: 1fr; /* mobile */
		gap: 12px;
	}
	@media(min-width: 992px) {
		.lux-form-grid {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}
	.lux-section {
		background: #fff;
		border: 1px solid rgba(2, 6, 23, .08);
		border-radius: 18px;
		padding: 14px;
		box-shadow: 0 10px 22px rgba(2, 6, 23, .05);
		height: 100%;
	}
	.lux-section--full {
		grid-column: 1 / -1;
	}

	.lux-section-title {
		font-weight: 900;
		margin: 0 0 10px;
		color: #0b1220;
		display: flex;
		align-items: center;
		gap: 10px;
	}

	/* radios en pills */
	.lux-pills {
		display: flex;
		gap: 10px;
		flex-wrap: wrap;
	}
	.lux-pill {
		position: relative;
	}
	.lux-pill input {
		position: absolute;
		opacity: 0;
		pointer-events: none;
	}
	.lux-pill label {
		cursor: pointer;
		user-select: none;
		padding: 10px 14px;
		border-radius: 999px;
		border: 1px solid rgba(2, 6, 23, .10);
		background: rgba(255, 255, 255, .92);
		box-shadow: 0 8px 16px rgba(2, 6, 23, .06);
		font-weight: 900;
		color: #0b1220;
		transition: 0.16s ease;
	}
	.lux-pill input:checked + label {
		transform: translateY(-1px);
		box-shadow: 0 14px 28px rgba(2, 6, 23, .10);
	}

	/* footer */
	.lux-modal .modal-footer {
		border: 0;
		padding: 14px 22px 18px;
		background: #fff;
	}
	.lux-btn {
		border-radius: 999px;
		padding: 11px 16px;
		font-weight: 900;
		letter-spacing: 0.2px;
		box-shadow: 0 12px 28px rgba(2, 6, 23, .10);
	}

	/* headers gradients */
	.lux-header-success {
		background: linear-gradient(135deg, #16a34a, #22c55e);
	}
	.lux-header-primary {
		background: linear-gradient(135deg, #2563eb, #3b82f6);
	}
	.lux-header-danger {
		background: linear-gradient(135deg, #dc2626, #ef4444);
	}

	/* accents checked (suivant thème) */
	.lux-modal[data-theme="success"] .lux-pill input:checked + label {
		border-color: rgba(34, 197, 94, .55);
	}
	.lux-modal[data-theme="primary"] .lux-pill input:checked + label {
		border-color: rgba(59, 130, 246, .55);
	}
	.lux-modal[data-theme="danger"] .lux-pill input:checked + label {
		border-color: rgba(239, 68, 68, .55);
	}
</style>


{# ===========================
   3 BLOCS UNIQUEMENT
   =========================== #}
<div
	class="row g-3" id="medicalBlocks">

	{# DIGESTIF #}
	<div class="col-md-4">
		<div class="med-tile" data-section="digestif" role="button" aria-label="Troubles digestifs">
			<div class="med-top">
				<div class="med-ico" style="background: linear-gradient(135deg,#16a34a,#22c55e);">
					<i class="bi bi-bandaid fs-4"></i>
				</div>
				<div class="flex-grow-1">
					<h5>Troubles digestifs</h5>
					<p class="mb-0 small" id="sub-digestif">Clique pour renseigner rapidement.</p>
				</div>
			</div>
			<div class="med-bottom">
				<span class="med-pill todo" id="badge-digestif">
					<i class="bi bi-dot"></i>
					À compléter</span>
				<span class="med-chevron">
					<i class="bi bi-chevron-right"></i>
				</span>
			</div>
		</div>
	</div>

	{# SYMPTOMES #}
	<div class="col-md-4">
		<div class="med-tile" data-section="symptomes" role="button" aria-label="Symptômes généraux">
			<div class="med-top">
				<div class="med-ico" style="background: linear-gradient(135deg,#2563eb,#3b82f6);">
					<i class="bi bi-heart-pulse fs-4"></i>
				</div>
				<div class="flex-grow-1">
					<h5>Symptômes généraux</h5>
					<p class="mb-0 small" id="sub-symptomes">Clique pour renseigner rapidement.</p>
				</div>
			</div>
			<div class="med-bottom">
				<span class="med-pill todo" id="badge-symptomes">
					<i class="bi bi-dot"></i>
					À compléter</span>
				<span class="med-chevron">
					<i class="bi bi-chevron-right"></i>
				</span>
			</div>
		</div>
	</div>

	{# MALADIES #}
	<div class="col-md-4">
		<div class="med-tile" data-section="maladies" role="button" aria-label="Maladies chroniques">
			<div class="med-top">
				<div class="med-ico" style="background: linear-gradient(135deg,#dc2626,#ef4444);">
					<i class="bi bi-activity fs-4"></i>
				</div>
				<div class="flex-grow-1">
					<h5>Maladies chroniques</h5>
					<p class="mb-0 small" id="sub-maladies">Clique pour renseigner rapidement.</p>
				</div>
			</div>
			<div class="med-bottom">
				<span class="med-pill todo" id="badge-maladies">
					<i class="bi bi-dot"></i>
					À compléter</span>
				<span class="med-chevron">
					<i class="bi bi-chevron-right"></i>
				</span>
			</div>
		</div>
	</div>

</div>


{# ===========================
   MODALS (ÉDITION DIRECTE)
   ✅ 2 questions par ligne
   =========================== #}

{# -------- Digestif -------- #}
<div class="modal fade lux-modal" id="modalEditDigestif" tabindex="-1" aria-hidden="true" data-theme="success">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">

			<div class="modal-header lux-header-success">
				<div class="lux-head">
					<div class="lux-icon bg-white text-success">
						<i class="bi bi-bandaid fs-4"></i>
					</div>
					<div>
						<h5 class="lux-title">Troubles digestifs</h5>
						<p class="lux-subtitle mb-0">Sélection rapide — sauvegarde instantanée.</p>
					</div>
				</div>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">
				<form id="form-digestif">
					{% set itemsDigestif = [
            {t:"Acidité gastrique", n:"aciditeGastrique", o:["Jamais","Parfois","Souvent"], i:"bi-fire"},
            {t:"Constipation", n:"constipation", o:["Jamais","Parfois","Souvent"], i:"bi-exclamation-octagon"},
            {t:"Diarrhée", n:"diarrhee", o:["Jamais","Occasionnelle","Souvent"], i:"bi-droplet-half"},
            {t:"Gaz", n:"gaz", o:["Rarement","Parfois","Fréquents"], i:"bi-wind"},
            {t:"Éructation", n:"eructation", o:["Rarement","Parfois","Souvent"], i:"bi-cloud"},
            {t:"Aspect des selles", n:"aspectSelles", o:["Minces","Épaisses","Discontinues"], i:"bi-droplet-fill"}
          ] %}

					<div class="lux-form-grid">
						{% for it in itemsDigestif %}
							<div class="lux-section">
								<div class="lux-section-title">
									<i class="bi {{ it.i }}"></i>
									{{ it.t }}
								</div>
								<div class="lux-pills">
									{% for opt in it.o %}
										<div class="lux-pill">
											<input type="radio" name="{{ it.n }}" value="{{ opt }}" id="digestif_{{ it.n }}_{{ loop.index }}">
											<label for="digestif_{{ it.n }}_{{ loop.index }}">{{ opt }}</label>
										</div>
									{% endfor %}
								</div>
							</div>
						{% endfor %}
					</div>
				</form>
			</div>

			<div class="modal-footer d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-light lux-btn" data-bs-dismiss="modal">Annuler</button>
				<button type="button" class="btn btn-success lux-btn text-light" id="btnSave-digestif">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


{# -------- Symptômes -------- #}
<div class="modal fade lux-modal" id="modalEditSymptomes" tabindex="-1" aria-hidden="true" data-theme="primary">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">

			<div class="modal-header lux-header-primary">
				<div class="lux-head">
					<div class="lux-icon bg-white text-primary">
						<i class="bi bi-heart-pulse fs-4"></i>
					</div>
					<div>
						<h5 class="lux-title">Symptômes généraux</h5>
						<p class="lux-subtitle mb-0">Choisis en 1 clic — sauvegarde sans recharger.</p>
					</div>
				</div>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">
				<form id="form-symptomes">
					{% set itemsSymptomes = [
            {t:"Maux de tête", n:"mauxTete", o:["Jamais","Parfois","Souvent"], i:"bi-emoji-dizzy"},
            {t:"Maux de nuque", n:"mauxNuque", o:["Jamais","Parfois","Souvent"], i:"bi-person-arms-up"},
            {t:"Insomnie", n:"insomnie", o:["Jamais","Difficultés d’endormissement","Réveils nocturnes","Insomnie sévère"], i:"bi-moon-stars"},
            {t:"Hémorroïdes", n:"hemorroides", o:["Jamais","Occasionnelles","Fréquentes"], i:"bi-emoji-frown"},
            {t:"Énurésie", n:"enuresie", o:["Jamais","Rare","Parfois","Souvent"], i:"bi-droplet-half"}
          ] %}

					<div class="lux-form-grid">
						{% for it in itemsSymptomes %}
							<div class="lux-section">
								<div class="lux-section-title">
									<i class="bi {{ it.i }}"></i>
									{{ it.t }}
								</div>
								<div class="lux-pills">
									{% for opt in it.o %}
										<div class="lux-pill">
											<input type="radio" name="{{ it.n }}" value="{{ opt }}" id="symptomes_{{ it.n }}_{{ loop.index }}">
											<label for="symptomes_{{ it.n }}_{{ loop.index }}">{{ opt }}</label>
										</div>
									{% endfor %}
								</div>
							</div>
						{% endfor %}
					</div>
				</form>
			</div>

			<div class="modal-footer d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-light lux-btn" data-bs-dismiss="modal">Annuler</button>
				<button type="button" class="btn btn-primary lux-btn text-light" id="btnSave-symptomes">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


{# -------- Maladies -------- #}
<div class="modal fade lux-modal" id="modalEditMaladies" tabindex="-1" aria-hidden="true" data-theme="danger">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">

			<div class="modal-header lux-header-danger">
				<div class="lux-head">
					<div class="lux-icon bg-white text-danger">
						<i class="bi bi-activity fs-4"></i>
					</div>
					<div>
						<h5 class="lux-title">Maladies chroniques</h5>
						<p class="lux-subtitle mb-0">L’essentiel + une note si besoin.</p>
					</div>
				</div>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">
				<form id="form-maladies">
					{% set itemsMaladies = [
            {t:"Diabète", n:"diabetique", o:["Oui","Non"], i:"bi-capsule"},
            {t:"Hypertension", n:"hypertendu", o:["Oui","Non"], i:"bi-activity"},
            {t:"Cholestérol", n:"cholesterol", o:["Oui","Non"], i:"bi-droplet"},
            {t:"Allergies nasales", n:"allergieNasale", o:["Jamais","Parfois","Souvent"], i:"bi-wind"}
          ] %}

					<div class="lux-form-grid">
						{% for it in itemsMaladies %}
							<div class="lux-section">
								<div class="lux-section-title">
									<i class="bi {{ it.i }}"></i>
									{{ it.t }}
								</div>
								<div class="lux-pills">
									{% for opt in it.o %}
										<div class="lux-pill">
											<input type="radio" name="{{ it.n }}" value="{{ opt }}" id="maladies_{{ it.n }}_{{ loop.index }}">
											<label for="maladies_{{ it.n }}_{{ loop.index }}">{{ opt }}</label>
										</div>
									{% endfor %}
								</div>
							</div>
						{% endfor %}

						<div class="lux-section lux-section--full">
							<div class="lux-section-title">
								<i class="bi bi-card-text"></i>
								Autre maladie (notes)
							</div>
							<div class="form-floating">
								<textarea class="form-control rounded-4" name="autreMaladie" id="autreMaladie" style="height:120px" placeholder="Autre maladie"></textarea>
								<label for="autreMaladie">Détail / commentaire…</label>
							</div>
						</div>
					</div>
				</form>
			</div>

			<div class="modal-footer d-flex gap-2 justify-content-end">
				<button type="button" class="btn btn-light lux-btn" data-bs-dismiss="modal">Annuler</button>
				<button type="button" class="btn btn-danger lux-btn text-light" id="btnSave-maladies">
					<i class="bi bi-check2-circle me-1"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


{# ===========================
   JS CLEAN (1 seul script)
   - sérialise TOUS les champs (même non cochés => null)
   - évite les bugs "symptomes/maladies ne s'enregistre pas"
   =========================== #}
 <script>
document.addEventListener("DOMContentLoaded", () => {

  const SECTIONS = {
    digestif: {
      modalId: "modalEditDigestif",
      formId: "form-digestif",
      saveBtnId: "btnSave-digestif",
      badgeId: "badge-digestif",
      subId: "sub-digestif",
      fields: ["aciditeGastrique","constipation","diarrhee","gaz","eructation","aspectSelles"],
      showUrl: "{{ path('api_troubles_digestifs_show', {idClient: fiche_client.id}) }}",
      addUrl:  "{{ path('api_digestifs_add', {id: fiche_client.id}) }}",
      editUrl: "{{ path('api_digestifs_edit', {id: fiche_client.id}) }}"
    },
    symptomes: {
      modalId: "modalEditSymptomes",
      formId: "form-symptomes",
      saveBtnId: "btnSave-symptomes",
      badgeId: "badge-symptomes",
      subId: "sub-symptomes",
      fields: ["mauxTete","mauxNuque","insomnie","hemorroides","enuresie"],
      showUrl: "{{ path('api_symptomes_show', {idClient: fiche_client.id}) }}",
      addUrl:  "{{ path('api_symptomes_add', {id: fiche_client.id}) }}",
      editUrl: "{{ path('api_symptomes_edit', {id: fiche_client.id}) }}"
    },
    maladies: {
      modalId: "modalEditMaladies",
      formId: "form-maladies",
      saveBtnId: "btnSave-maladies",
      badgeId: "badge-maladies",
      subId: "sub-maladies",
      fields: ["diabetique","hypertendu","cholesterol","allergieNasale","autreMaladie"],
      showUrl: "{{ path('api_maladies_show', {idClient: fiche_client.id}) }}",
      addUrl:  "{{ path('api_maladies_add', {id: fiche_client.id}) }}",
      editUrl: "{{ path('api_maladies_edit', {id: fiche_client.id}) }}"
    }
  };

  const state = { digestif:false, symptomes:false, maladies:false };

  function setTile(section, filled){
    const cfg = SECTIONS[section];
    const badge = document.getElementById(cfg.badgeId);
    const sub = document.getElementById(cfg.subId);
    if (!badge || !sub) return;

    badge.classList.remove("ok","todo");
    if (filled){
      badge.classList.add("ok");
      badge.innerHTML = `<i class="bi bi-check-circle"></i> Renseigné`;
      sub.textContent = "Clique pour modifier les informations.";
    } else {
      badge.classList.add("todo");
      badge.innerHTML = `<i class="bi bi-dot"></i> À compléter`;
      sub.textContent = "Clique pour renseigner rapidement.";
    }
  }

  async function fetchSection(section){
    const cfg = SECTIONS[section];
    const r = await fetch(cfg.showUrl);
    const res = await r.json();

    const filled = !!(res.exists && res.data);
    state[section] = filled;

    setTile(section, filled);
    return res.data || null;
  }

  function fillFormFromData(section, data){
    const cfg = SECTIONS[section];
    const form = document.getElementById(cfg.formId);
    if (!form) return;

    form.reset();

    if (!data) return;

    cfg.fields.forEach((key) => {
      const val = data[key];

      // textarea
      const ta = form.querySelector(`textarea[name="${key}"]`);
      if (ta) ta.value = (val ?? "");

      // radio
      const radios = form.querySelectorAll(`input[type="radio"][name="${key}"]`);
      if (radios && radios.length){
        radios.forEach(r => r.checked = false);
        if (val !== null && val !== undefined && val !== ""){
          radios.forEach(r => { if (r.value === String(val)) r.checked = true; });
        }
      }
    });
  }

  function serializeAll(section){
    const cfg = SECTIONS[section];
    const form = document.getElementById(cfg.formId);
    const payload = {};

    cfg.fields.forEach((key) => {
      const ta = form.querySelector(`textarea[name="${key}"]`);
      if (ta){
        payload[key] = ta.value ?? "";
        return;
      }

      const checked = form.querySelector(`input[type="radio"][name="${key}"]:checked`);
      payload[key] = checked ? checked.value : null; // ✅ clé toujours envoyée
    });

    return payload;
  }

  async function openEditor(section){
    const cfg = SECTIONS[section];
    const modalEl = document.getElementById(cfg.modalId);
    if (!modalEl) return;

    const data = await fetchSection(section);
    fillFormFromData(section, data);

    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  }

  async function saveSection(section){
    const cfg = SECTIONS[section];
    const modalEl = document.getElementById(cfg.modalId);
    const btn = document.getElementById(cfg.saveBtnId);
    if (!modalEl || !btn) return;

    const payload = serializeAll(section);
    const url = state[section] ? cfg.editUrl : cfg.addUrl;

    const oldHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement...`;

    try {
      const r = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const res = await r.json();

      if (!res.success){
        window.buttonSoundError?.(cfg.saveBtnId);
        alert("Erreur : " + (res.message ?? "Erreur serveur"));
        return;
      }

      window.buttonSoundSuccess?.(cfg.saveBtnId);

      // ✅ refresh bloc sans reload
      await fetchSection(section);

      // ✅ une fois sauvegardé, section devient “existante”
      state[section] = true;

      bootstrap.Modal.getInstance(modalEl)?.hide();
    } catch (e){
      console.error(e);
      alert("Erreur réseau.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = oldHtml;
    }
  }

  // clic sur les blocs
  document.getElementById("medicalBlocks")?.addEventListener("click", (e) => {
    const tile = e.target.closest("[data-section]");
    if (!tile) return;
    openEditor(tile.dataset.section);
  });

  // boutons save
  Object.keys(SECTIONS).forEach((section) => {
    document.getElementById(SECTIONS[section].saveBtnId)
      ?.addEventListener("click", () => saveSection(section));
  });

  // init badges
  Promise.all([
    fetchSection("digestif"),
    fetchSection("symptomes"),
    fetchSection("maladies"),
  ]);
});
</script>

