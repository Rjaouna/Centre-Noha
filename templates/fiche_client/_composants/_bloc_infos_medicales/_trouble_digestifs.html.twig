{# ========================================================= #}
{#  HUB INFOS MÉDICALES - UX Moderne (1 modal, tabs, live UI) #}
{# ========================================================= #}

	<section class="medical-hub mt-3"> <div class="medical-hub__header">
		<div class="d-flex align-items-start gap-3">
			<div class="medical-hub__icon">
				<i class="bi bi-clipboard2-pulse"></i>
			</div>
			<div class="flex-grow-1">
				<div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
					<div>
						<h4 class="medical-hub__title mb-1">Informations médicales</h4>
						<div class="medical-hub__subtitle">Renseigne rapidement les infos clés, sans recharger la page.</div>
					</div>

					<button class="btn btn-dark rounded-pill px-4 medical-hub__open" data-bs-toggle="modal" data-bs-target="#medicalHubModal">
						<i class="bi bi-window-sidebar me-1"></i>
						Ouvrir le hub
					</button>
				</div>

				<div class="mt-3">
					<div class="d-flex align-items-center justify-content-between small text-muted mb-1">
						<span>Complétude</span>
						<span id="medicalCompletionText">—</span>
					</div>
					<div class="progress medical-progress">
						<div class="progress-bar" id="medicalCompletionBar" role="progressbar" style="width:0%"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Tiles #}
	<div class="medical-tiles mt-3">
		<button type="button" class="medical-tile" id="tile-digestif" data-open-tab="digestif" data-bs-toggle="modal" data-bs-target="#medicalHubModal">
			<div class="medical-tile__stripe stripe-success"></div>
			<div class="medical-tile__top">
				<div class="medical-tile__badge" id="badge-digestif">—</div>
				<div class="medical-tile__chev">
					<i class="bi bi-chevron-right"></i>
				</div>
			</div>
			<div class="medical-tile__title">
				<span class="tile-icon bg-success-subtle text-success">
					<i class="bi bi-bandaid"></i>
				</span>
				Troubles digestifs
			</div>
			<div class="medical-tile__desc" id="desc-digestif">Chargement…</div>
			<div class="medical-tile__mini" id="mini-digestif"></div>
		</button>

		<button type="button" class="medical-tile" id="tile-symptomes" data-open-tab="symptomes" data-bs-toggle="modal" data-bs-target="#medicalHubModal">
			<div class="medical-tile__stripe stripe-primary"></div>
			<div class="medical-tile__top">
				<div class="medical-tile__badge" id="badge-symptomes">—</div>
				<div class="medical-tile__chev">
					<i class="bi bi-chevron-right"></i>
				</div>
			</div>
			<div class="medical-tile__title">
				<span class="tile-icon bg-primary-subtle text-primary">
					<i class="bi bi-heart-pulse"></i>
				</span>
				Symptômes généraux
			</div>
			<div class="medical-tile__desc" id="desc-symptomes">Chargement…</div>
			<div class="medical-tile__mini" id="mini-symptomes"></div>
		</button>

		<button type="button" class="medical-tile" id="tile-maladies" data-open-tab="maladies" data-bs-toggle="modal" data-bs-target="#medicalHubModal">
			<div class="medical-tile__stripe stripe-danger"></div>
			<div class="medical-tile__top">
				<div class="medical-tile__badge" id="badge-maladies">—</div>
				<div class="medical-tile__chev">
					<i class="bi bi-chevron-right"></i>
				</div>
			</div>
			<div class="medical-tile__title">
				<span class="tile-icon bg-danger-subtle text-danger">
					<i class="bi bi-activity"></i>
				</span>
				Maladies chroniques
			</div>
			<div class="medical-tile__desc" id="desc-maladies">Chargement…</div>
			<div class="medical-tile__mini" id="mini-maladies"></div>
		</button>
	</div>
</section>

{# ========================= MODAL HUB ========================= #}
<div class="modal fade" id="medicalHubModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered">
		<div class="modal-content medical-modal border-0 shadow-lg rounded-4 overflow-hidden">

			<div class="medical-modal__header">
				<div class="d-flex align-items-center gap-3">
					<div class="medical-modal__icon">
						<i class="bi bi-clipboard2-pulse"></i>
					</div>
					<div class="flex-grow-1">
						<div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
							<div>
								<h5 class="mb-0 fw-bold">Hub médical</h5>
								<div class="small opacity-75">Consulter + modifier sans recharger.</div>
							</div>
							<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
						</div>

						<div class="medical-tabs mt-3">
							<ul class="nav nav-pills" id="medicalTabs" role="tablist">
								<li class="nav-item" role="presentation">
									<button class="nav-link active" id="tab-btn-digestif" data-bs-toggle="pill" data-bs-target="#tab-digestif" type="button" role="tab">
										<i class="bi bi-bandaid me-1"></i>
										Digestif
									</button>
								</li>
								<li class="nav-item" role="presentation">
									<button class="nav-link" id="tab-btn-symptomes" data-bs-toggle="pill" data-bs-target="#tab-symptomes" type="button" role="tab">
										<i class="bi bi-heart-pulse me-1"></i>
										Symptômes
									</button>
								</li>
								<li class="nav-item" role="presentation">
									<button class="nav-link" id="tab-btn-maladies" data-bs-toggle="pill" data-bs-target="#tab-maladies" type="button" role="tab">
										<i class="bi bi-activity me-1"></i>
										Maladies
									</button>
								</li>
							</ul>
						</div>

					</div>
				</div>
			</div>

			<div class="modal-body p-0">
				<div
					class="tab-content p-4">

					{# -------- TAB DIGESTIF (dans ce fichier) -------- #}
					<div class="tab-pane fade show active" id="tab-digestif" role="tabpanel">

						<div class="section-head">
							<div>
								<div class="section-kicker text-success">Section</div>
								<h5 class="section-title mb-0">Troubles digestifs</h5>
							</div>

							<div class="d-flex gap-2">
								<button class="btn btn-outline-light rounded-pill px-3" type="button" id="btnEdit-digestif">
									<i class="bi bi-pencil-square me-1"></i>
									Modifier
								</button>
							</div>
						</div>

						<div class="section-card">
							<div class="row g-3 align-items-start">
								<div class="col-lg-8">
									<div class="fw-semibold mb-2">Résumé</div>
									<div class="chips" id="chips-digestif"></div>
									<div class="text-muted small mt-2" id="empty-digestif" style="display:none;">
										Aucune donnée. Clique sur “Modifier” pour compléter.
									</div>
								</div>

								<div class="col-lg-4">
									<div class="mini-panel">
										<div class="mini-panel__title">Conseil UX</div>
										<div class="mini-panel__text">
											Mets “Jamais / Parfois / Souvent” au feeling, tu pourras affiner plus tard.
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="edit-drawer" id="drawer-digestif" style="display:none;">
							<form id="form-digestif" class="edit-form">
								<div class="row g-3">
									{% set dig = [
                    ['aciditeGastrique','Acidité gastrique','bi-fire', ['Jamais','Parfois','Souvent']],
                    ['constipation','Constipation','bi-exclamation-octagon', ['Jamais','Parfois','Souvent']],
                    ['diarrhee','Diarrhée','bi-droplet-half', ['Jamais','Occasionnelle','Souvent']],
                    ['gaz','Gaz','bi-wind', ['Rarement','Parfois','Fréquents']],
                    ['eructation','Éructation','bi-cloud', ['Rarement','Parfois','Souvent']],
                    ['aspectSelles','Aspect des selles','bi-droplet', ['Minces','Épaisses','Discontinues']]
                  ] %}
									{% for f in dig %}
										<div class="col-md-6">
											<div class="choice-card">
												<div class="choice-card__title">
													<i class="bi {{ f[2] }} text-success me-1"></i>
													{{ f[1] }}
												</div>
												<div class="choice-row">
													{% for opt in f[3] %}
														{% set id = 'digestif_' ~ f[0] ~ '_' ~ loop.index %}
														<input class="btn-check" type="radio" name="{{ f[0] }}" id="{{ id }}" value="{{ opt }}" autocomplete="off">
														<label class="btn btn-outline-success rounded-pill px-3 py-2" for="{{ id }}">{{ opt }}</label>
													{% endfor %}
												</div>
											</div>
										</div>
									{% endfor %}
								</div>

								<div class="edit-actions">
									<button type="button" class="btn btn-light rounded-pill px-4" id="btnCancel-digestif">
										Annuler
									</button>
									<button type="button" class="btn btn-success rounded-pill px-4" id="btnSave-digestif">
										<i class="bi bi-check2-circle me-1"></i>
										Enregistrer
									</button>
								</div>
							</form>
						</div>

					</div>

					{# -------- TAB SYMPTOMES + MALADIES (dans leurs fichiers) -------- #}
					{{ include('fiche_client/_composants/_bloc_infos_medicales/_symptomes_generaux.html.twig') }}
					{{ include('fiche_client/_composants/_bloc_infos_medicales/_maladies_chroniques.html.twig') }}

				</div>
			</div>

		</div>
	</div>
</div>

{# ========================= STYLE (UX) ========================= #}
<style>
	.medical-hub {
		border-radius: 24px;
		border: 1px solid rgba(0, 0, 0, .08);
		background: linear-gradient(180deg, rgba(13,110,253,.06), rgba(255,255,255,.85));
		box-shadow: 0 18px 50px rgba(0, 0, 0, .08);
		overflow: hidden;
	}
	.medical-hub__header {
		padding: 20px 20px 16px;
	}
	.medical-hub__icon {
		width: 48px;
		height: 48px;
		border-radius: 16px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(13, 110, 253, .12);
		color: #0d6efd;
		box-shadow: 0 10px 26px rgba(0, 0, 0, .08);
		flex: 0 0 auto;
		font-size: 22px;
	}
	.medical-hub__title {
		font-weight: 900;
		letter-spacing: 0.2px;
	}
	.medical-hub__subtitle {
		color: rgba(0, 0, 0, .55);
		font-size: 0.95rem;
	}
	.medical-hub__open {
		box-shadow: 0 12px 26px rgba(0, 0, 0, .14);
	}

	.medical-progress {
		height: 10px;
		border-radius: 999px;
		overflow: hidden;
		background: rgba(0, 0, 0, .06);
	}
	.medical-progress .progress-bar {
		border-radius: 999px;
	}

	.medical-tiles {
		padding: 0 20px 20px;
		display: grid;
		grid-template-columns: repeat(12, 1fr);
		gap: 14px;
	}
	.medical-tile {
		grid-column: span 4;
		border: 1px solid rgba(0, 0, 0, .08);
		border-radius: 22px;
		background: rgba(255, 255, 255, .85);
		box-shadow: 0 10px 30px rgba(0, 0, 0, .06);
		padding: 16px 16px 14px;
		text-align: left;
		position: relative;
		overflow: hidden;
		transition: 0.18s ease;
	}
	.medical-tile:hover {
		transform: translateY(-2px);
		box-shadow: 0 18px 46px rgba(0, 0, 0, .10);
	}
	.medical-tile__stripe {
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 7px;
		border-radius: 20px 0 0 20px;
	}
	.stripe-success {
		background: linear-gradient(180deg, #20c997, #198754);
	}
	.stripe-primary {
		background: linear-gradient(180deg, #4dabf7, #0d6efd);
	}
	.stripe-danger {
		background: linear-gradient(180deg, #ff6b6b, #dc3545);
	}

	.medical-tile__top {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 10px;
	}
	.medical-tile__badge {
		font-size: 0.78rem;
		padding: 6px 10px;
		border-radius: 999px;
		font-weight: 800;
		letter-spacing: 0.2px;
		border: 1px solid rgba(0, 0, 0, .10);
		background: rgba(0, 0, 0, .03);
	}
	.medical-tile__chev {
		opacity: .55;
	}
	.medical-tile__title {
		font-weight: 900;
		display: flex;
		align-items: center;
		gap: 10px;
	}
	.tile-icon {
		width: 34px;
		height: 34px;
		border-radius: 12px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
	}
	.medical-tile__desc {
		color: rgba(0, 0, 0, .58);
		margin-top: 8px;
		font-size: 0.92rem;
	}
	.medical-tile__mini {
		margin-top: 10px;
		display: flex;
		flex-wrap: wrap;
		gap: 6px;
	}
	.mini-chip {
		font-size: 0.78rem;
		padding: 6px 10px;
		border-radius: 999px;
		background: rgba(13, 110, 253, .08);
		border: 1px solid rgba(13, 110, 253, .14);
		color: #0d6efd;
		font-weight: 700;
	}

	@media(max-width: 992px) {
		.medical-tile {
			grid-column: span 12;
		}
	}

	.medical-modal__header {
		padding: 18px 18px 14px;
		background: linear-gradient(135deg, #111827, #0b1220);
		color: white;
	}
	.medical-modal__icon {
		width: 44px;
		height: 44px;
		border-radius: 16px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(255, 255, 255, .12);
		box-shadow: 0 12px 28px rgba(0, 0, 0, .25);
		font-size: 20px;
	}
	.medical-tabs .nav-link {
		border-radius: 999px;
		font-weight: 900;
		letter-spacing: 0.2px;
		padding: 10px 14px;
		color: rgba(255, 255, 255, .78);
		background: rgba(255, 255, 255, .08);
	}
	.medical-tabs .nav-link.active {
		background: rgba(255, 255, 255, .20);
		color: #fff;
	}

	.section-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 14px;
		flex-wrap: wrap;
		margin-bottom: 14px;
	}
	.section-kicker {
		font-size: 0.78rem;
		font-weight: 900;
		letter-spacing: 0.2px;
		text-transform: uppercase;
		opacity: .75;
	}
	.section-title {
		font-weight: 950;
		letter-spacing: 0.2px;
	}
	.section-card {
		border-radius: 22px;
		border: 1px solid rgba(0, 0, 0, .08);
		background: rgba(255, 255, 255, .92);
		box-shadow: 0 12px 34px rgba(0, 0, 0, .06);
		padding: 16px;
	}
	.chips {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
	}
	.chip {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		border-radius: 999px;
		padding: 8px 12px;
		font-weight: 800;
		font-size: 0.86rem;
		border: 1px solid rgba(0, 0, 0, .10);
		background: rgba(0, 0, 0, .03);
	}
	.chip i {
		opacity: .75;
	}

	.mini-panel {
		border-radius: 20px;
		background: linear-gradient(180deg, rgba(13,110,253,.08), rgba(13,110,253,.04));
		border: 1px solid rgba(13, 110, 253, .18);
		padding: 14px;
	}
	.mini-panel__title {
		font-weight: 950;
		letter-spacing: 0.2px;
	}
	.mini-panel__text {
		color: rgba(0, 0, 0, .58);
		font-size: 0.92rem;
		margin-top: 6px;
	}

	.edit-drawer {
		margin-top: 14px;
		border-radius: 22px;
		border: 1px solid rgba(0, 0, 0, .08);
		background: rgba(255, 255, 255, .92);
		box-shadow: 0 12px 34px rgba(0, 0, 0, .06);
		padding: 16px;
	}
	.choice-card {
		border-radius: 18px;
		border: 1px solid rgba(0, 0, 0, .08);
		background: rgba(0, 0, 0, .02);
		padding: 12px;
	}
	.choice-card__title {
		font-weight: 900;
		margin-bottom: 10px;
	}
	.choice-row {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
	}
	.edit-actions {
		display: flex;
		justify-content: flex-end;
		gap: 10px;
		margin-top: 14px;
	}
</style>

{# ========================= JS (Live UI) ========================= #}
 <script>
(function () {
  const URLS = {
    digestif: {
      show: "{{ path('api_troubles_digestifs_show', {idClient: fiche_client.id}) }}",
      add:  "{{ path('api_digestifs_add', {id: fiche_client.id}) }}",
      edit: "{{ path('api_digestifs_edit', {id: fiche_client.id}) }}"
    },
    symptomes: {
      show: "{{ path('api_symptomes_show', {idClient: fiche_client.id}) }}",
      add:  "{{ path('api_symptomes_add', {id: fiche_client.id}) }}",
      edit: "{{ path('api_symptomes_edit', {id: fiche_client.id}) }}"
    },
    maladies: {
      show: "{{ path('api_maladies_show', {idClient: fiche_client.id}) }}",
      add:  "{{ path('api_maladies_add', {id: fiche_client.id}) }}",
      edit: "{{ path('api_maladies_edit', {id: fiche_client.id}) }}"
    }
  };

  const FIELDS = {
    digestif: [
      ['aciditeGastrique','Acidité', 'bi-fire'],
      ['constipation','Constipation', 'bi-exclamation-octagon'],
      ['diarrhee','Diarrhée', 'bi-droplet-half'],
      ['gaz','Gaz', 'bi-wind'],
      ['eructation','Éructation', 'bi-cloud'],
      ['aspectSelles','Selles', 'bi-droplet']
    ],
    symptomes: [
      ['mauxTete','Maux tête', 'bi-emoji-dizzy'],
      ['mauxNuque','Nuque', 'bi-person-arms-up'],
      ['insomnie','Insomnie', 'bi-moon-stars'],
      ['hemorroides','Hémorroïdes', 'bi-emoji-frown'],
      ['enuresie','Énurésie', 'bi-droplet-half']
    ],
    maladies: [
      ['diabetique','Diabète', 'bi-capsule'],
      ['hypertendu','Hypertension', 'bi-heart-pulse'],
      ['cholesterol','Cholestérol', 'bi-droplet'],
      ['allergieNasale','Allergies', 'bi-wind'],
      ['autreMaladie','Autre', 'bi-three-dots']
    ]
  };

  const state = {
    digestif: { exists:false, data:null },
    symptomes:{ exists:false, data:null },
    maladies: { exists:false, data:null }
  };

  const $ = (id) => document.getElementById(id);

  async function fetchJSON(url) {
    const r = await fetch(url);
    return await r.json();
  }

  function isFilled(section){
    return !!(state[section].exists && state[section].data);
  }

  function computeCompletion(){
    const total = 3;
    const done = ['digestif','symptomes','maladies'].filter(isFilled).length;
    const pct = Math.round((done/total)*100);

    if ($('medicalCompletionText')) $('medicalCompletionText').textContent = `${done}/${total} sections`;
    if ($('medicalCompletionBar')) $('medicalCompletionBar').style.width = `${pct}%`;
  }

  function badgeHTML(exists){
    return exists
      ? `<span class="text-warning-emphasis">Renseigné</span>`
      : `<span class="text-success-emphasis">À compléter</span>`;
  }

  function renderTile(section){
    const exists = isFilled(section);

    const badge = $('badge-'+section);
    if (badge) badge.innerHTML = badgeHTML(exists);

    const desc = $('desc-'+section);
    if (desc) desc.textContent = exists
      ? "Ouvre pour consulter / modifier."
      : "Clique pour compléter rapidement.";

    const mini = $('mini-'+section);
    if (!mini) return;

    mini.innerHTML = '';
    if (!exists) return;

    const data = state[section].data || {};
    const chips = [];

    for (const [key,label] of FIELDS[section]) {
      const v = data[key];
      if (v && String(v).trim() !== '') chips.push(`${label}: ${v}`);
      if (chips.length >= 3) break;
    }

    chips.forEach(t => {
      const span = document.createElement('span');
      span.className = 'mini-chip';
      span.textContent = t;
      mini.appendChild(span);
    });
  }

  function renderChips(section){
    const chipsBox = $('chips-'+section);
    const emptyBox = $('empty-'+section);
    if (!chipsBox) return;

    chipsBox.innerHTML = '';

    if (!isFilled(section)) {
      if (emptyBox) emptyBox.style.display = 'block';
      return;
    }
    if (emptyBox) emptyBox.style.display = 'none';

    const data = state[section].data || {};
    FIELDS[section].forEach(([key,label,icon]) => {
      const v = data[key];
      if (!v || String(v).trim() === '') return;

      const div = document.createElement('div');
      div.className = 'chip';
      div.innerHTML = `<i class="bi ${icon}"></i><span>${label} :</span><strong>${v}</strong>`;
      chipsBox.appendChild(div);
    });

    if (!chipsBox.children.length && emptyBox) emptyBox.style.display = 'block';
  }

  function openDrawer(section, open){
    const drawer = $('drawer-'+section);
    if (!drawer) return;
    drawer.style.display = open ? 'block' : 'none';
  }

  function fillForm(section){
    const form = $('form-'+section);
    if (!form) return;

    form.reset();
    if (!isFilled(section)) {
      // textarea "autreMaladie" doit être vidé si add
      const ta = form.querySelector('textarea[name="autreMaladie"]');
      if (ta) ta.value = '';
      return;
    }

    const data = state[section].data || {};
    Object.keys(data).forEach((k) => {
      const v = data[k];
      if (v == null || v === '') return;

      const radio = form.querySelector(`input[name="${k}"][value="${CSS.escape(String(v))}"]`);
      if (radio) radio.checked = true;

      const ta = form.querySelector(`textarea[name="${k}"]`);
      if (ta) ta.value = v;
    });
  }

  async function refreshSection(section){
    const res = await fetchJSON(URLS[section].show);

    state[section].exists = !!(res.exists && res.data);
    state[section].data = (res.exists && res.data) ? res.data : null;

    renderTile(section);
    renderChips(section);
    computeCompletion();
  }

  async function refreshAll(){
    await Promise.all([
      refreshSection('digestif'),
      refreshSection('symptomes'),
      refreshSection('maladies')
    ]);
  }

  async function saveSection(section){
    const form = $('form-'+section);
    if (!form) return;

    const payload = Object.fromEntries(new FormData(form));
    const url = isFilled(section) ? URLS[section].edit : URLS[section].add;

    const response = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (!result.success) {
      window.buttonSoundError?.('btnSave-'+section);
      alert('Erreur : ' + (result.message ?? 'Erreur serveur'));
      return;
    }

    window.buttonSoundSuccess?.('btnSave-'+section);

    await refreshSection(section);
    openDrawer(section, false);
  }

  // ✅ Câblage des 3 sections (EDIT / CANCEL / SAVE)
  ['digestif','symptomes','maladies'].forEach((section) => {
    const btnEdit = $('btnEdit-'+section);
    const btnCancel = $('btnCancel-'+section);
    const btnSave = $('btnSave-'+section);

    btnEdit?.addEventListener('click', async () => {
      await refreshSection(section);
      fillForm(section);
      openDrawer(section, true);
    });

    btnCancel?.addEventListener('click', () => openDrawer(section, false));
    btnSave?.addEventListener('click', () => saveSection(section));
  });

  // Tiles -> open tab
  document.querySelectorAll('[data-open-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-open-tab');
      const map = { digestif:'tab-btn-digestif', symptomes:'tab-btn-symptomes', maladies:'tab-btn-maladies' };
      $(map[tab])?.click();
    });
  });

  // modal open => refresh all
  $('medicalHubModal')?.addEventListener('show.bs.modal', refreshAll);

  document.addEventListener('DOMContentLoaded', refreshAll);
})();
</script>

