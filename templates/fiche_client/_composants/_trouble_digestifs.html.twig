{# --------------------------------------------- #}
{#  Troubles digestifs - fiche patient          #}
{#  Th√®me Bootswatch : Lux                      #}
{# --------------------------------------------- #}

<!-- üåà LOGIQUE BOUTON DYNAMIQUE -->
 <script>
document.addEventListener("DOMContentLoaded", function () {

    const clientId = {{ fiche_client.id }};
    const button = document.getElementById('btnTroublesDigestifs');

    fetch(`/api/troubles-digestifs/${clientId}`)
        .then(res => res.json())
        .then(data => {

            if (!data.exists) {
                button.innerHTML = `<i class="bi bi-plus-circle"></i> Ajouter troubles digestifs`;
                button.classList.remove('btn-warning');
                button.classList.add('btn-success');

            } else {
                button.innerHTML = `<i class="bi bi-pencil-square"></i> Modifier troubles digestifs`;
                button.classList.remove('btn-success');
                button.classList.add('btn-warning');
            }

        });
});
</script>

<!-- üß© CARTE REGROUPEMENT -->
	<div class="card shadow-sm border-0 mb-4"> <div class="card-body">

		<h5 class="fw-bold mb-3">Autres informations</h5>

		<div
			class="row g-3">

			{# üåø Troubles digestifs ‚Äî vert #}
			<div class="col-md-4">
				<div class="alert alert-success shadow-sm rounded-4 p-4 clickable-alert" role="alert" data-bs-toggle="modal" {% if fiche_client.troublesDigestifs %} data-bs-target="#modalDigestif" {% else %} data-bs-target="#modalAddDigestif" {% endif %} style="cursor:pointer;">

					<div class="d-flex justify-content-between">
						<div>
							<h5 class="fw-bold mb-1">
								<i class="bi bi-bandaid me-2"></i>
								Troubles digestifs
							</h5>
							<p class="mb-0 small opacity-75">
								Ajouter ou modifier les troubles digestifs du patient.
							</p>
						</div>

						<span class="ms-3">
							<i class="bi bi-chevron-right fs-4 opacity-50"></i>
						</span>
					</div>

				</div>
			</div>

			{# üîµ Sympt√¥mes / douleurs ‚Äî bleu #}
			{# üîµ Sympt√¥mes / douleurs ‚Äî bleu #}
			<div class="col-md-4">
				<div class="alert alert-primary shadow-sm rounded-4 p-4 clickable-alert" role="alert" style="cursor:pointer;" data-bs-toggle="modal" {% if fiche_client.symptomesGeneraux %} data-bs-target="#modalSymptomesGeneraux" {% else %} data-bs-target="#modalAddSymptomesGeneraux" {% endif %}>

					<div class="d-flex justify-content-between">
						<div>
							<h5 class="fw-bold mb-1">
								<i class="bi bi-body-text me-2"></i>
								Sympt√¥mes & douleurs
							</h5>
							<p class="mb-0 small opacity-75">
								Renseigner les douleurs, zones touch√©es et intensit√©.
							</p>
						</div>

						<span class="ms-3">
							<i class="bi bi-chevron-right fs-4 opacity-50"></i>
						</span>
					</div>

				</div>
			</div>


			{# üî¥ Maladies chroniques ‚Äî rouge #}
			{# üî¥ Maladies chroniques ‚Äî rouge #}
			<div class="col-md-4">
				<div class="alert alert-danger shadow-sm rounded-4 p-4 clickable-alert" role="alert" style="cursor:pointer;" data-bs-toggle="modal" {% if fiche_client.maladiesChroniques %} data-bs-target="#modalMaladiesChroniques" {% else %} data-bs-target="#modalAddMaladiesChroniques" {% endif %}>

					<div class="d-flex justify-content-between">

						<div>
							<h5 class="fw-bold mb-1">
								<i class="bi bi-activity me-2"></i>
								Maladies chroniques
							</h5>

							<p class="mb-0 small opacity-75">
								Ajouter ou consulter les maladies suivies.
							</p>
						</div>

						<span class="ms-3">
							<i class="bi bi-chevron-right fs-4 opacity-50"></i>
						</span>

					</div>

				</div>
			</div>


		</div>
	</div>


	<!-- üöÄ MODAL AJOUT / √âDITION -->
	<div class="modal fade" id="modalAddDigestif" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">

				<div class="modal-header bg-success text-white">
					<h5 class="modal-title">
						<i class="bi bi-plus-circle"></i>
						Ajouter / modifier les troubles digestifs
					</h5>
					<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">

					<form
						id="digestifForm" class="mt-2">

						{# üî∂ TEMPLATE BLOC #}
						{% macro bloc(icon, title, name, options) %}
							<div class="p-3 mb-4 bg-light border rounded-3 shadow-sm">
								<h5 class="fw-bold text-primary mb-2">
									<i class="bi {{ icon }}"></i>
									{{ title }}
								</h5>

								<div class="d-flex flex-wrap gap-3">
									{% for opt in options %}
										<div class="form-check form-check-inline">
											<input class="form-check-input" type="radio" name="{{ name }}" value="{{ opt }}" id="{{ name }}_{{ loop.index }}">
											<label class="form-check-label" for="{{ name }}_{{ loop.index }}">
												{{ opt }}
											</label>
										</div>
									{% endfor %}
								</div>
							</div>
						{% endmacro %}

						{{ _self.bloc("bi-fire", "Acidit√© gastrique", "aciditeGastrique", ["Jamais","Parfois","Souvent"]) }}
						{{ _self.bloc("bi-exclamation-octagon", "Constipation", "constipation", ["Jamais","Parfois","Souvent"]) }}
						{{ _self.bloc("bi-water", "Diarrh√©e", "diarrhee", ["Jamais","Occasionnelle","Souvent"]) }}
						{{ _self.bloc("bi-wind", "Gaz", "gaz", ["Rarement","Parfois","Fr√©quents"]) }}
						{{ _self.bloc("bi-cloud", "√âructation", "eructation", ["Rarement","Parfois","Souvent"]) }}
						{{ _self.bloc("bi-droplet-half", "Aspect des selles", "aspectSelles", ["Minces","√âpaisses","Discontinues"]) }}

					</form>

				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>

					<button class="btn btn-success" id="btnSaveDigestif">
						<i class="bi bi-check-circle"></i>
						Enregistrer
					</button>
				</div>

			</div>
		</div>
	</div>


	<!-- üíæ JS SAUVEGARDE (ADD / EDIT) -->
 <script>
document.getElementById("btnSaveDigestif").addEventListener("click", async () => {

    const form = document.getElementById("digestifForm");
    const data = Object.fromEntries(new FormData(form));
    const pop  = document.getElementById("popupSuccess");

    // Choix URL : ajout ou √©dition
    const url = "{{ fiche_client.troublesDigestifs
        ? path('api_digestifs_edit', {id: fiche_client.id})
        : path('api_digestifs_add', {id: fiche_client.id})
    }}";

    const response = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.success) {

        // üîä Succ√®s
        buttonSoundSuccess('btnSaveDigestif');

        // ‚úî FERMETURE AUTOMATIQUE DE LA MODAL
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalAddDigestif"));
        if (modal) modal.hide();

        // üéâ POPUP SUCC√àS
        pop.style.display = "block";
        pop.innerHTML = `
<div class="d-flex align-items-start">
    <i class="bi bi-check-circle-fill fs-1 text-white bg-success p-2 rounded-circle me-3"></i>

    <div>
        <h5 class="fw-bold mb-1">Mise √† jour avec succ√®s ! üéâ</h5>
        <p class="mb-1">Les troubles digestifs du patient ont √©t√© enregistr√©s.</p>
        <small class="text-muted d-block mt-2">Merci ‚úîÔ∏è</small>
    </div>

    <button type="button" class="btn-close" onclick="popupSuccess.style.display='none';"></button>
</div>`;

    } else {
        buttonSoundError('btnSaveDigestif');
        alert("Erreur : " + (result.message ?? 'Erreur serveur'));
    }
});
</script>




<!-- üü° MODAL DE VISUALISATION ‚Äì CHARGEMENT DYNAMIQUE -->
<div class="modal fade" id="modalDigestif" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div
			class="modal-content rounded-4 shadow-lg">

			<!-- ---------- HEADER ---------- -->
			<div class="modal-header bg-warning text-white rounded-top-4">
				<h3 class="modal-title d-flex align-items-center fw-bold">
					<i class="bi bi-bandaid-fill me-2 fs-3"></i>
					Troubles digestifs
				</h3>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<!-- ---------- BODY ---------- -->
			<div class="modal-body py-4 px-4">

				<div
					class="row g-4">

					<!-- Acidit√© -->
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-danger bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-fire me-1 text-danger"></i>
								Acidit√© gastrique
							</p>
							<p class="fs-5 fw-bold" id="view-aciditeGastrique">-</p>
						</div>
					</div>

					<!-- Constipation -->
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-warning bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-dash-circle-fill me-1 text-warning"></i>
								Constipation
							</p>
							<p class="fs-5 fw-bold" id="view-constipation">-</p>
						</div>
					</div>

					<!-- Diarrh√©e -->
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-primary bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-droplet-half me-1 text-primary"></i>
								Diarrh√©e
							</p>
							<p class="fs-5 fw-bold" id="view-diarrhee">-</p>
						</div>
					</div>

					<!-- Gaz -->
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-success bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-wind me-1 text-success"></i>
								Gaz
							</p>
							<p class="fs-5 fw-bold" id="view-gaz">-</p>
						</div>
					</div>

					<!-- √âructation -->
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-info bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-chat-dots-fill me-1 text-info"></i>
								√âructation
							</p>
							<p class="fs-5 fw-bold" id="view-eructation">-</p>
						</div>
					</div>

					<!-- Aspect des selles -->
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-secondary bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-droplet-fill me-1 text-secondary"></i>
								Aspect des selles
							</p>
							<p class="fs-5 fw-bold" id="view-aspectSelles">-</p>
						</div>
					</div>

				</div>

				<!-- ---------- BUTTON MODIFIER ---------- -->
				<div class="text-end mt-4">
					<button class="btn btn-warning btn-lg px-4 shadow-sm fw-bold" id="btnEditDigestif" data-bs-target="#modalAddDigestif" data-bs-toggle="modal" data-bs-dismiss="modal">
						<i class="bi bi-pencil-square me-1"></i>
						Modifier
					</button>
				</div>

			</div>

		</div>
	</div>
</div>

<!-- üöÄ JS : FETCH AUTOMATIQUE √Ä L‚ÄôOUVERTURE -->
 <script>
document.getElementById('modalDigestif')
    .addEventListener('show.bs.modal', async () => {

    try {
        const response = await fetch("{{ path('api_troubles_digestifs_show', {idClient: fiche_client.id}) }}");
        const result   = await response.json();

        if (!result.exists || !result.data) {
            return;
        }

        const d = result.data;

        const fields = [
            'aciditeGastrique',
            'constipation',
            'diarrhee',
            'gaz',
            'eructation',
            'aspectSelles'
        ];

        fields.forEach(field => {
            const el = document.getElementById(`view-${field}`);
            if (el) {
                el.textContent = d[field] ?? '-';
            }
        });

    } catch (e) {
        console.error('Erreur chargement troubles digestifs', e);
    }
});
</script>




	<!-- ‚úèÔ∏è JS PR√â-REMPLISSAGE POUR √âDITION -->
	 <script>
	document.getElementById("btnEditDigestif")?.addEventListener("click", async () => {
	
		const response = await fetch("{{ path('api_troubles_digestifs_show', {idClient: fiche_client.id}) }}");
		const data = await response.json();
	
		if (!data.exists || !data.data) {
			return;
		}
	
		const values = data.data;
	
		for (const key in values) {
			const value = values[key];
	
			if (value) {
				const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
				if (radio) {
					radio.checked = true;
				}
			}
		}
	});
	</script>
