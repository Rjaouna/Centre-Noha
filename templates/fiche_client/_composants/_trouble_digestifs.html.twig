{# --------------------------------------------- #}
{#  Troubles digestifs - fiche patient          #}
{#  ThÃ¨me Bootswatch : Lux                      #}
{# --------------------------------------------- #}

<!-- ðŸŒˆ LOGIQUE BOUTON DYNAMIQUE -->
 <script>
document.addEventListener("DOMContentLoaded", function () {

    const clientId = {{ fiche_client.id }};
    const button = document.getElementById('btnTroublesDigestifs');

    fetch(`/api/troubles-digestifs/${clientId}`)
        .then(res => res.json())
        .then(data => {

            if (!data.exists) {
                button.innerHTML = `<i class="bi bi-plus-circle"></i> Ajouter troubles digestifs`;
                button.classList.remove('btn-warning');
                button.classList.add('btn-success');

            } else {
                button.innerHTML = `<i class="bi bi-pencil-square"></i> Modifier troubles digestifs`;
                button.classList.remove('btn-success');
                button.classList.add('btn-warning');
            }

        });
});
</script>

<!-- ðŸ§© CARTE REGROUPEMENT -->
	<div class="card shadow-sm border-0 mb-4"> <div class="card-body">

		<h5 class="fw-bold mb-3">Autres informations</h5>

<div
	class="row g-3">

	{# ðŸŒ¿ Troubles digestifs â€” vert #}
	<div class="col-md-4">
		<div class="alert alert-success shadow-sm rounded-4 p-4 clickable-alert" role="alert" data-bs-toggle="modal" {% if fiche_client.troublesDigestifs %} data-bs-target="#modalDigestif" {% else %} data-bs-target="#modalAddDigestif" {% endif %} style="cursor:pointer;">

			<div class="d-flex justify-content-between">
				<div>
					<h5 class="fw-bold mb-1">
						<i class="bi bi-bandaid me-2"></i>
						Troubles digestifs
					</h5>
					<p class="mb-0 small opacity-75">
						Ajouter ou modifier les troubles digestifs du patient.
					</p>
				</div>

				<span class="ms-3">
					<i class="bi bi-chevron-right fs-4 opacity-50"></i>
				</span>
			</div>

		</div>
	</div>

	{# ðŸ”µ SymptÃ´mes / douleurs â€” bleu #}
{# ðŸ”µ SymptÃ´mes / douleurs â€” bleu #}
<div class="col-md-4">
	<div class="alert alert-primary shadow-sm rounded-4 p-4 clickable-alert" role="alert" style="cursor:pointer;" data-bs-toggle="modal" {% if fiche_client.symptomesGeneraux %} data-bs-target="#modalSymptomesGeneraux" {% else %} data-bs-target="#modalAddSymptomesGeneraux" {% endif %}>

		<div class="d-flex justify-content-between">
			<div>
				<h5 class="fw-bold mb-1">
					<i class="bi bi-body-text me-2"></i>
					SymptÃ´mes & douleurs
				</h5>
				<p class="mb-0 small opacity-75">
					Renseigner les douleurs, zones touchÃ©es et intensitÃ©.
				</p>
			</div>

			<span class="ms-3">
				<i class="bi bi-chevron-right fs-4 opacity-50"></i>
			</span>
		</div>

	</div>
</div>





	{# ðŸ”´ Maladies chroniques â€” rouge #}
{# ðŸ”´ Maladies chroniques â€” rouge #}
<div class="col-md-4">
	<div class="alert alert-danger shadow-sm rounded-4 p-4 clickable-alert"
		 role="alert"
		 style="cursor:pointer;"
		 data-bs-toggle="modal"
		 {% if fiche_client.maladiesChroniques %}
			 data-bs-target="#modalMaladiesChroniques"
		 {% else %}
			 data-bs-target="#modalAddMaladiesChroniques"
		 {% endif %}
	>

		<div class="d-flex justify-content-between">

			<div>
				<h5 class="fw-bold mb-1">
					<i class="bi bi-activity me-2"></i>
					Maladies chroniques
				</h5>

				<p class="mb-0 small opacity-75">
					Ajouter ou consulter les maladies suivies.
				</p>
			</div>

			<span class="ms-3">
				<i class="bi bi-chevron-right fs-4 opacity-50"></i>
			</span>

		</div>

	</div>
</div>




	</div>
</div>


<!-- ðŸš€ MODAL AJOUT / Ã‰DITION -->
<div class="modal fade" id="modalAddDigestif" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">

			<div class="modal-header bg-success text-white">
				<h5 class="modal-title">
					<i class="bi bi-plus-circle"></i>
					Ajouter / modifier les troubles digestifs
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<form
					id="digestifForm" class="mt-2">

					{# ðŸ”¶ TEMPLATE BLOC #}
					{% macro bloc(icon, title, name, options) %}
						<div class="p-3 mb-4 bg-light border rounded-3 shadow-sm">
							<h5 class="fw-bold text-primary mb-2">
								<i class="bi {{ icon }}"></i>
								{{ title }}
							</h5>

							<div class="d-flex flex-wrap gap-3">
								{% for opt in options %}
									<div class="form-check form-check-inline">
										<input class="form-check-input" type="radio" name="{{ name }}" value="{{ opt }}" id="{{ name }}_{{ loop.index }}">
										<label class="form-check-label" for="{{ name }}_{{ loop.index }}">
											{{ opt }}
										</label>
									</div>
								{% endfor %}
							</div>
						</div>
					{% endmacro %}

					{{ _self.bloc("bi-fire", "AciditÃ© gastrique", "aciditeGastrique", ["Jamais","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-exclamation-octagon", "Constipation", "constipation", ["Jamais","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-water", "DiarrhÃ©e", "diarrhee", ["Jamais","Occasionnelle","Souvent"]) }}
					{{ _self.bloc("bi-wind", "Gaz", "gaz", ["Rarement","Parfois","FrÃ©quents"]) }}
					{{ _self.bloc("bi-cloud", "Ã‰ructation", "eructation", ["Rarement","Parfois","Souvent"]) }}
					{{ _self.bloc("bi-droplet-half", "Aspect des selles", "aspectSelles", ["Minces","Ã‰paisses","Discontinues"]) }}

				</form>

			</div>

			<div class="modal-footer">
				<button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>

				<button class="btn btn-success" id="btnSaveDigestif">
					<i class="bi bi-check-circle"></i>
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


<!-- ðŸ’¾ JS SAUVEGARDE (ADD / EDIT) -->
 <script>
document.getElementById("btnSaveDigestif").addEventListener("click", async () => {

    const form = document.getElementById("digestifForm");
    const data = Object.fromEntries(new FormData(form));

    // Choix URL : ajout si pas de donnÃ©es, Ã©dition sinon
    const url = "{{ fiche_client.troublesDigestifs
        ? path('api_digestifs_edit', {id: fiche_client.id})
        : path('api_digestifs_add', {id: fiche_client.id})
    }}";

    const response = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.success) {
showFlashMessage("Troubles digestifs enregistrÃ©s !", "success");



        location.reload();
    } else {
        alert("Erreur : " + (result.message ?? 'Erreur serveur'));
    }
});
</script>


<!-- ðŸŸ¡ MODAL DE VISUALISATION -->
<div class="modal fade" id="modalDigestif" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div
			class="modal-content rounded-4 shadow-lg">

			{# ---------- HEADER ---------- #}
			<div class="modal-header bg-warning text-white rounded-top-4">
				<h3 class="modal-title d-flex align-items-center fw-bold">
					<i class="bi bi-bandaid-fill me-2 fs-3"></i>
					Troubles digestifs
				</h3>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			{# ---------- BODY ---------- #}
			<div class="modal-body py-4 px-4">

				{% set d = fiche_client.troublesDigestifs %}

				<div
					class="row g-4">

					{# ----- AciditÃ© ------ #}
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-danger bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-fire me-1 text-danger"></i>
								AciditÃ© gastrique
							</p>
							<p class="fs-5 fw-bold">{{ d.aciditeGastrique ?? "-" }}</p>
						</div>
					</div>

					{# ----- Constipation ------ #}
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-warning bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-dash-circle-fill me-1 text-warning"></i>
								Constipation
							</p>
							<p class="fs-5 fw-bold">{{ d.constipation ?? "-" }}</p>
						</div>
					</div>

					{# ----- DiarrhÃ©e ------ #}
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-primary bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-droplet-half me-1 text-primary"></i>
								DiarrhÃ©e
							</p>
							<p class="fs-5 fw-bold">{{ d.diarrhee ?? "-" }}</p>
						</div>
					</div>

					{# ----- Gaz ------ #}
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-success bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-wind me-1 text-success"></i>
								Gaz
							</p>
							<p class="fs-5 fw-bold">{{ d.gaz ?? "-" }}</p>
						</div>
					</div>

					{# ----- Ã‰ructation ------ #}
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-info bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-chat-dots-fill me-1 text-info"></i>
								Ã‰ructation
							</p>
							<p class="fs-5 fw-bold">{{ d.eructation ?? "-" }}</p>
						</div>
					</div>

					{# ----- Aspect des selles ------ #}
					<div class="col-md-4">
						<div class="p-3 rounded-4 border-start border-4 border-secondary bg-light shadow-sm h-100">
							<p class="text-secondary fw-semibold mb-1">
								<i class="bi bi-droplet-fill me-1 text-secondary"></i>
								Aspect des selles
							</p>
							<p class="fs-5 fw-bold">{{ d.aspectSelles ?? "-" }}</p>
						</div>
					</div>

				</div>

				{# ---------- BUTTON MODIFIER ---------- #}
				<div class="text-end mt-4">
					<button class="btn btn-warning btn-lg px-4 shadow-sm fw-bold" id="btnEditDigestif" data-bs-target="#modalAddDigestif" data-bs-toggle="modal" data-bs-dismiss="modal">

						<i class="bi bi-pencil-square me-1"></i>
						Modifier
					</button>
				</div>

			</div>

		</div>
	</div>
</div>




<!-- âœï¸ JS PRÃ‰-REMPLISSAGE POUR Ã‰DITION -->
 <script>
document.getElementById("btnEditDigestif")?.addEventListener("click", async () => {

	const response = await fetch("{{ path('api_troubles_digestifs_show', {idClient: fiche_client.id}) }}");
	const data = await response.json();

	if (!data.exists || !data.data) {
		return;
	}

	const values = data.data;

	for (const key in values) {
		const value = values[key];

		if (value) {
			const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
			if (radio) {
				radio.checked = true;
			}
		}
	}
});
</script>

