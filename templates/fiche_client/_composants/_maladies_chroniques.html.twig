{# --------------------------------------------- #}
{#  Maladies Chroniques - fiche patient          #}
{# --------------------------------------------- #}



{# ðŸŸ¦ MODAL AJOUT / Ã‰DITION #}
<div class="modal fade" id="modalAddMaladiesChroniques" tabindex="-1" aria-hidden="true">


	<div class="modal-dialog modal-lg">
		<div class="modal-content">

			<div class="modal-header bg-danger text-white">
				<h5 class="modal-title">
					<i class="bi bi-plus-circle"></i>
					Ajouter / modifier</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body">

				<form id="maladiesForm">

					{% macro bloc(title, name, options) %}
						<div class="p-3 mb-4 bg-light border rounded-3 shadow-sm">
							<h5 class="fw-bold mb-2 text-danger">
								<i class="bi bi-capsule"></i>
								{{ title }}
							</h5>
							<div class="d-flex flex-wrap gap-3">
								{% for opt in options %}
									<div class="form-check form-check-inline">
										<input type="radio" class="form-check-input" name="{{ name }}" value="{{ opt }}" id="{{ name }}_{{ loop.index }}">
										<label for="{{ name }}_{{ loop.index }}" class="form-check-label">{{ opt }}</label>
									</div>
								{% endfor %}
							</div>
						</div>
					{% endmacro %}

					{{ _self.bloc("DiabÃ¨te", "diabetique", ["Oui","Non"]) }}
					{{ _self.bloc("Hypertension", "hypertendu", ["Oui","Non"]) }}
					{{ _self.bloc("CholestÃ©rol", "cholesterol", ["Oui","Non"]) }}
					{{ _self.bloc("Allergies nasales", "allergieNasale", ["Jamais","Parfois","Souvent"]) }}

					<div class="mb-3">
						<label class="form-label fw-bold">Autre maladie</label>
						<textarea name="autreMaladie" class="form-control" rows="3"></textarea>
					</div>

				</form>

			</div>

			<div class="modal-footer">
				<button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
				<button class="btn btn-danger" id="btnSaveMaladies">
					<i class="bi bi-check-circle"></i>
					Enregistrer</button>
			</div>

		</div>
	</div>
</div>


<!-- ðŸŸ© MODAL â€” VISUALISATION (DYNAMIQUE) -->

<div class="modal fade" id="modalMaladiesChroniques" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
<div class="modal-content rounded-4 shadow-lg">


<!-- HEADER -->

			<div class="modal-header bg-danger text-white rounded-top-4">
				<h3 class="modal-title">
					<i class="bi bi-activity me-2"></i>
Maladies chroniques</h3>

				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

<!-- BODY -->
<div class="modal-body py-4 px-4">


<!-- CONTENU DYNAMIQUE -->
<div id="maladiesContent">


<div class="row g-4">


<!-- DiabÃ¨te -->
<div class="col-md-4">

<div class="p-3 rounded-4 border-start border-4 border-danger bg-light shadow-sm h-100">
	<p class="text-secondary fw-semibold mb-1">DiabÃ¨te</p>
	<p class="fs-5 fw-bold" id="view-diabetique">-</p>
</div></div>


<!-- Hypertension -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-warning bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">Hypertension</p>
		<p class="fs-5 fw-bold" id="view-hypertendu">-</p>
	</div>
</div>


<!-- CholestÃ©rol -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-primary bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">CholestÃ©rol</p>
		<p class="fs-5 fw-bold" id="view-cholesterol">-</p>
	</div>
</div>

<!-- Allergies nasales -->
<div class="col-md-4">
	<div class="p-3 rounded-4 border-start border-4 border-info bg-light shadow-sm h-100">
		<p class="text-secondary fw-semibold mb-1">Allergies nasales</p>
		<p class="fs-5 fw-bold" id="view-allergieNasale">-</p>
	</div>
</div>

<!-- Autre maladie -->

						<div class="col-12">
							<div class="p-3 rounded-4 border-start border-4 border-secondary bg-light shadow-sm">
								<p class="text-secondary fw-semibold mb-1">Autre maladie</p>
<p class="fs-5 fw-bold" id="view-autreMaladie">-</p>

							</div>
						</div>

					</div>

<!-- BOUTON MODIFIER -->

					<div class="text-end mt-4">
						<button class="btn btn-danger btn-lg px-4" id="btnEditMaladies" data-bs-target="#modalAddMaladiesChroniques" data-bs-toggle="modal" data-bs-dismiss="modal">
							<i class="bi bi-pencil-square me-1"></i>
							Modifier
						</button>
					</div>

</div>

<!-- FALLBACK SI AUCUNE DONNÃ‰E -->
<div id="maladiesEmpty" class="text-center text-muted d-none">
	Aucune maladie chronique enregistrÃ©e.
</div>


			</div>

		</div>
	</div>
</div>

<!-- ðŸš€ JS â€” FETCH Ã€ Lâ€™OUVERTURE -->
 <script>
document.getElementById('modalMaladiesChroniques')
    .addEventListener('show.bs.modal', async () => {

    const content = document.getElementById('maladiesContent');
    const empty   = document.getElementById('maladiesEmpty');

    try {
        const response = await fetch("{{ path('api_maladies_show', {idClient: fiche_client.id}) }}");
        const result   = await response.json();

        if (!result.exists || !result.data) {
            content.classList.add('d-none');
            empty.classList.remove('d-none');
            return;
        }

        content.classList.remove('d-none');
        empty.classList.add('d-none');

        const m = result.data;

        const fields = [
            'diabetique',
            'hypertendu',
            'cholesterol',
            'allergieNasale',
            'autreMaladie'
        ];

        fields.forEach(field => {
            const el = document.getElementById(`view-${field}`);
            if (el) {
                el.textContent = m[field] ?? '-';
            }
        });

    } catch (e) {
        console.error('Erreur chargement maladies chroniques', e);
    }
});
</script>



{# JS : PrÃ©-remplissage en Ã©dition #}
 <script>
document.getElementById("btnEditMaladies")?.addEventListener("click", async () => {

	const response = await fetch("{{ path('api_maladies_show', {idClient: fiche_client.id}) }}");
	const data = await response.json();


	if (!data.exists || !data.data) return;

	const values = data.data;

	for (const key in values) {
		const value = values[key];
		if (!value) continue;

		const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
		if (radio) radio.checked = true;

		if (key === "autreMaladie") {
			document.querySelector('textarea[name="autreMaladie"]').value = value;
		}
	}
});
</script>


{# JS : Enregistrement #}
 <script>
document.getElementById("btnSaveMaladies").addEventListener("click", async () => {

    const form = document.getElementById("maladiesForm");
    const data = Object.fromEntries(new FormData(form));
    const pop  = document.getElementById("popupSuccess");

    const url = "{{ fiche_client.maladiesChroniques
        ? path('api_maladies_edit', {id: fiche_client.id})
        : path('api_maladies_add', {id: fiche_client.id})
    }}";

    const response = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.success) {

        // ðŸ”Š Son validation
        buttonSoundSuccess("btnSaveMaladies");

        // ðŸ”’ Fermeture automatique de la modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalAddMaladiesChroniques"));
        if (modal) modal.hide();

        // ðŸŽ‰ Popup succÃ¨s
        pop.style.display = "block";
        pop.innerHTML = `
<div class="d-flex align-items-start">
	<i class="bi bi-check-circle-fill fs-1 text-white bg-success p-2 rounded-circle me-3"></i>

	<div>
		<h5 class="fw-bold mb-1 text-light">Mise Ã  jour avec succÃ¨s !</h5>
		<p class="mb-1 text-light">Les maladies chroniques ont Ã©tÃ© enregistrÃ©es.</p>

	</div>

	<button type="button" class="btn-close" onclick="document.getElementById('popupSuccess').style.display='none';"></button>
</div>
        `;
    } 
    else {
        alert("Erreur : " + (result.message ?? "Erreur serveur"));
    }
});
</script>



