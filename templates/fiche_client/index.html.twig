{# templates/fiche_client/index.html.twig (exemple) #}
{% extends 'base.html.twig' %}

{% block title %}Gestion des patients
{% endblock %}

{% block body %}

	{# ================= HEADER ================= #}
	<div class="mt-4">

		{% embed '_partials/_page_header.html.twig' with {
      icon: 'bi bi-people-fill',
      title: 'Gestion des patients',
      subtitle: 'Suivi médical & salle d’attente'
    } %}
			{% block header_actions_left %}
				<span class="action-icon bg-primary" role="button" data-bs-toggle="modal" data-bs-target="#modalAddClient" title="Nouveau patient">
					<i class="bi bi-person-plus"></i>
				</span>
			{% endblock %}
		{% endembed %}

		{# ================= TABLE ================= #}
		<div class="card shadow-sm border-0 rounded-4 mt-3">
			<div class="card-body px-4">
				<table id="patientsTable" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>Patient</th>
							<th>Ville</th>
							<th>Téléphone</th>
							<th>Âge</th>
							<th>Maladie</th>
							<th>Salle</th>
							<th class="text-center">Actions</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>

	</div>

	{# ================= MODALS ================= #}
	{% include 'home/_modals/_add_patient.html.twig' %}

	{# ===== MODAL NOTE ARRIVÉE SALLE ===== #}
	{{ include('fiche_client/_composants/_choix_appel_waiting_room.html.twig') }}

{% endblock %}

{% block javascripts %}
	{{ parent() }}

	{# ⚠️ Décommente seulement si pas déjà dans base.html.twig #}
	{#
	   <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
#}

	 <script>
	  (function () {
	    let patientsDT = null;
	    let wrModal = null;
	    let currentPatientId = null;
	    let refreshTimer = null;
	
	    // ✅ Appel safe au loader GLOBAL (sans le redéfinir ici)
	    function uiShowLoader(text = "Chargement…") {
	      if (typeof window.showLoader === 'function') window.showLoader(text);
	    }
	    function uiHideLoader() {
	      if (typeof window.hideLoader === 'function') window.hideLoader();
	    }
	
	    async function safeJsonFetch(url, options = {}) {
	      const r = await fetch(url, options);
	      const t = await r.text();
	      let j = {};
	      try { j = JSON.parse(t); } catch(e) {}
	      if (!r.ok) throw new Error(j.message ?? "Erreur serveur");
	      return j;
	    }
	
	    function raw(s){ return (s ?? "").toString().trim().toUpperCase(); }
	
	    function badgeSalle(row) {
	      if (!row.wrId || raw(row.wrStatut) === 'TERMINE')
	        return `<span class="badge bg-light text-dark rounded-pill">Hors salle</span>`;
	
	      const map = {
	        EN_ATTENTE: 'bg-warning text-dark',
	        APPELE: 'bg-primary',
	        EN_CONSULTATION: 'bg-success',
	        ABSENT: 'bg-danger'
	      };
	      const cls = map[raw(row.wrStatut)] ?? 'bg-dark';
	      return `<span class="badge ${cls} rounded-pill">${row.wrStatut}</span>`;
	    }
	
	    function initPatientsTable() {
	      uiShowLoader("Chargement des patients…");
	
	      // ✅ sécurité : DataTables est-il chargé ?
	      if (!window.jQuery || !window.$ || !$.fn || !$.fn.DataTable) {
	        console.error("jQuery/DataTables non chargé. Vérifie base.html.twig.");
	        uiHideLoader();
	        return;
	      }
	
	      // ✅ destroy si déjà initialisé
	      if ($.fn.DataTable.isDataTable('#patientsTable')) {
	        $('#patientsTable').DataTable().clear().destroy();
	      }
	
	      patientsDT = $('#patientsTable').DataTable({
	        responsive: true,
	        processing: false,
	        ajax: { url: "{{ path('app_fiche_client_ajax') }}", dataSrc: 'data' },
	        order: [[0,'desc']],
	        pageLength: 10,
	        lengthChange: false,
	        language: { url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json' },
	
	        columns: [
	          { data:'id', className:'fw-bold' },
	
	          { data:null, render: r => `
	            <strong>${r.nom} ${r.prenom ?? ''}</strong>
	            ${r.isNew ? '<span class="badge bg-success ms-2">Nouveau</span>' : ''}
	          `},
	
	          { data:'ville', defaultContent:'—' },
	
	          { data:'telephone', render:t =>
	            t ? `<a href="tel:${t}" class="text-primary fw-semibold">${t}</a>` : '—'
	          },
	
	          { data:'age', render:a => a ? `${a} ans` : '—' },
	
	          { data:'maladie', render:m =>
	            `<span class="badge bg-info bg-opacity-75 rounded-pill">${m ?? '—'}</span>`
	          },
	
	          { data:null, render: r => badgeSalle(r) },
	
	          { data:null, orderable:false, className:'text-center', render:r => {
	            const url = "{{ path('app_fiche_client_show', {'id':'ID'}) }}".replace('ID', r.id);
	            const inRoom = r.wrId && raw(r.wrStatut) !== 'TERMINE';
	
	            return `
	              <div class="d-flex justify-content-center gap-2">
	                <a href="${url}" class="btn btn-sm rounded-pill btn-outline-primary">
	                  <i class="bi bi-eye"></i>
	                </a>
	
	                ${!inRoom ? `
	                  <button class="btn btn-sm rounded-pill btn-warning text-dark js-arrive-wr"
	                          data-patient-id="${r.id}">
	                    <i class="bi bi-telephone-fill"></i>
	                  </button>` : `
	                  <span class="badge bg-warning text-dark rounded-pill px-3">
	                    <i class="bi bi-hourglass-split"></i>
	                  </span>`
	                }
	              </div>
	            `;
	          }}
	        ]
	      });
	
	      // ✅ Loader global sur toutes les requêtes DataTables
	      $('#patientsTable')
	        .on('preXhr.dt', () => uiShowLoader("Chargement des patients…"))
	        .on('xhr.dt', () => uiHideLoader())
	        .on('error.dt', () => uiHideLoader());
	
	      // ✅ Auto-refresh toutes les 5 secondes (lancé après l'init)
	      refreshTimer = setInterval(() => {
	        if (patientsDT) patientsDT.ajax.reload(null, false);
	      }, 5000);
	
	      // ✅ stop timer quand on quitte la page (évite refresh fantôme)
	      window.addEventListener('pagehide', () => {
	        if (refreshTimer) clearInterval(refreshTimer);
	        refreshTimer = null;
	      }, { once: true });
	    }
	
	    function initArriveModal() {
	      const modalEl = document.getElementById('wrNoteModal');
	      if (!modalEl) return;
	
	      wrModal = bootstrap.Modal.getOrCreateInstance(modalEl);
	
	      document.body.addEventListener('click', (e) => {
	        const btn = e.target.closest('.js-arrive-wr');
	        if (!btn) return;
	
	        currentPatientId = btn.dataset.patientId;
	        const noteEl = document.getElementById('wrNote');
	        if (noteEl) noteEl.value = '';
	        wrModal.show();
	      });
	
	      const confirmBtn = document.getElementById('wrConfirmArrive');
	      if (!confirmBtn) return;
	
	      confirmBtn.addEventListener('click', async () => {
	        const note = document.getElementById('wrNote')?.value;
	        if (!note) { alert("Veuillez choisir un motif"); return; }
	
	        try {
	          uiShowLoader("Mise en salle…");
	
	          await safeJsonFetch('/api/waiting-room/arrive', {
	            method:'POST',
	            headers:{'Content-Type':'application/json'},
	            body: JSON.stringify({
	              patientId: parseInt(currentPatientId,10),
	              note: note
	            })
	          });




	
	          wrModal.hide();
	          if (patientsDT) patientsDT.ajax.reload(null,false);
	
	        } catch(e) {
	          alert(e.message);
	        } finally {
	          uiHideLoader();
	        }
	      });
	    }
	
	    window.addEventListener('load', () => {
	      initArriveModal();
	      initPatientsTable();
	    });
	  })();
	  </script>
{% endblock %}

