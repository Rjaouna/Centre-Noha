{# templates/fiche_client/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Gestion des patients
{% endblock %}

{% block body %}
	<div class="mt-4">

		{% embed '_partials/_page_header.html.twig' with {
      icon: 'bi bi-people-fill',
      title: 'Gestion des patients',
      subtitle: 'Suivi médical & dossiers patients'
    } %}
			{% block header_actions_left %}
				<span class="action-icon bg-primary" role="button" data-bs-toggle="modal" data-bs-target="#modalAddClient" title="Nouveau patient">
					<i class="bi bi-person-plus"></i>
				</span>
			{% endblock %}
		{% endembed %}

		<div class="card shadow-sm border-0 rounded-4 mt-3">
			<div class="card-body px-4">
				<table id="patientsTable" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>Patient</th>
							<th>Ville</th>
							<th>Téléphone</th>
							<th>Âge</th>
							<th>Maladie</th>
							<th>Statut (Salle)</th>
							<th class="text-center">Actions</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>

	</div>

	{% include 'home/_modals/_add_patient.html.twig' %}
{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	    let patientsDT;
	
	    function hideLoader() {
	      const loader = document.getElementById('pageLoader');
	      if (loader) loader.style.display = 'none';
	    }
	    function showLoader() {
	      const loader = document.getElementById('pageLoader');
	      if (loader) loader.style.display = 'flex';
	    }
	
	    async function safeJsonFetch(url, options = {}) {
	      const r = await fetch(url, options);
	      const text = await r.text();
	      let j = null;
	      try { j = JSON.parse(text); } catch (e) {}
	      if (!r.ok) throw new Error(j?.message ?? `Erreur HTTP ${r.status}`);
	      if (!j) throw new Error("Réponse JSON invalide");
	      return j;
	    }
	
	    function rawStatut(s) {
	      return (s ?? "").toString().trim().toUpperCase();
	    }
	
	    function isInWaitingRoom(row) {
	      const wrId = row?.wrId ?? null;
	      const wrStatut = rawStatut(row?.wrStatut);
	      // ✅ en salle = il a une ligne WR du jour ET pas terminé
	      return (wrId !== null) && (wrStatut !== 'TERMINE');
	    }
	
	    function badgeWaitingRoom(row) {
	      const wrId = row?.wrId ?? null;
	      const v = rawStatut(row?.wrStatut);
	
	      // ✅ Hors salle si pas de ligne OU terminé
	      if (!wrId || v === 'TERMINE') {
	        return `<span class="badge bg-light text-dark rounded-pill">Hors salle</span>`;
	      }
	
	      if (v === 'APPELE')          return `<span class="badge bg-primary rounded-pill">Appelé</span>`;
	      if (v === 'EN_CONSULTATION') return `<span class="badge bg-success rounded-pill">Consultation</span>`;
	      if (v === 'ABSENT')          return `<span class="badge bg-danger rounded-pill">Absent</span>`;
	      if (v === 'EN_ATTENTE')      return `<span class="badge bg-warning text-dark rounded-pill">En attente</span>`;
	
	      return `<span class="badge bg-dark rounded-pill">${v}</span>`;
	    }
	
	    function initPatientsTable() {
	      const tableEl = $('#patientsTable');
	
	      if (!tableEl.length || !$.fn.DataTable) {
	        console.error("DataTables n'est pas chargé.");
	        hideLoader();
	        return;
	      }
	      if (!$.fn.dataTable.Responsive) {
	        console.error("DataTables Responsive n'est pas chargé (js/css).");
	        hideLoader();
	        return;
	      }
	
	      if ($.fn.DataTable.isDataTable(tableEl)) {
	        tableEl.DataTable().clear().destroy();
	      }
	
	      patientsDT = tableEl.DataTable({
	        processing: true,
	        responsive: true,
	        autoWidth: false,
	
	        ajax: {
	          url: "{{ path('app_fiche_client_ajax') }}",
	          dataSrc: 'data'
	        },
	
	        language: {
	          url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json',
	          processing: "Chargement..."
	        },
	
	        pageLength: 10,
	        lengthChange: false,
	        order: [[0, 'desc']],
	
	        columns: [
	          { data: 'id', className: 'fw-bold' },
	
	          {
	            data: null,
	            render: row => `
	              <div class="d-flex flex-column">
	                <div class="d-flex align-items-center gap-2">
	                  <strong>${row.nom ?? ''} ${row.prenom ?? ''}</strong>
	                  ${row.isNew ? '<span class="badge bg-success rounded-pill">Nouveau</span>' : ''}
	                </div>
	                ${row.cin ? `<div class="small text-muted mt-1">CIN: ${row.cin}</div>` : ''}
	              </div>
	            `
	          },
	
	          { data: 'ville', defaultContent: '—' },
	
	          {
	            data: 'telephone',
	            render: tel => tel
	              ? `<a href="tel:${tel}" class="fw-semibold text-primary text-decoration-none">${tel}</a>`
	              : '—'
	          },
	
	          {
	            data: 'age',
	            render: age => age ? `<span class="badge bg-light rounded-pill px-3">${age} ans</span>` : '—'
	          },
	
	          {
	            data: 'maladie',
	            render: m => `<span class="badge bg-info bg-opacity-75 rounded-pill px-3">${m ?? '—'}</span>`
	          },
	
	          // ✅ Statut Salle (selon WaitingRoom)
	          {
	            data: null,
	            render: row => badgeWaitingRoom(row)
	          },
	
	          // ✅ Actions
	          {
	            data: null,
	            orderable: false,
	            className: 'text-center',
	            render: row => {
	              const patientId = row.id;
	              const url = "{{ path('app_fiche_client_show', {'id': 'ID'}) }}".replace('ID', patientId);
	
	              const inRoom = isInWaitingRoom(row);
	              const canSetWaiting = !inRoom; // ✅ bouton téléphone seulement si hors salle
	
	              return `
	                <div class="d-flex justify-content-center gap-2 flex-wrap">
	                  <a href="${url}" class="btn btn-sm px-3 py-2 fw-semibold rounded-pill btn-view-outline" title="Voir">
	                    <i class="bi bi-eye"></i>
	                  </a>
	
	                  ${canSetWaiting ? `
	                    <button type="button"
	                            class="btn btn-sm px-3 py-2 fw-semibold rounded-pill btn-warning text-dark js-arrive-wr"
	                            data-patient-id="${patientId}"
	                            title="Mettre en salle (EN_ATTENTE)">
	                      <i class="bi bi-telephone-fill"></i>
	                    </button>
	                  ` : `
	                    <span class="badge bg-warning text-dark rounded-pill px-3 py-2" title="Déjà en salle">
	                      <i class="bi bi-hourglass-split"></i>
	                    </span>
	                  `}
	                </div>
	              `;
	            }
	          }
	        ],
	
	        initComplete: function() {
	          const api = this.api();
	          requestAnimationFrame(() => { api.columns.adjust(); api.responsive.recalc(); });
	          setTimeout(() => { api.columns.adjust(); api.responsive.recalc(); }, 250);
	        }
	      });
	
	      patientsDT.one('draw.dt', () => {
	        setTimeout(() => { patientsDT.columns.adjust().responsive.recalc(); hideLoader(); }, 80);
	      });
	
	      window.refreshPatientsTable = () => {
	        if (patientsDT) patientsDT.ajax.reload(null, false);
	      };
	
	      // ✅ bouton "mettre en salle"
	      $('#patientsTable').on('click', '.js-arrive-wr', async function () {
	        const patientId = this.dataset.patientId;
	        if (!patientId) return;
	
	        const oldHtml = this.innerHTML;
	        this.disabled = true;
	        this.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
	
	        try {
	          const j = await safeJsonFetch(`/api/waiting-room/arrive`, {
	            method: "POST",
	            headers: { "Content-Type": "application/json" },
	            body: JSON.stringify({ patientId: parseInt(patientId, 10) })
	          });
	
	          if (!j.success) {
	            alert(j.message ?? "Impossible d'ajouter en salle.");
	            return;
	          }
	
	          window.playSuccessSound?.();
	          window.refreshPatientsTable?.();
	
	        } catch (e) {
	          console.error(e);
	          alert(e.message ?? "Erreur serveur.");
	        } finally {
	          this.disabled = false;
	          this.innerHTML = oldHtml;
	        }
	      });
	
	      setTimeout(() => hideLoader(), 6000);
	    }
	
	    showLoader();
	    window.addEventListener('load', initPatientsTable);
	  </script>
{% endblock %}

