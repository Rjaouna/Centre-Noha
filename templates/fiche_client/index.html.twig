{% extends 'base.html.twig' %}

{% block title %}Gestion des patients
{% endblock %}

{% block body %}
<style>
	.dt-length {
		display: none !important;
	}
	@media (max-width: 576px) {

    .dt-search {
        width: 100%;
    }

    .dt-search label {
        width: 100%;
        display: block;
    }

    .dt-search input {
        width: 90% !important;
        
    }

}
@media (max-width: 576px) {
    .dt-search label {
        font-size: 0;
    }

    .dt-search input {
        font-size: 1rem;
    }
}

</style>


	<div
		class="container-fluid mt-4">

		<!-- ================= HEADER ================= -->
		<div class="card shadow-lg border-0 rounded-4 mb-4">
			<div class="card-body px-4 py-4">
				<div class="row align-items-center">

					<div class="col-md-7 d-flex align-items-center">
						<i class="bi bi-people-fill text-primary fs-1 me-3"></i>
						<div>
							<h2 class="fw-bold text-primary mb-0">Gestion des patients</h2>
							<small class="text-muted">Suivi m√©dical & dossiers patients</small>
						</div>
					</div>

<div
	class="col-md-5 d-flex gap-3 justify-content-md-end mt-3 mt-md-0">

	<!-- ‚ûï Nouveau patient -->
	<span class="action-icon bg-primary" role="button" data-bs-toggle="modal" data-bs-target="#modalAddClient" data-bs-toggle="tooltip" title="Nouveau patient">
		<i class="bi bi-person-plus"></i>
	</span>

	<!-- ‚¨ÖÔ∏è Accueil -->
	<a href="{{ path('app_home') }}" class="action-icon bg-light text-dark" data-bs-toggle="tooltip" title="Page d'accueil">
		<i class="bi bi-house"></i>
	</a>

</div>




				</div>
			</div>
		</div>

		<!-- ================= TABLE ================= -->
		<div class="card shadow-sm border-0 rounded-4">
<div class="card-body px-2">


				<table id="patientsTable" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>Patient</th>
							<th>Ville</th>
							<th>T√©l√©phone</th>
							<th>√Çge</th>
							<th>Maladie</th>
							<th>Statut</th>
							<th class="text-center">Actions</th>
						</tr>
					</thead>

					<tbody>
						{% for fiche_client in fiche_clients %}
							{% set isNew = not fiche_client.isConsulted %}

							<tr class="{{ isNew ? 'table-success bg-opacity-10' : '' }}">
								<td class="fw-bold">{{ fiche_client.id }}</td>

								<td>
									<div class="d-flex align-items-center gap-2">
										<strong>{{ fiche_client.nom }}</strong>
										{% if isNew %}
											<span class="badge bg-success rounded-pill">Nouveau</span>
										{% endif %}
									</div>
								</td>

								<td>{{ fiche_client.ville }}</td>

								<td>
									<a href="tel:{{ fiche_client.telephone }}" class="text-decoration-none fw-semibold text-primary">
										{{ fiche_client.telephone }}
									</a>
								</td>

								<td>
									{% if fiche_client.agePatient %}
										<span class="badge bg-light rounded-pill px-3">
											{{ fiche_client.agePatient }}
											ans
										</span>
									{% else %}
										<span class="text-muted">‚Äî</span>
									{% endif %}
								</td>

								<td>
									<span class="badge bg-info bg-opacity-75 rounded-pill px-3">
										{{ fiche_client.typeMaladie }}
									</span>
								</td>

								<td>
									{% if fiche_client.isConsulted %}
										<span class="badge bg-light rounded-pill">
											Consult√©
										</span>
									{% else %}
										<span class="badge bg-success rounded-pill">
											En attente
										</span>
									{% endif %}
								</td>

								<td class="text-center">
									<a href="{{ path('app_fiche_client_show', {'id': fiche_client.id}) }}" class="btn btn-info text-light btn-sm rounded-pill px-3">
										<i class="bi bi-eye"></i>
										Voir
									</a>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>

			</div>
		</div>
	</div>

	<!-- ================= MODAL AJOUT PATIENT ================= -->
	<div class="modal fade" id="modalAddClient" tabindex="-1">
		<div class="modal-dialog modal-xl modal-dialog-centered">
			<div class="modal-content rounded-4 shadow-lg">

				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title fw-bold">
						<i class="bi bi-person-plus me-2"></i>
						Ajouter un patient
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body p-4">
					{{ include('fiche_client/_form.html.twig') }}
				</div>

			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	
	document.addEventListener('DOMContentLoaded', () => {

	const table = $('#patientsTable');

	// üî• SOLUTION D√âFINITIVE
	if ($.fn.DataTable.isDataTable(table)) {
		table.DataTable().clear().destroy();
	}

	table.DataTable({
    language: {
        url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
    },
    pageLength: 10,
    lengthChange: false, // ‚úÖ SUPPRIME "Afficher X entr√©es"
    order: [[0, 'desc']],
    responsive: true,
    autoWidth: false
});


});
	
		/* ================= AJAX FORM ================= */
		const form  = document.getElementById('ficheForm');
		const modal = new bootstrap.Modal(document.getElementById('modalAddClient'));
		const pop   = document.getElementById('popupSuccess');
	
		const routeShowPatient =
			"{{ path('app_fiche_client_show', {'id': 0}) }}".replace('/0', '');
	
		if (!form) return;
	
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
	
			const payload = {};
			new FormData(form).forEach((v, k) => {
				payload[k.replace('fiche_client[', '').replace(']', '')] = v;
			});
	
			const response = await fetch("{{ path('app_fiche_client_new') }}", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify(payload)
			});
	
			if (!response.ok) {
				alert("Erreur lors de l‚Äôenregistrement");
				return;
			}
	
			const result = await response.json();
	
			form.reset();
			modal.hide();
	
			pop.style.display = 'block';
			pop.innerHTML = `
				<div class="d-flex align-items-start">
					<i class="bi bi-check-circle-fill fs-1 text-white bg-success p-2 rounded-circle me-3"></i>
					<div>
						<h5 class="fw-bold mb-1">Patient ajout√© avec succ√®s üéâ</h5>
						<ul class="mb-2 ps-3">
							<li><strong>Nom :</strong> ${result.nom}</li>
							<li><strong>Ville :</strong> ${result.ville}</li>
							<li><strong>T√©l√©phone :</strong> ${result.telephone}</li>
						</ul>
						<a href="${routeShowPatient}/${result.id}"
						   class="btn btn-outline-light btn-sm rounded-pill">
							<i class="bi bi-eye"></i>
							Voir le patient
						</a>
					</div>
				</div>
			`;
		});
	});
	</script>
{% endblock %}

