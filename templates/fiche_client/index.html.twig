{% extends 'base.html.twig' %}

{% block title %}Gestion des patients
{% endblock %}

{% block body %}




<div class="container-fluid mt-4">

	{% embed '_partials/_page_header.html.twig' with {
		icon: 'bi bi-people-fill',
		title: 'Gestion des patients',
		subtitle: 'Suivi m√©dical & dossiers patients'
	} %}
		{% block header_actions_left %}
			<span class="action-icon bg-primary" role="button" data-bs-toggle="modal" data-bs-target="#modalAddClient" data-bs-toggle="tooltip" title="Nouveau patient">
				<i class="bi bi-person-plus"></i>
			</span>
		{% endblock %}

		{# Si tu veux garder home+retour par d√©faut, tu ne touches pas header_actions_right #}
	{% endembed %}

	{# ... le reste de ta page ... #}








		<!-- ================= TABLE ================= -->
		<div class="card shadow-sm border-0 rounded-4">
<div class="card-body px-4">


				<table id="patientsTable" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>Patient</th>
							<th>Ville</th>
							<th>T√©l√©phone</th>
							<th>√Çge</th>
							<th>Maladie</th>
							<th>Statut</th>
							<th class="text-center">Actions</th>
						</tr>
					</thead>

					<tbody>
						{% for fiche_client in fiche_clients %}
							{% set isNew = not fiche_client.isConsulted %}

<tr class="{{ isNew ? 'table-success bg-opacity-10' : '' }}">
	<td class="fw-bold">{{ fiche_client.id }}</td>

	<td>
		<div class="d-flex flex-column">
			<div class="d-flex align-items-center gap-2">
				<strong>{{ fiche_client.nom }}
					{{ fiche_client.prenom }}</strong>

				{% if isNew %}
					<span class="badge bg-success rounded-pill">Nouveau</span>
				{% endif %}
			</div>

			{% if fiche_client.cin %}
				<div class="small text-muted mt-1">CIN:
					{{ fiche_client.cin }}</div>
			{% endif %}
		</div>
	</td>

	<td>{{ fiche_client.ville }}</td>

	<td>
		<a href="tel:{{ fiche_client.telephone }}" class="text-decoration-none fw-semibold text-primary">
			{{ fiche_client.telephone }}
		</a>
	</td>

	<td>
		{% if fiche_client.agePatient %}
			<span class="badge bg-light rounded-pill px-3">
				{{ fiche_client.agePatient }}
				ans
			</span>
		{% else %}
<td>
	<span class="badge bg-info bg-opacity-75 rounded-pill px-3">
		{{ fiche_client.typeMaladie }}
	</span>
</td>


		{% endif %}
	</td>

<td>
	<span class="badge bg-info bg-opacity-75 rounded-pill px-3">
		{{ fiche_client.typeMaladie }}
	</span>
</td>



	<td>
		{% if fiche_client.isConsulted %}
			<span class="badge bg-light rounded-pill">Consult√©</span>
		{% else %}
			<span class="badge bg-success rounded-pill">En attente</span>
		{% endif %}
	</td>

	<td class="text-center">
<a href="{{ path('app_fiche_client_show', {'id': fiche_client.id}) }}" class="btn btn-sm px-3 py-2 fw-semibold rounded-pill btn-view-outline">
	<i class="bi bi-eye me-1"></i>
	Voir
</a>


	</td>
</tr>


						{% endfor %}
					</tbody>
				</table>

			</div>
		</div>
	</div>


</div>
{% include 'home/_modals/_add_patient.html.twig' %}
{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	
	document.addEventListener('DOMContentLoaded', () => {

	const table = $('#patientsTable');

	// üî• SOLUTION D√âFINITIVE
	if ($.fn.DataTable.isDataTable(table)) {
		table.DataTable().clear().destroy();
	}

	table.DataTable({
    language: {
        url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
    },
    pageLength: 10,
    lengthChange: false, // ‚úÖ SUPPRIME "Afficher X entr√©es"
    order: [[0, 'desc']],
    responsive: true,
    autoWidth: false
});


});
	
		/* ================= AJAX FORM ================= */
		const form  = document.getElementById('ficheForm');
		const modal = new bootstrap.Modal(document.getElementById('modalAddClient'));
		const pop   = document.getElementById('popupSuccess');
	
		const routeShowPatient =
			"{{ path('app_fiche_client_show', {'id': 0}) }}".replace('/0', '');
	
		if (!form) return;
	
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
	
			const payload = {};
			new FormData(form).forEach((v, k) => {
				payload[k.replace('fiche_client[', '').replace(']', '')] = v;
			});
	
			const response = await fetch("{{ path('app_fiche_client_new') }}", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify(payload)
			});
	
			if (!response.ok) {
				alert("Erreur lors de l‚Äôenregistrement");
				return;
			}
	
			const result = await response.json();
	
			form.reset();
			modal.hide();
	
			pop.style.display = 'block';
			pop.innerHTML = `
				<div class="d-flex align-items-start">
					<i class="bi bi-check-circle-fill fs-1 text-white bg-success p-2 rounded-circle me-3"></i>
					<div>
						<h5 class="fw-bold mb-1">Patient ajout√© avec succ√®s üéâ</h5>
						<ul class="mb-2 ps-3">
							<li><strong>Nom :</strong> ${result.nom}</li>
							<li><strong>Ville :</strong> ${result.ville}</li>
							<li><strong>T√©l√©phone :</strong> ${result.telephone}</li>
						</ul>
						<a href="${routeShowPatient}/${result.id}"
						   class="btn btn-outline-light btn-sm rounded-pill">
							<i class="bi bi-eye"></i>
							Voir le patient
						</a>
					</div>
				</div>
			`;
		});
	});
	</script>
<style>
	.btn-view-outline {
		border: 1px solid rgba(13, 110, 253, .35);
		background: rgba(13, 110, 253, .06);
		color: #0d6efd;
		transition: transform 0.12s ease, background 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
	}
	.btn-view-outline:hover {
		background: rgba(13, 110, 253, .10);
		border-color: rgba(13, 110, 253, .55);
		box-shadow: 0 10px 22px rgba(13, 110, 253, .12);
		transform: translateY(-1px);
	}
</style>


{% endblock %}

