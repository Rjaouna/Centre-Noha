{% extends 'base.html.twig' %}

{% block title %}Gestion des patients
{% endblock %}

{% block body %}

	<div
		class="container-fluid mt-4">

		{# ================= HEADER ================= #}
		{% embed '_partials/_page_header.html.twig' with {
        icon: 'bi bi-people-fill',
        title: 'Gestion des patients',
        subtitle: 'Suivi m√©dical & dossiers patients'
    } %}
			{% block header_actions_left %}
				<span class="action-icon bg-primary" role="button" data-bs-toggle="modal" data-bs-target="#modalAddClient" title="Nouveau patient">
					<i class="bi bi-person-plus"></i>
				</span>
			{% endblock %}
		{% endembed %}

		{# ================= TABLE ================= #}
		<div class="card shadow-sm border-0 rounded-4 mt-3">
			<div class="card-body px-4">

				<table id="patientsTable" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>Patient</th>
							<th>Ville</th>
							<th>T√©l√©phone</th>
							<th>√Çge</th>
							<th>Maladie</th>
							<th>Statut</th>
							<th class="text-center">Actions</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>

			</div>
		</div>

	</div>

	{# ================= MODALS ================= #}
	{% include 'home/_modals/_add_patient.html.twig' %}

{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	let patientsDT;
	
	document.addEventListener('DOMContentLoaded', () => {
	
	    const tableEl = $('#patientsTable');
	
	    // s√©curit√©
	    if (!tableEl.length || !$.fn.DataTable) return;
	
	    patientsDT = tableEl.DataTable({
	        ajax: {
	            url: "{{ path('app_fiche_client_ajax') }}",
	            dataSrc: 'data'
	        },
	
	        language: {
	            url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
	        },
	
	        pageLength: 10,
	        lengthChange: false,
	        order: [[0, 'desc']],
	        responsive: true,
	        autoWidth: false,
	
	        columns: [
	            {
	                data: 'id',
	                className: 'fw-bold'
	            },
	
	            {
	                data: null,
	                render: row => `
	                    <div class="d-flex flex-column">
	                        <div class="d-flex align-items-center gap-2">
	                            <strong>${row.nom} ${row.prenom}</strong>
	                            ${row.isNew ? '<span class="badge bg-success rounded-pill">Nouveau</span>' : ''}
	                        </div>
	                        ${row.cin ? `<div class="small text-muted mt-1">CIN: ${row.cin}</div>` : ''}
	                    </div>
	                `
	            },
	
	            { data: 'ville' },
	
	            {
	                data: 'telephone',
	                render: tel => `
	                    <a href="tel:${tel}" class="fw-semibold text-primary text-decoration-none">
	                        ${tel}
	                    </a>
	                `
	            },
	
	            {
	                data: 'age',
	                render: age =>
	                    age
	                        ? `<span class="badge bg-light rounded-pill px-3">${age} ans</span>`
	                        : '‚Äî'
	            },
	
	            {
	                data: 'maladie',
	                render: m => `
	                    <span class="badge bg-info bg-opacity-75 rounded-pill px-3">
	                        ${m ?? '‚Äî'}
	                    </span>
	                `
	            },
	
	            {
	                data: 'statut',
	                render: s =>
	                    s === 'Consult√©'
	                        ? `<span class="badge bg-light rounded-pill">Consult√©</span>`
	                        : `<span class="badge bg-success rounded-pill">En attente</span>`
	            },
	
	            {
	                data: 'id',
	                orderable: false,
	                className: 'text-center',
	                render: id => {
    const url = "{{ path('app_fiche_client_show', {'id': 'ID'}) }}".replace('ID', id);

    return `
        <a href="${url}"
           class="btn btn-sm px-3 py-2 fw-semibold rounded-pill btn-view-outline">
            <i class="bi bi-eye me-1"></i> Voir
        </a>
    `;
}

	            }
	        ],
	
	        createdRow: (row, data) => {
	            if (data.isNew) {
	                row.classList.add('table-success', 'bg-opacity-10');
	            }
	        }
	    });
	
	    // üî• Highlight du premier patient apr√®s reload AJAX
	    patientsDT.on('xhr', () => {
	        setTimeout(() => {
	            $('#patientsTable tbody tr:first')
	                .addClass('table-success', 'bg-opacity-25');
	        }, 150);
	    });
	
	    // üåç Fonction globale (appel√©e depuis le modal)
	    window.refreshPatientsTable = () => {
	        if (patientsDT) {
	            patientsDT.ajax.reload(null, false);
	        }
	    };
	
	});
	</script>



{% endblock %}

