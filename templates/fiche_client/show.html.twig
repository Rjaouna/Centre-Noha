{% extends 'base.html.twig' %}

{% block title %}
	{{ fiche_client.nom }}
{% endblock %}

{% block body %}

<div class="mt-4">


    <div class="card shadow-lg border-0 mb-4 rounded-4">
        <div class="card-body py-4 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">

            <!-- TITRE -->
            <div>
                <h2 class="fw-bold text-primary mb-1 d-flex align-items-center">
                    <i class="bi bi-person-vcard me-2 fs-1"></i>
                    {{ fiche_client.nom }}
                </h2>
<!-- Infos -->
<div class="d-flex align-items-center text-muted small gap-3">

	<span class="d-flex align-items-center">
		<i class="bi bi-geo-alt-fill me-1 text-danger"></i>
		{{ fiche_client.ville }}
	</span>


<span class="d-flex align-items-center">
	<i class="bi bi-telephone-fill me-1 text-success"></i>
	<a href="tel:{{ fiche_client.telephone }}" class="text-decoration-none text-success fw-semibold">
		{{ fiche_client.telephone }}
	</a>
</span>


</div>

            </div>


<!-- MODAL RDV -->
<div class="modal fade" id="modalRdv" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-calendar-plus me-2"></i>
					RÃ©server un rendez-vous
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body p-4">

				<h5 class="fw-bold mb-3 text-primary">
					SÃ©lectionner un jour (30 prochains jours)
				</h5>

				<!-- JOURS -->
				<div id="daysList" class="row g-3 mb-4">
					{% for i in 0..29 %}
						{% set dateObj = "now"|date_modify("+" ~ i ~ " days") %}
						{% set fullDate = dateObj|date("Y-m-d") %}
						{% set dayName = dateObj|date("D") %}
						{% set dayNum = dateObj|date("d") %}
						{% set month = dateObj|date("M") %}

{% set daysFR = {
    'Mon': 'Lundi',
    'Tue': 'Mardi',
    'Wed': 'Mercredi',
    'Thu': 'Jeudi',
    'Fri': 'Vendredi',
    'Sat': 'Samedi',
    'Sun': 'Dimanche'
} %}


						<div class="col-4 col-md-2">
							<div class="day-card shadow-sm rounded-4 p-2 text-center border" style="cursor:pointer;" data-date="{{ fullDate }}">

								<div class="fw-bold fs-5">{{ dayNum }}</div>
								<div class="text-primary">{{ month }}</div>
<small class="text-muted">
	{{ daysFR[dayName] ?? dayName }}</small>


							</div>
						</div>
					{% endfor %}
				</div>

				<h5 class="fw-bold mb-3 text-primary">CrÃ©neaux disponibles</h5>

				<div id="creneauxList" class="row g-3">
					<p class="text-muted text-center">SÃ©lectionnez d'abord un jourâ€¦</p>
				</div>

			</div>
		</div>
	</div>
</div>


<!-- MODAL CHOIX MOTIF -->
<div class="modal fade" id="modalMotif" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-list-check me-2"></i>Motif du rendez-vous
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body p-4">

				<label class="fw-bold mb-2">SÃ©lectionner un motif :</label>
				<select id="selectMotif" class="form-select mb-3">
<option value="SantÃ© mentale">SantÃ© mentale (mal-Ãªtre, anxiÃ©tÃ©, stress)</option>

<option

">FiÃ¨vre</option>
<option value="Rhume">Rhume</option>
<option value="Maux de gorge">Maux de gorge</option>

<option value="Renouvellement et rÃ©Ã©valuation de traitement">Renouvellement et rÃ©Ã©valuation de traitement</option>

<option value="Consultation de suivi">Consultation de suivi</option>

<option value="Troubles digestifs">Troubles digestifs</option>

<option value="GÃªne urinaire">GÃªne urinaire</option>

<option value="Douleur au dos">Douleur au dos</option>

<option value="SymptÃ´mes allergiques">SymptÃ´mes allergiques</option>

<option value="GynÃ©cologie">GynÃ©cologie</option>

<option value="ProblÃ¨me de peau">ProblÃ¨me de peau</option>

<option value="Maux de tÃªte">Maux de tÃªte</option>

<option value="Suivi gÃ©nÃ©ral">Suivi gÃ©nÃ©ral</option></select>



				
				<button class="btn btn-primary w-100 rounded-pill mt-3" id="validerMotif">
					<i class="bi bi-check-lg"></i>
					Valider
				</button>

			</div>
		</div>
	</div>
</div>








            <!-- BOUTONS -->
            <div class="d-flex flex-column flex-lg-row gap-2">

{# Bouton dans le header #}
<button class="btn btn-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalRdv">
	<i class="bi bi-calendar-plus me-1"></i>
	RÃ©server un RDV
</button>







           
<div class="btn-group">


<button type="button" class="btn btn-outline-primary  btn-lg rounded-pill shadow-sm dropdown-toggle px-4 d-flex align-items-center gap-2" data-bs-toggle="dropdown" aria-expanded="false">
	<i class="bi bi-person-lines-fill"></i>
	Gestion paiment


</button>


<ul class="dropdown-menu" style="">


<li>
	<a class="dropdown-item" href="{{path('app_paiement_index',{id: fiche_client.id})}}">






<i class="bi bi-clock-history me-2"></i>
Historique paiment</a></li>
<li>
<a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#paiementModal">


		


		<i class="bi bi-clock-history me-2"></i>
		Ajouter un paiement</a>
</li>


</ul>


</div>


               

                <a href="{{ path('app_fiche_client_index') }}"
class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">

                    <i class="bi bi-arrow-left"></i>
                    Retour
                </a>

            </div>

        </div>
    </div>

</div>



		{# -------------------------------------------- #}
		{# ðŸ”· SECTIONS PERSONNELLES & MEDICALES CÃ”TE Ã€ CÃ”TE #}
		{# -------------------------------------------- #}
			<div
			class="row g-4 mb-4"> {# ðŸŸ¦ INFORMATIONS PERSONNELLES #}
			<div class="col-lg-6 d-flex">
				<div class="card shadow-lg border-0 rounded-4 flex-fill h-100">
					<div class="card-body py-4 px-4">

						<h3 class="text-primary fw-bold mb-4 d-flex align-items-center">
							<i class="bi bi-person-lines-fill me-2 fs-2"></i>
							Informations personnelles
						</h3>

						<div class="row g-3">

							<div class="col-md-6">
								<div class="border-start border-3 border-primary ps-3">
									<p class="text-secondary mb-1 fw-semibold">Nom</p>
									<p class="fs-5 fw-bold">{{ fiche_client.nom }}</p>
								</div>
							</div>

							<div class="col-md-6">
								<div class="border-start border-3 border-info ps-3">
									<p class="text-secondary mb-1 fw-semibold">Ville</p>
									<p class="fs-5 fw-bold">{{ fiche_client.ville }}</p>
								</div>
							</div>

							<div class="col-md-6">
								<div class="border-start border-3 border-success ps-3">
									<p class="text-secondary mb-1 fw-semibold">TÃ©lÃ©phone</p>
									<p class="fs-5 fw-bold">{{ fiche_client.telephone }}</p>
								</div>
							</div>

							<div class="col-md-6">
								<div class="border-start border-3 border-warning ps-3">
									<p class="text-secondary mb-1 fw-semibold">Ã‚ge</p>
{% if fiche_client.age %}
	{% set birth = fiche_client.age is not same as(null) ? fiche_client.age : null %}
	{% if birth %}
		{% set diff = date().diff(birth) %}

		{% if diff.y >= 1 %}
			<p class="fs-5 fw-bold">{{ diff.y }}
				ans</p>

		{% elseif diff.m >= 1 %}
			<p class="fs-5 fw-bold">{{ diff.m }}
				mois</p>

		{% else %}
			<p class="fs-5 fw-bold">{{ diff.d }}
				jours</p>
		{% endif %}
	{% endif %}
{% endif %}


								</div>
							</div>

							<div class="col-md-6">
								<div class="border-start border-3 border-danger ps-3">
									<p class="text-secondary mb-1 fw-semibold">Poids</p>
									<p class="fs-5 fw-bold">{{ fiche_client.poids }}
										kg</p>
								</div>
							</div>

							<div class="col-md-6">
								<div class="border-start border-3 border-dark ps-3">
									<p class="text-secondary mb-1 fw-semibold">CrÃ©Ã© le</p>
									<p class="fs-5 fw-bold">{{ fiche_client.createdAt|date('d/m/Y H:i') }}</p>
								</div>
							</div>

{# <div class="col-md-6">


								<div class="border-start border-3 border-secondary ps-3">
									<p class="text-secondary mb-1 fw-semibold">Mis Ã  jour le</p>
									<p class="fs-5 fw-bold">{{ fiche_client.updatedAt|date('d/m/Y H:i') }}</p>
								</div>
</div>

#}









						</div>

						{# ðŸ”µ BLOC RDV â€” INSÃ‰RÃ‰ ICI #}
						<h3 class="text-info fw-bold mb-3 d-flex align-items-center mt-4">
							<i class="bi bi-calendar-event me-2 fs-3"></i>
							Historique des rendez-vous
						</h3>

						<div class="d-flex flex-wrap gap-4 my-4">

							<div class="text-center">
								<div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center shadow-sm rdv-circle">
									{{ rdv_total }}
								</div>
								<small class="d-block mt-2 fw-bold text-primary">Total</small>
							</div>

							<div class="text-center">
								<div class="rounded-circle bg-success text-white d-flex justify-content-center align-items-center shadow-sm rdv-circle">
									{{ rdv_future }}
								</div>
								<small class="d-block mt-2 fw-bold text-success">Ã€ venir</small>
							</div>

							<div class="text-center">
								<div class="rounded-circle bg-warning text-dark d-flex justify-content-center align-items-center shadow-sm rdv-circle">
									{{ rdv_canceled }}
								</div>
								<small class="d-block mt-2 fw-bold text-warning">AnnulÃ©s</small>
							</div>

							<div class="text-center">
								<div class="rounded-circle bg-danger text-white d-flex justify-content-center align-items-center shadow-sm rdv-circle">
									{{ rdv_past }}
								</div>
								<small class="d-block mt-2 fw-bold text-danger">PassÃ©s</small>
							</div>

						</div>

					</div>
				</div>
			</div>


			{# ðŸŸ¢ INFORMATIONS MÃ‰DICALES #}
			<div class="col-lg-6 d-flex">
				<div class="card shadow-lg border-0 rounded-4 flex-fill h-100">
					<div class="card-body py-4 px-4">

						<h3 class="text-success fw-bold mb-4 d-flex align-items-center">
							<i class="bi bi-heart-pulse-fill me-2 fs-2"></i>
							Informations mÃ©dicales
						</h3>

						<div class="row g-3">

<div class="col-md-6">

								<div class="border-start border-3 border-success ps-3">
									<p class="text-secondary mb-1 fw-semibold">DurÃ©e de la maladie</p>
<p class="fs-5 fw-bold">{{ fiche_client.dureeMaladie }}
	Jours</p>


								</div>
							</div>

<div class="col-md-6">

								<div class="border-start border-3 border-info ps-3">
									<p class="text-secondary mb-1 fw-semibold">Type de maladie</p>
									<p class="fs-5 fw-bold">{{ fiche_client.typeMaladie }}</p>
								</div>
								
							</div>


						</div>

						{# Composants mÃ©dicaux #}
						<div class="mt-4">
<a href="{{ path('app_dossier_medical_index', { id: fiche_client.id }) }}" class="btn btn-link btn-lg rounded-pill mb-2 shadow-sm d-flex align-items-center gap-2">


	<i class="bi bi-folder"></i>
	{% if fiche_client.dossierMedicals|length > 0 %}


		Dossiers de suivi
		<span class="text-warning">({{fiche_client.dossierMedicals|length}})</span>


	{% else %}

		+ dossier suivi
	{% endif %}

</a>

							{{ include('fiche_client/_composants/_trouble_digestifs.html.twig') }}
							{{ include('fiche_client/_composants/_symptomes_generaux.html.twig') }}
							{{ include('fiche_client/_composants/_maladies_chroniques.html.twig') }}
							{{ include('fiche_client/_composants/_modal_edit_client/_modal_edit_client.html.twig') }}
{{ include('fiche_client/_composants/_modal_rdv/_modal_rdv.html.twig') }}
{{ include('fiche_client/_composants/_modal_paiment/_modal_paiment.html.twig') }}



						</div>
{{ include('fiche_client/_composants/_galerie/_galerie.html.twig') }}
{{ include('fiche_client/_composants/_modal_image/_modal_image.html.twig') }}
<button class="btn btn-primary rounded-pill mt-3" data-bs-toggle="modal" data-bs-target="#modalUploadImage">
	<i class="bi bi-image"></i>
	Ajouter une image
</button>

					</div>
				</div>
			</div>

		</div>


		{# -------------------------------------------- #}
		{# ðŸ”¶ TRAITEMENT & OBSERVATIONS                 #}
		{# -------------------------------------------- #}
			<div class="card shadow-lg border-0 rounded-4 mb-4"> <div class="card-body py-4 px-4">

				<h3 class="text-warning fw-bold mb-4 d-flex align-items-center">
					<i class="bi bi-journal-medical me-2 fs-2"></i>
					Traitement & Observations
				</h3>

				<div class="row g-4">

					<div class="col-12">
						<p class="text-secondary mb-1 fw-semibold">Traitement</p>
						<div class="fs-5 p-3 bg-light rounded-3 shadow-sm">
							{{ fiche_client.traitement ?: 'â€”' }}
						</div>
					</div>

					<div class="col-12">
						<p class="text-secondary mb-1 fw-semibold">Observations</p>
						<div class="fs-5 p-3 bg-light rounded-3 shadow-sm">
							{{ fiche_client.observation ?: 'â€”' }}
						</div>
					</div>

				</div>

			</div>
		</div>

	</div>

	<style>
		.rdv-circle {
			width: 40px;
			height: 40px;
			font-size: 1rem;
			transition: transform 0.2s ease-in-out;
		}
		.rdv-circle:hover {
			transform: scale(1.12);
		}
			.day-card {
		transition: 0.2s ease;
	}
	.day-card:hover {
		background: rgba(50, 158, 244, 0.1);
		transform: translateY(-3px);
	}
	.day-card.selected {
		background: var(--bs-primary);
		color: white !important;
		border-color: var(--bs-primary);
	}
	</style>
 <script>
document.addEventListener("DOMContentLoaded", () => {

    const daysList = document.querySelectorAll(".day-card");
    const creneauxList = document.getElementById("creneauxList");

    daysList.forEach(day => {

        day.addEventListener("click", async () => {
            // reset selection
            daysList.forEach(d => d.classList.remove("selected"));
            day.classList.add("selected");

            const selectedDate = day.dataset.date;

            creneauxList.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary"></div>
                </div>
            `;

            const res = await fetch(`/api/rdv/disponibilites/${selectedDate}`);
            const data = await res.json();

            creneauxList.innerHTML = "";

            data.forEach(c => {
                creneauxList.innerHTML += `
                    <div class="col-4 col-md-3">
                        <button 
                            class="btn ${c.disponible ? 'btn-success' : 'btn-secondary'} w-100 rounded-pill"
                            ${c.disponible ? '' : 'disabled'}
                            onclick="reserverRdv('${selectedDate}', '${c.heure}')">
                            ${c.heure}
                        </button>
                    </div>
                `;
            });
        });

    });

});


async function reserverRdv(date, heure) {
    rdvDateSelected = date;
    rdvHeureSelected = heure;

    // Ouvre le modal des motifs
    new bootstrap.Modal(document.getElementById("modalMotif")).show();
}

// Quand l'utilisateur valide le motif
document.getElementById("validerMotif").addEventListener("click", async () => {

    const selectMotif = document.getElementById("selectMotif").value;

    const motif =  selectMotif;

    if (!motif) {
        alert("Veuillez sÃ©lectionner ou saisir un motif.");
        return;
    }

    const payload = {
        patient: {{ fiche_client.id }},
        date: rdvDateSelected,
        heure: rdvHeureSelected,
        motif: motif
    };

    const res = await fetch("/api/rdv/reserver", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
        alert("RDV rÃ©servÃ© !");
        location.reload();
    } else {
        alert(data.error);
    }
});

</script>

{% endblock %}

