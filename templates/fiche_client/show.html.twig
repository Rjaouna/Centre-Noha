{% extends 'base.html.twig' %}

{% block title %}
	{{ fiche_client.nom }}
{% endblock %}

{% block body %}

{# ================= HEADER PATIENT (r√©utilisable) ================= #}
{# ‚úÖ Pr√©requis : _partials/_page_header.html.twig existe d√©j√† #}

	<div class="mt-4"> {% embed '_partials/_page_header.html.twig' with {
        icon: 'bi bi-person-vcard',
        title: fiche_client.nom,
        subtitle: null
    } %}

		{# --------- Sous-ligne (ville + t√©l√©phone) sous le titre --------- #}
		{% block header_subtitle %}
			<div class="d-flex flex-wrap align-items-center text-muted small gap-3 mt-1">
				<span class="d-flex align-items-center">
					<i class="bi bi-geo-alt-fill me-1 text-danger"></i>
					{{ fiche_client.ville }}
				</span>

				<span class="d-flex align-items-center">
					<i class="bi bi-telephone-fill me-1 text-success"></i>
					<a href="tel:{{ fiche_client.telephone }}" class="text-decoration-none text-success fw-semibold">
						{{ fiche_client.telephone }}
					</a>
				</span>
			</div>
		{% endblock %}

		{# --------- Actions m√©tier (mobile √† gauche / desktop √† droite) --------- #}
		{% block header_actions_left %}

			<span class="action-icon bg-primary text-white" role="button" data-bs-toggle="modal" data-bs-target="#modalRdv" data-bs-toggle="tooltip" title="Prendre un rendez-vous">
				<i class="bi bi-calendar-plus"></i>
			</span>

			<span class="action-icon bg-outline" role="button" data-bs-toggle="modal" data-bs-target="#documentsModal" data-bs-toggle="tooltip" title="Documents m√©dicaux">
<i class="bi bi-file-earmark-text-fill"></i>


			</span>

			

		{% endblock %}

		{# --------- Navigation (mobile √† droite / desktop √† droite) --------- #}
		{% block header_actions_right %}
			<a href="{{ path('app_home') }}" class="action-icon bg-light text-dark" data-bs-toggle="tooltip" title="Accueil">
				<i class="bi bi-house"></i>
			</a>

			<a href="{{ path('app_fiche_client_index') }}" class="action-icon bg-light" data-bs-toggle="tooltip" title="Retour √† la liste">
				<i class="bi bi-arrow-left"></i>
			</a>
		{% endblock %}

	{% endembed %}
</div>




		{# ===================================================== #}
		{# üü¶ INFORMATIONS PATIENT                              #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">

					<div class="d-flex justify-content-between align-items-center mb-4">
							<h4 class="fw-bold text-dark d-flex align-items-center mb-0">


														<i class="bi bi-person-lines-fill me-2 fs-4"></i>
							Informations patient


						</h4>

						<button class="btn btn-outline-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalEditFiche">
							<i class="bi bi-pencil-square"></i>
							
						</button>
					</div>
{# ===========================
   INFOS CLIENT ‚Äî UX GROUP√â
   =========================== #}

{% macro item(icon, label, value, color) %}
	<div class="ux-info-card ux-{{ color }}">
		<div class="ux-info-icon">
			<i class="bi {{ icon }}"></i>
		</div>
		<div class="ux-info-content">
			<div class="ux-info-label">{{ label }}</div>
			<div class="ux-info-value">{{ value ?: '‚Äî' }}</div>
		</div>
	</div>
{% endmacro %}

<div
	class="accordion ux-accordion" id="uxAccordionClient">

	{# ================= IDENTIT√â ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accIdentite">
			<button class="accordion-button ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIdentite" aria-expanded="true" aria-controls="collapseIdentite">
				<span class="ux-acc-icon">
					<i class="bi bi-person-badge"></i>
				</span>
				<span class="ux-acc-title">Identit√©</span>
			</button>
		</h2>

		<div id="collapseIdentite" class="accordion-collapse collapse show" aria-labelledby="accIdentite" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-person-badge', 'Nom', fiche_client.nom, 'primary') }}
					{{ _self.item('bi-person', 'Pr√©nom', fiche_client.prenom, 'primary') }}
					{{ _self.item('bi-credit-card-2-front', 'CIN', fiche_client.cin, 'secondary') }}
					{{ _self.item('bi-calendar3', 'Date de naissance', fiche_client.dateNaissance ? fiche_client.dateNaissance|date('d/m/Y') : null, 'dark') }}
					{{ _self.item('bi-hourglass-split', '√Çge', fiche_client.agePatient is not null ? fiche_client.agePatient ~ ' ans' : null, 'dark') }}
				</div>
			</div>
		</div>
	</div>

	{# ================= CONTACT ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accContact">
			<button class="accordion-button collapsed ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact" aria-expanded="false" aria-controls="collapseContact">
				<span class="ux-acc-icon">
					<i class="bi bi-telephone"></i>
				</span>
				<span class="ux-acc-title">Contact</span>
			</button>
		</h2>

		<div id="collapseContact" class="accordion-collapse collapse" aria-labelledby="accContact" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-geo-alt', 'Ville', fiche_client.ville, 'info') }}
					{{ _self.item('bi-telephone', 'T√©l√©phone', fiche_client.telephone, 'success') }}
				</div>
			</div>
		</div>
	</div>

	{# ================= SANT√â ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accSante">
			<button class="accordion-button collapsed ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSante" aria-expanded="false" aria-controls="collapseSante">
				<span class="ux-acc-icon">
					<i class="bi bi-clipboard2-pulse"></i>
				</span>
				<span class="ux-acc-title">Sant√©</span>
			</button>
		</h2>

		<div id="collapseSante" class="accordion-collapse collapse" aria-labelledby="accSante" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-speedometer2', 'Poids', fiche_client.poids ? fiche_client.poids ~ ' kg' : null, 'danger') }}
					{{ _self.item('bi-clock-history', 'Dur√©e maladie', fiche_client.dureeMaladie ? fiche_client.dureeMaladie ~ ' jours' : null, 'warning') }}
					{{ _self.item('bi-clipboard2-pulse', 'Type maladie', fiche_client.typeMaladie, 'secondary') }}
				</div>
			</div>
		</div>
	</div>

	{# ================= SYST√àME ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accSysteme">
			<button class="accordion-button collapsed ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSysteme" aria-expanded="false" aria-controls="collapseSysteme">
				<span class="ux-acc-icon">
					<i class="bi bi-shield-check"></i>
				</span>
				<span class="ux-acc-title">Syst√®me</span>
			</button>
		</h2>

		<div id="collapseSysteme" class="accordion-collapse collapse" aria-labelledby="accSysteme" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-calendar-check', 'Cr√©√© le', fiche_client.createdAt ? fiche_client.createdAt|date('d/m/Y H:i') : null, 'dark') }}
					{{ _self.item('bi-arrow-repeat', 'Mis √† jour le', fiche_client.updatedAt ? fiche_client.updatedAt|date('d/m/Y H:i') : null, 'dark') }}
				</div>
			</div>
		</div>
	</div>

</div>





{# ===== Traitement & Observations (UX luxe) ===== #}

<div class="ux-block mt-4" data-theme="warning">

	<div class="d-flex align-items-center gap-2 mb-3">
		<span class="ux-badge-icon">
			<i class="bi bi-journal-medical"></i>
		</span>
		<div>
			<h6 class="mb-0 fw-bold">Traitement & observations</h6>
<small class="text-muted">Infos saisies lors de l‚Äôadmission</small>


		</div>
	</div>

	<div class="row g-3">
		<div class="col-12 col-md-6">
			<div class="ux-note-card h-100">
				<div class="ux-note-head">
<span class="ux-note-label">Traitement d√©clar√© par le patient</span>


				</div>
				<div class="ux-note-value">
					{{ fiche_client.traitement ?: '‚Äî' }}
				</div>
			</div>
		</div>

		<div class="col-12 col-md-6">
			<div class="ux-note-card h-100">
				<div class="ux-note-head">
					<span class="ux-note-label">Observations</span>
				</div>
				<div class="ux-note-value">
					{{ fiche_client.observation ?: '‚Äî' }}
				</div>
			</div>
		</div>
	</div>

</div>

					

				</div>
			</div>
		</section>


		{# ===================================================== #}
		{# ü©∫ INFORMATIONS M√âDICALES                            #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 px-4">

					<h4 class="fw-bold text-success d-flex align-items-center mb-4">
						<i class="bi bi-heart-pulse-fill me-2 fs-4"></i>
						Informations m√©dicales
					</h4>

					<div class="row g-4">
{{ include('fiche_client/_composants/_bloc_infos_medicales/_trouble_digestifs.html.twig') }}


					</div>


					{{ include('fiche_client/_composants/_modal_edit_client/_modal_edit_client.html.twig') }}

				</div>
			</div>
		</section>


		{# ===================================================== #}
		{# üì∏ DOCUMENTATION CLINIQUE                            #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 px-4">

					<h5 class="fw-bold text-info d-flex align-items-center mb-2">
						<i class="bi bi-camera-fill me-2"></i>
						Documentation clinique
					</h5>

					<p class="text-muted small mb-3">
						Photographies m√©dicales permettant le suivi visuel et l‚Äô√©volution du patient.
					</p>

					{{ include('fiche_client/_composants/_galerie/_galerie.html.twig') }}
					{{ include('fiche_client/_composants/_modal_image/_modal_image.html.twig') }}
					{{ include('fiche_client/_composants/_arret_maladie.html.twig') }}
					{{ include('fiche_client/_composants/_ducument_medicaux.html.twig') }}
					{{ include('fiche_client/_composants/_modal_analyse.html.twig') }}

					<button class="btn btn-info btn-upload-static rounded-pill mt-3 shadow-sm text-light" data-bs-toggle="modal" data-bs-target="#modalUploadImage">
						<i class="bi bi-camera me-2 fs-5"></i>
						Ajouter photos, ordonnances, traitements
					</button>

				</div>
			</div>
		</section>


		{# ===================================================== #}
		{# üìÅ SUIVI DOSSIERS                                   #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 px-4">

					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="fw-bold text-warning d-flex align-items-center mb-0">
							<i class="bi bi-folder-fill me-2"></i>
							Suivi dossiers
						</h5>

						<button class="btn btn-warning rounded-pill px-4 shadow-sm text-light" data-bs-toggle="modal" data-bs-target="#modalAddDossier">
							<i class="bi bi-folder-plus"></i>
							Dossier
						</button>
					</div>

					<div class="p-3 bg-light rounded-3 d-flex justify-content-between align-items-center mb-3">
{% set dossierCount = fiche_client.dossierMedicals|length %}

{% if dossierCount > 0 %}
	<div>
		<p class="mb-1 fw-semibold">Dossiers enregistr√©s</p>
		<small class="text-muted">
			Historique m√©dical, observations et √©volution
		</small>
	</div>
{% else %}
	<div class="d-flex align-items-start gap-3">
		<div class="rounded-4 d-flex align-items-center justify-content-center bg-warning bg-opacity-10 text-warning flex-shrink-0" style="width:48px;height:48px;">
			<i class="bi bi-folder-plus fs-4"></i>
		</div>

	<div id="dossiersEmptyState" class="flex-grow-1">

			<p class="mb-1 fw-bold">Aucun dossier pour ce patient</p>
			<small class="text-muted d-block mb-2">
				Cr√©ez un dossier pour commencer le suivi (motif, observations, √©volution‚Ä¶).
			</small>

			<button class="btn btn-warning rounded-pill btn-sm text-light shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAddDossier">
				<i class="bi bi-folder-plus me-1"></i>
				Cr√©er un dossier
			</button>
		</div>
	</div>
{% endif %}



						<span id="dossierCount" class="badge bg-warning text-dark fs-6 px-3 py-2 rounded-pill">
							{{ fiche_client.dossierMedicals|length }}
						</span>
					</div>

					<div id="dossiersContainer" class="row g-4"></div>

				</div>
			</div>
		</section>


{# ===================================================== #}
{# üß™ SUIVI ANALYSES                                   #}
{# ===================================================== #}
	<section class="mb-4"> <div class="card shadow-sm border-0 rounded-4">
		<div class="card-body">

			<div class="d-flex justify-content-between align-items-center mb-3">
				<h5 class="fw-bold text-success mb-0 d-flex align-items-center gap-2">
					<i class="bi bi-clipboard-check"></i>
Analyses


				</h5>

<button class="btn btn-info text-white rounded-pill d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#modalAnalysePrescription">

	<i class="bi bi-plus-circle"></i>


				</button>
			</div>

			<div id="analysePrescriptionsContainer" data-patient-id="{{ fiche_client.id }}">
				{% include 'fiche_client/_composants/_analyse_prescriptions.html.twig' with {
						prescriptions: fiche_client.analysePrescriptions
					} %}
			</div>

		</div>
	</div>
</section>



		{# ===================================================== #}
		{# üìú CERTIFICAT (tu l'avais mais il √©tait m√©lang√©)      #}
		{# ===================================================== #}
	
					{{ include('fiche_client/_composants/_certficat.html.twig') }}
			

{% include 'fiche_client/_composants/_radiologie_block.html.twig' with { patient: fiche_client } %}

		{# ===================================================== #}
		{# üí≥ HISTORIQUE DES PAIEMENTS                          #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-sm border-0 rounded-4">
				<div class="card-body">
					{% include 'fiche_client/_composants/_paiements.html.twig' %}
				</div>
			</div>
		</section>

	</div>


	{# ============================== #}
	{# ‚úÖ MODAL AJOUT DOSSIER (mieux plac√©) #}
	{# ============================== #}
	{{ include('dossier_medical/_composants/_modal_ajouter_dossier.html.twig', { patient: fiche_client }) }}


{{ include('fiche_client/_composants/_modal_rendezvous.html.twig') }}








	{# ============================== #}
{# üìú JAVASCRIPT (ton script dossiers intact) #}
	{# ============================== #}
	 <script>
	function createDossierCard(d) {
	    const urlSuivi = "{{ path('app_suivi_par_dossier', {
	        patientId: fiche_client.id,
	        dossierId: '__ID__'
	    }) }}".replace('__ID__', d.id);
	
	    return `
	<div class="col-md-6 col-lg-4">
	    <div class="medical-card h-100">
	
	        <div class="medical-card-header">
	            <div class="medical-icon">
	                <i class="bi bi-folder2-open"></i>
	            </div>
	
	            <div class="medical-title">
	                <h5>${d.titre}</h5>
	                <span class="medical-id">Dossier #${d.id}</span>
	            </div>
	        </div>
	
	        <div class="medical-card-body">
	            <p class="medical-description">
	                ${d.description ?? "Aucune description renseign√©e pour ce dossier."}
	            </p>
	        </div>
	
	        <div class="medical-card-footer">
	            <div class="medical-meta">
	                <span>
	                    <i class="bi bi-calendar3"></i>
	                    ${d.createdAt}
	                </span>
	                <span class="medical-count">
	                    <i class="bi bi-activity"></i>
	                    ${d.suiviCount ?? 0} suivis
	                </span>
	            </div>
	
	            <a href="${urlSuivi}" class="btn btn-outline-primary btn-sm rounded-pill">
	                <i class="bi bi-search-heart me-1"></i>
	                Voir le dossier
	            </a>
	        </div>
	
	    </div>
	</div>
	    `;
	}
	
	async function loadDossiers() {
	    const container = document.getElementById("dossiersContainer");
	
	    container.innerHTML = `
	        <div class="col-12 text-center py-4">
	            <div class="spinner-border text-warning"></div>
	        </div>
	    `;
	
	    try {
	        const response = await fetch(
	            "{{ path('api_dossier_medical_by_patient', { id: fiche_client.id }) }}",
	            {
	                headers: {
	                    "Authorization": "Bearer " + localStorage.getItem("jwt_token")
	                }
	            }
	        );
	
	        if (!response.ok) throw new Error("Erreur chargement");
	
	        const dossiers = await response.json();
	        container.innerHTML = "";
	
	        dossiers.forEach(d => {
	            container.insertAdjacentHTML("beforeend", createDossierCard(d));
	        });
	
	    } catch (error) {
	        console.error(error);
	        container.innerHTML = `
	            <div class="text-danger text-center">
	                Erreur chargement dossiers
	            </div>
	        `;
	    }
	}
	
	document.addEventListener("DOMContentLoaded", () => {
	    loadDossiers();
	
	    const form = document.getElementById("formAddDossier");
	    const modalEl = document.getElementById("modalAddDossier");
	    const modal = new bootstrap.Modal(modalEl);
	    const addBtn = document.getElementById("addDossier");
	    const container = document.getElementById("dossiersContainer");
	    const badge = document.getElementById("dossierCount");
	
	    if (!form) return;
	
	    form.addEventListener("submit", async (e) => {
	        e.preventDefault();
	
	        const motif = document.querySelector('input[name="motif"]:checked');
	        if (!motif) {
	            alert("Veuillez s√©lectionner un motif.");
	            return;
	        }
	
	        addBtn.disabled = true;
	        addBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Cr√©ation...`;
	
	        try {
	            const response = await fetch(
	                "{{ path('api_dossier_medical_add', { id: fiche_client.id }) }}",
	                {
	                    method: "POST",
	                    headers: {
	                        "Content-Type": "application/json",
	                        "Authorization": "Bearer " + localStorage.getItem("jwt_token")
	                    },
	                    body: JSON.stringify({
	                        titre: motif.value,
	                        description: document.getElementById("dossier_description").value
	                    })
	                }
	            );
	
	            if (response.status !== 200 && response.status !== 201) {
	                throw new Error("Erreur ajout");
	            }
	
	            const dossier = await response.json();
				// ‚úÖ si c‚Äô√©tait le 1er dossier, on enl√®ve le bloc "Aucun dossier"
				document.getElementById("dossiersEmptyState")?.classList.add("d-none");
	            container.insertAdjacentHTML("afterbegin", createDossierCard(dossier));
	            badge.textContent = parseInt(badge.textContent) + 1;
	
	            form.reset();
	            modal.hide();
	
	        } catch (error) {
	            console.error(error);
	            alert("Erreur lors de l'ajout du dossier");
	        } finally {
	            addBtn.disabled = false;
	            addBtn.innerHTML = `<i class="bi bi-check-circle"></i> Enregistrer`;
	        }
	    });
	});
	</script>

{% endblock %}

