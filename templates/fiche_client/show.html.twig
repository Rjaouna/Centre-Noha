{% extends 'base.html.twig' %}

{% block title %}
	{{ fiche_client.nom }}
{% endblock %}

{% block body %}

<div class="mt-4">


    <div class="card shadow-lg border-0 mb-4 rounded-4">
        <div class="card-body py-4 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">

            <!-- TITRE -->
            <div>
                <h2 class="fw-bold text-primary mb-1 d-flex align-items-center">
                    <i class="bi bi-person-vcard me-2 fs-1"></i>
                    {{ fiche_client.nom }}
                </h2>
<!-- Infos -->
<div class="d-flex align-items-center text-muted small gap-3">

	<span class="d-flex align-items-center">
		<i class="bi bi-geo-alt-fill me-1 text-danger"></i>
		{{ fiche_client.ville }}
	</span>


<span class="d-flex align-items-center">
	<i class="bi bi-telephone-fill me-1 text-success"></i>
	<a href="tel:{{ fiche_client.telephone }}" class="text-decoration-none text-success fw-semibold">
		{{ fiche_client.telephone }}
	</a>
</span>


</div>

            </div>





<!-- MODAL RDV -->
<div class="modal fade" id="modalRdv" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-calendar-plus me-2"></i>
					R√©server un rendez-vous
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body p-4">

				<h5 class="fw-bold mb-3 text-primary">
					S√©lectionner un jour (30 prochains jours)
				</h5>

				<!-- JOURS -->
				<div id="daysList" class="row g-3 mb-4">
					{% for i in 0..29 %}
						{% set dateObj = "now"|date_modify("+" ~ i ~ " days") %}
						{% set fullDate = dateObj|date("Y-m-d") %}
						{% set dayName = dateObj|date("D") %}
						{% set dayNum = dateObj|date("d") %}
						{% set month = dateObj|date("M") %}

{% set daysFR = {
    'Mon': 'Lundi',
    'Tue': 'Mardi',
    'Wed': 'Mercredi',
    'Thu': 'Jeudi',
    'Fri': 'Vendredi',
    'Sat': 'Samedi',
    'Sun': 'Dimanche'
} %}


						<div class="col-4 col-md-2">
							<div class="day-card shadow-sm rounded-4 p-2 text-center border" style="cursor:pointer;" data-date="{{ fullDate }}">

								<div class="fw-bold fs-5">{{ dayNum }}</div>
								<div class="text-primary">{{ month }}</div>
<small class="text-muted">
	{{ daysFR[dayName] ?? dayName }}</small>


							</div>
						</div>
					{% endfor %}
				</div>

				<h5 class="fw-bold mb-3 text-primary">Cr√©neaux disponibles</h5>

				<div id="creneauxList" class="row g-3">
					<p class="text-muted text-center">S√©lectionnez d'abord un jour‚Ä¶</p>
				</div>

			</div>
		</div>
	</div>
</div>


<!-- MODAL CHOIX MOTIF -->
<div class="modal fade" id="modalMotif" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-list-check me-2"></i>Motif du rendez-vous
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body p-4">

				<label class="fw-bold mb-2">S√©lectionner un motif :</label>
				<select id="selectMotif" class="form-select mb-3">
<option value="Sant√© mentale">Sant√© mentale (mal-√™tre, anxi√©t√©, stress)</option>

<option

">Fi√®vre</option>
<option value="Rhume">Rhume</option>
<option value="Maux de gorge">Maux de gorge</option>

<option value="Renouvellement et r√©√©valuation de traitement">Renouvellement et r√©√©valuation de traitement</option>

<option value="Consultation de suivi">Consultation de suivi</option>

<option value="Troubles digestifs">Troubles digestifs</option>

<option value="G√™ne urinaire">G√™ne urinaire</option>

<option value="Douleur au dos">Douleur au dos</option>

<option value="Sympt√¥mes allergiques">Sympt√¥mes allergiques</option>

<option value="Gyn√©cologie">Gyn√©cologie</option>

<option value="Probl√®me de peau">Probl√®me de peau</option>

<option value="Maux de t√™te">Maux de t√™te</option>

<option value="Suivi g√©n√©ral">Suivi g√©n√©ral</option></select>



				
				<button class="btn btn-primary w-100 rounded-pill mt-3" id="validerMotif">
					<i class="bi bi-check-lg"></i>
					Valider
				</button>

			</div>
		</div>
	</div>
</div>








            <!-- BOUTONS -->
            <div class="d-flex flex-column flex-lg-row gap-2">

{# Bouton dans le header #}
<button class="btn btn-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalRdv">
	<i class="bi bi-calendar-plus me-1"></i>
	R√©server un RDV
</button>

<button class="btn btn-outline-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalEditFiche">
	<i class="bi bi-pencil-square me-1"></i>
	Modifier la fiche
</button>






           
<div class="btn-group">


<button type="button" class="btn btn-outline-primary  btn-lg rounded-pill shadow-sm dropdown-toggle px-4 d-flex align-items-center gap-2" data-bs-toggle="dropdown" aria-expanded="false">
	<i class="bi bi-person-lines-fill"></i>
	Gestion paiment


</button>


<ul class="dropdown-menu" style="">


<li>
	<a class="dropdown-item" href="{{path('app_paiement_index',{id: fiche_client.id})}}">






<i class="bi bi-clock-history me-2"></i>
Historique paiment</a></li>
<li>
<a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#paiementModal">


		


		<i class="bi bi-clock-history me-2"></i>
		Ajouter un paiement</a>
</li>


</ul>


</div>


               

                <a href="{{ path('app_fiche_client_index') }}"
class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">

                    <i class="bi bi-arrow-left"></i>
                    Retour
                </a>

            </div>

        </div>
    </div>

</div>


{# ===================================================== #}
{# üî∑ INFOS CLIENT ‚Äî VERSION COMPACTE & PRO (BOOTSTRAP) #}
{# ===================================================== #}

	<div class="row mb-4"> <div class="col-12">

		<div class="card shadow-sm border-0 rounded-4">
			<div
				class="card-body p-4">

				{# ================= TITRE ================= #}
				<h4 class="fw-bold text-primary d-flex align-items-center mb-4">
					<i class="bi bi-person-lines-fill me-2 fs-4"></i>
					Informations patient
				</h4>

				{# ================= INFOS GRID ================= #}
				<div class="row g-3 small">

					{% macro info(label, value, color) %}
						<div class="col-6 col-md-4">
							<div class="border-start border-3 border-{{ color }} ps-2 h-100">
								<div class="text-muted small">{{ label }}</div>
								<div class="fw-semibold">{{ value ?: '‚Äî' }}</div>
							</div>
						</div>
					{% endmacro %}

					{{ _self.info('Nom', fiche_client.nom, 'primary') }}
					{{ _self.info('Ville', fiche_client.ville, 'info') }}
					{{ _self.info('T√©l√©phone', fiche_client.telephone, 'success') }}
					{{ _self.info('Poids', fiche_client.poids ? fiche_client.poids ~ ' kg' : null, 'danger') }}
					{{ _self.info('Dur√©e maladie', fiche_client.dureeMaladie ? fiche_client.dureeMaladie ~ ' jours' : null, 'warning') }}
					{{ _self.info('Type maladie', fiche_client.typeMaladie, 'secondary') }}

					{# √ÇGE (calcul) #}
					<div class="col-6 col-md-4">
						<div class="border-start border-3 border-dark ps-2 h-100">
							<div class="text-muted small">√Çge</div>
<div class="fw-semibold">
	{% if fiche_client.dateNaissance %}
		{% set diff = fiche_client.dateNaissance.diff(date()) %}

		{% if diff.y >= 1 %}
			{{ diff.y }}
			an{{ diff.y > 1 ? 's' : '' }}
		{% elseif diff.m >= 1 %}
			{{ diff.m }}
			mois
		{% elseif diff.d >= 7 %}
			{{ (diff.d / 7)|round(0, 'floor') }}
			semaine{{ (diff.d / 7)|round(0, 'floor') > 1 ? 's' : '' }}
		{% elseif diff.d > 0 %}
			{{ diff.d }}
			jour{{ diff.d > 1 ? 's' : '' }}
		{% else %}
			moins d‚Äôun jour
		{% endif %}
	{% else %}
		‚Äî
	{% endif %}
</div>


						</div>
					</div>

					{{ _self.info('Cr√©√© le', fiche_client.createdAt|date('d/m/Y'), 'dark') }}

				</div>

				{# ================= TRAITEMENT ================= #}
				<hr class="my-4">

				<h6 class="fw-bold text-warning d-flex align-items-center mb-3">
					<i class="bi bi-journal-medical me-2"></i>
					Traitement & observations
				</h6>

				<div class="row g-3 small">
					<div class="col-12 col-md-6">
						<div class="p-3 bg-light rounded-3 h-100">
							<div class="fw-semibold text-muted mb-1">Traitement</div>
							<div>{{ fiche_client.traitement ?: '‚Äî' }}</div>
						</div>
					</div>

					<div class="col-12 col-md-6">
						<div class="p-3 bg-light rounded-3 h-100">
							<div class="fw-semibold text-muted mb-1">Observations</div>
							<div>{{ fiche_client.observation ?: '‚Äî' }}</div>
						</div>
					</div>
				</div>

				{# ================= RDV ================= #}
				<hr class="my-4">

				<h6 class="fw-bold text-info d-flex align-items-center mb-3">
					<i class="bi bi-calendar-event me-2"></i>
					Rendez-vous
				</h6>

				<div class="d-flex flex-wrap gap-4 small">

					{% macro stat(value, label, color) %}
						<div class="text-center">
							<div class="rounded-circle bg-{{ color }} text-white
								                                        d-flex justify-content-center align-items-center fw-bold" style="width:48px;height:48px;">
								{{ value }}
							</div>
							<div class="fw-semibold text-{{ color }} mt-1">{{ label }}</div>
						</div>
					{% endmacro %}

					{{ _self.stat(rdv_total, 'Total', 'primary') }}
					{{ _self.stat(rdv_future, '√Ä venir', 'success') }}
					{{ _self.stat(rdv_canceled, 'Annul√©s', 'warning') }}
					{{ _self.stat(rdv_past, 'Pass√©s', 'danger') }}

				</div>

			</div>
		</div>

	</div>
</div>




{# ===================================================== #}
{# üü¢ INFORMATIONS M√âDICALES / DOCUMENTATION / SUIVI    #}
{# ===================================================== #}

	<div class="row g-4 mb-4"> <div class="col-12">
		<div class="card shadow-lg border-0 rounded-4">

			<div class="card-body py-4 px-4">

				{# ========================= #}
				{# ü©∫ INFORMATIONS M√âDICALES #}
				{# ========================= #}
					<h4 class="fw-bold text-success d-flex align-items-center mb-4"> <i class="bi bi-heart-pulse-fill me-2 fs-4"></i>
					Informations m√©dicales
				</h4>

				<div class="row g-4">
					<div class="col-12">
						{{ include('fiche_client/_composants/_trouble_digestifs.html.twig') }}
					</div>

					<div class="col-12">
						{{ include('fiche_client/_composants/_symptomes_generaux.html.twig') }}
					</div>

					<div class="col-12">
						{{ include('fiche_client/_composants/_maladies_chroniques.html.twig') }}
					</div>
				</div>

				<div class="mt-3">
					{{ include('fiche_client/_composants/_modal_edit_client/_modal_edit_client.html.twig') }}
				</div>

				<hr class="my-4">

				{# ============================== #}
				{# üì∏ DOCUMENTATION CLINIQUE      #}
				{# ============================== #}
					<h5 class="fw-bold text-info d-flex align-items-center "> <i class="bi bi-camera-fill me-2"></i>
					Documentation clinique
				</h5>

				<p class="text-muted small mb-3">
					Photographies m√©dicales permettant le suivi visuel et l‚Äô√©volution du patient.
				</p>

				{{ include('fiche_client/_composants/_galerie/_galerie.html.twig') }}
				{{ include('fiche_client/_composants/_modal_image/_modal_image.html.twig') }}

				<button class="btn btn-info rounded-pill mt-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalUploadImage">
					<i class="bi bi-camera me-1"></i>
Ajouter Photos, ordonnances, traitements...

				</button>

				<hr class="my-4">

				{# ============================== #}
				{# üìÅ DOSSIERS DE SUIVI            #}
				{# ============================== #}
					<div class="d-flex justify-content-between align-items-center mb-3"> <h5 class="fw-bold text-warning d-flex align-items-center mb-0">
						<i class="bi bi-folder-fill me-2"></i>
						Dossiers de suivi
					</h5>

					<a href="{{ path('app_dossier_medical_index', { id: fiche_client.id }) }}" class="btn btn-warning rounded-pill px-3 shadow-sm">
						<i class="bi bi-folder-plus me-1"></i>
						Acc√©der
					</a>
				</div>

				<div class="p-3 bg-light rounded-3 d-flex align-items-center justify-content-between">
					<div>
						<p class="mb-1 fw-semibold">
							Dossiers enregistr√©s
						</p>
						<small class="text-muted">
							Historique m√©dical, observations et √©volution
						</small>
					</div>

					<span class="badge bg-warning text-dark fs-6 px-3 py-2 rounded-pill">
						{{ fiche_client.dossierMedicals|length }}
					</span>
				</div>

				<div class="mt-3">
					{{ include('fiche_client/_composants/_modal_rdv/_modal_rdv.html.twig') }}
					{{ include('fiche_client/_composants/_modal_paiment/_modal_paiment.html.twig') }}
				</div>

			</div>
		</div>
	</div>

</div>




	

	<style>
		.rdv-circle {
			width: 40px;
			height: 40px;
			font-size: 1rem;
			transition: transform 0.2s ease-in-out;
		}
		.rdv-circle:hover {
			transform: scale(1.12);
		}
			.day-card {
		transition: 0.2s ease;
	}
	.day-card:hover {
		background: rgba(50, 158, 244, 0.1);
		transform: translateY(-3px);
	}
	.day-card.selected {
		background: var(--bs-primary);
		color: white !important;
		border-color: var(--bs-primary);
	}
	</style>
 <script>
document.addEventListener("DOMContentLoaded", () => {

    const daysList = document.querySelectorAll(".day-card");
    const creneauxList = document.getElementById("creneauxList");

    daysList.forEach(day => {

        day.addEventListener("click", async () => {
            // reset selection
            daysList.forEach(d => d.classList.remove("selected"));
            day.classList.add("selected");

            const selectedDate = day.dataset.date;

            creneauxList.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary"></div>
                </div>
            `;

            const res = await fetch(`/api/rdv/disponibilites/${selectedDate}`);
            const data = await res.json();

            creneauxList.innerHTML = "";

            data.forEach(c => {
                creneauxList.innerHTML += `
                    <div class="col-4 col-md-3">
                        <button 
                            class="btn ${c.disponible ? 'btn-success' : 'btn-secondary'} w-100 rounded-pill"
                            ${c.disponible ? '' : 'disabled'}
                            onclick="reserverRdv('${selectedDate}', '${c.heure}')">
                            ${c.heure}
                        </button>
                    </div>
                `;
            });
        });

    });

});


async function reserverRdv(date, heure) {
    rdvDateSelected = date;
    rdvHeureSelected = heure;

    // Ouvre le modal des motifs
    new bootstrap.Modal(document.getElementById("modalMotif")).show();
}

// Quand l'utilisateur valide le motif
document.getElementById("validerMotif").addEventListener("click", async () => {

    const selectMotif = document.getElementById("selectMotif").value;

    const motif =  selectMotif;

    if (!motif) {
        alert("Veuillez s√©lectionner ou saisir un motif.");
        return;
    }

    const payload = {
        patient: {{ fiche_client.id }},
        date: rdvDateSelected,
        heure: rdvHeureSelected,
        motif: motif
    };

    const res = await fetch("/api/rdv/reserver", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
        alert("RDV r√©serv√© !");
        location.reload();
    } else {
        alert(data.error);
    }
});

</script>

{% endblock %}

