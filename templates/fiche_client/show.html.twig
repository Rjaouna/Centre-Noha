{% extends 'base.html.twig' %}

{% block title %}
	{{ fiche_client.nom }}
{% endblock %}

{% block body %}

{# ================= HEADER PATIENT (r√©utilisable) ================= #}
{# ‚úÖ Pr√©requis : _partials/_page_header.html.twig existe d√©j√† #}

	<div class="mt-4"> {% embed '_partials/_page_header.html.twig' with {
        icon: 'bi bi-person-vcard',
        title: fiche_client.nom,
        subtitle: null
    } %}

		{# --------- Sous-ligne (ville + t√©l√©phone) sous le titre --------- #}
		{% block header_subtitle %}
			<div class="d-flex flex-wrap align-items-center text-muted small gap-3 mt-1">
				<span class="d-flex align-items-center">
					<i class="bi bi-geo-alt-fill me-1 text-danger"></i>
					{{ fiche_client.ville }}
				</span>

				<span class="d-flex align-items-center">
					<i class="bi bi-telephone-fill me-1 text-success"></i>
					<a href="tel:{{ fiche_client.telephone }}" class="text-decoration-none text-success fw-semibold">
						{{ fiche_client.telephone }}
					</a>
				</span>
			</div>
		{% endblock %}

		{# --------- Actions m√©tier (mobile √† gauche / desktop √† droite) --------- #}
		{% block header_actions_left %}

			<span class="action-icon bg-primary text-white" role="button" data-bs-toggle="modal" data-bs-target="#modalRdv" data-bs-toggle="tooltip" title="Prendre un rendez-vous">
				<i class="bi bi-calendar-plus"></i>
			</span>

			<span class="action-icon bg-outline" role="button" data-bs-toggle="modal" data-bs-target="#documentsModal" data-bs-toggle="tooltip" title="Documents m√©dicaux">
<i class="bi bi-file-earmark-text-fill"></i>


			</span>

			
<span class="action-icon bg-warning text-dark js-arrive-wr" role="button" data-patient-id="{{ fiche_client.id }}" title="Mettre en salle">
	<i class="bi bi-telephone-fill"></i>
</span>


		{% endblock %}

		{# --------- Navigation (mobile √† droite / desktop √† droite) --------- #}
		{% block header_actions_right %}
			<a href="{{ path('app_home') }}" class="action-icon bg-light text-dark" data-bs-toggle="tooltip" title="Accueil">
				<i class="bi bi-house"></i>
			</a>

			<a href="{{ path('app_fiche_client_index') }}" class="action-icon bg-light" data-bs-toggle="tooltip" title="Retour √† la liste">
				<i class="bi bi-arrow-left"></i>
			</a>
		{% endblock %}

	{% endembed %}
</div>




		{# ===================================================== #}
		{# üü¶ INFORMATIONS PATIENT                              #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-sm border-0 rounded-4">
<div class="card-body py-4">



					<div class="d-flex justify-content-between align-items-center mb-4">
							<h4 class="fw-bold text-dark d-flex align-items-center mb-0">


														<i class="bi bi-person-lines-fill me-2 fs-4"></i>
							Informations patient


						</h4>

						<button class="btn btn-outline-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalEditFiche">
							<i class="bi bi-pencil-square"></i>
							
						</button>
					</div>
{# ===========================
   INFOS CLIENT ‚Äî UX GROUP√â
   =========================== #}

{% macro item(icon, label, value, color) %}
	<div class="ux-info-card ux-{{ color }}">
		<div class="ux-info-icon">
			<i class="bi {{ icon }}"></i>
		</div>
		<div class="ux-info-content">
			<div class="ux-info-label">{{ label }}</div>
			<div class="ux-info-value">{{ value ?: '‚Äî' }}</div>
		</div>
	</div>
{% endmacro %}

<div
	class="accordion ux-accordion" id="uxAccordionClient">

	{# ================= IDENTIT√â ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accIdentite">
			<button class="accordion-button ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIdentite" aria-expanded="true" aria-controls="collapseIdentite">
				<span class="ux-acc-icon">
					<i class="bi bi-person-badge"></i>
				</span>
<span class="ux-acc-title">Informations patient</span>


			</button>
		</h2>

		<div id="collapseIdentite" class="accordion-collapse collapse show" aria-labelledby="accIdentite" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-person-badge', 'Nom', fiche_client.nom, 'primary') }}
					{{ _self.item('bi-person', 'Pr√©nom', fiche_client.prenom, 'primary') }}
					{{ _self.item('bi-credit-card-2-front', 'CIN', fiche_client.cin, 'secondary') }}
					{{ _self.item('bi-calendar3', 'Date de naissance', fiche_client.dateNaissance ? fiche_client.dateNaissance|date('d/m/Y') : null, 'dark') }}
					{{ _self.item('bi-hourglass-split', '√Çge', fiche_client.agePatient is not null ? fiche_client.agePatient ~ ' ans' : null, 'dark') }}
				</div>
			</div>
		</div>
	</div>

	{# ================= CONTACT ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accContact">
			<button class="accordion-button collapsed ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact" aria-expanded="false" aria-controls="collapseContact">
				<span class="ux-acc-icon">
					<i class="bi bi-telephone"></i>
				</span>
<span class="ux-acc-title">Coordonn√©es patient</span>


			</button>
		</h2>

		<div id="collapseContact" class="accordion-collapse collapse" aria-labelledby="accContact" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-geo-alt', 'Ville', fiche_client.ville, 'info') }}
					{{ _self.item('bi-telephone', 'T√©l√©phone', fiche_client.telephone, 'success') }}
				</div>
			</div>
		</div>
	</div>

	{# ================= SANT√â ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accSante">
			<button class="accordion-button collapsed ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSante" aria-expanded="false" aria-controls="collapseSante">
				<span class="ux-acc-icon">
					<i class="bi bi-clipboard2-pulse"></i>
				</span>
<span class="ux-acc-title">Donn√©es de sant√©</span>


			</button>
		</h2>

		<div id="collapseSante" class="accordion-collapse collapse" aria-labelledby="accSante" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-speedometer2', 'Poids', fiche_client.poids ? fiche_client.poids ~ ' kg' : null, 'danger') }}
					{{ _self.item('bi-clock-history', 'Dur√©e maladie', fiche_client.dureeMaladie ? fiche_client.dureeMaladie ~ ' jours' : null, 'warning') }}
					{{ _self.item('bi-clipboard2-pulse', 'Type maladie', fiche_client.typeMaladie, 'secondary') }}
				</div>
			</div>
		</div>
	</div>

	{# ================= SYST√àME ================= #}
	<div class="accordion-item ux-acc-item">
		<h2 class="accordion-header" id="accSysteme">
			<button class="accordion-button collapsed ux-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSysteme" aria-expanded="false" aria-controls="collapseSysteme">
				<span class="ux-acc-icon">
					<i class="bi bi-shield-check"></i>
				</span>
<span class="ux-acc-title">Infos dossier</span>


			</button>
		</h2>

		<div id="collapseSysteme" class="accordion-collapse collapse" aria-labelledby="accSysteme" data-bs-parent="#uxAccordionClient">
			<div class="accordion-body ux-acc-body">
				<div class="ux-info-grid">
					{{ _self.item('bi-calendar-check', 'Cr√©√© le', fiche_client.createdAt ? fiche_client.createdAt|date('d/m/Y H:i') : null, 'dark') }}
					{{ _self.item('bi-arrow-repeat', 'Mis √† jour le', fiche_client.updatedAt ? fiche_client.updatedAt|date('d/m/Y H:i') : null, 'dark') }}
				</div>
			</div>
		</div>
	</div>

</div>





{# ===== Traitement & Observations (UX luxe) ===== #}

<div class="ux-block mt-4" data-theme="warning">

	<div class="d-flex align-items-center gap-2 mb-3">
		<span class="ux-badge-icon">
			<i class="bi bi-journal-medical"></i>
		</span>
		<div>
			<h6 class="mb-0 fw-bold">Traitement & observations</h6>
<small class="text-muted">Infos saisies lors de l‚Äôadmission</small>


		</div>
	</div>

	<div class="row g-3">
		<div class="col-12 col-md-6">
			<div class="ux-note-card h-100">
				<div class="ux-note-head">
<span class="ux-note-label">Traitement d√©clar√© par le patient</span>


				</div>
				<div class="ux-note-value">
					{{ fiche_client.traitement ?: '‚Äî' }}
				</div>
			</div>
		</div>

		<div class="col-12 col-md-6">
			<div class="ux-note-card h-100">
				<div class="ux-note-head">
					<span class="ux-note-label">Observations</span>
				</div>
				<div class="ux-note-value">
					{{ fiche_client.observation ?: '‚Äî' }}
				</div>
			</div>
		</div>
	</div>

</div>

					

				</div>
			</div>
		</section>


		{# ===================================================== #}
		{# ü©∫ INFORMATIONS M√âDICALES                            #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 px-4">

					<h4 class="fw-bold text-success d-flex align-items-center mb-4">
						<i class="bi bi-heart-pulse-fill me-2 fs-4"></i>
						Informations m√©dicales
					</h4>

					<div class="row g-4">
{{ include('fiche_client/_composants/_bloc_infos_medicales/_trouble_digestifs.html.twig') }}


					</div>


					{{ include('fiche_client/_composants/_modal_edit_client/_modal_edit_client.html.twig') }}

				</div>
			</div>
		</section>


		{# ===================================================== #}
		{# üì∏ DOCUMENTATION CLINIQUE                            #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 px-4">

					<h5 class="fw-bold text-info d-flex align-items-center mb-2">
						<i class="bi bi-camera-fill me-2"></i>
						Documentation clinique
					</h5>

					<p class="text-muted small mb-3">
						Photographies m√©dicales permettant le suivi visuel et l‚Äô√©volution du patient.
					</p>

					{{ include('fiche_client/_composants/_galerie/_galerie.html.twig') }}
					{{ include('fiche_client/_composants/_modal_image/_modal_image.html.twig') }}
					{{ include('fiche_client/_composants/_arret_maladie.html.twig') }}
					{{ include('fiche_client/_composants/_ducument_medicaux.html.twig') }}
					{{ include('fiche_client/_composants/_modal_analyse.html.twig') }}

					<button class="btn btn-info btn-upload-static rounded-pill mt-3 shadow-sm text-light" data-bs-toggle="modal" data-bs-target="#modalUploadImage">
						<i class="bi bi-camera me-2 fs-5"></i>
						Ajouter photos, ordonnances, traitements
					</button>

				</div>
			</div>
		</section>


		{# ===================================================== #}
		{# üìÅ SUIVI DOSSIERS                                   #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 px-4">

					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="fw-bold text-warning d-flex align-items-center mb-0">
							<i class="bi bi-folder-fill me-2"></i>
							Suivi dossiers
						</h5>

						<button class="btn btn-warning rounded-pill px-4 shadow-sm text-light" data-bs-toggle="modal" data-bs-target="#modalAddDossier">
							<i class="bi bi-folder-plus"></i>
							Dossier
						</button>
					</div>

					<div class="p-3 bg-light rounded-3 d-flex justify-content-between align-items-center mb-3">
{% set dossierCount = fiche_client.dossierMedicals|length %}

{% if dossierCount > 0 %}
	<div>
		<p class="mb-1 fw-semibold">Dossiers enregistr√©s</p>
		<small class="text-muted">
			Historique m√©dical, observations et √©volution
		</small>
	</div>
{% else %}
	<div class="d-flex align-items-start gap-3">
		<div class="rounded-4 d-flex align-items-center justify-content-center bg-warning bg-opacity-10 text-warning flex-shrink-0" style="width:48px;height:48px;">
			<i class="bi bi-folder-plus fs-4"></i>
		</div>

	<div id="dossiersEmptyState" class="flex-grow-1">

			<p class="mb-1 fw-bold">Aucun dossier pour ce patient</p>
			<small class="text-muted d-block mb-2">
				Cr√©ez un dossier pour commencer le suivi (motif, observations, √©volution‚Ä¶).
			</small>

			<button class="btn btn-warning rounded-pill btn-sm text-light shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAddDossier">
				<i class="bi bi-folder-plus me-1"></i>
				Cr√©er un dossier
			</button>
		</div>
	</div>
{% endif %}



						<span id="dossierCount" class="badge bg-warning text-dark fs-6 px-3 py-2 rounded-pill">
							{{ fiche_client.dossierMedicals|length }}
						</span>
					</div>

					<div id="dossiersContainer" class="row g-4"></div>

				</div>
			</div>
		</section>


{# ===================================================== #}
{# üß™ SUIVI ANALYSES                                   #}
{# ===================================================== #}
	<section class="mb-4"> <div class="card shadow-sm border-0 rounded-4">
		<div class="card-body">

			<div class="d-flex justify-content-between align-items-center mb-3">
				<h5 class="fw-bold text-success mb-0 d-flex align-items-center gap-2">
					<i class="bi bi-clipboard-check"></i>
Analyses


				</h5>

<button class="btn btn-info text-white rounded-pill d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#modalAnalysePrescription">

	<i class="bi bi-plus-circle"></i>


				</button>
			</div>

			<div id="analysePrescriptionsContainer" data-patient-id="{{ fiche_client.id }}">
				{% include 'fiche_client/_composants/_analyse_prescriptions.html.twig' with {
						prescriptions: fiche_client.analysePrescriptions
					} %}
			</div>

		</div>
	</div>
</section>



		{# ===================================================== #}
		{# üìú CERTIFICAT (tu l'avais mais il √©tait m√©lang√©)      #}
		{# ===================================================== #}
	
					{{ include('fiche_client/_composants/_certficat.html.twig') }}
			

{% include 'fiche_client/_composants/_radiologie_block.html.twig' with { patient: fiche_client } %}

		{# ===================================================== #}
		{# üí≥ HISTORIQUE DES PAIEMENTS                          #}
		{# ===================================================== #}
			<section class="mb-4"> <div class="card shadow-sm border-0 rounded-4">
				<div class="card-body">
{% include 'fiche_client/_composants/_prestations.html.twig' with { fiche_client: fiche_client } %}


				</div>
			</div>
		</section>

	</div>


	{# ============================== #}
	{# ‚úÖ MODAL AJOUT DOSSIER (mieux plac√©) #}
	{# ============================== #}
	{{ include('dossier_medical/_composants/_modal_ajouter_dossier.html.twig', { patient: fiche_client }) }}


{{ include('fiche_client/_composants/_modal_rendezvous.html.twig') }}
{{ include('fiche_client/_composants/_choix_appel_waiting_room.html.twig') }}











	{# ============================== #}
{# üìú JAVASCRIPT (ton script dossiers intact) #}
	{# ============================== #}
	 <script>
	function createDossierCard(d) {
		const isActif = d.isActif === true || d.isActif === 1 || d.isActif === "1";
const toggleTitle = isActif ? "D√©sactiver" : "Activer";
const toggleIcon = isActif ? "bi-toggle-on" : "bi-toggle-off";

const toggleBtn = `
  <button type="button"
          class="btn btn-action border-success-subtle ${isActif ? 'text-success' : 'text-secondary'}"
          data-action="toggle-actif"
          data-id="${d.id}"
          data-is-actif="${isActif ? 1 : 0}"
          title="${toggleTitle}">
    <i class="bi ${toggleIcon}"></i>
  </button>
`;

	    const urlSuivi = "{{ path('app_suivi_par_dossier', {
	        patientId: fiche_client.id,
	        dossierId: '__ID__'
	    }) }}".replace('__ID__', d.id);
const hasSuivi = (d.suiviCount ?? 0) > 0;

	
	    return `
	<div class="col-md-6 col-lg-4">
<div class="medical-card h-100 ${isActif ? 'medical-card-active' : ''}">





<div

class="medical-card-header d-flex align-items-start justify-content-between">
<!-- Gauche : ic√¥ne + titre -->
<div class="d-flex align-items-center gap-2">
	<div class="medical-icon">
		<i class="bi bi-folder2-open"></i>
	</div>


<div class="medical-title">
	<h5>${d.titre}
${isActif ? `<span class="badge text-bg-success ms-2">Actif</span>` : ''}


</h5>
	<span class="medical-id">Dossier #${d.id}</span>

</div></div>

<div class="table-actions">
${toggleBtn}

${hasSuivi ? `
<span id="deleteDisabled" class="delete-disabled-wrap">
	<button type="button" class="btn btn-action border-danger-subtle text-danger" disabled tabindex="-1" aria-disabled="true">
		<i class="bi bi-trash3"></i>
	</button>
</span>




<a href="${urlSuivi}" class="btn btn-action border-danger-subtle text-success">

<i class="bi bi-eye me-1"></i>

	
</a>
` : `
<button type="button" class="btn btn-action border-danger-subtle text-danger" data-action="delete" data-id="${d.id}" title="Supprimer">
	<i class="bi bi-trash3"></i>
</button>

<a href="${urlSuivi}" class="btn btn-action border-danger-subtle text-success">

<i class="bi bi-eye me-1"></i>

	
</a>
`}</div>



	</div>

	<div class="medical-card-body">
		<p class="medical-description">
			${d.description ?? "Aucune description renseign√©e pour ce dossier."}
		</p>
	</div>

	<div class="medical-card-footer">
		<div class="medical-meta">
			<span>
				<i class="bi bi-calendar3"></i>
				${d.createdAt}
			</span>
			<span class="medical-count">
				<i class="bi bi-activity"></i>
				${d.suiviCount ?? 0} suivis
			</span>
		</div>

	
	</div>

</div>


	</div>
	    `;
	}
	let activeDossierToastShown = false;

function isActifValue(v) {
  return v === true || v === 1 || v === "1";
}

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function showActiveDossierToast(dossier) {
  const toastEl = document.getElementById("activeDossierToast");
  const bodyEl = document.getElementById("activeDossierToastBody");
  if (!toastEl || !bodyEl) return;

  // URL vers la page dossier (suivi)
  const urlSuivi = "{{ path('app_suivi_par_dossier', { patientId: fiche_client.id, dossierId: '__ID__' }) }}"
    .replace('__ID__', dossier.id);

  bodyEl.innerHTML = `
    <div class="fw-bold mb-1">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      Attention : dossier actif
    </div>

    <div>
      Le dossier actif pour ce client est
      <a class="dossier-link" href="${urlSuivi}">
        ${escapeHtml(dossier.titre)}
      </a>
      <span class="fw-semibold">(#${escapeHtml(dossier.id)})</span>.
      <div class="mt-1">
        Pensez √† le changer si ce n‚Äôest pas le bon.
      </div>
    </div>
  `;

  bootstrap.Toast.getOrCreateInstance(toastEl, {
    delay: 5000,
    autohide: true
  }).show();
}


	async function loadDossiers() {
  const container = document.getElementById("dossiersContainer");
  const badge = document.getElementById("dossierCount");
  const emptyState = document.getElementById("dossiersEmptyState");

  container.innerHTML = `
    <div class="col-12 text-center py-4">
      <div class="spinner-border text-warning"></div>
    </div>
  `;

  try {
    const baseUrl = "{{ path('api_dossier_medical_by_patient', { id: fiche_client.id }) }}";
    const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "ts=" + Date.now(); // ‚úÖ anti-cache

    const response = await fetch(url, {
      method: "GET",
      cache: "no-store", // ‚úÖ important
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("jwt_token"),
        "Accept": "application/json",
        "Cache-Control": "no-cache"
      }
    });

    if (!response.ok) throw new Error("Erreur chargement");

    const dossiers = await response.json();

    // ‚úÖ compteur + empty state
    if (badge) badge.textContent = String(dossiers.length);
    if (emptyState) emptyState.classList.toggle("d-none", dossiers.length > 0);

    container.innerHTML = "";
    dossiers.forEach(d => container.insertAdjacentHTML("beforeend", createDossierCard(d)));

  } catch (error) {
    console.error(error);
    container.innerHTML = `<div class="text-danger text-center">Erreur chargement dossiers</div>`;
  }
}

// ‚úÖ important : rendre accessible depuis les autres scripts
window.loadDossiers = loadDossiers;


	document.addEventListener("DOMContentLoaded", () => {
	    loadDossiers();
	
	    const form = document.getElementById("formAddDossier");
	    const modalEl = document.getElementById("modalAddDossier");
	    const modal = new bootstrap.Modal(modalEl);
	    const addBtn = document.getElementById("addDossier");
	    const container = document.getElementById("dossiersContainer");
	    const badge = document.getElementById("dossierCount");
	
	    if (!form) return;
	
	    form.addEventListener("submit", async (e) => {
	        e.preventDefault();
	
	        const motif = document.querySelector('input[name="motif"]:checked');
	        if (!motif) {
	            alert("Veuillez s√©lectionner un motif.");
	            return;
	        }
	
	        addBtn.disabled = true;
	        addBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Cr√©ation...`;
	
	        try {
	            const response = await fetch(
	                "{{ path('api_dossier_medical_add', { id: fiche_client.id }) }}",
	                {
	                    method: "POST",
	                    headers: {
	                        "Content-Type": "application/json",
	                        "Authorization": "Bearer " + localStorage.getItem("jwt_token")
	                    },
	                    body: JSON.stringify({
	                        titre: motif.value,
	                        description: document.getElementById("dossier_description").value
	                    })
	                }
	            );
	
	            if (response.status !== 200 && response.status !== 201) {
	                throw new Error("Erreur ajout");
	            }
	
	            const dossier = await response.json();
				// ‚úÖ si c‚Äô√©tait le 1er dossier, on enl√®ve le bloc "Aucun dossier"
				document.getElementById("dossiersEmptyState")?.classList.add("d-none");
	            container.insertAdjacentHTML("afterbegin", createDossierCard(dossier));
	            badge.textContent = parseInt(badge.textContent) + 1;
	
	            form.reset();
	            modal.hide();
	
	        } catch (error) {
	            console.error(error);
	            alert("Erreur lors de l'ajout du dossier");
	        } finally {
	            addBtn.disabled = false;
	            addBtn.innerHTML = `<i class="bi bi-check-circle"></i> Enregistrer`;
	        }
	    });
	});
	</script>
 <script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("dossiersContainer");
  if (!container) return;

  const API_SET_ACTIF = (id) =>
    "{{ path('api_dossier_medical_set_actif', { id: '__ID__' }) }}".replace('__ID__', id);

  container.addEventListener("click", async (e) => {
    const btn = e.target.closest('[data-action="toggle-actif"]');
    if (!btn) return;

    const id = btn.dataset.id;
    const current = btn.dataset.isActif === "1";
    const next = !current;

    btn.disabled = true;

    try {
      const res = await fetch(API_SET_ACTIF(id), {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("jwt_token"),
          "Accept": "application/json",
        },
        body: JSON.stringify({ isActif: next })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.success) {
        alert(data.error || data.message || "Erreur lors de la mise √† jour");
        return;
      }

      // üî• Le plus simple/solide : on recharge la liste (garantit un seul actif affich√©)
      await loadDossiers();

    } catch (err) {
      console.error(err);
      alert("Erreur r√©seau");
    } finally {
      btn.disabled = false;
    }
  });
});
</script>


 <script>
document.addEventListener("DOMContentLoaded", () => {
  // Ferme tous les accordions au chargement
  document.querySelectorAll(".accordion .accordion-collapse").forEach((el) => {
    // ferme via Bootstrap (si d√©j√† initialis√© ou non)
    bootstrap.Collapse.getOrCreateInstance(el, { toggle: false }).hide();
  });

  // optionnel : remet l'√©tat visuel des boutons (fl√®che / aria)
  document.querySelectorAll(".accordion .accordion-button").forEach((btn) => {
    btn.classList.add("collapsed");
    btn.setAttribute("aria-expanded", "false");
  });
});

document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("dossiersContainer");
  if (!container) return;

  const API_DELETE = (id) => `/dossier/medical/api/dossier-medical/${id}`;

  container.addEventListener("click", async (e) => {
    const btn = e.target.closest('[data-action="delete"]');
    if (!btn) return;

    const id = btn.dataset.id;

    if (!confirm("Supprimer ce dossier ?")) return;

    try {
      const res = await fetch(API_DELETE(id), {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("jwt_token")
        }
      });

      const data = await res.json();

      if (!res.ok || !data.success) {
        alert(data.message || "Erreur lors de la suppression");
        return;
      }

      // Supprime la carte (et sa colonne)
      btn.closest(".col-md-6")?.remove();

      // Met √† jour compteur + recharge (si tu veux √™tre s√ªr)
      const badge = document.getElementById("dossierCount");
      if (badge) badge.textContent = Math.max(0, parseInt(badge.textContent || "0", 10) - 1);

      await loadDossiers();

    } catch (err) {
      console.error(err);
      alert("Erreur r√©seau");
    }
  });
});


</script>
 <script>
document.addEventListener("DOMContentLoaded", () => {
  // Tooltip unique
  const tip = document.createElement("div");
  tip.className = "delete-tip";
  tip.innerHTML = `
    <div class="title">
      <i class="bi bi-info-circle"></i>
      Suppression impossible
    </div>
    <div class="text">
      Vous ne pouvez pas supprimer un dossier qui contient un suivi‚Ä¶
    </div>
  `;
  document.body.appendChild(tip);

  function showTipFor(el){
    const r = el.getBoundingClientRect();

    // Position : √† droite en dessous du bouton
    const left = Math.min(window.innerWidth - 12 - 320, r.right - 320);
    const top  = r.bottom + 10;

    tip.style.left = Math.max(12, left) + "px";
    tip.style.top  = Math.max(12, top) + "px";
    tip.classList.add("show");
  }

  function hideTip(){
    tip.classList.remove("show");
  }

  // Event delegation (marche m√™me si l'√©l√©ment est ajout√© apr√®s)
  document.addEventListener("mousemove", (e) => {
    const wrap = e.target.closest("#deleteDisabled");
    if (!wrap) return hideTip();
    showTipFor(wrap);
  });

  document.addEventListener("scroll", hideTip, { passive: true });
});
</script>

 <script>
(function () {
  let wrModal = null;
  let currentPatientId = null;

  async function safeJsonFetch(url, options = {}) {
    const r = await fetch(url, options);
    const t = await r.text();
    let j = {};
    try { j = JSON.parse(t); } catch(e) {}
    if (!r.ok) throw new Error(j.message ?? "Erreur serveur");
    return j;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('wrNoteModal');
    if (!modalEl) {
      console.error("‚ùå wrNoteModal introuvable dans la page");
      return;
    }

    wrModal = bootstrap.Modal.getOrCreateInstance(modalEl);

    // Ouverture modal depuis le header (ou n'importe o√π)
    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('.js-arrive-wr');
      if (!btn) return;

      currentPatientId = btn.dataset.patientId;
      document.getElementById('wrNote').value = '';
      wrModal.show();
    });

    // Validation
    document.getElementById('wrConfirmArrive')?.addEventListener('click', async () => {
      const note = document.getElementById('wrNote')?.value;
      if (!note) { alert("Veuillez choisir un motif"); return; }

      try {
        if (typeof window.showLoader === 'function') window.showLoader("Mise en salle‚Ä¶");

        await safeJsonFetch('/api/waiting-room/arrive', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            patientId: parseInt(currentPatientId, 10),
            note: note
          })
        });
if (typeof window.loadDossiers === "function") {

await window.loadDossiers();

}


        wrModal.hide();
      } catch (e) {
        console.error(e);
        alert(e.message);
      } finally {
        if (typeof window.hideLoader === 'function') window.hideLoader();
      }
    });
  });
})();
</script>
 <script>
document.addEventListener("DOMContentLoaded", async () => {
  const toastEl = document.getElementById("activeDossierToast");
  const bodyEl  = document.getElementById("activeDossierToastBody");
  if (!toastEl || !bodyEl) return;

  try {
    // R√©cup√©rer les dossiers du patient
    const baseUrl = "{{ path('api_dossier_medical_by_patient', { id: fiche_client.id }) }}";
    const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "ts=" + Date.now(); // anti-cache

    const res = await fetch(url, {
      method: "GET",
      cache: "no-store",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem("jwt_token"),
        "Accept": "application/json"
      }
    });

    if (!res.ok) return;

    const dossiers = await res.json();

    // Trouver dossier actif
    const actif = dossiers.find(d => d.isActif === true || d.isActif === 1 || d.isActif === "1");
    if (!actif) return;

    // Lien vers le dossier
    const urlSuivi = "{{ path('app_suivi_par_dossier', { patientId: fiche_client.id, dossierId: '__ID__' }) }}"
      .replace("__ID__", actif.id);

    // Contenu toast
    bodyEl.innerHTML = `
      <div class="fw-bold mb-1">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Attention : dossier actif
      </div>
      <div>
        Le dossier actif pour ce client est
        <a class="dossier-link" href="${urlSuivi}">${String(actif.titre ?? '').replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}</a>
        <span class="fw-semibold">(#${actif.id})</span>.
        <div class="mt-1">Pensez √† le changer si ce n‚Äôest pas le bon.</div>
      </div>
    `;

    // ‚úÖ Affichage 5s
    bootstrap.Toast.getOrCreateInstance(toastEl, {
      delay: 5000,
      autohide: true
    }).show();

  } catch (e) {
    console.error(e);
  }
});
</script>



{{ include('fiche_client/_composants/_notifications.html.twig') }}




{% endblock %}

