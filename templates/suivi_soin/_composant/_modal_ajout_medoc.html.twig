<!-- üîµ MODAL RECHERCHE M√âDICAMENTS -->
<div class="modal fade" id="modalMedicSearch" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
		<div class="modal-content ux-med-modal">

			<input
			type="hidden" id="currentSuiviId" value="">

			<!-- HEADER -->
			<div class="modal-header ux-med-header">
				<div class="d-flex align-items-center gap-3">
					<div class="ux-ico">
						<i class="bi bi-capsule-pill"></i>
					</div>
					<div class="lh-1">
						<h5 class="modal-title fw-bold mb-1">Recherche des m√©dicaments</h5>
						<small class="text-white-50">Tape au moins 2 caract√®res puis ajoute au suivi</small>
					</div>
				</div>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
			</div>

			<!-- BODY -->
			<div
				class="modal-body p-4">

				<!-- SEARCH BAR -->
				<div class="ux-search-wrap">
					<i class="bi bi-search ux-search-ico"></i>

					<input type="text" id="medicineSearch" class="form-control ux-search-input" placeholder="Ex: Doliprane, amoxicilline, parac√©tamol‚Ä¶" autocomplete="off">

					<button type="button" id="btnClearMedSearch" class="btn ux-clear-btn" title="Effacer" aria-label="Effacer">
						<i class="bi bi-x-lg"></i>
					</button>
				</div>

				<!-- mini info -->
				<div class="d-flex flex-wrap align-items-center justify-content-between mt-2 mb-3">
					<small class="text-muted">
						<i class="bi bi-lightning-charge-fill text-warning me-1"></i>
						Astuce : tu peux rechercher par nom ou dosage
					</small>

					<small class="text-muted">
						<span id="medCount" class="badge bg-light text-dark rounded-pill px-3">0 r√©sultat</span>
					</small>
				</div>

				<!-- INTRO -->
				<div id="staticIntro" class="ux-intro">
					<div class="row g-3">
						<div class="col-12 col-md-4">
							<div class="ux-intro-card">
								<i class="bi bi-capsule text-danger"></i>
								<div>
									<div class="fw-bold">Rapide</div>
									<div class="text-muted small">Recherche instantan√©e + ajout en 1 clic.</div>
								</div>
							</div>
						</div>

						<div class="col-12 col-md-4">
							<div class="ux-intro-card">
								<i class="bi bi-search text-danger"></i>
								<div>
									<div class="fw-bold">Intelligente</div>
									<div class="text-muted small">Affichage clair (dosage, forme, pr√©sentation).</div>
								</div>
							</div>
						</div>

						<div class="col-12 col-md-4">
							<div class="ux-intro-card">
								<i class="bi bi-shield-check text-danger"></i>
								<div>
									<div class="fw-bold">S√©curis√©e</div>
									<div class="text-muted small">Chaque ajout est li√© au suivi s√©lectionn√©.</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- STATES -->
				<div id="medState" class="mt-3"></div>

				<!-- RESULTS -->
				<div id="results" class="ux-med-grid mt-3"></div>

			</div>

			<!-- FOOTER -->
			<div class="modal-footer ux-med-footer">
				<button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
					Fermer
				</button>
			</div>

		</div>
	</div>
</div>

<style>
	/* ===== Modal look ===== */
	.ux-med-modal {
		border-radius: 22px;
		overflow: hidden;
		border: 1px solid rgba(0, 0, 0, .06);
		box-shadow: 0 22px 60px rgba(0, 0, 0, .18);
	}

	.ux-med-header {
		background: linear-gradient(90deg, rgba(220,53,69,1) 0%, rgba(255,99,132,1) 100%);
		color: #fff;
		padding: 18px 20px;
		border: 0;
	}

	.ux-ico {
		width: 46px;
		height: 46px;
		border-radius: 16px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		background: rgba(255, 255, 255, .16);
		box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .18);
	}
	.ux-ico i {
		font-size: 1.25rem;
	}

	/* ===== Search ===== */
	.ux-search-wrap {
		position: relative;
		background: #fff;
		border: 1px solid rgba(0, 0, 0, .08);
		border-radius: 999px;
		padding: 6px 44px;
		box-shadow: 0 12px 30px rgba(0, 0, 0, .08);
	}
	.ux-search-ico {
		position: absolute;
		left: 16px;
		top: 50%;
		transform: translateY(-50%);
		color: rgba(0, 0, 0, .45);
		font-size: 1.05rem;
	}
	.ux-search-input {
		border: 0 !important;
		outline: none !important;
		box-shadow: none !important;
		border-radius: 999px !important;
		padding: 12px 4px;
		font-weight: 600;
	}
	.ux-search-input::placeholder {
		color: rgba(0, 0, 0, .45);
		font-weight: 500;
	}

	.ux-clear-btn {
		position: absolute;
		right: 10px;
		top: 50%;
		transform: translateY(-50%);
		width: 34px;
		height: 34px;
		border-radius: 999px;
		border: 1px solid rgba(0, 0, 0, .08);
		background: rgba(0, 0, 0, .03);
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.ux-clear-btn:hover {
		background: rgba(0, 0, 0, .06);
	}

	/* ===== Intro cards ===== */
	.ux-intro {
		margin-top: 8px;
	}
	.ux-intro-card {
		background: #fff;
		border: 1px solid rgba(0, 0, 0, .06);
		border-radius: 18px;
		padding: 14px;
		display: flex;
		align-items: center;
		gap: 12px;
		box-shadow: 0 12px 26px rgba(0, 0, 0, .06);
	}
	.ux-intro-card i {
		font-size: 1.35rem;
	}

	/* ===== Results grid ===== */
	.ux-med-grid {
		display: grid;
		grid-template-columns: 1fr;
		gap: 12px;
	}
	@media(min-width: 992px) {
		.ux-med-grid {
			grid-template-columns: 1fr 1fr;
		}
	}

	/* ===== Medicine card ===== */
	.ux-med-card {
		background: #fff;
		border: 1px solid rgba(0, 0, 0, .06);
		border-radius: 18px;
		padding: 14px;
		box-shadow: 0 14px 34px rgba(0, 0, 0, .08);
		transition: 0.18s ease;
		cursor: pointer;
	}
	.ux-med-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 18px 44px rgba(0, 0, 0, .12);
	}

	.ux-med-title {
		font-weight: 900;
		color: #111827;
		line-height: 1.2;
	}
	.ux-med-sub {
		color: #6b7280;
		font-size: 0.88rem;
		margin-top: 4px;
	}

	.ux-badges {
		display: flex;
		flex-wrap: wrap;
		gap: 6px;
		margin-top: 10px;
	}
	.ux-badge {
		font-size: 0.78rem;
		font-weight: 800;
		padding: 0.30rem 0.60rem;
		border-radius: 999px;
		border: 1px solid rgba(0, 0, 0, .06);
		background: rgba(0, 0, 0, .03);
	}
	.ux-badge.ok {
		background: rgba(25, 135, 84, .08);
		border-color: rgba(25, 135, 84, .18);
		color: #198754;
	}
	.ux-badge.no {
		background: rgba(220, 53, 69, .08);
		border-color: rgba(220, 53, 69, .18);
		color: #dc3545;
	}

	.ux-med-actions {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 10px;
		margin-top: 12px;
	}

	/* ===== Your ‚Äúbtn-action‚Äù style ===== */
	.table-actions {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.35rem;
		border-radius: 999px;
		background: rgba(13, 110, 253, .06);
		border: 1px solid rgba(13, 110, 253, .10);
	}

	.btn-action {
		width: 36px;
		height: 36px;
		padding: 0;
		border-radius: 12px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-size: 1rem;
		box-shadow: 0 6px 16px rgba(0, 0, 0, .06);
		background: #fff;
	}
	.btn-action:hover {
		filter:brightness(0.98);
	}

	.btn-action-primary {
		border: 1px solid rgba(13, 110, 253, .25);
		color: #0d6efd;
	}
	.btn-action-success {
		border: 1px solid rgba(25, 135, 84, .25);
		color: #198754;
	}
	.btn-action-secondary {
		border: 1px solid rgba(108, 117, 125, .25);
		color: #6c757d;
	}

	/* ===== State blocks ===== */
	.ux-state {
		border: 1px dashed rgba(0, 0, 0, .12);
		border-radius: 18px;
		padding: 18px;
		text-align: center;
		color: #6b7280;
		background: rgba(0, 0, 0, .02);
	}
	.ux-skeleton {
		border-radius: 18px;
		border: 1px solid rgba(0, 0, 0, .06);
		background: #fff;
		padding: 14px;
		box-shadow: 0 14px 34px rgba(0, 0, 0, .06);
	}
	.ux-skel-line {
		height: 10px;
		border-radius: 999px;
		background: rgba(0, 0, 0, .07);
		overflow: hidden;
		position: relative;
	}
	.ux-skel-line::after {
		content: "";
		position: absolute;
		inset: 0;
		background: linear-gradient(90deg, transparent, rgba(255,255,255,.7), transparent);
		transform: translateX(-100%);
		animation: shimmer 1.0s infinite;
	}
	@keyframes shimmer {
		100% {
			transform: translateX(100%);
		}
	}

	.ux-med-footer {
		border-top: 1px solid rgba(0, 0, 0, .06);
		background: rgba(248, 249, 250, .92);
		backdrop-filter: blur(8px);
	}
</style>

 <script>
(() => {
  const modalEl   = document.getElementById('modalMedicSearch');
  const input     = document.getElementById('medicineSearch');
  const resultsEl = document.getElementById('results');
  const introEl   = document.getElementById('staticIntro');
  const stateEl   = document.getElementById('medState');
  const countEl   = document.getElementById('medCount');
  const btnClear  = document.getElementById('btnClearMedSearch');
  const hiddenSuiviId = document.getElementById('currentSuiviId');

  if (!modalEl || !input || !resultsEl || !introEl || !stateEl || !countEl || !btnClear || !hiddenSuiviId) return;

  let timer = null;
  let aborter = null;

  // ===== helpers =====
  const setCount = (n) => {
    countEl.textContent = `${n} r√©sultat${n > 1 ? 's' : ''}`;
  };

  const showState = (html) => {
    stateEl.innerHTML = html || '';
  };

  const showSkeleton = () => {
    showState('');
    resultsEl.innerHTML = `
      <div class="ux-skeleton">
        <div class="ux-skel-line" style="width:70%"></div>
        <div class="ux-skel-line mt-2" style="width:55%"></div>
        <div class="ux-skel-line mt-3" style="width:40%"></div>
      </div>
      <div class="ux-skeleton">
        <div class="ux-skel-line" style="width:66%"></div>
        <div class="ux-skel-line mt-2" style="width:52%"></div>
        <div class="ux-skel-line mt-3" style="width:38%"></div>
      </div>
      <div class="ux-skeleton d-none d-lg-block">
        <div class="ux-skel-line" style="width:72%"></div>
        <div class="ux-skel-line mt-2" style="width:58%"></div>
        <div class="ux-skel-line mt-3" style="width:42%"></div>
      </div>
      <div class="ux-skeleton d-none d-lg-block">
        <div class="ux-skel-line" style="width:62%"></div>
        <div class="ux-skel-line mt-2" style="width:50%"></div>
        <div class="ux-skel-line mt-3" style="width:35%"></div>
      </div>
    `;
  };

  const clearResults = () => {
    resultsEl.innerHTML = '';
    showState('');
    setCount(0);
    introEl.style.display = 'block';
  };

  function esc(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[s]));
  }

  function renderResults(data){
    resultsEl.innerHTML = '';
    showState('');

    if (!Array.isArray(data) || data.length === 0){
      setCount(0);
      showState(`
        <div class="ux-state">
          <div class="fw-bold text-dark mb-1"><i class="bi bi-emoji-frown me-1"></i>Aucun m√©dicament trouv√©</div>
          <div class="small">Essaie avec un autre mot (ex: ‚Äúpara‚Äù, ‚Äúamoxi‚Äù, ‚Äúdolip‚Äù‚Ä¶)</div>
        </div>
      `);
      return;
    }

    setCount(data.length);

    data.forEach(m => {
      const rembOk = Number(m.tauxRembourssement || 0) !== 0;

      const dosage = [m.dosage, m.uniteDosage].filter(Boolean).join(' ');
      const title  = `${esc(m.name)}${dosage ? ' ‚Äî ' + esc(dosage) : ''}`;
      const sub    = [m.forme, m.presentation].filter(Boolean).map(esc).join(' ‚Äî ');

      const rembTxt = rembOk ? `Rembours√© (${esc(m.tauxRembourssement)}%)` : 'Non remboursable';

      const card = document.createElement('div');
      card.className = 'ux-med-card';
      card.setAttribute('role', 'button');
      card.tabIndex = 0;

      // clique sur la carte -> fiche m√©dicament
      card.addEventListener('click', () => {
        window.location = `/medicine/${m.id}`;
      });

      // enter -> ouvrir aussi
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') window.location = `/medicine/${m.id}`;
      });

      card.innerHTML = `
        <div class="ux-med-title">${title}</div>
        <div class="ux-med-sub">${sub || '<span class="text-muted">‚Äî</span>'}</div>

        <div class="ux-badges">
          <span class="ux-badge ${rembOk ? 'ok' : 'no'}">
            <i class="bi ${rembOk ? 'bi-shield-check' : 'bi-x-circle'} me-1"></i>
            ${rembTxt}
          </span>
          ${m.forme ? `<span class="ux-badge"><i class="bi bi-tag me-1"></i>${esc(m.forme)}</span>` : ''}
        </div>

        <div class="ux-med-actions">
          <small class="text-muted">
            <i class="bi bi-box-arrow-up-right me-1"></i>Ouvrir la fiche
          </small>

          <div class="table-actions">
            <button type="button"
                    class="btn btn-action btn-action-success"
                    title="Ajouter au suivi"
                    data-med-id="${m.id}">
              <i class="bi bi-plus-lg"></i>
            </button>

            <a class="btn btn-action btn-action-secondary"
               href="/medicine/${m.id}"
               title="Voir"
               onclick="event.stopPropagation();"
               target="_blank">
              <i class="bi bi-eye"></i>
            </a>
          </div>
        </div>
      `;

      // bouton ajouter (stop propagation)
      card.querySelector('[data-med-id]').addEventListener('click', (e) => {
        e.stopPropagation();
        addMedicineToSuivi(Number(m.id));
      });

      resultsEl.appendChild(card);
    });
  }

  async function doSearch(q){
    if (aborter) aborter.abort();
    aborter = new AbortController();

    showSkeleton();

    const res = await fetch(`/medicine/search/api?search=${encodeURIComponent(q)}`, {
      headers: { 'Accept': 'application/json' },
      signal: aborter.signal
    });

    if (!res.ok){
      const txt = await res.text().catch(() => '');
      throw new Error(`HTTP ${res.status} ${txt}`);
    }

    return res.json();
  }

  // ===== search listener =====
  input.addEventListener('input', () => {
    const q = input.value.trim();

    clearTimeout(timer);

    if (q.length < 2){
      clearResults();
      return;
    }

    introEl.style.display = 'none';

    timer = setTimeout(async () => {
      try {
        const data = await doSearch(q);
        renderResults(data);
      } catch (e) {
        if (e.name === 'AbortError') return;
        console.error(e);
        resultsEl.innerHTML = '';
        setCount(0);
        showState(`
          <div class="ux-state">
            <div class="fw-bold text-dark mb-1"><i class="bi bi-wifi-off me-1"></i>Erreur de chargement</div>
            <div class="small">Impossible de r√©cup√©rer les r√©sultats. V√©rifie la route API.</div>
          </div>
        `);
      }
    }, 260);
  });

  // clear
  btnClear.addEventListener('click', () => {
    input.value = '';
    clearResults();
    input.focus();
  });

  // focus & reset when modal opens
  modalEl.addEventListener('shown.bs.modal', () => {
    setTimeout(() => input.focus(), 120);
  });

  modalEl.addEventListener('hidden.bs.modal', () => {
    // reset √† la fermeture
    input.value = '';
    clearResults();
  });

  // ‚úÖ D√©l√©gation : r√©cup√®re le suiviId quand on clique sur un bouton ‚Äúajouter m√©dicament‚Äù
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.openMedicModal');
    if (!btn) return;

    const suiviId = btn.dataset.suiviId;
    hiddenSuiviId.value = suiviId || '';
  });

  // ‚úÖ AJOUT MEDICAMENT AU SUIVI (garde ta route)
  window.addMedicineToSuivi = function(medicineId){
    const suiviId = hiddenSuiviId.value;

    if (!suiviId) {
      alert("‚ùå Impossible de d√©terminer le suivi (suiviId manquant).");
      return;
    }

    fetch(`/suivi/${suiviId}/medicine/add`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "application/json"
      },
      body: JSON.stringify({ medicine_id: medicineId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert("‚ùå " + data.error);
        return;
      }

      // ‚úÖ refresh de ta timeline
      if (typeof reloadTimeline === 'function') reloadTimeline();

      // Option UX: petit feedback
      // alert("‚úÖ M√©dicament ajout√© !");
    })
    .catch(err => {
      console.error(err);
      alert("Erreur r√©seau");
    });
  };

})();
</script>

