<!-- üîµ MODAL RECHERCHE M√âDICAMENTS -->
<div class="modal fade" id="modalMedicSearch" tabindex="-1">
	<div class="modal-dialog modal-xl">
		<div
			class="modal-content rounded-4 shadow-lg">
<input type="hidden" id="currentSuiviId">



			<!-- HEADER -->
			<div class="modal-header bg-danger text-white rounded-top-4">
				<h5 class="modal-title fw-bold d-flex align-items-center">
					<i class="bi bi-capsule-pill fs-4 me-2"></i>
					Recherche des M√©dicaments
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<!-- BODY -->
			<div
				class="modal-body p-4">

				<!-- ‚≠ê‚≠ê CHAMP DE RECHERCHE ‚≠ê‚≠ê -->
				<div class="position-relative my-4">
					<i class="bi bi-search text-secondary position-absolute top-50 start-3 translate-middle-y"></i>

					<input type="text" id="medicineSearch" class="form-control-lg shadow-sm form-control rounded-pill ps-5" placeholder="Rechercher un m√©dicament...">
				</div>

				<style>
					.start-3 {
						left: 16px
					}
				</style>

				<!-- ‚≠ê‚≠ê CONTENU STATIQUE ‚≠ê‚≠ê -->
				<div id="staticIntro" class="mb-4">

					<div class="row g-4">

						<div class="col-md-4">
							<div class="card med-info shadow-sm border-0 rounded-4 p-4 h-100">
								<i class="bi bi-capsule text-danger fs-2 mb-3"></i>
								<h5 class="fw-bold">Vue d‚Äôensemble rapide</h5>
								<p class="text-secondary small">
									Acc√©dez en un coup d‚Äô≈ìil aux m√©dicaments les plus courants.
								</p>
							</div>
						</div>

						<div class="col-md-4">
							<div class="card med-info shadow-sm border-0 rounded-4 p-4 h-100">
								<i class="bi bi-search text-danger fs-2 mb-3"></i>
								<h5 class="fw-bold">Recherche intelligente</h5>
								<p class="text-secondary small">
									Tapez quelques lettres pour filtrer instantan√©ment.
								</p>
							</div>
						</div>

						<div class="col-md-4">
							<div class="card med-info shadow-sm border-0 rounded-4 p-4 h-100">
								<i class="bi bi-shield-check text-danger fs-2 mb-3"></i>
								<h5 class="fw-bold">S√©curit√©</h5>
								<p class="text-secondary small">
									Chaque fiche est li√©e au suivi m√©dical.
								</p>
							</div>
						</div>

					</div>

				</div>

				<!-- ‚≠ê‚≠ê R√âSULTATS API ‚≠ê‚≠ê -->
				<div id="results"></div>

			</div>

		</div>
	</div>
</div>

<!-- ‚≠ê‚≠ê STYLES + SCRIPT ‚≠ê‚≠ê -->
<style>
	.med-card {
		background: white;
		border-radius: 20px;
		padding: 22px;
		margin-bottom: 18px;
		border: 1px solid rgba(0, 0, 0, 0.08);
		transition: 0.3s;
		cursor: pointer;
	}
	.med-card:hover {
		transform: translateY(-6px);
		box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
	}
	.med-info {
		transition: 0.3s;
	}
	.med-info:hover {
		transform: translateY(-5px);
		box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
	}
</style>

 <script>
document.addEventListener("DOMContentLoaded", () => {

    const input = document.getElementById("medicineSearch");
    const results = document.getElementById("results");
    const staticIntro = document.getElementById("staticIntro");
    let timer = null;

    function renderResults(data) {
        results.innerHTML = "";

        data.forEach(m => {
            const card = `
<div class="med-card shadow-sm" onclick="window.location='/medicine/${m.id}'">
	<div class="d-flex justify-content-between">

		<div>
			<p class="fw-bold text-secondary mb-1">${m.name} - ${m.dosage} ${m.uniteDosage}

			</p>


			<p class="text-secondary small mb-1">
				${m.forme} - ${m.presentation}


				<span class="text-${m.tauxRembourssement != 0 ? 'success' : 'danger'}">
					${m.tauxRembourssement != 0 ? '(Taux de rembourssement : 70%)' : '(Non Rembourssable)'}</span>


			</p>
		</div>

		
<button onclick="event.stopPropagation(); addMedicineToSuivi(${m.id})" class="btn btn-outline-danger btn-sm rounded">
	Pr√©scrire
</button>



	</div>
</div>`;
            results.insertAdjacentHTML("beforeend", card);
        });
    }

    // Recherche
    input.addEventListener("keyup", () => {

        clearTimeout(timer);

        timer = setTimeout(() => {

            const q = input.value.trim();

            if (q.length < 2) {
                staticIntro.style.display = "block";
                results.innerHTML = "";
                return;
            }

            staticIntro.style.display = "none";

            fetch(`/medicine/search/api?search=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(data => {

                    if (data.length === 0) {
                        results.innerHTML = `
                            <div class="alert alert-warning text-center rounded-4 py-3">
                                Aucun m√©dicament trouv√©.
                            </div>`;
                        return;
                    }

                    renderResults(data);
                });

        }, 250);
    });

});
// recupere le suivi id
let currentSuiviId = null;

// Quand on clique sur un bouton pour ouvrir le modal
document.querySelectorAll(".openMedicModal").forEach(btn => {

    btn.addEventListener("click", () => {
        currentSuiviId = btn.getAttribute("data-suivi-id");
        console.log("Suivi s√©lectionn√© :", currentSuiviId);
    });

});

// ajouter un medicine a un suivi de soin
function addMedicineToSuivi(medicineId) {
    const suiviId = document.getElementById("currentSuiviId").value;

    if (!suiviId) {
        alert("‚ùå Impossible de d√©terminer le suivi !");
        return;
    }

    if (!confirm("Voulez-vous vraiment ajouter ce m√©dicament ?")) {
        return; // Annul√© par l‚Äôutilisateur
    }

    fetch(`/suivi/${suiviId}/medicine/add`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ medicine_id: medicineId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("‚ùå " + data.error);
            return;
        }

        alert("‚úî M√©dicament ajout√© !");
        reloadTimeline();
    })
    .catch(err => {
        alert("Erreur r√©seau");
        console.error(err);
    });
}



</script>

