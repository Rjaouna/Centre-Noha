<!-- ===== MODAL AJOUT SUIVI ===== -->
<div class="modal fade" id="modalAddSuivi" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-clipboard-plus me-2"></i>
					Nouveau suivi médical
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body p-4">

				<input type="text" id="symptomeSearch" class="form-control mb-1" placeholder="Tapez un symptôme (ex: fièvre, toux, douleur...)" autocomplete="off">

				<div id="symptomeResults" class="list-group position-absolute w-100 shadow-sm" style="z-index:1050; display:none;"></div>

				<form id="formAddSuivi">

					<div class="form-floating mb-3">
						<textarea id="suivi_diagnostic" class="form-control" style="height:120px;" placeholder="Diagnostic" required></textarea>
						<label for="suivi_diagnostic">Ordonnance</label>
					</div>

					<button id="addSuivi" class="btn btn-primary w-100 rounded-pill py-2">
						<i class="bi bi-check-circle"></i>
						Enregistrer
					</button>

				</form>

			</div>
		</div>
	</div>
</div>

{% block javascripts %}
 <script>
document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById("formAddSuivi");
    const modalEl = document.getElementById("modalAddSuivi");
    const modal = new bootstrap.Modal(modalEl);
    const addBtn = document.getElementById("addSuivi");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // UI loading
        addBtn.disabled = true;
        addBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2"></span>
            Enregistrement...
        `;

        const payload = {
            diagnostic: document.getElementById("suivi_diagnostic").value
        };

        try {
            const res = await fetch(
                `{{ path('api_suivi_create', { patientId: patient.id, dossierId: dossier.id }) }}`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + localStorage.getItem("jwt_token")
                    },
                    body: JSON.stringify(payload)
                }
            );

            const data = await res.json();

            if (!data.success) {
                throw new Error(data.message || "Erreur API");
            }

            // ✅ Recharger toute la timeline proprement
            reloadTimeline();

            // Reset & close
            form.reset();
            modal.hide();

        } catch (error) {
            console.error(error);
            alert("Erreur lors de l'ajout du suivi.");
        } finally {
            addBtn.disabled = false;
            addBtn.innerHTML = `<i class="bi bi-check-circle"></i> Enregistrer`;
        }
    });
});
</script>
 <script>
document.addEventListener("DOMContentLoaded", () => {

    const input = document.getElementById("symptomeSearch");
    const resultsBox = document.getElementById("symptomeResults");
    const diagnosticField = document.getElementById("suivi_diagnostic");

    let timeout = null;
    let selectedSymptomes = new Set();

    input.addEventListener("input", () => {
        const query = input.value.trim();
        clearTimeout(timeout);

        if (query.length < 2) {
            resultsBox.style.display = "none";
            return;
        }

        timeout = setTimeout(async () => {
            const res = await fetch(`/api/symptomes/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            resultsBox.innerHTML = "";

            if (!data.length) {
                resultsBox.style.display = "none";
                return;
            }

            data.forEach(symptome => {
                if (selectedSymptomes.has(symptome.name)) return;

                const item = document.createElement("button");
                item.type = "button";
                item.className = "list-group-item list-group-item-action";
                item.innerHTML = `
                    <strong>${symptome.name}</strong>
                    <small class="text-muted d-block">${symptome.category}</small>
                `;

                item.onclick = () => addSymptome(symptome.name);
                resultsBox.appendChild(item);
            });

            resultsBox.style.display = "block";
        }, 300);
    });

    function addSymptome(name) {
        if (selectedSymptomes.has(name)) return;
        selectedSymptomes.add(name);

        let text = diagnosticField.value.trim();
        if (!text.includes("Symptômes :")) {
            diagnosticField.value = `Symptômes :\n- ${name}\n\n${text}`;
        } else {
            diagnosticField.value += `- ${name}\n`;
        }
    }

    document.addEventListener("click", e => {
        if (!e.target.closest("#symptomeSearch")) {
            resultsBox.style.display = "none";
        }
    });
});
</script>
{% endblock %}


