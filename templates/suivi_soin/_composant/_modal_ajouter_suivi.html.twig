<!-- ===== MODAL AJOUT SUIVI ===== -->
<div class="modal fade" id="modalAddSuivi" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content rounded-4 shadow-lg">

			<div class="modal-header bg-primary text-white rounded-top-4">
				<h5 class="modal-title fw-bold">
					<i class="bi bi-clipboard-plus me-2"></i>
					Nouveau suivi mÃ©dical
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div class="modal-body p-4">

				<form id="formAddSuivi">

					<input type="hidden" id="patient_id" value="{{ patient.id }}">
					<input type="hidden" id="dossier_id" value="{{ dossier.id }}">

					<div class="form-floating mb-3">
						<textarea id="suivi_diagnostic" class="form-control" style="height:120px;" placeholder="Diagnostic" required></textarea>
						<label for="suivi_diagnostic">Diagnostic</label>
					</div>

					<button id="addSuivi" class="btn btn-primary w-100 rounded-pill py-2">
						<i class="bi bi-check-circle"></i>
						Enregistrer
					</button>

				</form>

			</div>

		</div>
	</div>
</div>

{% block javascripts %}

	 <script>
	document.addEventListener("DOMContentLoaded", () => {
	
	    const form = document.getElementById("formAddSuivi");
	
	    // Le modal existe forcÃ©ment car il est INCLUS avant ce script
	    const modalElement = document.getElementById("modalAddSuivi");
	    const modal = new bootstrap.Modal(modalElement);
	
	    // Bouton enregistrer
	    const addBtn = document.getElementById("addSuivi");
	
	    // VÃ©rification sÃ©curitÃ©
	    if (!addBtn) {
	        console.error("âŒ ERREUR : Le bouton #addSuivi n'existe pas dans le DOM.");
	        return;
	    }
	
	    const timeline = document.querySelector(".timeline-container");
	
	    form.addEventListener("submit", async (e) => {
	        e.preventDefault();
	
	        // Spinner + countdown
	        let seconds = 2;
	        addBtn.disabled = true;
	        addBtn.innerHTML = `
	            <span class="spinner-border spinner-border-sm me-2"></span>
	            Enregistrement... (${seconds}s)
	        `;
	
	        const countdown = setInterval(() => {
	            seconds--;
	            addBtn.innerHTML = `
	                <span class="spinner-border spinner-border-sm me-2"></span>
	                Enregistrement... (${seconds}s)
	            `;
	            if (seconds <= 0) clearInterval(countdown);
	        }, 1000);
	
	        // Payload
	        const payload = {
	            diagnostic: document.getElementById("suivi_diagnostic").value
	        };
	
	        // API URL
	        const apiUrl = `{{ path('api_suivi_create', { patientId: patient.id, dossierId: dossier.id }) }}`;
	
	        const res = await fetch(apiUrl, {
	            method: "POST",
	            headers: {
	                "Content-Type": "application/json",
	                "Authorization": "Bearer " + localStorage.getItem("jwt_token")
	            },
	            body: JSON.stringify(payload)
	        });
	
	        const data = await res.json();
	
	        if (!data.success) {
	            addBtn.innerHTML = `<i class="bi bi-x-circle"></i> Erreur`;
	            addBtn.classList.add("btn-danger");
	            return;
	        }
	
	        // Supprimer le message "Aucun suivi"
	        const noData = document.getElementById("noData");
	        if (noData) noData.remove();
	
	        // CrÃ©ation du nouvel item timeline ðŸš€
	        const newItem = `
	            <div class="timeline-item fade-in">
	                <div class="timeline-marker"></div>
	
	                <div class="timeline-content shadow-sm rounded-4">
	
	                    <div class="timeline-header">
	                        <i class="bi bi-clipboard2-pulse text-primary fs-4 me-2"></i>
	                        <h5 class="mb-0 fw-bold text-primary">Diagnostic</h5>
	                    </div>
	
	                    <p class="text-secondary mt-3">${data.diagnostic}</p>
	
	                    <div class="timeline-meta text-muted small mt-2">
	                        <i class="bi bi-clock-history me-1"></i>
	                        AjoutÃ© maintenant
	                    </div>
	
	                    <div class="mt-3 text-end">
	                        <a href="#" class="btn btn-outline-danger btn-sm rounded-pill">
	                            <i class="bi bi-trash"></i>
	                        </a>
	                    </div>
	
	                </div>
	            </div>
	        `;
	
	        // Ajout au dÃ©but de la timeline
	        timeline.insertAdjacentHTML("afterbegin", newItem);
	
	        // Reset & fermeture modal
	        setTimeout(() => {
	            form.reset();
	            modal.hide();
	            addBtn.disabled = false;
	            addBtn.innerHTML = `<i class="bi bi-check-circle"></i> Enregistrer`;
	        }, 2000);
	
	    });
	
	});
	</script>

{% endblock %}




