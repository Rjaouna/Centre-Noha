{% extends 'base.html.twig' %}

{% block title %}Suivi —
	{{ dossier.titre }}
{% endblock %}

{% block body %}

	{{ include('suivi_soin/_composant/_modal_ajouter_suivi.html.twig') }}

	<style>
		/* ===============================
       ✅ LISTE SUIVI (CARDS)
    =============================== */
		.suivi-card {
			background: #fff;
			border-radius: 18px;
			border: 1px solid #eef1f6;
			box-shadow: 0 8px 18px rgba(0, 0, 0, .06);
			transition: 0.2s ease;
			overflow: hidden;
		}

		.suivi-card-header {
			padding: 16px 18px;
			border-bottom: 1px solid #f1f3f7;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			flex-wrap: wrap;
		}

		.suivi-card-title {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.suivi-card-title i {
			font-size: 1.2rem;
		}

		.suivi-card-body {
			padding: 18px;
		}

		.suivi-card-meta {
			padding: 14px 18px;
			border-top: 1px solid #f1f3f7;
			background: #fbfcff;
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap;
		}

		.ordonnance-meds .med-item {
			background: #f8faff;
			border: 1px solid #e9eefb;
		}

		.fade-in {
			animation: fadeIn 0.5s ease-in-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.fade-out {
			opacity: 0;
			transition: 0.3s ease;
			transform: translateX(-20px);
		}
	</style>

	<div
		class="mt-4">

		{# ================= HEADER (même style que ton app) ================= #}
		<section class="mb-4">
			<div class="card shadow-lg border-0 rounded-4">
				<div class="card-body py-4 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">

					<div>
						<h2 class="fw-bold text-primary mb-1 d-flex align-items-center">
							<i class="bi bi-journal-medical me-2 fs-1"></i>
							Suivi médical
						</h2>

						<div class="d-flex flex-wrap align-items-center text-muted small gap-3">
							<span class="d-flex align-items-center">
								<i class="bi bi-folder2-open me-1 text-warning"></i>
								Dossier :
								<strong class="ms-1">{{ dossier.titre }}</strong>
							</span>

							<span class="d-flex align-items-center">
								<i class="bi bi-person-fill me-1 text-primary"></i>
								Patient :
								<strong class="ms-1">{{ patient.nom }}</strong>
							</span>
						</div>
					</div>

					<div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
						<div class="d-flex align-items-center gap-3">

							<span class="action-icon bg-primary text-white" data-bs-toggle="modal" data-bs-target="#modalAddSuivi" title="Ajouter un suivi">
								<i class="bi bi-clipboard-plus"></i>
							</span>

						</div>

						<a href="javascript:void(0);" onclick="history.back()" class="action-icon bg-light" title="Retour">
							<i class="bi bi-arrow-left"></i>
						</a>
					</div>

				</div>
			</div>
		</section>

		{# ================= LISTE SUIVI ================= #}
		<section class="mb-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">

					<div id="suiviList" class="row g-4">
						<div class="col-12 text-center text-muted py-4">
							<div class="spinner-border text-primary"></div>
							<div class="mt-2">Chargement des suivis...</div>
						</div>
					</div>

				</div>
			</div>
		</section>

	</div>

	{# ================= MODAL CONFIRM DELETE ================= #}
	<div class="modal fade" id="modalConfirmDelete" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<div class="modal-header bg-danger text-white rounded-top-4">
					<h5 class="modal-title fw-bold">
						<i class="bi bi-exclamation-triangle me-2"></i>
						Confirmer la suppression
					</h5>
					<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">
					<p class="mb-0">
						Voulez-vous vraiment supprimer ce suivi ?<br>
						<strong>Cette action est irréversible.</strong>
					</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Annuler</button>
					<button id="confirmDeleteBtn" class="btn btn-danger rounded-pill">
						Supprimer
					</button>
				</div>

			</div>
		</div>
	</div>

	{{ include('suivi_soin/_composant/_modal_ajout_medoc.html.twig') }}

 <script>
    const apiUrl = `/patient/{{ patient.id }}/dossier/{{ dossier.id }}/suivis/api`;

    function renderEmptySuivi() {
        return `
            <div class="col-12 fade-in">
                <div class="p-4 bg-light rounded-4 text-center shadow-sm">
                    <div class="mb-3">
                        <i class="bi bi-journal-x fs-1 text-primary"></i>
                    </div>
                    <h4 class="fw-bold text-primary mb-2">Aucun suivi médical</h4>
                    <p class="text-muted mb-4">
                        Ce dossier ne contient encore aucun suivi.<br>
                        Vous pouvez commencer par en créer un dès maintenant.
                    </p>
                    <button class="btn btn-primary rounded-pill px-4 shadow-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#modalAddSuivi">
                        <i class="bi bi-clipboard-plus me-2"></i>
                        Ajouter le premier suivi
                    </button>
                </div>
            </div>
        `;
    }

    function renderSuiviCard(suivi) {
        const medsHtml = (suivi.medicines && suivi.medicines.length > 0)
            ? `
                <div class="mt-3">
                    <h6 class="fw-bold text-primary mb-2">Médicaments prescrits</h6>
                    <div class="ordonnance-meds">
                        ${suivi.medicines.map(med => `
                            <div class="med-item mb-3 p-3 rounded-3 shadow-sm">
                                <div class="text-primary fw-semibold">
                                    ${med.name} — ${med.dosage} ${med.uniteDosage}
                                </div>
                                <div class="text-muted mt-1 small">
                                    ${med.forme} — ${med.presentation}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
              `
            : `<p class="text-muted mt-3"><em>Aucun médicament ajouté pour ce suivi.</em></p>`;

        return `
            <div class="col-12 fade-in">
                <div class="suivi-card">

                    <div class="suivi-card-header">
                        <div class="suivi-card-title">
                            <i class="bi bi-clipboard2-pulse text-primary"></i>
                            <div>
                                <div class="fw-bold text-primary">Suivi N° : ${suivi.id}</div>
                                <div class="text-muted small">
                                    <i class="bi bi-clock-history me-1"></i>${suivi.createdAt}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <a href="#" onclick="deleteSuivi(${suivi.id}, this.closest('.col-12'))"
                               class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash"></i>
                            </a>

                            <a href="#" class="btn btn-outline-primary btn-sm openMedicModal"
                               data-suivi-id="${suivi.id}"
                               data-bs-toggle="modal"
                               data-bs-target="#modalMedicSearch">
                                <i class="bi bi-capsule-pill"></i>
                            </a>

                            <a href="/suivi/${suivi.id}/ordonnance?print=1" target="_blank"
                               class="btn btn-outline-secondary btn-sm text-secondary">
                                <i class="bi bi-printer"></i>
                            </a>

                            <a href="/suivi/${suivi.id}/ordonnance"
                               class="btn btn-danger text-white btn-sm">
                                <i class="bi bi-file-pdf"></i>
                            </a>
                        </div>
                    </div>

                    <div class="suivi-card-body">
                        <p class="text-secondary mb-0">${suivi.diagnostic}</p>
                        ${medsHtml}
                    </div>

                </div>
            </div>
        `;
    }

    function reloadTimeline() {
        const container = document.getElementById("suiviList");

        container.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <div class="spinner-border text-primary"></div>
                <div class="mt-2">Chargement des suivis...</div>
            </div>
        `;

        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {

                container.innerHTML = "";

                if (!data || data.length === 0) {
                    container.innerHTML = renderEmptySuivi();
                    return;
                }

                data.forEach(suivi => {
                    container.insertAdjacentHTML("beforeend", renderSuiviCard(suivi));
                });
            });
    }

    document.addEventListener("DOMContentLoaded", reloadTimeline);
</script>

	 <script>
	    document.addEventListener("click", function (e) {
	        const btn = e.target.closest(".openMedicModal");
	        if (!btn) return;
	
	        const suiviId = btn.dataset.suiviId;
	        document.getElementById("currentSuiviId").value = suiviId;
	    });
	</script>

	 <script>
	    let pendingDelete = { id: null, element: null };
	
	    async function deleteSuivi(id, element) {
	        pendingDelete.id = id;
	        pendingDelete.element = element;
	
	        const modal = new bootstrap.Modal(document.getElementById("modalConfirmDelete"));
	        modal.show();
	    }
	
	    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
	
	        const { id, element } = pendingDelete;
	
	        const url = `{{ path('api_suivi_delete', {id : 'replace_id'}) }}`.replace("replace_id", id);
	
	        const res = await fetch(url, {
	            method: "DELETE",
	            headers: {
	                "Authorization": "Bearer " + localStorage.getItem("jwt_token")
	            }
	        });
	
	        const text = await res.text();
	        let data;
	        try {
	            data = JSON.parse(text);
	        } catch (e) {
	            alert("Erreur interne du serveur");
	            return;
	        }
	
	        if (data.success) {
	            element.classList.add("fade-out");
	            setTimeout(() => {
	                element.remove();
	                reloadTimeline(); // ✅ si plus aucun suivi, on affiche l'empty state
	            }, 300);
	
	            bootstrap.Modal.getInstance(document.getElementById("modalConfirmDelete")).hide();
	        } else {
	            alert("Erreur : " + data.message);
	        }
	    });
	</script>

{% endblock %}

