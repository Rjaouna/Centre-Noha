{% extends 'base.html.twig' %}

{% block title %}Suivi —
	{{ dossier.titre }}
{% endblock %}

{% block body %}

	{{ include('suivi_soin/_composant/_modal_ajouter_suivi.html.twig') }}

	<style>
		/* ===============================
       ✅ LISTE SUIVI (CARDS)
    =============================== */
		.suivi-card {
			background: #fff;
			border-radius: 18px;
			border: 1px solid #eef1f6;
			box-shadow: 0 8px 18px rgba(0, 0, 0, .06);
			transition: 0.2s ease;
			overflow: hidden;
		}

		.suivi-card-header {
			padding: 16px 18px;
			border-bottom: 1px solid #f1f3f7;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			flex-wrap: wrap;
		}

		.suivi-card-title {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.suivi-card-title i {
			font-size: 1.2rem;
		}

		.suivi-card-body {
			padding: 18px;
		}

		.suivi-card-meta {
			padding: 14px 18px;
			border-top: 1px solid #f1f3f7;
			background: #fbfcff;
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap;
		}

		.ordonnance-meds .med-item {
			background: #f8faff;
			border: 1px solid #e9eefb;
		}
.med-item {
  position: relative;
}

.btn-del-med {
  position: absolute;
  top: 12px;
  right: 12px;

  width: 36px;
  height: 36px;
  border-radius: 50%;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  flex-shrink: 0;
}

		.fade-in {
			animation: fadeIn 0.5s ease-in-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.fade-out {
			opacity: 0;
			transition: 0.3s ease;
			transform: translateX(-20px);
		}
		/* Optionnel si déjà présent chez toi */
.table-actions{
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  padding:.35rem;
  border-radius:999px;
  background: rgba(13,110,253,.06);
  border: 1px solid rgba(13,110,253,.10);
}

.btn-action{
  width:36px;
  height:36px;
  padding:0;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:1rem;
  box-shadow:0 6px 16px rgba(0,0,0,.06);
  background:#fff;
}
.btn-del-med {
  flex-shrink: 0;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}


/* variantes */
.btn-action-primary{ border:1px solid rgba(13,110,253,.25); color:#0d6efd; }
.btn-action-danger{ border:1px solid rgba(220,53,69,.25); color:#dc3545; }

/* nouvelle variante pour l'impression */
.btn-action-secondary{
  border:1px solid rgba(108,117,125,.25);
  color:#6c757d;
}

.btn-action:hover{ filter:brightness(.98); }

	</style>

	<div
		class="mt-4">

		{# ================= HEADER (même style que ton app) ================= #}
{# ================= HEADER SUIVI MÉDICAL (avec ton partial) ================= #}

{% embed '_partials/_page_header.html.twig' with {
    icon: 'bi bi-journal-medical',
    title: 'Suivi médical',
    subtitle: null
} %}

	{# --------- Sous-ligne dossier + patient --------- #}
	{% block header_subtitle %}
		<div class="d-flex flex-wrap align-items-center text-muted small gap-3 mt-1">

			<span class="d-flex align-items-center">
				<i class="bi bi-folder2-open me-1 text-warning"></i>
				Dossier :
				<strong class="ms-1">{{ dossier.titre }}</strong>
			</span>

			<span class="d-flex align-items-center">
				<i class="bi bi-person-fill me-1 text-primary"></i>
				Patient :
				<strong class="ms-1">{{ patient.nom }}</strong>
			</span>

		</div>
	{% endblock %}

	{# --------- Actions métier (mobile à gauche / desktop à droite) --------- #}
	{% block header_actions_left %}

		<span class="action-icon bg-primary text-white" role="button" data-bs-toggle="modal" data-bs-target="#modalAddSuivi" data-bs-toggle="tooltip" title="Ajouter un suivi">
			<i class="bi bi-clipboard-plus"></i>
		</span>

	{% endblock %}

	{# --------- Navigation (mobile à droite / desktop à droite) --------- #}
	{% block header_actions_right %}

		<a href="{{ path('app_home') }}" class="action-icon bg-light text-dark" data-bs-toggle="tooltip" title="Accueil">
			<i class="bi bi-house"></i>
		</a>

		<a href="javascript:void(0);" onclick="history.back()" class="action-icon bg-light" data-bs-toggle="tooltip" title="Retour">
			<i class="bi bi-arrow-left"></i>
		</a>

	{% endblock %}

{% endembed %}



		{# ================= LISTE SUIVI ================= #}
		<section class="mb-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">

					<div id="suiviList" class="row g-4">
						<div class="col-12 text-center text-muted py-4">
							<div class="spinner-border text-primary"></div>
							<div class="mt-2">Chargement des suivis...</div>
						</div>
					</div>

				</div>
			</div>
		</section>

	</div>

	{# ================= MODAL CONFIRM DELETE ================= #}
	<div class="modal fade" id="modalConfirmDelete" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<div class="modal-header bg-danger text-white rounded-top-4">
					<h5 class="modal-title fw-bold">
						<i class="bi bi-exclamation-triangle me-2"></i>
						Confirmer la suppression
					</h5>
					<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">
					<p class="mb-0">
						Voulez-vous vraiment supprimer ce suivi ?<br>
						<strong>Cette action est irréversible.</strong>
					</p>
				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Annuler</button>
					<button id="confirmDeleteBtn" class="btn btn-danger rounded-pill">
						Supprimer
					</button>
				</div>

			</div>
		</div>
	</div>

	{{ include('suivi_soin/_composant/_modal_ajout_medoc.html.twig') }}

 <script>
    const apiUrl = `/patient/{{ patient.id }}/dossier/{{ dossier.id }}/suivis/api`;

    function renderEmptySuivi() {
  return `
    <div class="col-12 fade-in">
      <div class="p-4 p-md-5 rounded-4 text-center shadow-sm border bg-white">
        <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
             style="width:72px;height:72px;background:rgba(13,110,253,.08);border:1px solid rgba(13,110,253,.12);">
          <i class="bi bi-journal-x fs-2 text-primary"></i>
        </div>

        <h4 class="fw-bold mb-2">Aucun suivi médical</h4>
        <p class="text-muted mb-4">
          Ce dossier ne contient encore aucun suivi.<br>
          Ajoute le premier suivi pour commencer l’historique.
        </p>

        <button class="btn btn-primary rounded-pill px-4 shadow-sm"
                data-bs-toggle="modal"
                data-bs-target="#modalAddSuivi">
          <i class="bi bi-clipboard-plus me-2"></i>
          Ajouter le premier suivi
        </button>
      </div>
    </div>
  `;
}


    function renderSuiviCard(suivi) {
  const medsCount = (suivi.medicines && suivi.medicines.length) ? suivi.medicines.length : 0;

  const medsHtml = medsCount > 0
    ? `
      <div class="mt-4">
        <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-capsule-pill text-primary"></i>
            <h6 class="fw-bold mb-0">Médicaments</h6>
            <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border"
                  style="border-color: rgba(13,110,253,.14) !important;">
              ${medsCount}
            </span>
          </div>
          <small class="text-muted">Prescrits pour ce suivi</small>
        </div>

        <div class="ordonnance-meds">
          ${suivi.medicines.map(med => `
<div class="med-item mb-2 p-3 rounded-4 shadow-sm position-relative">

              <div class="d-flex align-items-start justify-content-between gap-3">
                <div class="min-w-0">
                  <div class="fw-semibold text-primary text-truncate">
					${med.name}


									</div>
					<span class="text-mutted">
						${med.dosage}<span class="text-dark">—</span>${med.uniteDosage}


					</span>



                  <div class="d-flex flex-wrap gap-2 mt-2">
                    ${med.forme ? `
                      <span class="badge rounded-pill bg-light text-dark border"
                            style="border-color: rgba(0,0,0,.06) !important;">
                        <i class="bi bi-tag me-1"></i>${med.forme}
                      </span>` : ''}

                    ${med.presentation ? `
                      <span class="badge rounded-pill bg-light text-dark border"
                            style="border-color: rgba(0,0,0,.06) !important;">
                        <i class="bi bi-box-seam me-1"></i>${med.presentation}
                      </span>` : ''}
                  </div>
                </div>

                <!-- ✅ bouton retirer (hook JS existant) -->
                <button type="button"
                        class="btn btn-action btn-action-danger btn-del-med"
                        title="Retirer ce médicament"
                        data-suivi-id="${suivi.id}"
                        data-med-id="${med.id}">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `
    : `
      <div class="mt-4">
        <div class="d-flex align-items-center gap-2 text-muted">
          <i class="bi bi-capsule-pill"></i>
          <em>Aucun médicament ajouté pour ce suivi.</em>
        </div>
      </div>
    `;

  return `
    <div class="col-12 fade-in">
      <div class="suivi-card">

        <div class="suivi-card-header">
          <div class="suivi-card-title">
            <div class="d-inline-flex align-items-center justify-content-center rounded-4"
                 style="width:44px;height:44px;background:rgba(13,110,253,.08);border:1px solid rgba(13,110,253,.12);">
              <i class="bi bi-clipboard2-pulse text-primary"></i>
            </div>

            <div class="lh-1">
              <div class="fw-bold text-primary d-flex align-items-center gap-2 flex-wrap">
                Suivi #${suivi.id}
                <span class="badge rounded-pill bg-light text-dark border"
                      style="border-color: rgba(0,0,0,.06) !important;">
                  <i class="bi bi-clock-history me-1"></i>${suivi.createdAt}
                </span>
              </div>
              <div class="text-muted small mt-1">
                Historique du dossier
              </div>
            </div>
          </div>

          <!-- ✅ actions (inchangées) -->
          <div class="table-actions">
            <button type="button"
                    class="btn btn-action btn-action-danger"
                    title="Supprimer"
                    onclick="deleteSuivi(${suivi.id}, this.closest('.col-12'))">
              <i class="bi bi-trash"></i>
            </button>

            <button type="button"
                    class="btn btn-action btn-action-primary openMedicModal"
                    title="Ajouter un médicament"
                    data-suivi-id="${suivi.id}"
                    data-bs-toggle="modal"
                    data-bs-target="#modalMedicSearch">
              <i class="bi bi-capsule-pill"></i>
            </button>

            <a href="/suivi/${suivi.id}/ordonnance?print=1"
               target="_blank"
               class="btn btn-action btn-action-secondary"
               title="Imprimer">
              <i class="bi bi-printer"></i>
            </a>

            <a href="/suivi/${suivi.id}/ordonnance"
               class="btn btn-action btn-action-danger"
               title="PDF">
              <i class="bi bi-file-pdf"></i>
            </a>
          </div>
        </div>

        <div class="suivi-card-body">
          <div class="p-3 rounded-4 mb-3"
               style="background:rgba(13,110,253,.04);border:1px solid rgba(13,110,253,.10);">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="bi bi-clipboard-check text-primary"></i>
              <div class="fw-bold">Diagnostic</div>
            </div>
            <div class="text-dark">
              ${suivi.diagnostic ?? '<span class="text-muted">—</span>'}
            </div>
          </div>

          ${medsHtml}
        </div>

      </div>
    </div>
  `;
}

    function reloadTimeline() {
        const container = document.getElementById("suiviList");

        container.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <div class="spinner-border text-primary"></div>
                <div class="mt-2">Chargement des suivis...</div>
            </div>
        `;

        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {

                container.innerHTML = "";

                if (!data || data.length === 0) {
                    container.innerHTML = renderEmptySuivi();
                    return;
                }

                data.forEach(suivi => {
                    container.insertAdjacentHTML("beforeend", renderSuiviCard(suivi));
                });
            });
    }

    document.addEventListener("DOMContentLoaded", reloadTimeline);
</script>

	 <script>
	    document.addEventListener("click", function (e) {
	        const btn = e.target.closest(".openMedicModal");
	        if (!btn) return;
	
	        const suiviId = btn.dataset.suiviId;
	        document.getElementById("currentSuiviId").value = suiviId;
	    });
	</script>

	 <script>
	    let pendingDelete = { id: null, element: null };
	
	    async function deleteSuivi(id, element) {
	        pendingDelete.id = id;
	        pendingDelete.element = element;
	
	        const modal = new bootstrap.Modal(document.getElementById("modalConfirmDelete"));
	        modal.show();
	    }
	
	    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
	
	        const { id, element } = pendingDelete;
	
	        const url = `{{ path('api_suivi_delete', {id : 'replace_id'}) }}`.replace("replace_id", id);
	
	        const res = await fetch(url, {
	            method: "DELETE",
	            headers: {
	                "Authorization": "Bearer " + localStorage.getItem("jwt_token")
	            }
	        });
	
	        const text = await res.text();
	        let data;
	        try {
	            data = JSON.parse(text);
	        } catch (e) {
	            alert("Erreur interne du serveur");
	            return;
	        }
	
	        if (data.success) {
	            element.classList.add("fade-out");
	            setTimeout(() => {
	                element.remove();
	                reloadTimeline(); // ✅ si plus aucun suivi, on affiche l'empty state
	            }, 300);
	
	            bootstrap.Modal.getInstance(document.getElementById("modalConfirmDelete")).hide();
	        } else {
	            alert("Erreur : " + data.message);
	        }
	    });
	</script>
 <script>
  // ✅ route Symfony (on la construit proprement)
  const deleteMedUrlTpl = "{{ path('api_suivi_medicine_delete', { suiviId: 'SID', medicineId: 'MID' }) }}"
    .replace('SID', '__SID__')
    .replace('MID', '__MID__');

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-del-med');
    if (!btn) return;

    e.preventDefault();

    const suiviId = btn.dataset.suiviId;
    const medId   = btn.dataset.medId;

    if (!suiviId || !medId) return;

    if (!confirm("Retirer ce médicament de l'ordonnance ?")) return;

    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;

    try {
      const url = deleteMedUrlTpl
        .replace('__SID__', suiviId)
        .replace('__MID__', medId);

      const res = await fetch(url, {
        method: "DELETE",
        headers: {
          "Accept": "application/json",
          "X-Requested-With": "XMLHttpRequest",
          // ✅ si tu utilises JWT comme ton deleteSuivi:
          "Authorization": "Bearer " + localStorage.getItem("jwt_token")
        }
      });

      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e){}

      if (!res.ok || !data?.success) {
        alert(data?.message || "Erreur lors de la suppression du médicament.");
        btn.disabled = false;
        btn.innerHTML = original;
        return;
      }

      // ✅ simple & fiable : on recharge la timeline
      reloadTimeline();

    } catch (err) {
      console.error(err);
      alert("Erreur réseau.");
      btn.disabled = false;
      btn.innerHTML = original;
    }
  });
</script>


{% endblock %}

