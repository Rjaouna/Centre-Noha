<div id="authOverlay" class="auth-overlay d-none" aria-hidden="true">
	<div class="auth-card">
		<div class="auth-brand">
			<div class="auth-logo">
				<i class="bi bi-shield-lock"></i>
			</div>
			<div class="auth-title">
<div class="app-name" id="overlayAppName">Created by : We Digit All</div>


				<div class="cabinet-name" id="overlayCabinetName">—</div>
			</div>
		</div>

		<div class="auth-msg" id="overlayMessage">
			Votre session a expiré. Veuillez vous reconnecter.
		</div>

		<div class="auth-actions">
			<button type="button" id="btnReconnect" class="btn btn-primary rounded-pill px-4">
				<i class="bi bi-box-arrow-in-right me-2"></i>
				Se connecter
			</button>

			<button type="button" id="btnRetry" class="btn btn-outline-secondary rounded-pill px-4 d-none">
				<i class="bi bi-arrow-clockwise me-2"></i>
				Réessayer
			</button>
		</div>

		<div class="auth-hint text-muted small mt-3" id="overlayHint">
			Astuce : si vous êtes sur mobile, vérifiez votre connexion internet.
		</div>
	</div>
</div>

 <script>
(function(){
  // ✅ Mets ta route ping ici (symfony path conseillé)
  const PING_URL = "/api/auth/ping"; // à créer
const APP_NAME = "Created by : We Digit All"; // ou injecte depuis Twig



  const overlay = document.getElementById("authOverlay");
  const appNameEl = document.getElementById("overlayAppName");
  const cabinetNameEl = document.getElementById("overlayCabinetName");
  const msgEl = document.getElementById("overlayMessage");
  const hintEl = document.getElementById("overlayHint");
  const btnReconnect = document.getElementById("btnReconnect");
  const btnRetry = document.getElementById("btnRetry");

  let failCount = 0;
  let lastCabinet = null;

 function setCabinetDisplay(cab){
  const name = cab?.nom || (localStorage.getItem("cabinet_nom") || "—");
  const typeVal = cab?.type || (localStorage.getItem("cabinet_type") || "");
  const type = typeVal ? ` • ${typeVal}` : "";

 appNameEl.textContent = name + type;

cabinetNameEl.textContent = APP_NAME; // ✅ garde le nom de l’app

}


  function showOverlay(mode){
    // mode: "auth" | "network"
    document.body.classList.add("auth-locked");
    overlay.classList.remove("d-none");
    overlay.setAttribute("aria-hidden","false");


    if(mode === "network"){
      msgEl.textContent = "Connexion perdue. Impossible de joindre le serveur.";
      hintEl.textContent = "Vérifiez votre connexion (Wi-Fi / 4G), puis réessayez.";
      btnRetry.classList.remove("d-none");
      btnReconnect.classList.add("d-none");
    }else{
      msgEl.textContent = "Votre session a expiré. Veuillez vous reconnecter.";
      hintEl.textContent = "Vous serez redirigé vers la page de connexion.";
      btnRetry.classList.add("d-none");
      btnReconnect.classList.remove("d-none");
    }

    setCabinetDisplay(lastCabinet);
  }

  function hideOverlay(){
    document.body.classList.remove("auth-locked");
    overlay.classList.add("d-none");
    overlay.setAttribute("aria-hidden","true");
  }

  // ✅ fetch avec timeout
  async function fetchWithTimeout(url, opts={}, timeoutMs=8000){
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), timeoutMs);
    try{
      const res = await fetch(url, { ...opts, signal: controller.signal, headers: { "Accept":"application/json", ...(opts.headers||{}) } });
      return res;
    } finally {
      clearTimeout(t);
    }
  }

  async function ping(){
    try{
      const res = await fetchWithTimeout(PING_URL, {
        method: "GET",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          // si tu utilises JWT :
          ...(localStorage.getItem("jwt_token") ? {"Authorization": "Bearer " + localStorage.getItem("jwt_token")} : {})
        }
      }, 8000);

      if(res.status === 401 || res.status === 403){
        failCount = 0;
        showOverlay("auth");
        return;
      }

      if(!res.ok){
        failCount++;
        if(failCount >= 2) showOverlay("network");
        return;
      }

      // ✅ OK
      const data = await res.json().catch(()=>null);
      failCount = 0;

      if(data?.cabinet){
        lastCabinet = data.cabinet;
        localStorage.setItem("cabinet_nom", data.cabinet.nom || "");
        localStorage.setItem("cabinet_type", data.cabinet.type || "");
      }

      hideOverlay();
    } catch(e){
      // timeout / offline
      failCount++;
      if(failCount >= 2) showOverlay("network");
    }
  }

  // boutons
  btnReconnect?.addEventListener("click", () => {
    // ✅ redirection login (à adapter)
    window.location.href = "/login";
  });

  btnRetry?.addEventListener("click", async () => {
    failCount = 0;
    await ping();
  });

  // démarrage
  document.addEventListener("DOMContentLoaded", () => {
    setCabinetDisplay(null);
    ping(); // premier ping direct
    setInterval(ping, 60000); // toutes les 60s

    // quand l'utilisateur revient sur l'app
    document.addEventListener("visibilitychange", () => {
      if(!document.hidden) ping();
    });
  });

})();
</script>


<style>
	.auth-overlay {
		position: fixed;
		inset: 0;
		z-index: 99999;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 18px;
		background: rgba(255, 255, 255, .92);
		backdrop-filter: blur(8px);
	}
	.auth-card {
		width: min(520px, 100%);
		background: #fff;
		border: 1px solid rgba(0, 0, 0, .06);
		border-radius: 22px;
		box-shadow: 0 18px 45px rgba(0, 0, 0, .12);
		padding: 18px;
	}
	.auth-brand {
		display: flex;
		gap: 14px;
		align-items: center;
		margin-bottom: 12px;
	}
	.auth-logo {
		width: 54px;
		height: 54px;
		border-radius: 18px;
		background: rgba(13, 110, 253, .10);
		color: #0d6efd;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.4rem;
		border: 1px solid rgba(13, 110, 253, .16);
	}
	.auth-title .app-name {
		font-weight: 800;
		color: #0d6efd;
		line-height: 1.1;
	}
	.auth-title .cabinet-name {
		color: #6c757d;
		font-size: 0.9rem;
		margin-top: 2px;
	}
	.auth-msg {
		background: #f8f9fa;
		border: 1px solid rgba(0, 0, 0, .06);
		border-radius: 16px;
		padding: 12px 14px;
		margin: 12px 0;
	}
	.auth-actions {
		display: flex;
		gap: 10px;
		justify-content: center;
		flex-wrap: wrap;
		margin-top: 10px;
	}

	/* Optionnel : empêche scroll derrière */
	body.auth-locked {
		overflow: hidden !important;
	}
</style>

