{% extends 'base.html.twig' %}

{% block title %}Gestion des sympt√¥mes
{% endblock %}

{% block body %}
<style>
	/* Actions DataTable : rendu pro */
	.table-actions {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.35rem;
		border-radius: 999px;
		background: rgba(13, 110, 253, .06);
		border: 1px solid rgba(13, 110, 253, .10);
	}

	.btn-action {
		width: 36px;
		height: 36px;
		padding: 0;
		border-radius: 12px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		font-size: 1rem;
		box-shadow: 0 6px 16px rgba(0, 0, 0, .06);
	}

	.btn-action-primary {
		background: #fff;
		border: 1px solid rgba(13, 110, 253, .25);
		color: #0d6efd;
	}

	.btn-action-danger {
		background: #fff;
		border: 1px solid rgba(220, 53, 69, .25);
		color: #dc3545;
	}

	/* Hover simple (pas de ‚Äúmove‚Äù) */
	.btn-action:hover {
		filter: brightness(0.98);
	}
</style>

	{# ================= DATATABLES CSS ================= #}
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

	<div
		class="mt-4">

		{# ================= HEADER (menu + actions) ================= #}
		{% embed '_partials/_page_header.html.twig' with {
			icon: 'bi bi-activity',
			title: 'Gestion des sympt√¥mes',
			subtitle: 'Ajoutez, modifiez et g√©rez les sympt√¥mes m√©dicaux'
		} %}

			{# Actions m√©tier (mobile √† gauche) #}
			{% block header_actions_left %}
				{# ‚ûï Ajouter #}
				<span class="action-icon bg-primary text-white" role="button" data-bs-toggle="modal" data-bs-target="#modalSymptome" data-bs-toggle="tooltip" title="Ajouter un sympt√¥me">
					<i class="bi bi-plus-circle"></i>
				</span>

				{# üßæ Traitements #}
				<a href="{{ path('traitement_index') }}" class="action-icon bg-outline" data-bs-toggle="tooltip" title="Gestion des traitements">
					<i class="bi bi-prescription2"></i>
				</a>
			{% endblock %}

			{# Navigation (mobile √† droite) : home + retour (d√©j√† par d√©faut dans ton partial) #}
		{% endembed %}


		{# ================= TABLE DATATABLE ================= #}
		<section class="mb-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-3 p-md-4">

					<table id="symptomesTable" class="table table-striped table-hover align-middle mb-0" style="width:100%">
						<thead class="table-primary">
							<tr>
								<th>Nom</th>
								<th>Cat√©gorie</th>
								<th>Description</th>
								<th class="text-center">Traitement</th>
								<th class="text-center">Actions</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>

				</div>
			</div>
		</section>

	</div>


	{# ================= MODAL ================= #}
	<div class="modal fade" id="modalSymptome" tabindex="-1">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<form id="symptomeForm">

					<div class="modal-header bg-primary text-white rounded-top-4">
						<h5 class="modal-title fw-bold">
							<i class="bi bi-activity me-2"></i>
							Sympt√¥me
						</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>

					<div class="modal-body">

						<div class="row g-3">
							<div class="col-12">
								<label class="form-label">Nom</label>
								<input name="name" class="form-control" required>
							</div>

							<div class="col-12">
								<label class="form-label">Cat√©gorie</label>
								<select name="category" class="form-select" required>
									<option value="" disabled selected>‚Äî Choisir ‚Äî</option>
									<option>Abdomen & syst√®me digestif</option>
									<option>Appareil g√©nito-urinaire</option>
									<option>Articulations & muscles</option>
									<option>Cerveau & syst√®me nerveux</option>
									<option>Thorax & syst√®me respiratoire</option>
									<option>ORL</option>
									<option>≈íil</option>
									<option>Peau & cheveux</option>
									<option>Saignements</option>
									<option>Sympt√¥mes g√©n√©raux</option>
									<option>Gyn√©cologie & obst√©trique</option>
									<option>Sympt√¥mes chez l‚Äôenfant</option>
								</select>
							</div>

							<div class="col-12">
								<label class="form-label">Description</label>
								<textarea name="description" class="form-control" rows="3"></textarea>
							</div>
						</div>

					</div>

					<div class="modal-footer">
						<button class="btn btn-secondary rounded-pill px-4" type="button" data-bs-dismiss="modal">
							Annuler
						</button>
						<button class="btn btn-primary rounded-pill px-4" type="submit">
							<i class="bi bi-check2-circle me-1"></i>
							Enregistrer
						</button>
					</div>

				</form>

			</div>
		</div>
	</div>

{% endblock %}

{% block javascripts %}
	{{ parent() }}

	{# ‚ö†Ô∏è Mets ces CDN ici seulement si tu ne les as PAS d√©j√† dans base.html.twig #}
	 <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

	{# Si tu veux Responsive VRAIMENT stable, il faut aussi inclure Responsive JS+CSS #}
	{# <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css"> #}
	{#  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
	#}
	{#  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
#}

	 <script>
	  (function () {
	    let dt;
	    let editId = null;
	
	    function init() {
	      const modalEl = document.getElementById("modalSymptome");
	      const form = document.getElementById("symptomeForm");
	      const tableEl = $('#symptomesTable');
	
	      if (!modalEl || !form || !tableEl.length) return;
	
	      // ‚úÖ s√©curit√©: DataTables charg√© ?
	      if (!$.fn.DataTable) {
	        console.error("DataTables non charg√©.");
	        return;
	      }
	
	      // ‚úÖ destroy si d√©j√† initialis√© (√©vite doublons si navigation turbo/pjax etc.)
	      if ($.fn.DataTable.isDataTable(tableEl)) {
	        tableEl.DataTable().clear().destroy();
	      }
	
	      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
	
	      dt = tableEl.DataTable({
	        processing: true,
	        responsive: true,   // ‚ö†Ô∏è marche vraiment uniquement si plugin Responsive est charg√©
	        autoWidth: false,
	
	        ajax: {
	          url: '/api/symptomes',
	          dataSrc: ''
	        },
	
	        columns: [
	          { data: 'name', className: 'fw-semibold' },
	
	          {
	            data: 'category',
	            render: d => `<span class="badge bg-success rounded-pill px-3">${d ?? '‚Äî'}</span>`
	          },
	
	          {
	            data: 'description',
	            render: d => d ? d : `<span class="text-muted">‚Äî</span>`
	          },
	
	          {
	            data: 'hasTraitement',
	            className: 'text-center',
	            render: (has, type, row) => {
	              if (has) {
	                return `
	                  <span class="badge bg-success rounded-pill px-3">
	                    <i class="bi bi-check2-circle me-1"></i>${row.traitementCount ?? 0}
	                  </span>
	                `;
	              }
	              return `
	                <a href="{{ path('traitement_index') }}"
	                   class="badge bg-warning text-dark rounded-pill px-3 text-decoration-none">
	                  <i class="bi bi-plus-circle me-1"></i>Ajouter
	                </a>
	              `;
	            }
	          },
	
	          {
	            data: 'id',
	            orderable: false,
	            className: 'text-center',
	            render: id => `
	              <div class="table-actions">
	                <button type="button"
	                        class="btn btn-action btn-action-primary"
	                        data-action="edit"
	                        data-id="${id}"
	                        title="Modifier">
	                  <i class="bi bi-pencil"></i>
	                </button>
	
	                <button type="button"
	                        class="btn btn-action btn-action-danger"
	                        data-action="delete"
	                        data-id="${id}"
	                        title="Supprimer">
	                  <i class="bi bi-trash"></i>
	                </button>
	              </div>
	            `
	          }
	        ],
	
	        language: {
	          url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
	        },
	
	        pageLength: 10
	      });
	
	      // ‚úÖ reset modal
	      modalEl.addEventListener("hidden.bs.modal", () => {
	        editId = null;
	        form.reset();
	      });
	
	      // ‚úÖ delegation click actions (pas de onclick inline)
	      document.addEventListener('click', async (e) => {
	        const btn = e.target.closest('[data-action]');
	        if (!btn) return;
	
	        const action = btn.dataset.action;
	        const id = Number(btn.dataset.id);
	
	        if (action === 'edit') {
	          const res = await fetch(`/api/symptomes/${id}`);
	          if (!res.ok) return alert("Erreur chargement sympt√¥me");
	
	          const s = await res.json();
	          editId = id;
	          form.name.value = s.name ?? '';
	          form.category.value = s.category ?? '';
	          form.description.value = s.description ?? '';
	          modal.show();
	        }
	
	        if (action === 'delete') {
	          if (!confirm("Supprimer ce sympt√¥me ?")) return;
	
	          const res = await fetch(`/api/symptomes/${id}`, { method: 'DELETE' });
	          if (!res.ok) return alert("Erreur suppression");
	
	          dt.ajax.reload(null, false);
	        }
	      });
	
	      // ‚úÖ submit create/update
	      form.addEventListener("submit", async (e) => {
	        e.preventDefault();
	
	        const payload = {
	          name: form.name.value.trim(),
	          category: form.category.value,
	          description: form.description.value.trim()
	        };
	
	        const url = editId ? `/api/symptomes/${editId}` : `/api/symptomes`;
	        const method = editId ? 'PUT' : 'POST';
	
	        const res = await fetch(url, {
	          method,
	          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
	          body: JSON.stringify(payload)
	        });
	
	        if (!res.ok) {
	          const t = await res.text();
	          console.error(t);
	          alert("Erreur lors de l'enregistrement.");
	          return;
	        }
	
	        editId = null;
	        form.reset();
	        modal.hide();
	        dt.ajax.reload(null, false);
	      });
	
	      // ‚úÖ petit fix responsive (si plugin charg√©)
	      setTimeout(() => {
	        if (dt) {
	          dt.columns.adjust();
	          if (dt.responsive) dt.responsive.recalc();
	        }
	      }, 200);
	    }
	
	    // ‚úÖ stable: attendre que tout soit pr√™t
	    window.addEventListener('load', init);
	  })();
	  </script>
{% endblock %}

