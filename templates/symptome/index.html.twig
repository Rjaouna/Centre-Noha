{% extends 'base.html.twig' %}

{% block title %}Gestion des sympt√¥mes
{% endblock %}

{% block body %}

	{# ================= DATATABLES CSS ================= #}
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

	<div
		class="mt-4">

		<!-- ‚≠ê ENT√äTE ‚≠ê -->
		<div class="card shadow-lg border-0 rounded-4 mb-4">
			<div class="card-body py-4 px-4">
				<div class="row align-items-center">

					<div class="col-md-7 d-flex align-items-center">
						<i class="bi bi-activity text-primary fs-1 me-3"></i>
						<div>
							<h2 class="fw-bold text-primary mb-1">Gestion des sympt√¥mes</h2>
							<p class="text-secondary m-0">
								Ajoutez, modifiez et g√©rez les sympt√¥mes m√©dicaux
							</p>
						</div>
					</div>

					<div class="col-md-5 d-flex justify-content-md-end gap-2">
						<button onclick="history.back()" class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm">
							<i class="bi bi-arrow-left"></i>
							Retour
						</button>

						<button class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalSymptome">
							<i class="bi bi-plus-circle"></i>
							Ajouter
						</button>
					</div>

				</div>
			</div>
		</div>

		<!-- ‚≠ê TABLE DATATABLE ‚≠ê -->
		<table id="symptomesTable" class="table table-striped table-hover align-middle rounded-4" style="width:100%">
			<thead class="table-primary">
				<tr>
					<th>Nom</th>
					<th>Cat√©gorie</th>
					<th>Description</th>
<th class="text-center">Traitement</th>

					<th class="text-center">Actions</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>

	</div>

	<!-- ================= MODAL ================= -->
	<div class="modal fade" id="modalSymptome" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content rounded-4 shadow">

				<form id="symptomeForm">

					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title fw-bold">
							<i class="bi bi-activity me-2"></i>
							Sympt√¥me
						</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>

					<div class="modal-body">

						<div class="mb-3">
							<label class="form-label">Nom</label>
							<input name="name" class="form-control" required>
						</div>

						<div class="mb-3">
							<label class="form-label">Cat√©gorie</label>
							<select name="category" class="form-select" required>
								<option value="" disabled selected>‚Äî Choisir ‚Äî</option>
								<option>Abdomen & syst√®me digestif</option>
								<option>Appareil g√©nito-urinaire</option>
								<option>Articulations & muscles</option>
								<option>Cerveau & syst√®me nerveux</option>
								<option>Thorax & syst√®me respiratoire</option>
								<option>ORL</option>
								<option>≈íil</option>
								<option>Peau & cheveux</option>
								<option>Saignements</option>
								<option>Sympt√¥mes g√©n√©raux</option>
								<option>Gyn√©cologie & obst√©trique</option>
								<option>Sympt√¥mes chez l‚Äôenfant</option>
							</select>
						</div>

						<div class="mb-3">
							<label class="form-label">Description</label>
							<textarea name="description" class="form-control" rows="3"></textarea>
						</div>

					</div>

					<div class="modal-footer">
						<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
							Annuler
						</button>
						<button class="btn btn-primary rounded-pill">
							Enregistrer
						</button>
					</div>

				</form>

			</div>
		</div>
	</div>

{% endblock %}

{% block javascripts %}

	{# ================= DATATABLES JS ================= #}
	 <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

{{ parent() }}

	 <script>
	$(document).ready(function () {
	
	    const modal = new bootstrap.Modal(document.getElementById("modalSymptome"));
	    const form  = document.getElementById("symptomeForm");
	    let editId  = null;
	
	    // ‚úÖ DATATABLE
	    const table = $('#symptomesTable').DataTable({
	        ajax: {
	            url: '/api/symptomes',
	            dataSrc: ''
	        },
	        columns: [
	            { data: 'name', className: 'fw-semibold' },
	            {
	                data: 'category',
	                render: d =>
	                    `<span class="badge bg-success rounded-pill px-3">${d}</span>`
	            },
	            {
	                data: 'description',
	                render: d => d ?? '<span class="text-muted">‚Äî</span>'
	            },
				{
    data: 'hasTraitement',
    className: 'text-center',
    render: (has, type, row) => {
        if (has) {
            return `
                <span class="badge bg-success rounded-pill px-3">
                    ‚úî ${row.traitementCount}
                </span>
            `;
        }
        return `
            <span class="badge bg-warning rounded-pill px-3">
<a href="{{path('traitement_index')}}">Ajouter un traitement</a>

            </span>
        `;
    }
},

	            {
	                data: 'id',
	                orderable: false,
	                className: 'text-center',
	                render: id => `
	                    <button class="btn btn-sm btn-outline-primary rounded-pill me-1"
	                            onclick="editSymptome(${id})">
	                        <i class="bi bi-pencil"></i>
	                    </button>
	                    <button class="btn btn-sm btn-outline-danger rounded-pill"
	                            onclick="deleteSymptome(${id})">
	                        <i class="bi bi-trash"></i>
	                    </button>
	                `
	            }
	        ],
	        language: {
	            url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
	        },
	        pageLength: 10,
	        responsive: true
	    });
	
	    // ‚úèÔ∏è EDIT
	    window.editSymptome = async (id) => {
	        const s = await fetch(`/api/symptomes/${id}`).then(r => r.json());
	        editId = id;
	        form.name.value        = s.name;
	        form.category.value    = s.category;
	        form.description.value = s.description ?? '';
	        modal.show();
	    };
	
	    // üóë DELETE
	    window.deleteSymptome = async (id) => {
	        if (!confirm("Supprimer ce sympt√¥me ?")) return;
	        await fetch(`/api/symptomes/${id}`, { method: 'DELETE' });
	        table.ajax.reload(null, false);
	    };
	
	    // üíæ SUBMIT
	    form.addEventListener("submit", async (e) => {
	        e.preventDefault();
	
	        const payload = {
	            name: form.name.value,
	            category: form.category.value,
	            description: form.description.value
	        };
	
	        const url    = editId ? `/api/symptomes/${editId}` : `/api/symptomes`;
	        const method = editId ? 'PUT' : 'POST';
	
	        await fetch(url, {
	            method,
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify(payload)
	        });
	
	        editId = null;
	        form.reset();
	        modal.hide();
	        table.ajax.reload(null, false);
	    });
	
	});
	</script>

{% endblock %}

