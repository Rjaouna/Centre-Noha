{% extends 'base.html.twig' %}

{% block title %}
	{{ hopital.etablissement }}
	— Établissement hospitalier
{% endblock %}

{% block body %}

	<div
class="mt-4">


		{# ================= HEADER (STYLE APP UNIFIÉ) ================= #}
		{% embed '_partials/_page_header.html.twig' with {
		icon: 'bi bi-hospital',
		title: hopital.etablissement,
		subtitle: 'Établissement hospitalier de référence'
	} %}
			{% block header_actions_left %}
				<span class="action-icon bg-outline" onclick="history.back()" title="Retour">
					<i class="bi bi-arrow-left"></i>
				</span>
			{% endblock %}
		{% endembed %}

		{# ================= INFORMATIONS HÔPITAL ================= #}
		<section class="mb-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">

					<h5 class="fw-bold text-primary mb-4 d-flex align-items-center gap-2">
						<i class="bi bi-info-circle-fill"></i>
						Informations générales
					</h5>

					<div class="row g-4">

						<div class="col-md-6">
							<div class="info-box">
								<span class="info-label">
									<i class="bi bi-map"></i>
									Région
								</span>
								<span class="info-value">{{ hopital.region }}</span>
							</div>
						</div>

						<div class="col-md-6">
							<div class="info-box">
								<span class="info-label">
									<i class="bi bi-building"></i>
									Délégation
								</span>
								<span class="info-value">{{ hopital.delegation }}</span>
							</div>
						</div>

						<div class="col-md-6">
							<div class="info-box">
								<span class="info-label">
									<i class="bi bi-geo-alt"></i>
									Commune
								</span>
								<span class="info-value">{{ hopital.commune }}</span>
							</div>
						</div>

						<div class="col-md-6">
							<div class="info-box">
								<span class="info-label">
									<i class="bi bi-hospital-fill"></i>
									Type d’établissement
								</span>
								<span class="badge bg-info text-dark rounded-pill px-3 py-2">
									{{ hopital.categorie }}
								</span>
							</div>
						</div>

					</div>

				</div>
			</div>
		</section>

		{# ================= LETTRE DE RECOMMANDATION ================= #}
		<section>
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-4">

					<h5 class="fw-bold text-primary mb-4 d-flex align-items-center gap-2">
						<i class="bi bi-envelope-paper-heart"></i>
						Lettre de recommandation
					</h5>

					<div class="row g-3">

						<div class="col-12">
							<div class="form-floating">
								<select id="selectPatient" class="form-select rounded-4">
									<option value="">— Sélectionner un patient —</option>
									{% for p in patients %}
										<option value="{{ p.id }}">{{ p.nom }}</option>
									{% endfor %}
								</select>
								<label>Patient concerné</label>
							</div>
						</div>

						<div class="col-12">
							<div class="form-floating">
								<textarea id="motifRecommandation" class="form-control rounded-4" style="height:130px" placeholder="Motif"></textarea>
								<label>Motif de la recommandation</label>
							</div>
						</div>

						<div class="col-12 d-flex justify-content-end">
							<button id="btnRecommandation" class="btn btn-primary btn-lg rounded-pill px-4 d-flex align-items-center gap-2 shadow-sm">
								<i class="bi bi-pencil-square"></i>
								Créer la lettre
							</button>
						</div>

						<div class="col-12">
							<div id="recAlert"></div>
						</div>

					</div>

				</div>
			</div>
		</section>

	</div>

	{# ================= SCRIPT ================= #}
	 <script>
	document.getElementById('btnRecommandation').addEventListener('click', () => {
	
		const patientId = document.getElementById('selectPatient').value;
		const motif = document.getElementById('motifRecommandation').value.trim();
		const alertBox = document.getElementById('recAlert');
		const hopitalId = "{{ hopital.id }}";
	
		alertBox.innerHTML = '';
	
		if (!patientId) {
			alertBox.innerHTML = warning('Veuillez sélectionner un patient.');
			return;
		}
	
		if (!motif) {
			alertBox.innerHTML = warning('Veuillez saisir un motif de recommandation.');
			return;
		}
	
		alertBox.innerHTML = `
			<div class="alert alert-info rounded-4 d-flex align-items-center gap-2">
				<div class="spinner-border spinner-border-sm"></div>
				Génération de la lettre…
			</div>
		`;
	
		setTimeout(() => {
			window.location.href =
				`/recommendation/new?patient=${patientId}&hopital=${hopitalId}&motif=${encodeURIComponent(motif)}`;
		}, 1200);
	});
	
	function warning(msg){
		return `
			<div class="alert alert-warning rounded-4 d-flex align-items-center gap-2">
				<i class="bi bi-exclamation-triangle-fill"></i>
				${msg}
			</div>`;
	}
	</script>

	{# ================= STYLES ================= #}
		<style>
.info-box {
	background: #f8fafc;
	border: 1px solid rgba(0, 0, 0, .06);
	border-radius: 16px;
	padding: 16px;
	height: 100%;
	display: flex;
	flex-direction: column;
	gap: 4px;
}
.info-label {
	font-size: 0.85rem;
	color: #6b7280;
	display: flex;
	align-items: center;
	gap: 6px;
}
.info-value {
	font-weight: 800;
	font-size: 1.05rem;
}
</style>{% endblock %}

