{# templates/_partials/_app_menu.html.twig #}
{% if app.user %}
	{% set r = app.request.attributes.get('_route') %}

	{# ===========================
		   TOP APP BAR (minimal, app-like)
		=========================== #}
	<header class="app-topbar border-bottom sticky-top">
		<div class="container-fluid d-flex align-items-center justify-content-between py-2">

			<a href="{{ path('app_home') }}" class="app-brand d-flex align-items-center gap-2 text-decoration-none">
			

				<span class="brand-text">
<span class="brand-name d-block lh-4" id="logoName">
  <span class="logo-text">Chargement‚Ä¶</span>


</span>

<small class="brand-sub text-muted d-block lh-1" id="cabinetType">
  Etablissement m√©dical
</small>

			</a>

			<div
				class="d-flex align-items-center gap-2">




				{# Notifications (ouvre modal) #}
				<button type="button" class="btn btn-icon-soft position-relative" data-bs-toggle="modal" data-bs-target="#notifModal" aria-label="Notifications">
					<i class="bi bi-bell-fill"></i>
					<span class="badge bg-danger badge-notif" id="notifTopBadge">0</span>
				</button>

				{# Profil : desktop dropdown / mobile offcanvas #}
				<div class="d-none d-lg-block dropdown">
					<button class="btn btn-user dropdown-toggle d-flex align-items-center gap-2" data-bs-toggle="dropdown" aria-expanded="false">
						<span class="d-none d-xl-inline fw-semibold">
							{{ app.user.nom ?? app.user.email }}
						</span>
						<img src="https://ui-avatars.com/api/?name={{ app.user.nom ?? app.user.email }}&background=0D8ABC&color=fff" class="rounded-circle" width="36" height="36" alt="avatar">
					</button>

					<ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-4 p-2">
						<li class="px-3 py-2">
							<div class="fw-bold">{{ app.user.email }}</div>
							<small class="text-muted">Compte m√©dical</small>
						</li>
						<li><hr class="my-2"></li>
						<li>
							<a class="dropdown-item rounded-3 d-flex align-items-center gap-2" href="{{ path('app_user_profile') }}">
								<i class="bi bi-person-circle"></i>
								Profil
							</a>
						</li>
						<li>
							<a class="dropdown-item rounded-3 d-flex align-items-center gap-2" href="{{ path('app_cabinet_index') }}">
								<i class="bi bi-gear"></i>
								Param√®tres
							</a>
						</li>
						<li><hr class="my-2"></li>
						<li>
							<a class="dropdown-item rounded-3 d-flex align-items-center gap-2 text-danger" href="{{ path('app_logout') }}">
								<i class="bi bi-box-arrow-right"></i>
								D√©connexion
							</a>
						</li>
					</ul>
				</div>

<button type="button" class="btn btn-icon-soft d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#mobileMenuOffcanvas" aria-label="Menu">
	<i class="bi bi-three-dots-vertical"></i>
</button>



			</div>
		</div>
	</header>

	{# ===========================
		   DESKTOP SIDEBAR
		=========================== #}
	<aside class="app-sidebar d-none d-lg-flex">
		<div class="sidebar-inner">

			<div class="sidebar-user">
				<img src="https://ui-avatars.com/api/?name={{ app.user.nom ?? app.user.email }}&background=0D8ABC&color=fff" class="rounded-circle" width="44" height="44" alt="avatar">
				<div class="min-w-0">
					<div class="fw-bold text-truncate">{{ app.user.nom ?? app.user.email }}</div>
					<small class="text-muted text-truncate d-block">Compte m√©dical</small>
				</div>
			</div>

			<nav class="sidebar-nav mt-3">

				<a class="side-link {{ r == 'app_home' ? 'active' : '' }}" href="{{ path('app_home') }}">
					<i class="bi bi-house-door"></i>
					<span>Accueil</span>
				</a>

				<a class="side-link {{ r starts with 'app_fiche_client' ? 'active' : '' }}" href="{{ path('app_fiche_client_index') }}">
					<i class="bi bi-people"></i>
					<span>Patients</span>
				</a>

				<a class="side-link {{ r starts with 'rendezvous_calendrier' ? 'active' : '' }}" href="{{ path('rendezvous_calendrier') }}">
					<i class="bi bi-calendar3"></i>
					<span>Rendez-vous</span>
				</a>
<div class="side-section mt-3">



	<div
		class="side-sublinks">

	



{# üîπ R√©f√©rentiel (acc√®s rapides) #}

<div class="mm-list">


	<div class="mm-card mm-card-pathway">

		<div class="mm-card-header">
			<i class="bi bi-diagram-3"></i>
			<span>Parcours m√©dical</span>
		</div>


		<div class="mm-list">

			<a class="mm-row {{ r == 'symptome_index' ? 'active' : '' }}" href="{{ path('symptome_index') }}">


				<i class="bi bi-activity"></i>
<div class="d-flex flex-column">
	<span class="">1. Sympt√¥mes</span>
</div>
<i class="bi bi-arrow-down-short ms-auto text-muted"></i></a>


<a class="mm-row {{ r == 'maladie_chronique_index' ? 'active' : '' }}" href="{{ path('maladie_chronique_index') }}">


				<i class="bi bi-heart-pulse"></i>
<div class="d-flex flex-column">
	<span class="">2. Chronicit√©</span>


</div>
<i class="bi bi-arrow-down-short ms-auto text-muted"></i></a><a class="mm-row {{ r == 'traitement_index' ? 'active' : '' }}" href="{{ path('traitement_index') }}">


				<i class="bi bi-capsule"></i>
<div class="d-flex flex-column">
	<span class="">3. Traitement</span>
</div>
<i class="bi bi-chevron-right ms-auto"></i></a></div></div>


{# ===== Parcours m√©dical ===== #}
<a class="side-sublink {{ r == 'analyse_index' ? 'active' : '' }}" href="{{ path('analyse_index') }}">
	<span class="side-ico">
		<i class="bi bi-clipboard-data"></i>
	</span>
	<span>Type analyse</span>
	<i class="bi bi-chevron-right ms-auto side-chevron"></i>
</a>
{# ===== Parcours m√©dical ===== #}
<a class="side-sublink {{ r == 'radio_type_index' ? 'active' : '' }}" href="{{ path('radio_type_index') }}">


	<span class="side-ico">
		<i class="bi bi-plus-square"></i>


	</span>
	<span>Type radio</span>
	<i class="bi bi-chevron-right ms-auto side-chevron"></i>
</a>

		{# ===== Autres r√©f√©rentiels ===== #}
		<a class="side-sublink {{ r == 'certificats_index' ? 'active' : '' }}" href="{{ path('certificats_index') }}">
			<span class="side-ico">
				<i class="bi bi-file-medical"></i>
			</span>
<span>Type certificat</span>


			<i class="bi bi-chevron-right ms-auto side-chevron"></i>
		</a>

		<a class="side-sublink {{ r == 'disponibilite_index' ? 'active' : '' }}" href="{{ path('disponibilite_index') }}">
			<span class="side-ico">
				<i class="bi bi-calendar-check"></i>
			</span>
			<span>Disponibilit√©s</span>
			<i class="bi bi-chevron-right ms-auto side-chevron"></i>
		</a>

	</div>

</div>




			</nav>

<div class="sidebar-footer mt-4">
<a href="{{ path('app_logout') }}" class="btn btn-logout w-100  shadow-sm">

		<i class="bi bi-box-arrow-right me-2"></i>
		D√©connexion
	</a>
</div>


		</div>
	</aside>

{# ===========================
   OFFCANVAS: Menu Mobile (remplace le bottom nav)
=========================== #}
<div class="offcanvas offcanvas-end app-offcanvas d-lg-none" tabindex="-1" id="mobileMenuOffcanvas">
	<div class="offcanvas-header border-0">
		<div class="d-flex align-items-center gap-3">
			<img src="https://ui-avatars.com/api/?name={{ app.user.nom ?? app.user.email }}&background=0D8ABC&color=fff" class="rounded-circle" width="48" height="48" alt="avatar">
			<div class="min-w-0">
				<div class="fw-bold text-truncate">{{ app.user.nom ?? app.user.email }}</div>
				<small class="text-muted text-truncate d-block">{{ app.user.email }}</small>
			</div>
		</div>
		<button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
	</div>

	<div
		class="offcanvas-body pt-2">

		{# üîπ Navigation principale (ce que tu avais en bas) #}
		<div class="mm-section-title">
			<i class="bi bi-compass"></i>
			<span>Navigation</span>
		</div>

		<div class="mm-grid">
			<a class="mm-tile {{ r == 'app_home' ? 'active' : '' }}" href="{{ path('app_home') }}">
				<span class="mm-icon">
					<i class="bi bi-house-door"></i>
				</span>
				<span class="mm-label">Accueil</span>
			</a>

			<a class="mm-tile {{ r starts with 'app_fiche_client' ? 'active' : '' }}" href="{{ path('app_fiche_client_index') }}">
				<span class="mm-icon">
					<i class="bi bi-people"></i>
				</span>
				<span class="mm-label">Patients</span>
			</a>

			<a class="mm-tile {{ r starts with 'rendezvous_calendrier' ? 'active' : '' }}" href="{{ path('rendezvous_calendrier') }}">
				<span class="mm-icon">
					<i class="bi bi-calendar3"></i>
				</span>
				<span class="mm-label">RDV</span>
			</a>
<a class="mm-tile" id="footer-toggle-btn" >
<span class="mm-icon">
<i class="bi bi-info-circle"></i>
</span>
<span class="mm-label">Support</span>

</span>




</a>

		</div>

		<hr
		class="my-3">

		{# üîπ R√©f√©rentiel (acc√®s rapides) #}
		<div class="mm-section-title">
			<i class="bi bi-heart-pulse text-danger"></i>
			<span>R√©f√©rentiel m√©dical</span>
		</div>
<div class="mm-list">


<div class="mm-card mm-card-pathway">

	<div class="mm-card-header">
		<i class="bi bi-diagram-3"></i>
		<span>Parcours m√©dical</span>
	</div>

	

	<div class="mm-list">

		<a class="mm-row {{ r == 'symptome_index' ? 'active' : '' }}" href="{{ path('symptome_index') }}">
			<i class="bi bi-activity"></i>
			<div class="d-flex flex-column">
				<span class="fw-bold">1. D√©clarer les sympt√¥mes</span>
				<small class="text-muted">Identifier ce que le patient ressent</small>
			</div>
			<i class="bi bi-arrow-down-short ms-auto text-muted"></i>
		</a>

		<a class="mm-row {{ r == 'maladie_chronique_index' ? 'active' : '' }}" href="{{ path('maladie_chronique_index') }}">
			<i class="bi bi-heart-pulse"></i>
			<div class="d-flex flex-column">
<span class="fw-bold">2. D√©clarer une maladie chronique</span>

				<small class="text-muted">Relier les sympt√¥mes √† une pathologie</small>
			</div>
			<i class="bi bi-arrow-down-short ms-auto text-muted"></i>
		</a>

		<a class="mm-row {{ r == 'traitement_index' ? 'active' : '' }}" href="{{ path('traitement_index') }}">
			<i class="bi bi-capsule"></i>
			<div class="d-flex flex-column">
				<span class="fw-bold">3. D√©finir le traitement</span>
				<small class="text-muted">Attribuer un m√©dicament adapt√©</small>
			</div>
			<i class="bi bi-chevron-right ms-auto"></i>
		</a>

	</div>
</div>
<a class="mm-row {{ r == 'analyse_index' ? 'active' : '' }}" href="{{ path('analyse_index') }}">
	<i class="bi bi-clipboard-data"></i>
	<div class="d-flex flex-column">
		<span class="fw-bold">Type analyse</span>
		<small class="text-muted">
			D√©finir les analyses disponibles lors de la saisie des consultations
		</small>
	</div>

	<i class="bi bi-chevron-right ms-auto"></i>
</a>
<a class="mm-row {{ r == 'radio_type_index' ? 'active' : '' }}" href="{{ path('radio_type_index') }}">
	<i class="bi bi-plus-square"></i>
	<div class="d-flex flex-column">
		<span class="fw-bold">Type radio</span>
		<small class="text-muted">
			D√©finir les types de radiologie disponibles lors de la saisie des consultations
		</small>
	</div>
	<i class="bi bi-chevron-right ms-auto"></i>
</a>



	<a class="mm-row {{ r == 'certificats_index' ? 'active' : '' }}" href="{{ path('certificats_index') }}">
		<i class="bi bi-file-medical"></i>
		<div class="d-flex flex-column">
<span class="fw-bold">Type certificat</span>

			<small class="text-muted">
				Pr√©parer les certificats m√©dicaux g√©n√©r√©s automatiquement
			</small>
		</div>
		<i class="bi bi-chevron-right ms-auto"></i>
	</a>

	<a class="mm-row {{ r == 'disponibilite_index' ? 'active' : '' }}" href="{{ path('disponibilite_index') }}">
		<i class="bi bi-calendar-check"></i>
		<div class="d-flex flex-column">
			<span class="fw-bold">D√©finir les disponibilit√©s</span>
			<small class="text-muted">
				G√©rer les cr√©neaux de rendez-vous propos√©s aux patients
			</small>
		</div>
		<i class="bi bi-chevron-right ms-auto"></i>
	</a>

</div>


		<hr
		class="my-3">

		{# üîπ Compte (Plus) #}
		<div class="mm-section-title">
			<i class="bi bi-person"></i>
			<span>Compte</span>
		</div>

<div class="menu-actions">
	<a href="{{ path('app_user_profile') }}" class="menu-btn">
		<span class="menu-ico menu-ico-primary">
			<i class="bi bi-person-circle"></i>
		</span>
		<span class="menu-text">
			<span class="menu-title">Profil</span>
			<small class="menu-sub">Informations personnelles</small>
		</span>
		<span class="menu-arrow">
			<i class="bi bi-chevron-right"></i>
		</span>
	</a>

	<a href="{{ path('app_cabinet_index') }}" class="menu-btn">
		<span class="menu-ico menu-ico-dark">
			<i class="bi bi-gear"></i>
		</span>
		<span class="menu-text">
			<span class="menu-title">Param√®tres</span>
			<small class="menu-sub">Cabinet & configuration</small>
		</span>
		<span class="menu-arrow">
			<i class="bi bi-chevron-right"></i>
		</span>
	</a>

	<a href="{{ path('app_logout') }}" class="menu-btn menu-btn-danger mt-1">
		<span class="menu-ico menu-ico-danger">
			<i class="bi bi-box-arrow-right"></i>
		</span>
		<span class="menu-text">
			<span class="menu-title">D√©connexion</span>
			<small class="menu-sub">Fermer la session</small>
		</span>
		<span class="menu-arrow">
			<i class="bi bi-chevron-right"></i>
		</span>
	</a>
</div>


	</div>
</div>


	{# ===========================
		   OFFCANVAS: R√©f√©rentiel (mobile)
		=========================== #}
	<div class="offcanvas offcanvas-bottom app-offcanvas rounded-top-4" tabindex="-1" id="refOffcanvas">
		<div class="offcanvas-header border-0 pb-0">
			<div class="d-flex align-items-center gap-2">
				<div class="offcanvas-icon bg-danger-subtle text-danger">
					<i class="bi bi-heart-pulse"></i>
				</div>
				<div>
					<div class="fw-bold">R√©f√©rentiel m√©dical</div>
					<small class="text-muted">Acc√®s rapide</small>
				</div>
			</div>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
		</div>

		<div class="offcanvas-body pt-3">
			<div class="list-group list-group-flush">
				<a class="list-group-item rounded-4 mb-2 shadow-sm border-0 d-flex align-items-center gap-2" href="{{ path('symptome_index') }}">
					<i class="bi bi-activity text-primary"></i>
					Sympt√¥mes
				</a>

				<a class="list-group-item rounded-4 mb-2 shadow-sm border-0 d-flex align-items-center gap-2" href="{{ path('traitement_index') }}">
					<i class="bi bi-capsule text-success"></i>
					Traitements
				</a>

				<a class="list-group-item rounded-4 mb-2 shadow-sm border-0 d-flex align-items-center gap-2" href="{{ path('maladie_chronique_index') }}">
					<i class="bi bi-heart-pulse text-danger"></i>
					Maladies chroniques
				</a>

				<a class="list-group-item rounded-4 mb-2 shadow-sm border-0 d-flex align-items-center gap-2" href="{{ path('certificats_index') }}">
					<i class="bi bi-file-medical text-secondary"></i>
					Certificats
				</a>

				<a class="list-group-item rounded-4 mb-2 shadow-sm border-0 d-flex align-items-center gap-2" href="{{ path('disponibilite_index') }}">
					<i class="bi bi-calendar-check text-primary"></i>
					Disponibilit√©s
				</a>
			</div>
		</div>
	</div>

	{# ===========================
		   OFFCANVAS: Plus (mobile)
		=========================== #}
	<div class="offcanvas offcanvas-end app-offcanvas" tabindex="-1" id="moreOffcanvas">
		<div class="offcanvas-header border-0">
			<div class="d-flex align-items-center gap-3">
				<img src="https://ui-avatars.com/api/?name={{ app.user.nom ?? app.user.email }}&background=0D8ABC&color=fff" class="rounded-circle" width="48" height="48" alt="avatar">
				<div class="min-w-0">
					<div class="fw-bold text-truncate">{{ app.user.nom ?? app.user.email }}</div>
					<small class="text-muted text-truncate d-block">{{ app.user.email }}</small>
				</div>
			</div>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
		</div>

		<div class="offcanvas-body">
			<div class="d-grid gap-2">
				<a href="{{ path('app_user_profile') }}" class="btn btn-light rounded-pill text-start px-4">
					<i class="bi bi-person-circle me-2"></i>
					Profil
				</a>
				<a href="{{ path('app_cabinet_index') }}" class="btn btn-light rounded-pill text-start px-4">
					<i class="bi bi-gear me-2"></i>
					Param√®tres
				</a>

				<hr class="my-2">

				<a href="{{ path('app_logout') }}" class="btn btn-danger rounded-pill px-4">
					<i class="bi bi-box-arrow-right me-2"></i>
					D√©connexion
				</a>
			</div>
		</div>
	</div>

	{# ===========================
		   MODAL NOTIFICATIONS (inchang√©)
		=========================== #}
	<div class="modal fade" id="notifModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content shadow-lg border-0 rounded-4">

				<div class="modal-header bg-primary text-white rounded-top-4 border-0">
					<h5 class="modal-title fw-bold">
						<i class="bi bi-bell-fill me-2"></i>Centre des notifications
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">

					<h6 class="fw-bold text-primary mb-3">
						<i class="bi bi-person-plus-fill me-2"></i>
						Nouveaux inscrits
					</h6>
					<div id="notifClientsList" class="vstack gap-3"></div>

					<hr class="my-4">

					<h6 class="fw-bold text-success mb-3">
						<i class="bi bi-calendar-check-fill me-2"></i>
						RDV du jour
					</h6>
					<div id="notifRdvList" class="vstack gap-3"></div>

				</div>

				<div class="modal-footer border-0">
					<button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Fermer</button>
				</div>

			</div>
		</div>
	</div>

 <script>
/* =============================
   CABINET NAME (LOGO)
============================= */
async function majLogo() {
    const el = document.getElementById('logoName');
	const cabinetTypeEl = document.getElementById('cabinetType');
    if (!el) return;

    const url = "{{ path('app_nom_cabinet') }}";


    try {
        const response = await fetch(url);
        if (!response.ok) {
            el.textContent = "Erreur serveur";
            return;
        }

        const data = await response.json();

        if (!data.nom || data.nom === "null") {
            el.textContent = "Cabinet non configur√©";
        } else {
            el.textContent = data.nom;
        }
		if (cabinetTypeEl && data.type) {
			cabinetTypeEl.textContent = data.type;
		}
    } catch (e) {
        console.error(e);
        el.textContent = "Erreur r√©seau";
    }
}

/* =============================
   NOTIFICATIONS (CLIENTS + BADGE)
============================= */
const NOTIF_URL = "{{ path('api_notifications_feeds') }}";

function renderClientCard(c) {
    return `
        <div class="notify-card">
            <div class="notify-left">
                <div class="notify-title">
                    <i class="bi bi-person-circle text-primary me-1"></i>
                    ${c.nom} ‚Ä¢ ${c.ville}
                </div>
                <div class="notify-sub">
                    üìû ${c.telephone}<br>
                    üïí ${c.createdAt}
                </div>
            </div>
            <a href="/fiche/client/${c.id}"
               class="btn btn-sm btn-outline-primary fw-bold rounded-pill px-3">
                Voir
            </a>
        </div>
    `;
}

async function loadNotifications() {
    try {
        const res = await fetch(NOTIF_URL);
        if (!res.ok) return;

        const data = await res.json();

        // Badge top
        const topBadge = document.getElementById('notifTopBadge');
if (topBadge) {
    const clientsCount = data.newClients ? data.newClients.length : 0;
    const rdvCount = data.rdvToday ? data.rdvToday.length : 0;

    const total = clientsCount + rdvCount;

    topBadge.textContent = total;
    topBadge.style.display = total > 0 ? 'inline-flex' : 'none';
}


        // Clients
        const clientsContainer = document.getElementById('notifClientsList');
        if (clientsContainer) {
            clientsContainer.innerHTML =
                data.newClients && data.newClients.length
                    ? data.newClients.map(renderClientCard).join('')
                    : `
                        <div class="alert alert-light text-center py-2 mb-0 rounded-4">
                            Aucun nouveau patient
                        </div>
                    `;
        }

    } catch (e) {
        console.error(e);
    }
}

/* =============================
   RDV DU JOUR (BONNE ROUTE)
============================= */
const RDV_URL = "{{ path('api_rendezvous_list') }}";

function renderRdvCard(r) {
    return `
        <div class="notify-card ${r.isLate ? 'rdv-expired' : ''}">
            <div class="notify-left">
                <div class="notify-title">
                    <i class="bi bi-clock-fill text-success me-1"></i>
                    ${r.heureDebut} ‚Äì ${r.heureFin} ‚Äî ${r.nom}
                </div>
                <div class="notify-sub">
                    üìÖ ${r.date}<br>
                    ${
                        r.isLate
                            ? `<span class="badge bg-danger badge-status">Rendez-vous rat√©</span>`
                            : `<span class="badge bg-success badge-status">√Ä venir</span>`
                    }
                </div>
            </div>
            
        </div>
    `;
}

async function loadRdvToday() {
    try {
        const res = await fetch(RDV_URL);
        if (!res.ok) return;

        const rdvs = await res.json();
        const container = document.getElementById('notifRdvList');
        if (!container) return;

        container.innerHTML = rdvs.length
            ? rdvs.map(renderRdvCard).join('')
            : `
                <div class="alert alert-light text-center py-2 mb-0 rounded-4">
                    Aucun RDV aujourd‚Äôhui
                </div>
            `;
    } catch (e) {
        console.error(e);
    }
}

/* =============================
   INIT
============================= */
document.addEventListener('DOMContentLoaded', () => {
    majLogo();
    loadNotifications();
    loadRdvToday();

    setInterval(() => {
        loadNotifications();
        loadRdvToday();
    }, 30000);
});
</script>
<style>


	</style>


{% endif %}


