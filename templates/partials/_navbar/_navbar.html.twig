{% if app.user %}

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">


		<div
			class="container-fluid">

			<!-- LOGO -->
			<a class="navbar-brand fw-bold fs-3" href="{{ path('app_home') }}">
				<span id="logoName">
					<span id="globalLoader">
						<div class="spinner"></div>
					</span>
				</span>
			</a>

			<!-- RIGHT ICONS + BURGER (MOBILE FIRST) -->
			<div
				class="d-flex align-items-center">

				<!-- NOTIFICATION ICON MOBILE (ouvre le MODAL) -->
				<div class="nav-item mx-2 d-lg-none">
					<a class="nav-link position-relative" href="#" id="notifMobile" data-bs-toggle="modal" data-bs-target="#notifModal">
						<i class="bi bi-bell-fill fs-4 text-white"></i>
<span class="badge bg-danger position-absolute top-0 start-100 translate-middle px-2 rounded-pill" id="notifMobileBadge">


							0
						</span>
					</a>
				</div>

				<!-- PROFILE ICON MOBILE -->
				<div class="nav-item dropdown d-lg-none mx-2">
					<a class="nav-link" href="#" id="profileMobile" data-bs-toggle="dropdown">
						<img src="https://ui-avatars.com/api/?name={{ app.user.nom ?? app.user.email }}&background=0D8ABC&color=fff" class="rounded-circle" width="40" height="40">
					</a>

					<ul class="dropdown-menu dropdown-menu-end shadow animated--grow-in">
						<li>
							<a class="dropdown-item" href="{{ path('app_user_profile') }}">
								<i class="bi bi-person-circle me-2"></i>
								Profil
							</a>
						</li>
						<li>
							<a class="dropdown-item" href="{{ path('app_cabinet_index') }}">
								<i class="bi bi-gear me-2"></i>
								Param√®tres
							</a>
						</li>

						<li><hr></li>

						<li>
							<a class="dropdown-item text-danger" href="{{ path('app_logout') }}">
								<i class="bi bi-box-arrow-right me-2"></i>
								D√©connexion
							</a>
						</li>
					</ul>
				</div>

				<!-- BURGER -->
				<button class="navbar-toggler mx-2" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
					<span class="navbar-toggler-icon"></span>
				</button>

			</div>

			<!-- MENU COLLAPSABLE -->
			<div
				class="collapse navbar-collapse" id="mainNavbar">

				<!-- LEFT MENU -->
				<ul class="navbar-nav me-auto mt-3 mt-lg-0">

					<li class="nav-item">
						<a class="nav-link {{ app.request.attributes.get('_route') == 'app_home' ? 'active' : '' }}" href="{{ path('app_home') }}">
							<i class="bi bi-house-door"></i>
							Accueil
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link {{ app.request.attributes.get('_route') starts with 'app_fiche_client' ? 'active' : '' }}" href="{{ path('app_fiche_client_index') }}">
							<i class="bi bi-people"></i>
							Patients
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link disabled">
							<i class="bi bi-credit-card"></i>
							Paiements
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link {{ app.request.attributes.get('_route') starts with 'app_rdv' ? 'active' : '' }}" href="{{ path('app_rdv_index') }}">
							<i class="bi bi-calendar-week"></i>
							Rendez-vous
						</a>
					</li>

				</ul>

				<!-- DESKTOP RIGHT ICONS -->
				<ul
					class="navbar-nav ms-auto d-none d-lg-flex align-items-center gap-3">

					<!-- NOTIF DESKTOP (ouvre aussi le MODAL) -->
					<li class="nav-item">
						<a class="nav-link position-relative" href="#" id="notifDesktop" data-bs-toggle="modal" data-bs-target="#notifModal">
							<i class="bi bi-bell-fill fs-5"></i>
<span class="badge bg-danger position-absolute top-3 start-100 translate-middle px-2 rounded-pill">



								0
							</span>
						</a>
					</li>

					<!-- PROFILE DESKTOP -->
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle d-flex align-items-center gap-2" id="userDropdown" data-bs-toggle="dropdown">

							<span class="fw-semibold">{{ app.user.nom ?? app.user.email }}</span>

							<img src="https://ui-avatars.com/api/?name={{ app.user.nom ?? app.user.email }}&background=0D8ABC&color=fff" class="rounded-circle" width="40" height="40">
						</a>

						<ul class="dropdown-menu dropdown-menu-end shadow animated--grow-in">

							<li>
								<a class="dropdown-item" href="{{ path('app_user_profile') }}">
									<i class="bi bi-person-circle me-2"></i>
									Profil
								</a>
							</li>

							<li>
								<a class="dropdown-item" href="{{ path('app_cabinet_index') }}">
									<i class="bi bi-gear me-2"></i>
									Param√®tres
								</a>
							</li>

							<li><hr></li>

							<li>
								<a class="dropdown-item text-danger" href="{{ path('app_logout') }}">
									<i class="bi bi-box-arrow-right me-2"></i>
									D√©connexion
								</a>
							</li>

						</ul>
					</li>

				</ul>

			</div>

		</div>
	</nav>

	<!-- MODAL NOTIFICATIONS (mobile + desktop) -->
	<div class="modal fade" id="notifModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content shadow-lg border-0">

				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title">
						<i class="bi bi-bell-fill me-2"></i>Centre des notifications
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div
					class="modal-body">

					<!-- üìò Nouveaux inscrits -->
					<h6 class="fw-bold text-primary mb-3">
						<i class="bi bi-person-plus-fill me-2"></i>
						Nouveaux inscrits
					</h6>
					<div id="notifClientsList" class="vstack gap-3"></div>

					<hr
					class="my-4">

					<!-- üìó RDV du jour -->
					<h6 class="fw-bold text-success mb-3">
						<i class="bi bi-calendar-check-fill me-2"></i>
						RDV du jour
					</h6>
					<div id="notifRdvList" class="vstack gap-3"></div>

				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
				</div>

			</div>
		</div>
	</div>
<style>
.notify-card {
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    background: #fff;
    padding: 14px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: .2s ease;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
}

.notify-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 18px rgba(0,0,0,0.07);
    background: #f9fbff;
}

.notify-left {
    max-width: 75%;
}

.notify-title {
    font-weight: 600;
    font-size: 1rem;
}

.notify-sub {
    font-size: 0.87rem;
    color: #6c757d;
}

.badge-status {
    font-size: .75rem;
    padding: 4px 8px;
}

.navbar-nav .nav-link {
    font-size: 1.1rem;
    font-weight: 600;
}

.icon-circle {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
}

@media(max-width: 768px) {
    #logoName {
        font-size: 1.4rem;
        font-weight: 800;
    }

    .navbar-nav .nav-link {
        font-size: 1.2rem;
        font-weight: 700;
        padding: 12px;
    }

    .dropdown-menu {
        width: 90%;
        margin-left: 5%;
        border-radius: 15px;
    }

    .dropdown-item {
        font-size: 1.1rem;
        padding: 12px 18px;
    }
}

/* Loader global */
#globalLoader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(2px);
    display: none; /* masqu√© */
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

#globalLoader .spinner {
    width: 70px;
    height: 70px;
    border: 6px solid #ddd;
    border-top-color: #d9534f;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
<script>
function showLoader() {
    document.getElementById('globalLoader').style.display = 'flex';
}

function hideLoader() {
    document.getElementById('globalLoader').style.display = 'none';
}

async function majLogo() {
    const el = document.getElementById('logoName');

    el.innerHTML = `<span class="sr-only">Loading...</span>`;

    const url = "{{ path('app_nom_cabinet') }}";
    const urlConfig = "{{ path('app_cabinet_index') }}";

    try {
        const response = await fetch(url);

        if (!response.ok) {
            el.textContent = "Erreur serveur";
            return;
        }

        const data = await response.json();

        if (!data.nom || data.nom === "null") {
            el.innerHTML = `
                <span class="text-warning fw-bold">Cabinet non configur√©</span>
                <a href="${urlConfig}" class="btn btn-sm btn-warning ms-2">Configurer</a>
            `;
        } else {
            el.textContent = data.nom;
        }

    } catch (e) {
        console.error(e);
        el.textContent = "Erreur r√©seau";
    }
}

// =============================
// NOTIFICATIONS
// =============================
const NOTIF_URL = "{{ path('api_notifications_feeds') }}";

function loadNotifications() {
    fetch(NOTIF_URL)
        .then(res => res.json())
        .then(data => {

            const desktopBadge = document.querySelector('#notifDesktop .badge');
            const mobileBadge  = document.getElementById('notifMobileBadge');

            if (desktopBadge) desktopBadge.textContent = data.total;
            if (mobileBadge) mobileBadge.textContent = data.total;

            // --- Clients ---
            let cardClient = (c) => `
                <div class="notify-card">
                    <div class="notify-left">
                        <div class="notify-title">
                            <i class="bi bi-person-circle text-primary me-1"></i>
                            ${c.nom} ‚Ä¢ ${c.ville}
                        </div>
                        <div class="notify-sub">
                            üìû ${c.telephone}<br>
                            üïí ${c.createdAt}
                        </div>
                    </div>
<a href="/fiche/client/${c.id}" class="btn btn-sm btn-outline-primary fw-bold">Voir</a>


                </div>
            `;

            let clientsHtml = data.newClients && data.newClients.length
                ? data.newClients.map(c => cardClient(c)).join('')
: "<div class='alert alert-light text-center py-2 mb-0'>Aucun nouveau patient</div>";



            document.getElementById('notifClientsList').innerHTML = clientsHtml;

            // --- RDV du jour ---
            let cardRdv = (r) => `
                <div class="notify-card">
                    <div class="notify-left">
                        <div class="notify-title">
                            <i class="bi bi-clock-fill text-success me-1"></i>
                            ${r.heure} ‚Äî ${r.client}
                        </div>
                        <div class="notify-sub">
                            üìù ${r.motif ?? "‚Äî"}<br>
                            <span class="badge bg-info text-dark badge-status">
                                ${r.statut ?? "En attente"}
                            </span>
                        </div>
                    </div>
<a href="/rdv" class="btn btn-sm btn-outline-success fw-bold">Ouvrir</a>


                </div>
            `;

            let rdvHtml = data.rdvToday && data.rdvToday.length
                ? data.rdvToday.map(r => cardRdv(r)).join('')
: "<div class='alert alert-light text-center py-2 mb-0'>Aucun RDV aujourd‚Äôhui</div>";



            document.getElementById('notifRdvList').innerHTML = rdvHtml;

        })
        .catch(err => console.error(err));
}

// Ex√©cution au chargement
document.addEventListener('DOMContentLoaded', () => {
    majLogo();
    loadNotifications();

    // Refresh auto toutes les 30s
    setInterval(loadNotifications, 30000);
});
</script>


{% endif %}

