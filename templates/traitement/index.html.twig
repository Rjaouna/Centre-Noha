{% extends 'base.html.twig' %}

{% block title %}Gestion des traitements
{% endblock %}

{% block body %}

	{# ================= DATATABLES CSS ================= #}
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

	<div
		class="container-fluid mt-4">

		{# ================= HEADER (style app) ================= #}
		{% embed '_partials/_page_header.html.twig' with {
			icon: 'bi bi-capsule-pill',
			title: 'Gestion des traitements',
			subtitle: 'Base de traitements par sympt√¥me et contre-indications'
		} %}

			{# Actions m√©tier (mobile √† gauche) #}
			{% block header_actions_left %}
				<span class="action-icon bg-primary text-white" role="button" onclick="openModal()" data-bs-toggle="tooltip" title="Nouveau traitement">
					<i class="bi bi-plus-circle"></i>
				</span>

				<a href="{{ path('symptome_index') }}" class="action-icon bg-outline" data-bs-toggle="tooltip" title="Gestion des sympt√¥mes">
					<i class="bi bi-activity"></i>
				</a>
			{% endblock %}

			{# Navigation (mobile √† droite) #}
			{# -> on garde le bloc par d√©faut (Home + Retour) du partial #}
		{% endembed %}

		{# ================= TABLE ================= #}
		<section class="mb-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-3 p-md-4">
					<table id="traitementTable" class="table table-hover align-middle w-100">
						<thead class="table-light">
							<tr>
								<th>Sympt√¥me</th>
								<th>M√©dicament</th>
								<th>Posologie</th>
								<th>Contre-indications</th>
								<th class="text-end">Actions</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</section>

	</div>

	{# ================= MODAL ================= #}
	<div class="modal fade" id="traitementModal" tabindex="-1">
		<div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<div class="modal-header bg-primary text-white rounded-top-4">
					<h5 class="modal-title fw-bold d-flex align-items-center gap-2">
						<i class="bi bi-capsule-pill"></i>
						Traitement
					</h5>
					<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body p-3 p-md-4">

					<div
						class="row g-3">

						{# MEDICAMENT #}
						<div class="col-12 col-lg-6">
							<div class="card border-0 shadow-sm rounded-4 h-100">
								<div class="card-header bg-light fw-bold rounded-top-4 d-flex align-items-center gap-2">
									<i class="bi bi-capsule text-primary"></i>
									M√©dicament
								</div>
								<div class="card-body">
									<input id="medicineSearch" class="form-control rounded-3 mb-2" placeholder="Rechercher un m√©dicament‚Ä¶">

									<select id="medicine" class="form-select rounded-3" size="8"></select>

									<small class="text-muted d-block mt-2">
										‚ö° Astuce : tapez au moins 2 caract√®res
									</small>
								</div>
							</div>
						</div>

						{# SYMPTOME #}
						<div class="col-12 col-lg-6">
							<div class="card border-0 shadow-sm rounded-4 h-100">
								<div class="card-header bg-light fw-bold rounded-top-4 d-flex align-items-center gap-2">
									<i class="bi bi-activity text-primary"></i>
									Sympt√¥me
								</div>
								<div class="card-body">
									<input id="symptomeSearch" class="form-control rounded-3 mb-2" placeholder="Rechercher un sympt√¥me‚Ä¶">

									<select id="symptome" class="form-select rounded-3" size="8"></select>

									<small class="text-muted d-block mt-2">
										‚ö° Astuce : tapez au moins 2 caract√®res
									</small>
								</div>
							</div>
						</div>

						{# CI #}
						<div class="col-12">
							<div class="card border-0 shadow-sm rounded-4">
								<div class="card-header bg-warning-subtle fw-bold text-warning rounded-top-4 d-flex align-items-center gap-2">
									<i class="bi bi-exclamation-triangle"></i>
									Contre-indications
								</div>
								<div class="card-body">
									<div id="ciList" class="ci-list"></div>
								</div>
							</div>
						</div>

						{# POSOLOGIE #}
						<div class="col-12">
							<div class="card border-0 shadow-sm rounded-4">
								<div class="card-header bg-light fw-bold rounded-top-4 d-flex align-items-center gap-2">
									<i class="bi bi-pencil-square text-primary"></i>
									Posologie / Remarques
								</div>
								<div class="card-body">
									<textarea id="description" class="form-control rounded-3" rows="4" placeholder="Ex : 1g toutes les 6h ‚Äì max 4g/jour"></textarea>
								</div>
							</div>
						</div>

					</div>

				</div>

				<div class="modal-footer border-0 pt-0 pb-4 px-4">
					<button class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">
						Annuler
					</button>
					<button class="btn btn-primary rounded-pill px-4" onclick="saveTraitement()">
						<i class="bi bi-check2-circle me-1"></i>
						Enregistrer
					</button>
				</div>

			</div>
		</div>
	</div>

	<style>
		/* ‚úÖ Actions DataTable (pro, c√¥te √† c√¥te) */
		.table-actions {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.35rem;
			border-radius: 999px;
			background: rgba(13, 110, 253, .06);
			border: 1px solid rgba(13, 110, 253, .10);
		}
		.btn-action {
			width: 36px;
			height: 36px;
			padding: 0;
			border-radius: 12px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-size: 1rem;
			box-shadow: 0 6px 16px rgba(0, 0, 0, .06);
			background: #fff;
		}
		.btn-action-primary {
			border: 1px solid rgba(13, 110, 253, .25);
			color: #0d6efd;
		}
		.btn-action-danger {
			border: 1px solid rgba(220, 53, 69, .25);
			color: #dc3545;
		}
		.btn-action:hover {
			filter:brightness(0.98);
		}

		/* CI list */
		.ci-list {
			max-height: 220px;
			overflow: auto;
			padding: 0.90rem;
		}
		.ci-list .form-check {
			padding: 0.45rem 0.75rem;
			border-radius: 12px;
			background: #fff;
			border: 1px solid rgba(0, 0, 0, .06);
			margin-bottom: 0.5rem;
		}
	</style>

{% endblock %}

{% block javascripts %}
	{{ parent() }}

{# ================= DATATABLES JS ================= #}
	 <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

	 <script>
			let table;
			let currentId = null;
			let modalInstance = null;
	
			function el(id){ return document.getElementById(id); }
	
			document.addEventListener('DOMContentLoaded', () => {
				modalInstance = new bootstrap.Modal(el('traitementModal'));
	
				// ‚úÖ DATATABLE
				table = $('#traitementTable').DataTable({
					responsive: true,
					dom: `
						<"row mb-3"
							<"col-md-6" l>
							<"col-md-6 text-end" f>
						>
						<"row"<"col-12"tr>>
						<"row mt-3"
							<"col-md-5" i>
							<"col-md-7 text-end" p>
						>
					`,
					ajax: {
						url: '/api/traitements',
						dataSrc: ''
					},
					columns: [
						{ data: 'symptome', defaultContent: '-' },
						{ data: 'medicine', defaultContent: '-' },
						{
							data: 'description',
							render: d => d ? (d.length > 60 ? d.substring(0, 60) + '‚Ä¶' : d) : '<span class="text-muted">‚Äî</span>'
						},
						{
							data: 'contreIndications',
							render: d => (Array.isArray(d) && d.length)
								? d.map(ci => `<span class="badge bg-warning text-dark me-1 mb-1">${ci}</span>`).join('')
								: '<span class="text-muted">Aucune</span>'
						},
						{
							data: 'id',
							orderable: false,
							className: 'text-end',
							render: id => `
								<div class="table-actions">
									<button type="button"
											class="btn btn-action btn-action-primary"
											onclick="openModal(${id})"
											title="Modifier">
										<i class="bi bi-pencil"></i>
									</button>
	
									<button type="button"
											class="btn btn-action btn-action-danger"
											onclick="deleteTraitement(${id})"
											title="Supprimer">
										<i class="bi bi-trash"></i>
									</button>
								</div>
							`
						}
					],
					language: {
						search: "üîç Rechercher :",
						lengthMenu: "Afficher _MENU_",
						info: "_TOTAL_ traitements",
						paginate: { next: "Suivant", previous: "Pr√©c√©dent" }
					}
				});
	
				loadMaladiesChroniques();
	
				// SEARCH MEDICINE
				el('medicineSearch').addEventListener('keyup', () => {
					const q = el('medicineSearch').value.trim();
					if (q.length < 2) return;
	
					fetch(`/medicine/search/api?search=${encodeURIComponent(q)}`)
						.then(r => r.json())
						.then(data => {
							const select = el('medicine');
							select.innerHTML = '';
							data.forEach(m => {
								select.insertAdjacentHTML('beforeend', `
									<option value="${m.id}">
										${m.name} ${m.dosage ?? ''} ${m.uniteDosage ?? ''}
									</option>
								`);
							});
						});
				});
	
				// SEARCH SYMPTOME
				el('symptomeSearch').addEventListener('keyup', () => {
					const q = el('symptomeSearch').value.trim();
					if (q.length < 2) return;
	
					fetch(`/api/symptomes/search?q=${encodeURIComponent(q)}`)
						.then(r => r.json())
						.then(data => {
							const select = el('symptome');
							select.innerHTML = '';
							data.forEach(s => {
								select.insertAdjacentHTML('beforeend', `
									<option value="${s.id}">
										${s.name} ‚Äî ${s.category}
									</option>
								`);
							});
						});
				});
			});
	
			/* ============================
			   MODAL
			============================ */
			function openModal(id = null) {
				resetForm();
				currentId = id;
	
				if (id) {
					fetch(`/api/traitements/${id}`)
						.then(r => r.json())
						.then(fillForm);
				}
	
				modalInstance.show();
			}
			window.openModal = openModal;
	
			function resetForm() {
				currentId = null;
				el('description').value = '';
				el('medicine').innerHTML = '';
				el('symptome').innerHTML = '';
	
				el('medicineSearch').value = '';
				el('symptomeSearch').value = '';
	
				document.querySelectorAll('#ciList input').forEach(i => i.checked = false);
			}
	
			/* ============================
			   MALADIES CHRONIQUES
			============================ */
			function loadMaladiesChroniques(selected = []) {
				fetch('/api/referentiel/maladies-chroniques')
					.then(r => r.json())
					.then(data => {
						const box = el('ciList');
						box.innerHTML = '';
	
						data.forEach(m => {
							const checked = selected.includes(Number(m.id)) ? 'checked' : '';
							box.insertAdjacentHTML('beforeend', `
								<div class="form-check">
									<input class="form-check-input"
										   type="checkbox"
										   value="${m.id}"
										   id="ci_${m.id}"
										   ${checked}>
									<label class="form-check-label" for="ci_${m.id}">
										${m.nom}
									</label>
								</div>
							`);
						});
					});
			}
	
			/* ============================
			   FILL FORM
			============================ */
			function fillForm(t) {
				el('description').value = t.description ?? '';
	
				el('medicine').innerHTML = `
					<option value="${t.medicine.id}" selected>
						${t.medicine.label}
					</option>
				`;
	
				el('symptome').innerHTML = `
					<option value="${t.symptome.id}" selected>
						${t.symptome.label}
					</option>
				`;
	
				loadMaladiesChroniques((t.contreIndications || []).map(Number));
			}
	
			/* ============================
			   SAVE
			============================ */
			function saveTraitement() {
				const medicineId = el('medicine').value;
				const symptomeId = el('symptome').value;
	
				if (!medicineId || !symptomeId) {
					alert('Veuillez s√©lectionner un m√©dicament et un sympt√¥me');
					return;
				}
	
				const payload = {
					description: el('description').value,
					medicine: medicineId,
					symptome: symptomeId,
					contreIndications: [...document.querySelectorAll('#ciList input:checked')].map(i => i.value)
				};
	
				fetch(`/api/traitements${currentId ? '/' + currentId : ''}`, {
					method: currentId ? 'PUT' : 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				}).then(() => {
					modalInstance.hide();
					table.ajax.reload(null, false);
				});
			}
			window.saveTraitement = saveTraitement;
	
			/* ============================
			   DELETE
			============================ */
			function deleteTraitement(id) {
				if (!confirm('Supprimer ce traitement ?')) return;
	
				fetch(`/api/traitements/${id}`, { method: 'DELETE' })
					.then(() => table.ajax.reload(null, false));
			}
			window.deleteTraitement = deleteTraitement;
		</script>
{% endblock %}

