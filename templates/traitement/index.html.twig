{% extends 'base.html.twig' %}
{% block title %}Traitements
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<button class="btn btn-primary mb-3" onclick="openModal()">+ Nouveau traitement</button>

		<table class="table table-hover">
			<thead>
				<tr>
					<th>Sympt√¥me</th>
					<th>M√©dicament</th>
					<th>Posologie</th>
					<th>CI</th>
					<th></th>
				</tr>
			</thead>
			<tbody id="traitementTable"></tbody>
		</table>
	</div>

<div class="modal fade" id="traitementModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content rounded-4 shadow">

			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title fw-bold">
					üíä Cr√©ation d‚Äôun traitement
				</h5>
				<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>

			<div
				class="modal-body">

				<!-- üîç MEDICAMENT -->
				<div class="card mb-3">
					<div class="card-header fw-bold">üíä M√©dicament</div>
					<div class="card-body">
						<input type="text" id="medicineSearch" class="form-control mb-2" placeholder="Rechercher un m√©dicament">

						<select id="medicine" class="form-select" size="5"></select>
					</div>
				</div>

				<!-- üîç SYMPTOME -->
				<div class="card mb-3">
					<div class="card-header fw-bold">ü©∫ Sympt√¥me</div>
					<div class="card-body">
						<input type="text" id="symptomeSearch" class="form-control mb-2" placeholder="Rechercher un sympt√¥me">

						<select id="symptome" class="form-select" size="5"></select>
					</div>
				</div>

				<!-- ‚ö†Ô∏è CONTRE INDICATIONS -->
				<div class="card mb-3 border-warning">
					<div class="card-header fw-bold text-warning">
						‚ö†Ô∏è Contre-indications
					</div>
					<div
						class="card-body" id="ciList" style="max-height:200px; overflow-y:auto"><!-- checkboxes AJAX -->
					</div>
				</div>

				<!-- ‚úçÔ∏è POSOLOGIE -->
				<div class="card">
					<div class="card-header fw-bold">‚úçÔ∏è Posologie / Remarques</div>
					<div class="card-body">
						<textarea id="description" class="form-control" rows="4" placeholder="Ex : 1g toutes les 6h ‚Äì max 4g/jour"></textarea>
					</div>
				</div>

			</div>

			<div class="modal-footer">
				<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
					Annuler
				</button>
				<button class="btn btn-primary rounded-pill" onclick="saveTraitement()">
					Enregistrer
				</button>
			</div>

		</div>
	</div>
</div>


	
{% endblock %}

{% block javascripts %}
	{{ parent() }}
 <script>
const modal = new bootstrap.Modal(document.getElementById('traitementModal'));

let currentTraitementId = null;

/* ==========================
   INIT
========================== */
document.addEventListener('DOMContentLoaded', () => {
    loadTraitements();
    loadMaladiesChroniques();
});

/* ==========================
   TABLE LIST
========================== */
function loadTraitements() {
    fetch('/api/traitements')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('traitementTable');
            tbody.innerHTML = '';

            data.forEach(t => {
                tbody.innerHTML += `
                <tr>
                    <td>${t.symptome ?? '-'}</td>
                    <td>${t.medicine ?? '-'}</td>
                    <td>${t.description ? t.description.substring(0, 40) + '‚Ä¶' : '-'}</td>
                    <td>
                        ${t.contreIndications.length
                            ? t.contreIndications.map(ci =>
                                `<span class="badge bg-warning text-dark me-1">${ci}</span>`
                              ).join('')
                            : '<span class="text-muted">Aucune</span>'}
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1"
                                onclick="openModal(${t.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger"
                                onclick="deleteTraitement(${t.id})">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
        });
}

/* ==========================
   MODAL OPEN
========================== */
async function openModal(id = null) {
    resetForm();
    currentTraitementId = id;

    if (id) {
        const r = await fetch(`/api/traitements/${id}`);
        const t = await r.json();
        await fillForm(t);
    }

    modal.show();
}

/* ==========================
   RESET
========================== */
function resetForm() {
    currentTraitementId = null;
    description.value = '';
    medicine.innerHTML = '';
    symptome.innerHTML = '';
    document.querySelectorAll('#ciList input').forEach(i => i.checked = false);
}

/* ==========================
   MEDICINE SEARCH
========================== */
medicineSearch.addEventListener('keyup', () => {
    const q = medicineSearch.value.trim();
    if (q.length < 2) return;

    fetch(`/medicine/search/api?search=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
            medicine.innerHTML = '';
            data.forEach(m => {
                medicine.innerHTML += `
                    <option value="${m.id}">
                        ${m.name} ${m.dosage ?? ''}
                    </option>`;
            });
        });
});

/* ==========================
   SYMPTOME SEARCH
========================== */
symptomeSearch.addEventListener('keyup', () => {
    const q = symptomeSearch.value.trim();

    if (q.length < 2) {
        symptome.innerHTML = '';
        return;
    }

    fetch(`/api/symptomes/search?q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
            symptome.innerHTML = '';

            if (data.length === 0) {
                symptome.innerHTML = `<option disabled>Aucun sympt√¥me trouv√©</option>`;
                return;
            }

            data.forEach(s => {
                symptome.innerHTML += `
                    <option value="${s.id}">
                        ${s.name} ‚Äî ${s.category}
                    </option>`;
            });
        });
});


/* ==========================
   MALADIES CHRONIQUES
========================== */
function loadMaladiesChroniques(selected = []) {
    fetch('/api/maladies-chroniques')
        .then(r => r.json())
        .then(data => {
            ciList.innerHTML = '';
            data.forEach(m => {
                const checked = selected.includes(m.id) ? 'checked' : '';
                ciList.innerHTML += `
                    <div class="form-check mb-2">
                        <input class="form-check-input"
                               type="checkbox"
                               value="${m.id}"
                               id="ci_${m.id}"
                               ${checked}>
                        <label class="form-check-label" for="ci_${m.id}">
                            ${m.nom}
                        </label>
                    </div>`;
            });
        });
}

/* ==========================
   FILL FORM (EDIT)
========================== */
function fillForm(t) {
    description.value = t.description ?? '';

    // üî• MEDICAMENT : on injecte UNIQUEMENT l‚Äô√©l√©ment concern√©
    medicine.innerHTML = `
        <option value="${t.medicine.id}" selected>
            ${t.medicine.label}
        </option>
    `;

    // üî• SYMPTOME
    symptome.innerHTML = `
        <option value="${t.symptome.id}" selected>
            ${t.symptome.label}
        </option>
    `;

    // ‚ö†Ô∏è CONTRE-INDICATIONS
    loadMaladiesChroniques(t.contreIndications.map(Number));
}


function loadMedicinesForEdit(selectedId) {
    return fetch('/medicine/search/api?search=')
        .then(r => r.json())
        .then(data => {
            medicine.innerHTML = '';
            data.forEach(m => {
                const sel = Number(m.id) === Number(selectedId) ? 'selected' : '';
                medicine.innerHTML += `
                    <option value="${m.id}" ${sel}>
                        ${m.name} ${m.dosage ?? ''}
                    </option>`;
            });
        });
}

function loadSymptomesForEdit(selectedId) {
    return fetch('/api/symptomes?q=')
        .then(r => r.json())
        .then(data => {
            symptome.innerHTML = '';
            data.forEach(s => {
                const sel = Number(s.id) === Number(selectedId) ? 'selected' : '';
                symptome.innerHTML += `
                    <option value="${s.id}" ${sel}>
                        ${s.name}
                    </option>`;
            });
        });
}

/* ==========================
   SAVE
========================== */
function saveTraitement() {
    if (!medicine.value || !symptome.value) {
        alert('Veuillez s√©lectionner un m√©dicament et un sympt√¥me');
        return;
    }

    const payload = {
        description: description.value,
        medicine: medicine.value,
        symptome: symptome.value,
        contreIndications: [...document.querySelectorAll('#ciList input:checked')]
            .map(i => i.value)
    };

    const url = currentTraitementId
        ? `/api/traitements/${currentTraitementId}`
        : `/api/traitements`;

    fetch(url, {
        method: currentTraitementId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(() => {
        modal.hide();
        loadTraitements();
    });
}

/* ==========================
   DELETE
========================== */
function deleteTraitement(id) {
    if (!confirm('Supprimer ce traitement ?')) return;

    fetch(`/api/traitements/${id}`, { method: 'DELETE' })
        .then(() => loadTraitements());
}
</script>




{% endblock %}

