{% extends 'base.html.twig' %}

{% block title %}Gestion des traitements
{% endblock %}

{% block body %}
	<div
		class="container-fluid mt-4">

		<!-- ENT√äTE -->
		<div class="card shadow-sm border-0 rounded-4 mb-4">
			<div class="card-body d-flex justify-content-between align-items-center">
				<div>
					<h3 class="fw-bold mb-0">
						<i class="bi bi-capsule text-primary me-2"></i>
						Gestion des traitements
					</h3>
					<small class="text-muted">
						Base de traitements par sympt√¥me et contre-indications
					</small>
				</div>

				<button class="btn btn-primary rounded-pill px-4" onclick="openModal()">
					<i class="bi bi-plus-circle me-1"></i>
					Nouveau traitement
				</button>
			</div>
		</div>

		<!-- TABLE -->
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-body">
				<table id="traitementTable" class="table table-hover align-middle w-100">
					<thead class="table-light">
						<tr>
							<th>Sympt√¥me</th>
							<th>M√©dicament</th>
							<th>Posologie</th>
							<th>Contre-indications</th>
							<th class="text-end">Actions</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>

	</div>

	<!-- ================= MODAL ================= -->
	<div class="modal fade" id="traitementModal" tabindex="-1">
		<div class="modal-dialog modal-xl modal-dialog-scrollable">
			<div class="modal-content rounded-4 shadow">

				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title fw-bold">
						üíä Traitement
					</h5>
					<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>

				<div
					class="modal-body">

					<!-- MEDICAMENT -->
					<div class="card mb-3">
						<div class="card-header fw-bold">üíä M√©dicament</div>
						<div class="card-body">
							<input id="medicineSearch" class="form-control mb-2" placeholder="Rechercher un m√©dicament‚Ä¶">

							<select id="medicine" class="form-select" size="5"></select>
						</div>
					</div>

					<!-- SYMPTOME -->
					<div class="card mb-3">
						<div class="card-header fw-bold">ü©∫ Sympt√¥me</div>
						<div class="card-body">
							<input id="symptomeSearch" class="form-control mb-2" placeholder="Rechercher un sympt√¥me‚Ä¶">

							<select id="symptome" class="form-select" size="5"></select>
						</div>
					</div>

					<!-- CI -->
					<div class="card mb-3 border-warning">
						<div class="card-header fw-bold text-warning">
							‚ö†Ô∏è Contre-indications
						</div>
						<div class="card-body" id="ciList" style="max-height:200px;overflow:auto"></div>
					</div>

					<!-- POSOLOGIE -->
					<div class="card">
						<div class="card-header fw-bold">
							‚úçÔ∏è Posologie / Remarques
						</div>
						<div class="card-body">
							<textarea id="description" class="form-control" rows="4" placeholder="Ex : 1g toutes les 6h ‚Äì max 4g/jour"></textarea>
						</div>
					</div>

				</div>

				<div class="modal-footer">
					<button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
						Annuler
					</button>
					<button class="btn btn-primary rounded-pill" onclick="saveTraitement()">
						Enregistrer
					</button>
				</div>

			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	 <script>
	let table;
	let currentId = null;
	const modal = new bootstrap.Modal(document.getElementById('traitementModal'));
	
	/* ============================
	   DATATABLE INIT
	============================ */
	document.addEventListener('DOMContentLoaded', () => {
	
	    table = $('#traitementTable').DataTable({
	        responsive: true,
	        dom: `
	            <"row mb-3"
	                <"col-md-6" l>
	                <"col-md-6 text-end" f>
	            >
	            <"row"<"col-12"tr>>
	            <"row mt-3"
	                <"col-md-5" i>
	                <"col-md-7 text-end" p>
	            >
	        `,
	        ajax: {
	            url: '/api/traitements',
	            dataSrc: ''
	        },
	        columns: [
	            { data: 'symptome', defaultContent: '-' },
	            { data: 'medicine', defaultContent: '-' },
	            {
	                data: 'description',
	                render: d => d ? d.substring(0,50)+'‚Ä¶' : '-'
	            },
	            {
	                data: 'contreIndications',
	                render: d => d.length
	                    ? d.map(ci =>
	                        `<span class="badge bg-warning text-dark me-1">${ci}</span>`
	                      ).join('')
	                    : '<span class="text-muted">Aucune</span>'
	            },
	            {
	                data: 'id',
	                orderable: false,
	                className: 'text-end',
	                render: id => `
	                    <button class="btn btn-sm btn-outline-primary me-1"
	                            onclick="openModal(${id})">
	                        <i class="bi bi-pencil"></i>
	                    </button>
	                    <button class="btn btn-sm btn-outline-danger"
	                            onclick="deleteTraitement(${id})">
	                        <i class="bi bi-trash"></i>
	                    </button>
	                `
	            }
	        ],
	        language: {
	            search: "üîç Rechercher :",
	            lengthMenu: "Afficher _MENU_",
	            info: "_TOTAL_ traitements",
	            paginate: {
	                next: "Suivant",
	                previous: "Pr√©c√©dent"
	            }
	        }
	    });
	
	    loadMaladiesChroniques();
	});
	
	/* ============================
	   MODAL
	============================ */
	function openModal(id = null) {
	    resetForm();
	    currentId = id;
	
	    if (id) {
	        fetch(`/api/traitements/${id}`)
	            .then(r => r.json())
	            .then(fillForm);
	    }
	
	    modal.show();
	}
	
	function resetForm() {
	    currentId = null;
	    description.value = '';
	    medicine.innerHTML = '';
	    symptome.innerHTML = '';
	    document.querySelectorAll('#ciList input')
	        .forEach(i => i.checked = false);
	}
	
	/* ============================
	   SEARCH MEDICINE
	============================ */
	medicineSearch.addEventListener('keyup', () => {
	    const q = medicineSearch.value.trim();
	    if (q.length < 2) return;
	
	    fetch(`/medicine/search/api?search=${encodeURIComponent(q)}`)
	        .then(r => r.json())
	        .then(data => {
	            medicine.innerHTML = '';
	            data.forEach(m => {
	                medicine.innerHTML += `
	                    <option value="${m.id}">
	                        ${m.name} ${m.dosage ?? ''}
	                    </option>`;
	            });
	        });
	});
	
	/* ============================
	   SEARCH SYMPTOME
	============================ */
	symptomeSearch.addEventListener('keyup', () => {
	    const q = symptomeSearch.value.trim();
	    if (q.length < 2) return;
	
	    fetch(`/api/symptomes/search?q=${encodeURIComponent(q)}`)
	        .then(r => r.json())
	        .then(data => {
	            symptome.innerHTML = '';
	            data.forEach(s => {
	                symptome.innerHTML += `
	                    <option value="${s.id}">
	                        ${s.name} ‚Äî ${s.category}
	                    </option>`;
	            });
	        });
	});
	
	/* ============================
	   MALADIES CHRONIQUES
	============================ */
	function loadMaladiesChroniques(selected = []) {
	    fetch('/api/maladies-chroniques')
	        .then(r => r.json())
	        .then(data => {
	            ciList.innerHTML = '';
	            data.forEach(m => {
	                const checked = selected.includes(m.id) ? 'checked' : '';
	                ciList.innerHTML += `
	                    <div class="form-check mb-2">
	                        <input class="form-check-input"
	                               type="checkbox"
	                               value="${m.id}"
	                               id="ci_${m.id}"
	                               ${checked}>
	                        <label class="form-check-label"
	                               for="ci_${m.id}">
	                            ${m.nom}
	                        </label>
	                    </div>`;
	            });
	        });
	}
	
	/* ============================
	   FILL FORM
	============================ */
	function fillForm(t) {
	    description.value = t.description ?? '';
	
	    medicine.innerHTML = `
	        <option value="${t.medicine.id}" selected>
	            ${t.medicine.label}
	        </option>`;
	
	    symptome.innerHTML = `
	        <option value="${t.symptome.id}" selected>
	            ${t.symptome.label}
	        </option>`;
	
	    loadMaladiesChroniques(t.contreIndications.map(Number));
	}
	
	/* ============================
	   SAVE
	============================ */
	function saveTraitement() {
	    if (!medicine.value || !symptome.value) {
	        alert('Veuillez s√©lectionner un m√©dicament et un sympt√¥me');
	        return;
	    }
	
	    const payload = {
	        description: description.value,
	        medicine: medicine.value,
	        symptome: symptome.value,
	        contreIndications: [...document.querySelectorAll('#ciList input:checked')]
	            .map(i => i.value)
	    };
	
	    fetch(`/api/traitements${currentId ? '/' + currentId : ''}`, {
	        method: currentId ? 'PUT' : 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify(payload)
	    }).then(() => {
	        modal.hide();
	        table.ajax.reload(null, false);
	    });
	}
	
	/* ============================
	   DELETE
	============================ */
	function deleteTraitement(id) {
	    if (!confirm('Supprimer ce traitement ?')) return;
	
	    fetch(`/api/traitements/${id}`, { method: 'DELETE' })
	        .then(() => table.ajax.reload(null, false));
	}
	</script>
{% endblock %}

