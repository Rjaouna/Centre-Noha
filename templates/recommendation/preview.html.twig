{% extends 'base.html.twig' %}

{% block title %}
	Nouvelle recommandation —
	{{ hopital.etablissement }}
{% endblock %}

{% block body %}

	<div
class="mt-4">


		{# ================= HEADER APP UNIFIÉ ================= #}
		{% embed '_partials/_page_header.html.twig' with {
		icon: 'bi bi-pen',
		title: 'Nouvelle recommandation',
		subtitle: hopital.etablissement
	} %}
{% block header_actions_left %}
	<span class="action-icon bg-outline" onclick="generatePdf()" data-bs-toggle="tooltip" title="Générer le PDF">
		<i class="bi bi-filetype-pdf"></i>
	</span>

	<span class="action-icon bg-outline" onclick="printLetter()" data-bs-toggle="tooltip" title="Imprimer">
		<i class="bi bi-printer"></i>
	</span>

	<a href="{{ path('app_home') }}" class="action-icon bg-outline" data-bs-toggle="tooltip" title="Retour">
		<i class="bi bi-arrow-left"></i>
	</a>
{% endblock %}

		{% endembed %}

		{# ================= APERÇU DOCUMENT ================= #}
		<div class="pdf-wrapper">
			<div class="pdf-container">

				<div class="header">
					<strong>{{ "now"|date("d/m/Y") }}</strong>
				</div>

				<div class="title">Lettre de recommandation</div>

				<p>
					Je soussigné(e),
					<strong>{{ cabinet.nom }}</strong>,
										professionnel de santé, recommande vivement mon patient :
				</p>

				<div class="bloc">
					<strong>{{ patient.nom }}</strong><br>

					Né(e) le :
					<strong>{{ patient.age ? patient.age|date("d/m/Y") : "—" }}</strong><br>

					{% if patient.age %}
						{% set diff = date().diff(patient.age) %}
						Âge :
						<strong>
							{% if diff.y >= 1 %}
								{{ diff.y }}
								ans
							{% elseif diff.m >= 1 %}
								{{ diff.m }}
								mois
							{% else %}
								{{ diff.d }}
								jours
							{% endif %}
						</strong><br>
					{% endif %}

					Téléphone :
					{{ patient.telephone ?? '—' }}
				</div>

				<p>Pour une prise en charge au sein de l’établissement :</p>

				<div class="bloc">
					<strong>{{ hopital.etablissement }}</strong><br>
					Commune :
					{{ hopital.commune }}<br>
					Délégation :
					{{ hopital.delegation }}<br>
					Région :
					{{ hopital.region }}
				</div>

				<div class="bloc">
					<strong>Motif de recommandation :</strong><br>
					{{ motif|nl2br }}
				</div>

				<br>

				<p>
					Fait le :
					<strong>{{ "now"|date("d/m/Y") }}</strong>
				</p>

				<br>

				<p>
					Cordialement,<br>
					<strong>{{ app.user.prenom }}
						{{ app.user.nom }}</strong><br>
					{{ cabinet.type }}<br>
					<strong>{{ cabinet.nom }}</strong>
				</p>

				<div class="footer">
					{{ cabinet.nom }}
					—
					{{ cabinet.type }}<br>
					Adresse :
					{{ cabinet.adresse ?? '—' }}
					{{ cabinet.ville ?? '—' }}<br>
					Téléphone :
					{{ cabinet.telephone ?? '—' }}
					|
									Email :
					{{ cabinet.email ?? '—' }}
				</div>

			</div>
		</div>

	</div>

	{# ================= PDF SCRIPT ================= #}
	 <script>
	function generatePdf() {
		const patientId = "{{ patient.id }}";
		const hopitalId = "{{ hopital.id }}";
		const motif = `{{ motif|e('js') }}`;
		const encodedMotif = encodeURIComponent(motif);
	
		const iframe = document.createElement('iframe');
		iframe.style.display = 'none';
		iframe.src = `/recommendation/pdf/${patientId}/${hopitalId}?motif=${encodedMotif}`;
		document.body.appendChild(iframe);
	}
	</script>

	{# ================= STYLES (ISOLÉS PDF) ================= #}
		<style>
.pdf-wrapper {
	display: flex;
	justify-content: center;
	margin: 30px 0 50px;
}
.pdf-container {
	max-width: 650px;
	background: #fff;
	padding: 40px 50px;
	border-radius: 12px;
	box-shadow: 0 5px 25px rgba(0, 0, 0, .12);
	font-family: Helvetica, Arial, sans-serif;
	font-size: 13px;
	line-height: 1.6;
}
.header {
	text-align: right;
	margin-bottom: 40px
}
.title {
	font-size: 22px;
	font-weight: bold;
	text-align: center;
	margin-bottom: 25px;
	text-decoration: underline;
}
.bloc {
	margin-bottom: 20px
}
.footer {
	margin-top: 40px;
	padding-top: 12px;
	border-top: 1px solid #ccc;
	text-align: center;
	font-size: 12px;
	color: #555;
}
</style>


 <script>
function printLetter() {
	const content = document.querySelector('.pdf-container').innerHTML;

	const printWindow = window.open('', '', 'width=800,height=600');
	printWindow.document.write(`
		<html>
			<head>
				<title>Impression</title>
				<style>
					body {
						font-family: Helvetica, Arial, sans-serif;
						font-size: 13px;
						line-height: 1.6;
						padding: 30px;
					}
					.title {
						font-size: 22px;
						font-weight: bold;
						text-align: center;
						margin-bottom: 25px;
						text-decoration: underline;
					}
					.bloc { margin-bottom: 20px; }
					.footer {
						margin-top: 40px;
						padding-top: 12px;
						border-top: 1px solid #ccc;
						text-align: center;
						font-size: 12px;
						color: #555;
					}
				</style>
			</head>
			<body>
				${content}
			</body>
		</html>
	`);

	printWindow.document.close();
	printWindow.focus();
	printWindow.print();
	printWindow.close();
}
</script>



{% endblock %}

