{% extends 'base.html.twig' %}

{% block title %}Gestion disponibilit√©s

{% endblock %}

{% block body %}
	<div
		class="container-fluid mt-4">

		{# ================= HEADER (style app) ================= #}
		{% embed '_partials/_page_header.html.twig' with {
		icon: 'bi bi-calendar-check',
title: 'Gestion disponibilit√©s',

		subtitle: 'G√©rez vos cr√©neaux de consultation'
	} %}

			{# Actions m√©tier (mobile √† gauche) #}
			{% block header_actions_left %}
				<span class="action-icon bg-primary text-white" role="button" data-bs-toggle="modal" data-bs-target="#modalDispo" data-bs-toggle="tooltip" title="Ajouter une disponibilit√©">
					<i class="bi bi-plus-circle"></i>
				</span>
			{% endblock %}

			{# Navigation (mobile √† droite) : Home + Retour (par d√©faut du partial) #}
		{% endembed %}

		{# ================= AFFICHAGE PAR JOUR ================= #}
		<section class="mb-4">
			<div class="row g-3" id="dispoContainer"></div>
		</section>

	</div>

	{# ================= MODAL ================= #}
	<div class="modal fade" id="modalDispo" tabindex="-1">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content rounded-4 shadow">

				<form id="dispoForm">

					<div class="modal-header bg-primary text-white rounded-top-4">
						<h5 class="modal-title fw-bold d-flex align-items-center gap-2">
							<i class="bi bi-calendar-check"></i>
							Disponibilit√©
						</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>

					<div class="modal-body p-3 p-md-4">
						<div class="row g-3">

							<div class="col-md-6">
								<label class="form-label">Jour</label>
								<select name="jourSemaine" class="form-select" required>
									<option value="">‚Äî Choisir ‚Äî</option>
									<option value="1">Lundi</option>
									<option value="2">Mardi</option>
									<option value="3">Mercredi</option>
									<option value="4">Jeudi</option>
									<option value="5">Vendredi</option>
									<option value="6">Samedi</option>
									<option value="7">Dimanche</option>
								</select>
							</div>

							<div class="col-md-3">
								<label class="form-label">D√©but</label>
								<input type="time" name="heureDebut" class="form-control" required>
							</div>

							<div class="col-md-3">
								<label class="form-label">Fin</label>
								<input type="time" name="heureFin" class="form-control" required>
							</div>

							<div class="col-md-6">
								<label class="form-label">Dur√©e du cr√©neau (min)</label>
								<input type="number" name="dureeCreneau" class="form-control" required>
							</div>

							<div class="col-md-6 d-flex align-items-end">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" name="actif" checked>
									<label class="form-check-label">Actif</label>
								</div>
							</div>

						</div>
					</div>

					<div class="modal-footer border-0 pt-0 pb-4 px-4">
						<button class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">
							Annuler
						</button>
						<button class="btn btn-primary rounded-pill px-4">
							<i class="bi bi-check2-circle me-1"></i>
							Enregistrer
						</button>
					</div>

				</form>

			</div>
		</div>
	</div>

	{# ‚úÖ Style actions (comme Traitements) #}
	<style>
		.table-actions {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.35rem;
			border-radius: 999px;
			background: rgba(13, 110, 253, 0.06);
			border: 1px solid rgba(13, 110, 253, 0.10);
		}
		.btn-action {
			width: 36px;
			height: 36px;
			padding: 0;
			border-radius: 12px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-size: 1rem;
			box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
			background: #fff;
		}
		.btn-action-primary {
			border: 1px solid rgba(13, 110, 253, 0.25);
			color: #0d6efd;
		}
		.btn-action-danger {
			border: 1px solid rgba(220, 53, 69, 0.25);
			color: #dc3545;
		}
		.btn-action:hover {
			filter: brightness(0.98);
		}
	</style>

{% endblock %}

{% block javascripts %}
	{{ parent() }}

	 <script>
	document.addEventListener('DOMContentLoaded', () => {
	
		const jours = {
			1: 'Lundi',
			2: 'Mardi',
			3: 'Mercredi',
			4: 'Jeudi',
			5: 'Vendredi',
			6: 'Samedi',
			7: 'Dimanche'
		};
	
		const container = document.getElementById('dispoContainer');
		const modalEl = document.getElementById('modalDispo');
		const modal = new bootstrap.Modal(modalEl);
		const form = document.getElementById('dispoForm');
	
		let editId = null;
	
		// √âvite le bug JSON.stringify(d) dans onclick (quotes, caract√®res sp√©ciaux, etc.)
		// => on passe via data-id et un tableau en m√©moire.
		let cacheById = {};
	
		function badgeActif(isActif) {
			return isActif
				? `<span class="badge bg-success-subtle text-success rounded-pill">Actif</span>`
				: `<span class="badge bg-secondary-subtle text-secondary rounded-pill">Inactif</span>`;
		}
	
		function dispoRow(d) {
			return `
				<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded-3">
					<div class="pe-2">
						<div class="d-flex align-items-center gap-2 flex-wrap">
							<span class="d-flex align-items-center">
								<i class="bi bi-clock me-1"></i>
								<strong>${d.heureDebut}</strong> ‚Üí <strong>${d.heureFin}</strong>
							</span>
							<span class="text-muted">(${d.dureeCreneau} min)</span>
							${badgeActif(!!d.actif)}
						</div>
					</div>
	
					<div class="table-actions">
						<button type="button"
								class="btn btn-action btn-action-primary js-edit"
								data-id="${d.id}"
								title="Modifier">
							<i class="bi bi-pencil"></i>
						</button>
	
						<button type="button"
								class="btn btn-action btn-action-danger js-delete"
								data-id="${d.id}"
								title="Supprimer">
							<i class="bi bi-trash"></i>
						</button>
					</div>
				</div>
			`;
		}
	
		function dayCard(jourNumber, items) {
			const content = items.length === 0
				? `<p class="text-muted fst-italic mb-0">Aucune disponibilit√©</p>`
				: items.map(dispoRow).join('');
	
			return `
				<div class="col-md-6 col-lg-4">
					<div class="card shadow-sm rounded-4 h-100 border-0">
						<div class="card-header bg-primary text-white rounded-top-4">
							<h5 class="mb-0">${jours[jourNumber]}</h5>
						</div>
						<div class="card-body">
							${content}
						</div>
					</div>
				</div>
			`;
		}
	
		// üîÑ Chargement
		async function loadDispos() {
			container.innerHTML = `
				<div class="col-12 text-center py-4">
					<div class="spinner-border text-primary"></div>
				</div>
			`;
	
			const dispos = await fetch('/api/disponibilites').then(r => r.json());
	
			cacheById = {};
			dispos.forEach(d => { cacheById[d.id] = d; });
	
			const grouped = {};
			dispos.forEach(d => {
				const key = String(d.jourSemaine);
				if (!grouped[key]) grouped[key] = [];
				grouped[key].push(d);
			});
	
			container.innerHTML = '';
	
			Object.keys(jours).forEach(j => {
				const items = grouped[String(j)] ?? [];
				container.insertAdjacentHTML('beforeend', dayCard(j, items));
			});
		}
	
		// ‚ö° Delegation events (edit/delete)
		container.addEventListener('click', async (e) => {
			const btnEdit = e.target.closest('.js-edit');
			const btnDel  = e.target.closest('.js-delete');
	
			if (btnEdit) {
				const id = Number(btnEdit.dataset.id);
				const d = cacheById[id];
				if (!d) return;
	
				editId = d.id;
				form.jourSemaine.value = d.jourSemaine;
				form.heureDebut.value = d.heureDebut;
				form.heureFin.value = d.heureFin;
				form.dureeCreneau.value = d.dureeCreneau;
				form.actif.checked = !!d.actif;
	
				modal.show();
				return;
			}
	
			if (btnDel) {
				const id = Number(btnDel.dataset.id);
				if (!confirm('Supprimer cette disponibilit√© ?')) return;
	
				await fetch(`/api/disponibilites/${id}`, { method: 'DELETE' });
				await loadDispos();
				return;
			}
		});
	
		// Reset propre quand on ferme le modal
		modalEl.addEventListener('hidden.bs.modal', () => {
			editId = null;
			form.reset();
			// checkbox "actif" doit revenir √† checked si tu veux par d√©faut actif
			form.actif.checked = true;
		});
	
		// üíæ Enregistrement
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
	
			const payload = {
				jourSemaine: form.jourSemaine.value,
				heureDebut: form.heureDebut.value,
				heureFin: form.heureFin.value,
				dureeCreneau: form.dureeCreneau.value,
				actif: form.actif.checked
			};
	
			const url = editId ? `/api/disponibilites/${editId}` : `/api/disponibilites`;
	
			await fetch(url, {
				method: editId ? 'PUT' : 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
	
			modal.hide();
			await loadDispos();
		});
	
		loadDispos();
	});
	</script>
{% endblock %}

