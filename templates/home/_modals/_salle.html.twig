
 <script>
const sndClick = new Audio("/assets/media/success-340660.mp3");
const sndOk    = new Audio("/assets/media/success-340660.mp3");

sndClick.volume = 0.35;
sndOk.volume = 0.45;

const play = (a) => { try { a.currentTime = 0; a.play().catch(()=>{}); } catch(e) {} };

// ✅ helpers manquants (cause du blocage)
const toNum = (v) => {
  const n = Number(String(v ?? '0').replace(',', '.'));
  return Number.isNaN(n) ? 0 : n;
};
const money = (v) => toNum(v).toFixed(2).replace('.', ',') + ' DH';

document.addEventListener("DOMContentLoaded", () => {
  const modalEl = document.getElementById("waitingRoomModal");
  const boardEl = document.getElementById("wrBoard");
  const lastUpdateEl = document.getElementById("wrLastUpdate");

  // ✅ si un élément manque -> on ne casse pas toute la page
  if (!modalEl || !boardEl) return;

  const toastEl = document.getElementById("wrToast");
  const toastBody = document.getElementById("wrToastBody");
  const toast = toastEl ? bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2200 }) : null;

  let timer = null;

  const STAT = {
    EN_ATTENTE:      { label:"En attente",       icon:"bi-hourglass-split",  dot:"dot-wait",    actions:["APPELE","ABSENT"] },
    APPELE:          { label:"Appelé",           icon:"bi-megaphone-fill",   dot:"dot-call",    actions:["EN_CONSULTATION","EN_ATTENTE"] },
    EN_CONSULTATION: { label:"En consultation",  icon:"bi-heart-pulse-fill", dot:"dot-consult", actions:["TERMINE"] },
TERMINE: { label:"Terminé", icon:"bi-check2-circle", dot:"dot-done", actions:[] },


    ABSENT:          { label:"Absent",           icon:"bi-x-circle",         dot:"dot-abs",     actions:["EN_ATTENTE"] },
  };

  async function safeJsonFetch(url, options = {}) {
    const res = await fetch(url, options);
    const text = await res.text();
    if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
    try { return JSON.parse(text); } catch { throw new Error("Réponse JSON invalide"); }
  }

  const notify = (msg, ok = true) => {
    if (!toast || !toastBody) return;
    toastBody.textContent = msg;
    toastEl.classList.toggle("text-bg-dark", ok);
    toastEl.classList.toggle("text-bg-danger", !ok);
    toast.show();
  };

  const fmtTime = (iso) => {
    if (!iso) return null;
    const d = new Date(String(iso).replace(" ", "T"));
    return d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
  };

  const fmtDateTime = (iso) => {
    if (!iso) return null;
    const d = new Date(String(iso).replace(" ", "T"));
    return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
  };

  const statusBtn = (id, toStatut) => {
    const labelMap = { APPELE:"Appeler", EN_CONSULTATION:"En consultation", TERMINE:"Terminer", ABSENT:"Absent", EN_ATTENTE:"En attente" };
    const btnClassMap = { APPELE:"btn-primary", EN_CONSULTATION:"btn-success", TERMINE:"btn-secondary", ABSENT:"btn-danger", EN_ATTENTE:"btn-warning" };
    const iconMap = { APPELE:"bi-megaphone-fill", EN_CONSULTATION:"bi-heart-pulse-fill", TERMINE:"bi-check2-circle", ABSENT:"bi-x-circle", EN_ATTENTE:"bi-hourglass-split" };

    return `
      <button type="button"
        class="btn ${btnClassMap[toStatut]} btn-sm text-light"
        data-action="status"
        data-id="${id}"
        data-to="${toStatut}">
        <i class="bi ${iconMap[toStatut]} me-1"></i>${labelMap[toStatut]}
      </button>
    `;
  };

  const cardHtml = (p) => {
    const full = `${p.nom ?? ""} ${p.prenom ?? ""}`.trim() || "—";
    const rdvTime = fmtTime(p.rdvStart);
    const arrive = fmtDateTime(p.arriveAt);

    const statutKey = String(p.statut ?? '').toUpperCase();

    const noteBadge = p.note ? `
      <span class="wr-badge-soft ${p.note === 'Cas urgent' ? 'wr-urgent' : ''}">
        <i class="bi bi-clipboard-check me-1"></i>${p.note}
      </span>
    ` : '';

    // ✅ Prestations (safe)
    const presta = (["TERMINE", "EN_CONSULTATION"].includes(statutKey) && Array.isArray(p.prestations))
      ? p.prestations
      : [];

    const prestaCount = presta.length;

    const prestaTotal = presta.reduce((sum, x) => {
      const qty = Math.max(1, parseInt(x.quantite ?? 1, 10));
      const pu  = toNum(x.prixUnitaire ?? x.prix ?? 0);
      return sum + (pu * qty);
    }, 0);

const prestaList = prestaCount ? `
<div class="wr-presta mt-2">
	<div class="wr-presta-box">

		<div class="d-flex align-items-center justify-content-between gap-2 mb-2">
			<div class="fw-bold small d-flex align-items-center gap-2">
				<i class="bi bi-clipboard2-check text-primary"></i>
				Prestations
			</div>
			<span class="wr-presta-pill">
				<i class="bi bi-cash-coin text-primary"></i>
				${money(prestaTotal)}
			</span>
		</div>

		${presta.slice(0,4).map(x => {
		        const qty = Math.max(1, parseInt(x.quantite ?? 1, 10));
		        const pu  = toNum(x.prixUnitaire ?? x.prix ?? 0);
		        const lineTotal = pu * qty;
		
		        return `
		<div class="wr-presta-item">
			<div class="min-w-0">
				<div class="wr-presta-name">${x.nom ?? '—'}
					<span class="text-muted">×${qty}</span>
				</div>
				<div class="wr-presta-sub">PU :
					<b class="text-dark">${money(pu)}</b>
				</div>
			</div>

			<div class="wr-presta-right">
				<div class="small text-muted lh-1">Total</div>
				<div class="fw-bold text-primary lh-1">${money(lineTotal)}</div>
			</div>
		</div>
		`;
		      }).join('')}
		
		      ${prestaCount > 4 ? `<div class="small text-muted mt-2">… +${prestaCount - 4} autre(s)</div>` : ''}

	</div>
</div>
` : '';



    const arriveBadge = p.arriveAt ? `
      <span class="wr-badge-soft">
        <i class="bi bi-door-open me-1"></i> Arrivé ${arrive}
      </span>
    ` : "";

    const rdvBadge = p.rdvStart ? `
      <span class="wr-badge-soft wr-rdv ${p.rdvPassed ? "wr-rdv-late" : ""}">
        <i class="bi bi-calendar-check me-1"></i> RDV ${rdvTime ?? ""}
      </span>
    ` : "";

    // ✅ utiliser statutKey ici aussi
    const actions = (STAT[statutKey]?.actions ?? []).map(s => statusBtn(p.id, s)).join("");

    return `
      <div class="wr-card">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="wr-name">${full}</div>
            <div class="wr-meta">
              <i class="bi bi-geo-alt me-1"></i>${p.ville ?? "—"} •
              <i class="bi bi-telephone ms-2 me-1"></i>${p.telephone ?? "—"}
            </div>
          </div>

          <a class="btn btn-light btn-sm rounded-pill" href="/fiche/client/${p.patientId}">
            <i class="bi bi-box-arrow-up-right"></i>
          </a>
        </div>

        <div class="wr-badges">
          ${noteBadge}
          ${arriveBadge}
          ${rdvBadge}
          ${prestaList}
        </div>

        ${actions ? `<div class="wr-actions">${actions}</div>` : ""}
      </div>
    `;
  };

  const colHtml = (statut, list) => {
    const cfg = STAT[statut];
    const items = (list ?? []).map(cardHtml).join("") || `<div class="text-muted small px-2">Aucun patient</div>`;
    return `
      <div class="wr-col">
        <div class="wr-col-head">
          <div class="wr-col-title">
            <span class="wr-status-dot ${cfg.dot}"></span>
            <i class="bi ${cfg.icon}"></i> ${cfg.label}
          </div>
          <div class="wr-count">${(list ?? []).length}</div>
        </div>
        <div class="wr-list">${items}</div>
      </div>
    `;
  };

  const render = (data) => {
    boardEl.innerHTML = `
      ${colHtml("EN_ATTENTE", data.EN_ATTENTE)}
      ${colHtml("APPELE", data.APPELE)}
      ${colHtml("EN_CONSULTATION", data.EN_CONSULTATION)}
      ${colHtml("TERMINE", data.TERMINE)}
      ${colHtml("ABSENT", data.ABSENT)}
    `;
  };

  const load = async () => {
    const j = await safeJsonFetch("/api/waiting-room/list");
    if (!j.success) throw new Error(j.message || "Erreur chargement");

    render(j.data);

    if (lastUpdateEl) {
      const now = new Date();
      lastUpdateEl.textContent = "Maj: " + now.toLocaleTimeString("fr-FR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    }
  };

  const patchStatus = async (id, statut, btn) => {
    const old = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>...`;

    try {
      const j = await safeJsonFetch(`/api/waiting-room/${id}/status`, {
        method: "PATCH",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ statut })
      });

      if (!j.success) { notify(j.message || "Erreur", false); return; }

      notify("Statut mis à jour ✅");
      await load();
    } catch (e) {
      console.error(e);
      notify("Erreur réseau / API", false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = old;
    }
  };

  boardEl.addEventListener("click", (e) => {
    const b = e.target.closest('[data-action="status"]');
    if (!b) return;

    play(sndClick);
    patchStatus(b.dataset.id, b.dataset.to, b);
  });

  modalEl.addEventListener("shown.bs.modal", async () => {
    await load().catch(console.error);
    timer = setInterval(() => load().catch(()=>{}), 5000);
  });

  modalEl.addEventListener("hidden.bs.modal", () => {
    if (timer) clearInterval(timer);
    timer = null;
    boardEl.innerHTML = "";
  });
});
</script>

