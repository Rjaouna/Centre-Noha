{% extends 'base.html.twig' %}

{% block title %}Accueil
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
{% endblock %}


{% block body %}

<div class="container  px-0 py-4">





{# ======================= #}
{# ðŸ”¹ HEADER DASHBOARD #}
{# ======================= #}

<div class="card border-0 shadow-sm rounded-4 mb-4 dashboard-header">
	<div class="card-body py-3">


		<div
			class="d-flex justify-content-between align-items-center flex-wrap gap-3">

			<!-- LEFT -->
<div class="d-flex align-items-center gap-3">

				<div class="dashboard-icon">
					<i class="bi bi-clipboard-pulse"></i>
				</div>

				<div>
<h3 class="fw-bold mb-0">Tableau de bord</h3>

					<small class="text-muted">
Etablissement mÃ©dical :

						<span class="fw-semibold text-primary" id="nameCabinet"></span>
					</small>
				</div>
			</div>

<!-- RIGHT : HORLOGE -->
<div class="d-none d-md-block">
	<div class="clock-card">
		<div id="clock-time">--:--:--</div>
		<div id="clock-date">--</div>
	</div>

			</div>

		</div>

	</div>
</div>

 <script>
document.addEventListener("DOMContentLoaded", () => {

    function updateClock() {
        const now = new Date();

        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');

        const timeEl = document.getElementById('clock-time');
        const dateEl = document.getElementById('clock-date');

        if (!timeEl || !dateEl) return;

        timeEl.textContent = `${h}:${m}:${s}`;
        dateEl.textContent = now.toLocaleDateString('fr-FR', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    updateClock();
    setInterval(updateClock, 1000);
});
</script>




{# ======================= #}
{# ðŸ”¹ DASHBOARD MOBILE PRO #}
{# ======================= #}
	<div
	class="d-md-none"> {# âœ… ACTION PRINCIPALE #}
	<div class="mb-4">
		<a data-bs-toggle="modal" data-bs-target="#modalAddClient" class="text-decoration-none">
			<div class="mobile-primary-action py-4">
				<div class="icon">
					<i class="bi bi-person-plus-fill"></i>
				</div>
				<div>
					<h5>Ajouter un patient</h5>
					<p>CrÃ©er une nouvelle fiche mÃ©dicale</p>
				</div>
			</div>
		</a>
	</div>

	{# âœ… SALLE Dâ€™ATTENTE (UX TOP) #}
	<div class="mb-4">
		<a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#waitingRoomModal" id="openWaitingRoomMobile">
			<div class="mobile-wr-card">
				<div class="mobile-wr-left">
					<div class="mobile-wr-icon">
						<i class="bi bi-hourglass-split"></i>
					</div>

					<div class="mobile-wr-text">
						<div class="d-flex align-items-center gap-2">
							<h5 class="mb-0">Salle dâ€™attente</h5>
							
						</div>
						<div class="mobile-wr-sub">Suivi des statuts en temps rÃ©el</div>
					</div>
				</div>

				<div class="mobile-wr-right">
<span class="mobile-wr-live">
	<span class="dot"></span>Live
</span>

					<i class="bi bi-chevron-right"></i>
				</div>
			</div>
		</a>

		{# âœ… mini stats #}
		<div class="mobile-wr-stats mt-3" id="wrMobileStats">
			<div class="s s-wait">
				<div class="n" id="wrCountWait">0</div>
				<div class="l">Attente</div>
			</div>
			<div class="s s-call">
				<div class="n" id="wrCountCall">0</div>
				<div class="l">AppelÃ©s</div>
			</div>
			<div class="s s-consult">
				<div class="n" id="wrCountConsult">0</div>
				<div class="l">Consult.</div>
			</div>
			<div class="s s-done">
				<div class="n" id="wrCountDone">0</div>
				<div class="l">TerminÃ©s</div>
			</div>
			<div class="s s-abs">
				<div class="n" id="wrCountAbs">0</div>
				<div class="l">Absents</div>
			</div>
		</div>
	</div>

	{# âœ… STATS RAPIDES #}
	<div class="row g-3 mb-4">
		<div class="col-6">
			<a href="{{ path('app_fiche_client_index') }}" class="text-decoration-none">
				<div class="mobile-stat-card bg-info">
					<i class="bi bi-people-fill"></i>
					<div class="value">{{ totalClients ?? 0 }}
						Patients</div>
					<span>Gestion & consultations</span>
				</div>
			</a>
		</div>

		<div class="col-6">
			<a href="{{ path('rendezvous_calendrier') }}" class="text-decoration-none">
				<div class="mobile-stat-card bg-success">
					<i class="bi bi-calendar-check-fill"></i>
					<div class="value">Rendez-vous</div>
					<span>Agenda & consultations</span>
				</div>
			</a>
		</div>
	</div>

</div>




{# ======================= #}
{# ðŸ”¹ DASHBOARD DESKTOP #}
{# ======================= #}
	<div class="row g-3 d-none d-md-flex"> {% include 'home/_dashboard/_card_desktop.html.twig' with {
    title: 'Ajouter un patient',
    desc: 'CrÃ©er une nouvelle fiche',
    icon: 'bi-person-plus-fill',
    bg: 'bg-add',
    modal: '#modalAddClient'
  } %}

	{% include 'home/_dashboard/_card_desktop.html.twig' with {
    title: 'Patients',
    desc: 'GÃ©rer les dossiers',
    icon: 'bi-people-fill',
    bg: 'bg-patients',
    link: path('app_fiche_client_index'),
    badge: totalClients ?? null
  } %}

	{% include 'home/_dashboard/_card_desktop.html.twig' with {
    title: 'Salle dâ€™attente',
    desc: 'Patients du jour',
    icon: 'bi-hourglass-split',
    bg: 'bg-medicines',
    modal: '#waitingRoomModal'
  } %}

	{% include 'home/_dashboard/_card_desktop.html.twig' with {
    title: 'Rendez-vous',
    desc: 'Agenda & consultations',
    icon: 'bi-calendar-check-fill',
    bg: 'bg-rdv',
    link: path('rendezvous_calendrier'),
    badge: totalRdvToday ?? null
  } %}

</div>

{# âœ… MINI WIDGET SALLE Dâ€™ATTENTE (DESKTOP) #}
<div class="d-none d-md-block mt-5">
	<div class="wr-mini card border-0 shadow-sm rounded-4">
		<div class="card-body p-3 p-lg-4">

			<div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
				<div class="d-flex align-items-center gap-3">
					<div class="wr-mini-icon">
						<i class="bi bi-hourglass-split"></i>
					</div>

					<div>
						<div class="d-flex align-items-center gap-2">
							<h5 class="mb-0 fw-black">Salle dâ€™attente</h5>
							<span class="wr-mini-live">
								<span class="dot"></span>Live
							</span>
						</div>
						<div class="text-muted small">Vue rapide des patients du jour (statuts)</div>
					</div>
				</div>

				<div class="d-flex align-items-center gap-2">
					<div class="wr-mini-last" id="wrDeskLast">Maj: â€”</div>

					<button class="btn btn-primary rounded-pill fw-bold px-3" data-bs-toggle="modal" data-bs-target="#waitingRoomModal" id="openWaitingRoomDesktop">
						Ouvrir
						<i class="bi bi-box-arrow-up-right ms-1"></i>
					</button>
				</div>
			</div>

			<div class="wr-mini-stats mt-3" id="wrDeskStats">
				<div class="s s-wait">
					<div class="n" id="wrDeskWait">0</div>
					<div class="l">En attente</div>
				</div>
				<div class="s s-call">
					<div class="n" id="wrDeskCall">0</div>
					<div class="l">AppelÃ©s</div>
				</div>
				<div class="s s-consult">
					<div class="n" id="wrDeskConsult">0</div>
					<div class="l">Consultation</div>
				</div>
				<div class="s s-done">
					<div class="n" id="wrDeskDone">0</div>
					<div class="l">TerminÃ©s</div>
				</div>
				<div class="s s-abs">
					<div class="n" id="wrDeskAbs">0</div>
					<div class="l">Absents</div>
				</div>
			</div>

		</div>
	</div>
</div>



		{# ======================= #}
		{# ðŸ”¹ RESSOURCES #}
		{# ======================= #}
			

		{{ include('home/_stats/_stats.html.twig') }}

	</div>

{% include 'home/_modals/_add_patient.html.twig' %}



<style>

  .fw-black{font-weight:1000}

  .wr-mini{
    background: radial-gradient(1100px 320px at 0% 0%, rgba(59,130,246,.14), transparent 55%),
                radial-gradient(1100px 320px at 100% 0%, rgba(16,185,129,.12), transparent 55%),
                #fff;
  }
  .wr-mini-icon{
    width:56px;height:56px;border-radius:18px;
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:1.3rem;
    background: linear-gradient(135deg,#f59e0b,#fbbf24);
    box-shadow:0 18px 30px rgba(245,158,11,.25);
  }

  .wr-mini-live{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 10px;border-radius:999px;
    font-weight:1000;font-size:.78rem;
    background:rgba(16,185,129,.12);
    border:1px solid rgba(16,185,129,.22);
    color:#0f766e;
  }
  .wr-mini-live .dot{
    width:9px;height:9px;border-radius:999px;background:#10b981;
    box-shadow:0 0 0 5px rgba(16,185,129,.18);
    animation: wrPulse 1.5s infinite;
  }
  @keyframes wrPulse{
    0%{transform:scale(.95);opacity:.9}
    50%{transform:scale(1.05);opacity:1}
    100%{transform:scale(.95);opacity:.9}
  }

  .wr-mini-last{
    padding:8px 12px;border-radius:999px;background:#fff;
    border:1px solid rgba(15,23,42,.10);
    font-weight:900;font-size:.85rem;
    box-shadow:0 10px 22px rgba(2,6,23,.06);
  }

  .wr-mini-stats{
    display:grid;
    grid-template-columns: repeat(5, minmax(120px, 1fr));
    gap:10px;
  }
  .wr-mini-stats .s{
    background:#fff;
    border:1px solid rgba(15,23,42,.10);
    border-radius:18px;
    padding:12px 10px;
    text-align:center;
    box-shadow:0 14px 26px rgba(2,6,23,.06);
  }
  .wr-mini-stats .n{font-weight:1000;font-size:1.25rem;color:#0b1220}
  .wr-mini-stats .l{font-size:.82rem;font-weight:900;opacity:.75}

  .s-wait{border-top:3px solid rgba(245,158,11,.85)}
  .s-call{border-top:3px solid rgba(59,130,246,.85)}
  .s-consult{border-top:3px solid rgba(16,185,129,.85)}
  .s-done{border-top:3px solid rgba(100,116,139,.85)}
  .s-abs{border-top:3px solid rgba(239,68,68,.85)}
/* ===== MOBILE DASHBOARD ===== */
.dashboard-header {
  background: linear-gradient(
    135deg,
    rgba(255,255,255,0.95),
    rgba(248,250,255,0.95)
  );
  backdrop-filter: blur(6px);
}

.dashboard-icon {
  width: 64px;
  height: 64px;
  border-radius: 18px;
  background: linear-gradient(135deg, #0d6efd, #4dabf7);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.9rem;
  box-shadow: 0 10px 25px rgba(13,110,253,0.25);
}

.mobile-primary-action {
    display: flex;
    gap: 16px;
    padding: 18px;
    border-radius: 20px;
    background: linear-gradient(135deg, #0d6efd, #4dabf7);
    color: white;
box-shadow: 0 8px 22px rgba(0,0,0,.15);


}

.mobile-primary-action .icon {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: rgba(255,255,255,.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.mobile-primary-action h5 {
    margin: 0;
    font-weight: 800;
}

.mobile-primary-action p {
    margin: 0;
    opacity: .85;
    font-size: .9rem;
}

/* STATS */
.mobile-stat-card {
    border-radius: 20px;
    padding: 16px;
    color: white;
    text-align: center;
    box-shadow: 0 8px 22px rgba(0,0,0,.15);
}

.mobile-stat-card i {
    font-size: 1.6rem;
    opacity: .9;
}

.mobile-stat-card .value {
    font-size: 1rem;
    font-weight: 800;
    margin: 6px 0;
}

/* SHORTCUTS */
.mobile-shortcut {
    background: white;
    border-radius: 18px;
    padding: 16px;
    text-align: center;
    box-shadow: 0 6px 18px rgba(0,0,0,.08);
    font-weight: 600;
}

.mobile-shortcut i {
    font-size: 1.6rem;
    display: block;
    margin-bottom: 6px;
}
/* ===============================
   ðŸ§° MODULES DE RÃ‰FÃ‰RENCE
=============================== */

.resource-card {
    background: #ffffff;
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    height: 100%;
    transition: .25s ease;
    cursor: pointer;
}

.resource-card:hover {
    transform: translateY(-4px);
    background: #f6f9ff;
}

/* Header */
.resource-card-header {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 10px;
}

.resource-card-header i {
    font-size: 1.4rem;
}

/* Texte */
.resource-card-title {
    font-weight: 700;
    color: #212529;
    font-size: 0.95rem;
}

.resource-card-subtitle {
    font-size: 0.8rem;
    color: #6c757d;
    line-height: 1.4;
}

/* Indication action */
.resource-card::after {
    content: 'â†’';
    position: absolute;
    bottom: 14px;
    right: 16px;
    color: #0d6efd;
    font-weight: 700;
    opacity: 0;
    transition: .25s;
}

.resource-card:hover::after {
    opacity: 1;
}




{# ===================== #}
{# âœ… CSS SALLE Dâ€™ATTENTE #}
{# ===================== #}

	.mobile-wr-card{
	    display:flex;align-items:center;justify-content:space-between;
	    padding:16px 14px;border-radius:18px;
	    background: radial-gradient(800px 300px at 0% 0%, rgba(59,130,246,.16), transparent 55%),
	                radial-gradient(800px 300px at 100% 0%, rgba(16,185,129,.12), transparent 55%),
	                #fff;
	    border:1px solid rgba(15,23,42,.10);
	    box-shadow: 0 18px 40px rgba(2,6,23,.08);
	  }
	  .mobile-wr-left{display:flex;align-items:center;gap:12px;min-width:0}
	  .mobile-wr-icon{
	    width:52px;height:52px;border-radius:18px;
	    display:flex;align-items:center;justify-content:center;
	    color:#fff;font-size:1.25rem;
	    background: linear-gradient(135deg,#f59e0b,#fbbf24);
	    box-shadow:0 18px 30px rgba(245,158,11,.28);
	    flex:0 0 auto;
	  }
	  .mobile-wr-text{min-width:0}
	  .mobile-wr-text h5{font-weight:1000;color:#0b1220}
	  .mobile-wr-sub{
	    margin-top:4px;
	    font-size:.9rem;
	    color:rgba(15,23,42,.70);
	    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
	  }
	  .mobile-wr-right{
	    display:flex;align-items:center;gap:10px;
	    color:rgba(15,23,42,.70);
	    font-weight:900;
	    flex:0 0 auto;
	  }
	  .mobile-wr-last{
	    padding:6px 10px;border-radius:999px;background:#fff;
	    border:1px solid rgba(15,23,42,.10);
	    font-size:.8rem;
	  }
	  .mobile-wr-live{
	    display:inline-flex;align-items:center;gap:7px;
	    padding:5px 9px;border-radius:999px;
	    font-weight:1000;font-size:.75rem;
	    background:rgba(16,185,129,.12);
	    border:1px solid rgba(16,185,129,.22);
	    color:#0f766e;
	  }
	  .mobile-wr-live .dot{
	    width:9px;height:9px;border-radius:999px;background:#10b981;
	    box-shadow:0 0 0 5px rgba(16,185,129,.18);
	    animation: wrPulse 1.5s infinite;
	  }
	  @keyframes wrPulse{
	    0%{transform:scale(.95);opacity:.9}
	    50%{transform:scale(1.05);opacity:1}
	    100%{transform:scale(.95);opacity:.9}
	  }
	
	  .mobile-wr-stats{
	    display:grid;
	    grid-template-columns: repeat(5, 1fr);
	    gap:8px;
	  }
	  .mobile-wr-stats .s{
	    background:#fff;border:1px solid rgba(15,23,42,.10);
	    border-radius:16px;padding:10px 6px;
	    text-align:center;box-shadow:0 12px 24px rgba(2,6,23,.06);
	  }
	  .mobile-wr-stats .n{font-weight:1000;font-size:1.05rem;color:#0b1220}
	  .mobile-wr-stats .l{font-size:.72rem;font-weight:900;opacity:.70}
	
	  .s-wait{border-top:3px solid rgba(245,158,11,.85)}
	  .s-call{border-top:3px solid rgba(59,130,246,.85)}
	  .s-consult{border-top:3px solid rgba(16,185,129,.85)}
	  .s-done{border-top:3px solid rgba(100,116,139,.85)}
	  .s-abs{border-top:3px solid rgba(239,68,68,.85)}

</style>
{% endblock %}



{% block javascripts %}
	{{ parent() }}
{# ===================== #}
{# âœ… JS : charge les stats #}
{# ===================== #}
 <script>
document.addEventListener("DOMContentLoaded", () => {
  let timer = null;

  async function safeJsonFetch(url, options = {}) {
    const res = await fetch(url, options);
    const text = await res.text();
    let j = null;
    try { j = JSON.parse(text); } catch(e) {}
    if (!res.ok) throw new Error(j?.message ?? `HTTP ${res.status}`);
    if (!j) throw new Error("RÃ©ponse JSON invalide");
    return j;
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function setLast(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const now = new Date();
    el.textContent = "Maj: " + now.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit" });
  }

  function applyCounts(data) {
    const w  = data?.EN_ATTENTE?.length ?? 0;
    const a  = data?.APPELE?.length ?? 0;
    const c  = data?.EN_CONSULTATION?.length ?? 0;
    const t  = data?.TERMINE?.length ?? 0;
    const ab = data?.ABSENT?.length ?? 0;

    // âœ… Mobile ids
    setText("wrCountWait", w);
    setText("wrCountCall", a);
    setText("wrCountConsult", c);
    setText("wrCountDone", t);
    setText("wrCountAbs", ab);
    setLast("wrMobileLast");

    // âœ… Desktop ids
    setText("wrDeskWait", w);
    setText("wrDeskCall", a);
    setText("wrDeskConsult", c);
    setText("wrDeskDone", t);
    setText("wrDeskAbs", ab);
    setLast("wrDeskLast");
  }

  async function loadCounts() {
    try {
      const j = await safeJsonFetch("/api/waiting-room/list");
      if (!j.success) return;
      applyCounts(j.data);
    } catch (e) {
      // silencieux UX
    }
  }

  // 1er chargement
  loadCounts();

  // refresh quand le modal est ouvert
  const modalEl = document.getElementById("waitingRoomModal");
  modalEl?.addEventListener("shown.bs.modal", async () => {
    await loadCounts();
    timer = setInterval(loadCounts, 5000);
  });

  modalEl?.addEventListener("hidden.bs.modal", () => {
    if (timer) clearInterval(timer);
    timer = null;
  });
});
</script>



 <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

	 <script>
	        document.addEventListener('DOMContentLoaded', () => {
	            const el = document.querySelector('.dashboardCoverflow');
	
	            // si on est sur desktop, le slider n'existe pas (d-none d-md-none), donc on skip
	            if (!el || typeof Swiper === "undefined") return;
	
	            new Swiper(el, {
	                effect: 'coverflow',
	                grabCursor: true,
	                centeredSlides: true,
	                slidesPerView: 'auto',
	                spaceBetween: -20,
	                coverflowEffect: {
	                    rotate: 0,
	                    stretch: 0,
	                    depth: 120,
	                    modifier: 1.4,
	                    slideShadows: false,
	                },
	            });
	        });
	    </script>

	 <script>
	        async function afficherNomCabinet() {
	            const res = await fetch("{{ path('app_nom_cabinet') }}");
	            const data = await res.json();
	            const el = document.getElementById('nameCabinet');
	            if (el) el.innerText = data.nom ?? '';
	        }
	        afficherNomCabinet();
	    </script>
{% endblock %}

