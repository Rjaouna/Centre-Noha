<!-- ============================= -->
<!-- ðŸ”¥ SECTION ANALYTIQUE -->
<!-- ============================= -->

	<style>
/* ===== CHARTS ===== */
.chart-container {
	height: 180px !important;
	display: flex;
	justify-content: center;
	align-items: center;
}
canvas {
	max-height: 160px !important;
}

/* TITRES */
.block-title {
	font-size: 1.1rem;
	font-weight: bold;
	color: var(--bs-primary);
	text-align: center;
	margin-bottom: 10px;
}

/* LÃ‰GENDES EN POINTS */
.legend-dots {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	gap: 8px;
	margin-top: 8px;
}
.legend-item {
	display: flex;
	align-items: center;
	gap: 6px;
	font-size: 0.8rem;
	color: #555;
}
.legend-color {
	width: 12px;
	height: 12px;
	border-radius: 50%;
	display: inline-block;
}
</style>

	<div class="container mt-3 px-0"> <div class="row g-4">

		<!-- ============================= -->
		<!-- ðŸŸ¦ STATS GRAPHIQUES -->
		<!-- ============================= -->
			<div class="col-lg-9"> <div class="card shadow-lg border-0 rounded-4 p-4">

				<h4 class="fw-bold text-primary mb-3 d-flex align-items-center">
					<i class="bi bi-bar-chart-fill me-2"></i>
					Statistiques graphiques
				</h4>

				<hr>

				<!-- ðŸ”¥ 3 CAMEMBERTS SUR UNE LIGNE -->
				<div
					class="row text-center mb-4">

					<!-- Paiements -->
					<div class="col-md-4 mb-4">
						<h6 class="block-title">RÃ©partition des paiements</h6>
						<div class="chart-container">
							<canvas id="chartPaiements"></canvas>
						</div>
						<div id="legendPaiements" class="legend-dots"></div>
					</div>

					<!-- Types de maladies -->
					<div class="col-md-4 mb-4">
						<h6 class="block-title">Types de maladies</h6>
						<div class="chart-container">
							<canvas id="chartPieMaladies"></canvas>
						</div>
						<div id="legendMaladies" class="legend-dots"></div>
					</div>

					<!-- SymptÃ´mes -->
					<div class="col-md-4 mb-4">
						<h6 class="block-title">SymptÃ´mes gÃ©nÃ©raux</h6>
						<div class="chart-container">
							<canvas id="chartSymptomes"></canvas>
						</div>
						<div id="legendSymptomes" class="legend-dots"></div>
					</div>

				</div>

				<hr
				class="my-4">

				<!-- ðŸ“Š Clients par jour -->
				<h6 class="block-title">Clients passÃ©s par jour</h6>
<div>

					<canvas id="chartClientsPerDay"></canvas>
				</div>

			</div>
		</div>

		<!-- ============================= -->
		<!-- ðŸŸ© RDV Dâ€™AUJOURDâ€™HUI (5 derniers) -->
		<!-- ============================= -->
			<div class="col-lg-3"> <div class="card  border-0 rounded-4 p-4 h-100">

				<h4 class="fw-bold text-primary mb-3 d-flex align-items-center">
					<i class="bi bi-clock-history me-2"></i>
					RDV dâ€™aujourdâ€™hui
				</h4>

				<hr>

				<div class="d-flex flex-column gap-3">




					

<div id="rdvList" class="card border-0 shadow-sm rounded-3 p-3 rdv-card">



							

						</div>

			

				</div>

			</div>
		</div>

	</div>
</div>

<!-- ============================= -->
<!-- ðŸ“Š CHART JS -->
<!-- ============================= -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <script>

/* Tooltip */
const tooltipLabel = ctx => ctx.label + " : " + ctx.raw;

/* GÃ©nÃ©ration lÃ©gendes */
function generateLegend(containerId, labels, colors) {
	const container = document.getElementById(containerId);
	container.innerHTML = labels.map((label, i) =>
		`<div class='legend-item'>
			<span class='legend-color' style='background:${colors[i]}'></span>
			${label}
		</div>`
	).join("");
}

/* ============================= */
/* Paiements */
async function loadPaiementsChart() {
	const res = await fetch("/api/statistics/paiements");
	const stats = await res.json();

	const colors = [
		"rgba(13,110,253,0.8)",
		"rgba(25,135,84,0.8)",
		"rgba(255,193,7,0.8)",
		"rgba(220,53,69,0.8)",
		"rgba(108,117,125,0.8)"
	];

	new Chart(document.getElementById("chartPaiements"), {
		type: "pie",
		data: { labels: stats.labels, datasets: [{ data: stats.values, backgroundColor: colors }] },
		options: {
			plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipLabel } } }
		}
	});

	generateLegend("legendPaiements", stats.labels, colors);
}

/* ============================= */
/* Types de maladies */
async function loadMaladiesChart() {
	const res = await fetch("{{ path('api_statistics_maladies') }}");
	const stats = await res.json();

	const colors = [
		'rgba(255,99,132,0.8)','rgba(54,162,235,0.8)','rgba(255,206,86,0.8)',
		'rgba(75,192,192,0.8)','rgba(153,102,255,0.8)','rgba(255,159,64,0.8)',
		'rgba(11, 136, 214, 0.8)','rgba(178, 156, 221, 0.8)','rgba(137, 38, 106, 0.8)',
		'rgba(208, 217, 223, 0.8)','rgba(109, 77, 173, 0.8)','rgba(64, 255, 115, 0.8)'
	];

	new Chart(document.getElementById("chartPieMaladies"), {
		type: "pie",
		data: { labels: stats.labels, datasets: [{ data: stats.values, backgroundColor: colors }] },
		options: {
			plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipLabel } } }
		}
	});

	generateLegend("legendMaladies", stats.labels, colors);
}

/* ============================= */
/* SymptÃ´mes */
async function loadSymptomesChart() {
	const res = await fetch("{{ path('api_statistics_symptomes') }}");
	const stats = await res.json();

	const colors = [
		'rgba(255,99,132,0.8)','rgba(54,162,235,0.8)',
		'rgba(255,206,86,0.8)','rgba(75,192,192,0.8)',
		'rgba(153,102,255,0.8)'
	];

	new Chart(document.getElementById("chartSymptomes"), {
		type: "pie",
		data: { labels: stats.labels, datasets: [{ data: stats.values, backgroundColor: colors }] },
		options: {
			plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipLabel } } }
		}
	});

	generateLegend("legendSymptomes", stats.labels, colors);
}

/* ============================= */
/* Clients par jour */
async function loadClientsPerDayChart() {
	const res = await fetch("/api/statistics/clients-per-day");
	const stats = await res.json();

	new Chart(document.getElementById("chartClientsPerDay"), {
		type: "bar",
		data: {
			labels: stats.labels,
			datasets: [{
				data: stats.values,
				backgroundColor: "rgba(13,110,253,0.7)",
				borderColor: "rgba(13,110,253,1)",
				borderWidth: 1
			}]
		},
		options: {
			scales: { y: { beginAtZero: true }},
			plugins: { legend: { display: false } }
		}
	});
}

/* ============================= */
/* Validation RDV (fixÃ©) */
/* ============================= */
document.addEventListener("DOMContentLoaded", () => {

	loadPaiementsChart();
	loadMaladiesChart();
	loadSymptomesChart();
	loadClientsPerDayChart();

	document.querySelectorAll(".btn-validate-rdv").forEach(btn => {
		btn.addEventListener("click", async e => {
			e.preventDefault();

			const id = btn.dataset.id;

			const res = await fetch(`/api/rdv/validate/${id}`, { method: "POST" });
			const data = await res.json();

			if (data.success) {
				btn.innerHTML = "<i class='bi bi-check-circle-fill'></i>";
				btn.classList.replace("btn-success", "btn-secondary");
				btn.disabled = true;
			}


		});



	});

});

	async function loadRDV() {

    const res = await fetch("/api/rdv/today");
    const rdvs = await res.json();

    const list = document.getElementById("rdvList");
    list.innerHTML = "";

    if (rdvs.length === 0) {
        list.innerHTML = `<p class="text-muted text-center">Aucun rendez-vous aujourdâ€™hui</p>`;
        return;
    }

    rdvs.forEach(rdv => {
        list.insertAdjacentHTML("beforeend", `
            <div class="card border-0  rounded-3 p-3 mb-3">

                <div class="d-flex justify-content-between align-items-start">

                    <div>
                        <h6 class="fw-bold mb-1">
                            <i class="bi bi-person-circle text-primary"></i>
                            ${rdv.nom}
                        </h6>

                        <p class="text-muted small mb-1">
                            <i class="bi bi-chat-left-dots"></i>
                            ${rdv.motif ?? "Sans motif"}
                        </p>

                        <span class="badge bg-success px-2 py-1">
                            ${rdv.statut}
                        </span>
                    </div>

                    <a href="#" class="btn btn-success btn-sm rounded-pill px-2 py-1 btn-validate-rdv"
                       data-id="${rdv.id}">
                        <i class="bi bi-check-circle"></i>
                    </a>

                </div>

                <div class="text-muted small mt-2">
                    <i class="bi bi-clock"></i> ${rdv.date}
                </div>

            </div>
        `);
    });

    attachValidationEvents(); // Re-bind des events car on a modifiÃ© le DOM
}
function attachValidationEvents() {
    document.querySelectorAll(".btn-validate-rdv").forEach(btn => {
        btn.addEventListener("click", async e => {
            e.preventDefault();

            const id = btn.dataset.id;

            const res = await fetch(`/api/rdv/validate/${id}`, { method: "POST" });
            const data = await res.json();

            if (data.success) {
                // ðŸ”¥ Recharge toute la liste
                loadRDV();
            }
        });
    });
}
document.addEventListener("DOMContentLoaded", () => {
    loadRDV();
});



</script>

