{% extends 'base.html.twig' %}

{% block title %}Gestion des prestations
{% endblock %}

{% block body %}
	<style>
		/* Actions DataTable : rendu pro (copié de ton style) */
		.table-actions {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.35rem;
			border-radius: 999px;
			background: rgba(13, 110, 253, 0.06);
			border: 1px solid rgba(13, 110, 253, 0.10);
		}

		.btn-action {
			width: 36px;
			height: 36px;
			padding: 0;
			border-radius: 12px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-size: 1rem;
			box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
		}

		.btn-action-primary {
			background: #fff;
			border: 1px solid rgba(13, 110, 253, 0.25);
			color: #0d6efd;
		}

		.btn-action-danger {
			background: #fff;
			border: 1px solid rgba(220, 53, 69, 0.25);
			color: #dc3545;
		}

		.btn-action:hover {
			filter: brightness(0.98);
		}
	</style>

	{# ================= DATATABLES CSS ================= #}
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

	<div
		class="mt-4">

		{# ================= HEADER ================= #}
		{% embed '_partials/_page_header.html.twig' with {
    icon: 'bi bi-cash-coin',
    title: 'Gestion des prestations',
    subtitle: 'Ajoutez, modifiez et gérez les prestations et leurs prix'
  } %}
			{% block header_actions_left %}
				{# ➕ Ajouter #}
				<span class="action-icon bg-primary text-white" role="button" data-bs-toggle="modal" data-bs-target="#modalPrestationPrice" data-bs-toggle="tooltip" title="Ajouter une prestation">
					<i class="bi bi-plus-circle"></i>
				</span>
			{% endblock %}
		{% endembed %}

		{# ================= TABLE ================= #}
		<section class="mb-4">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-body p-3 p-md-4">

					<table id="prestationsTable" class="table table-striped table-hover align-middle mb-0" style="width:100%">
						<thead class="table-primary">
							<tr>
								<th>Nom</th>
								<th>Catégorie</th>
								<th class="text-center">Prix</th>
								<th class="text-center">Durée</th>
								<th>Description</th>
								<th class="text-center">Actions</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>

				</div>
			</div>
		</section>

	</div>

	{# ================= MODAL (partial) ================= #}
	{% include 'prestation_price/_modal.html.twig' %}

{% endblock %}

{% block javascripts %}
	{{ parent() }}

{# ⚠️ Mets ces CDN ici seulement si tu ne les as PAS déjà dans base.html.twig #}
	 <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	 <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

	 <script>
	    (function () {
	      let dt;
	      let editId = null;
	
	      function moneyEuro(value) {
	        if (value === null || value === undefined || value === '') return '—';
	        const n = Number(value);
	        if (Number.isNaN(n)) return value + ' €';
	        return n.toFixed(2).replace('.', ',') + ' €';
	      }
	
	      function init() {
	        const modalEl = document.getElementById("modalPrestationPrice");
	        const form = document.getElementById("prestationPriceForm");
	        const tableEl = $('#prestationsTable');
	
	        if (!modalEl || !form || !tableEl.length) return;
	
	        // ✅ sécurité: DataTables chargé ?
	        if (!$.fn.DataTable) {
	          console.error("DataTables non chargé.");
	          return;
	        }
	
	        // ✅ destroy si déjà initialisé
	        if ($.fn.DataTable.isDataTable(tableEl)) {
	          tableEl.DataTable().clear().destroy();
	        }
	
	        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
	
	        dt = tableEl.DataTable({
	          processing: true,
	          responsive: true,
	          autoWidth: false,
	
	          ajax: {
	            url: '/api/prestation-prices',
	            dataSrc: ''
	          },
	
	          columns: [
	            { data: 'nom', className: 'fw-semibold' },
	            {
	              data: 'categorie',
	              render: d => `<span class="badge bg-success rounded-pill px-3">${d ?? '—'}</span>`
	            },
	            {
	              data: 'prix',
	              className: 'text-center',
	              render: d => `<span class="badge bg-primary rounded-pill px-3">${moneyEuro(d)}</span>`
	            },
	            {
	              data: 'duree_minutes',
	              className: 'text-center',
	              render: d => d ? `${d} min` : `<span class="text-muted">—</span>`
	            },
	            {
	              data: 'description',
	              render: d => d ? d : `<span class="text-muted">—</span>`
	            },
	            {
	              data: 'id',
	              orderable: false,
	              className: 'text-center',
	              render: id => `
	                <div class="table-actions">
	                  <button type="button"
	                          class="btn btn-action btn-action-primary"
	                          data-action="edit"
	                          data-id="${id}"
	                          title="Modifier">
	                    <i class="bi bi-pencil"></i>
	                  </button>
	
	                  <button type="button"
	                          class="btn btn-action btn-action-danger"
	                          data-action="delete"
	                          data-id="${id}"
	                          title="Supprimer">
	                    <i class="bi bi-trash"></i>
	                  </button>
	                </div>
	              `
	            }
	          ],
	
	          language: {
	            url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
	          },
	
	          pageLength: 10
	        });
	
	        // ✅ reset modal
	        modalEl.addEventListener("hidden.bs.modal", () => {
	          editId = null;
	          form.reset();
	        });
	
	        // ✅ delegation click actions
	        document.addEventListener('click', async (e) => {
	          const btn = e.target.closest('[data-action]');
	          if (!btn) return;
	
	          const action = btn.dataset.action;
	          const id = Number(btn.dataset.id);
	
	          if (action === 'edit') {
	            const res = await fetch(`/api/prestation-prices/${id}`);
	            if (!res.ok) return alert("Erreur chargement prestation");
	
	            const p = await res.json();
	            editId = id;
	
	            form.nom.value = p.nom ?? '';
	            form.categorie.value = p.categorie ?? '';
	            form.prix.value = p.prix ?? '';
	            form.duree_minutes.value = p.duree_minutes ?? '';
	            form.description.value = p.description ?? '';
	
	            modal.show();
	          }
	
	          if (action === 'delete') {
	            if (!confirm("Supprimer cette prestation ?")) return;
	
	            const res = await fetch(`/api/prestation-prices/${id}`, { method: 'DELETE' });
	            if (!res.ok) return alert("Erreur suppression");
	
	            dt.ajax.reload(null, false);
	          }
	        });
	
	        // ✅ submit create/update
	        form.addEventListener("submit", async (e) => {
	          e.preventDefault();
	
	          const payload = {
	            nom: form.nom.value.trim(),
	            categorie: form.categorie.value,
	            prix: form.prix.value,
	            duree_minutes: form.duree_minutes.value,
	            description: form.description.value.trim()
	          };
	
	          const url = editId ? `/api/prestation-prices/${editId}` : `/api/prestation-prices`;
	          const method = editId ? 'PUT' : 'POST';
	
	          const res = await fetch(url, {
	            method,
	            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
	            body: JSON.stringify(payload)
	          });
	
	          if (!res.ok) {
	            const t = await res.text();
	            console.error(t);
	            alert("Erreur lors de l'enregistrement.");
	            return;
	          }
	
	          editId = null;
	          form.reset();
	          modal.hide();
	          dt.ajax.reload(null, false);
	        });
	
	        // ✅ petit fix responsive
	        setTimeout(() => {
	          if (dt) {
	            dt.columns.adjust();
	            if (dt.responsive) dt.responsive.recalc();
	          }
	        }, 200);
	      }
	
	      window.addEventListener('load', init);
	    })();
	  </script>
{% endblock %}

