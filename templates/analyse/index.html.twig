{% extends 'base.html.twig' %}

{% block title %}Analyses pr√©d√©finies
{% endblock %}

{% block body %}

	<div
		class="mt-4">

		<!-- ‚≠ê ENT√äTE -->
		<div class="card shadow-lg border-0 rounded-4 mb-4">
			<div class="card-body py-4 px-4">
				<div class="row align-items-center">

					<div class="col-md-7 d-flex align-items-center">
						<i class="bi bi-clipboard-pulse text-primary fs-1 me-3"></i>
						<div>
							<h2 class="fw-bold text-primary mb-1">Analyses pr√©d√©finies</h2>
							<p class="text-secondary m-0">
								R√©f√©rentiel des analyses disponibles pour prescription m√©dicale
							</p>
						</div>
					</div>

					<div class="col-md-5 d-flex justify-content-end gap-2 mt-3 mt-md-0">
						<button id="btnAddAnalyse" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
							<i class="bi bi-plus-circle"></i>
							Nouvelle analyse
						</button>

						<button onclick="history.back()" class="btn btn-outline-primary btn-lg rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
							<i class="bi bi-arrow-left"></i>
							Retour
						</button>
					</div>

				</div>
			</div>
		</div>

		<!-- üì¶ LISTE -->
		<div class="row g-4" id="analyseList">

			{% for analyse in analyses %}
<div class="col-md-6 col-lg-4 analyse-item" data-id="{{ analyse.id }}" data-token="{{ csrf_token('analyse_delete' ~ analyse.id) }}">


					<div class="analyse-card h-100">
						<div class="d-flex justify-content-between align-items-start">

							<div>
								<h5 class="fw-bold text-primary mb-1">{{ analyse.name }}</h5>
								<p class="text-secondary small mb-0">
									{{ analyse.description ?: 'Aucune description fournie' }}
								</p>
							</div>

							<div class="d-flex gap-2">
								<button class="btn btn-sm btn-outline-warning btnEdit" title="Modifier">
									<i class="bi bi-pencil"></i>
								</button>
								<button class="btn btn-sm btn-outline-danger btnDelete" title="Supprimer">
									<i class="bi bi-trash"></i>
								</button>
							</div>

						</div>
					</div>
				</div>
			{% else %}
				<div class="col-12">
					<div class="alert alert-info text-center rounded-4 py-4">
						Aucune analyse pr√©d√©finie enregistr√©e.
					</div>
				</div>
			{% endfor %}

		</div>

	</div>

	{% include 'analyse/modal.html.twig' %}

	<style>
		.analyse-card {
			background: white;
			border-radius: 20px;
			padding: 22px;
			border: 1px solid rgba(0, 0, 0, .08);
			transition: 0.3s ease;
		}
		.analyse-card:hover {
			transform: translateY(-6px);
			box-shadow: 0 18px 40px rgba(0, 0, 0, .12);
		}
	</style>

{% endblock %}

{% block javascripts %}
	{{ parent() }}
	 <script>
	document.addEventListener('DOMContentLoaded', function () {
	
	    const analyseModal = new bootstrap.Modal(
	        document.getElementById('analyseModal')
	    );
	
	    const routes = {
	        save: "{{ path('analyse_save') }}",
	        get:  "{{ path('analyse_get', {id: 0}) }}".replace('/0',''),
	        del:  "{{ path('analyse_delete', {id: 0}) }}".replace('/0','')
	    };
	
	    // ADD
	    document.getElementById('btnAddAnalyse').addEventListener('click', () => {
	        document.getElementById('analyseForm').reset();
	        document.getElementById('analyse_id').value = '';
	        analyseModal.show();
	    });
	
	    // EDIT
	    $('#analyseList').on('click', '.btnEdit', function () {
	        const card = $(this).closest('[data-id]');
	        const id = card.data('id');
	
	        $.get(routes.get + '/' + id, data => {
	            $('#analyse_id').val(data.id);
	            $('#name').val(data.name);
	            $('#description').val(data.description);
	            analyseModal.show();
	        });
	    });
	
	    // SAVE
	    $('#analyseForm').on('submit', function (e) {
	        e.preventDefault();
	
	        $.post(routes.save, $(this).serialize(), function (res) {
	
	            const a = res.analyse;
	            const cardHtml = `
	            <div class="col-md-6 col-lg-4 analyse-item" data-id="${a.id}">
	                <div class="analyse-card h-100">
	                    <div class="d-flex justify-content-between align-items-start">
	                        <div>
	                            <h5 class="fw-bold text-primary mb-1">${escapeHtml(a.name)}</h5>
	                            <p class="text-secondary small mb-0">
	                                ${escapeHtml(a.description || 'Aucune description fournie')}
	                            </p>
	                        </div>
	                        <div class="d-flex gap-2">
	                            <button class="btn btn-sm btn-outline-warning btnEdit">
	                                <i class="bi bi-pencil"></i>
	                            </button>
	                            <button class="btn btn-sm btn-outline-danger btnDelete">
	                                <i class="bi bi-trash"></i>
	                            </button>
	                        </div>
	                    </div>
	                </div>
	            </div>`;
	
	            const existing = $('#analyseList').find(`[data-id="${a.id}"]`);
	            if (existing.length) {
	                existing.replaceWith(cardHtml);
	            } else {
	                $('#analyseList').prepend(cardHtml);
	            }
	
	            analyseModal.hide();
	        });
	    });
	
	    // DELETE
	   // DELETE
$('#analyseList').on('click', '.btnDelete', function () {
    if (!confirm('Supprimer cette analyse ?')) return;

    const $card = $(this).closest('[data-id]');
    const id = $card.data('id');
    const token = $card.data('token');

    console.log('DELETE id=', id, 'token=', token);

    $.ajax({
        url: routes.del + '/' + id,
        method: 'POST',
        data: { _token: token },
        success: function (res) {
            console.log('DELETE response', res);

            if (res.success) {
                $card.remove();
            } else {
                alert(res.message || 'Erreur suppression');
            }
        },
        error: function (xhr) {
            console.log('DELETE ERROR', xhr.status, xhr.responseText);
            alert('Erreur serveur DELETE: ' + xhr.status);
        }
    });
});

	
	    function escapeHtml(str) {
	        return (str ?? '').toString()
	            .replaceAll('&','&amp;')
	            .replaceAll('<','&lt;')
	            .replaceAll('>','&gt;')
	            .replaceAll('"','&quot;')
	            .replaceAll("'","&#039;");
	    }
	
	});
	</script>
{% endblock %}

